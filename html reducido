<script>
      const kpiNames = {
  // FINANCIERO
  gci: 'GCI',
  volumenNegocio: 'Volumen Negocio',
  beneficioNeto: 'Beneficio Neto',
  totalTransacciones: 'Transacciones',
  
  // RATIOS
  cumplimientoGlobal: 'Cumplimiento',
  conversionCaptacion: 'ConversiÃ³n Capt.',
  conversionComprador: 'ConversiÃ³n Comp.',
  ratioCierreExclusivas: 'Ratio Cierre (GCI/EXCL)',
  productividad: 'Productividad',
  ticketPromedio: 'Ticket Promedio',
  actividadTotal: 'Actividad Total',
  
  // CAPTACIÃ“N - ORIGINALES
  citasCaptacion: 'Citas CaptaciÃ³n',
  exclusivasVenta: 'Exclusivas Venta',
  captacionesAbierto: 'Captaciones Abierto',
  
  // CAPTACIÃ“N - NUEVOS ğŸ†•
  captacionesAlquiler: 'Captaciones Alquiler',
  leadVendedor: 'Lead Vendedor',
  tresBs: '3Bs Activadas',
  bajadasPrecio: 'Bajadas Precio',
  
  // COMPRADOR - ORIGINALES
  citasCompradores: 'Citas Comprador',
  exclusivasComprador: 'Exclusivas Comprador',
  casasEnsenadas: 'Casas EnseÃ±adas',
  leadsCompradores: 'Leads Compradores',
  
  // COMPRADOR - NUEVOS ğŸ†•
  leadComprador: 'Lead Comprador',
  propuestasCompra: 'Propuestas Compra',
  leadSeguimiento: 'Lead Seguimiento',
  
  // GENERAL - ORIGINALES
  llamadas: 'Llamadas',
  
  // GENERAL - NUEVOS ğŸ†•
  arras: 'Arras Firmadas'
};
      
      // ============================================
// MEJORA 4: VISTA MÃšLTIPLE DE AGENTES
// ============================================
let mostrandoTodosLosAgentes = false;
        // ==================== DASHBOARD KW PRO - JAVASCRIPT COMPLETO (REPARADO v5.3) ====================
        // VERSION: 5.3 (Fix Vista Agente & Transacciones Crash)
        
        // ===== VARIABLES GLOBALES =====
        let datosGlobales = []; // Todos los datos de todos los agentes
        let datosFiltrados = []; // Datos filtrados por el gerente
        let datosAgregadosEquipo = {}; // Datos mensuales agregados del equipo
        let chartInstances = {}; // AlmacÃ©n de grÃ¡ficos activos
        let agenteActual = null; // Info del agente en la vista Agente
        let datosAgenteCompletos = null; // Datos completos del agente activo
        
        // Filtros
        let periodoActual = 'ano'; // Filtro de tiempo del gerente
        let periodoAgenteActual = 'ano'; // Filtro de tiempo del agente
        let agenteFechaInicio = null;
        let agenteFechaFin = null;
        let gerenteFechaInicio = null;
        let gerenteFechaFin = null;

        // â­ NUEVO: Para el modal de transacciones
        let agentesParaTransaccion = [];    

        let topN = 5;
        let vistaActualGerente = 'mando';
        let seleccionMultiAgente = false; // Para modo selecciÃ³n
        


        // 1. SISTEMA DE CAPAS (Para que no se cierren las ventanas de abajo)
function abrirModalEncima(idModal) {
    const modal = document.getElementById(idModal);
    if (modal) {
        modal.style.zIndex = "2000"; // Capa superior
        modal.classList.add('active');
        // No tocamos el body porque ya tiene 'modal-open' del padre
    } else {
        console.error("Error: No existe el modal " + idModal);
    }
}

function cerrarModalSuperior(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) {
        console.error('Modal no encontrado:', modalId);
        return;
    }
    
    modal.classList.remove('active');
    
    // âœ… VERIFICAR si hay otros modales abiertos
    const modalesAbiertos = document.querySelectorAll('.modal.active');
    
    // Solo quitar el bloqueo si NO hay mÃ¡s modales abiertos
    if (modalesAbiertos.length === 0) {
        document.body.classList.remove('modal-open');
    }
    
    console.log('âœ… Modal cerrado:', modalId, '| Modales abiertos restantes:', modalesAbiertos.length);
}
// FunciÃ³n de emergencia para desbloquear el scroll
function desbloquearScrollEmergencia() {
    document.body.classList.remove('modal-open');
    document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
    console.log('ğŸš¨ Scroll desbloqueado manualmente');
}

// Listener de tecla ESC para cerrar modales y desbloquear
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modalesAbiertos = document.querySelectorAll('.modal.active');
        if (modalesAbiertos.length > 0) {
            modalesAbiertos.forEach(m => m.classList.remove('active'));
            document.body.classList.remove('modal-open');
            console.log('âœ… Modales cerrados con ESC');
        }
    }
});

// FunciÃ³n "Salir" o reset total
function cerrarModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    
    modal.classList.remove('active');
    
    // Verificar si hay otros modales abiertos
    const modalesAbiertos = document.querySelectorAll('.modal.active');
    
    if (modalesAbiertos.length === 0) {
        document.body.classList.remove('modal-open');
    }
}
        
        // =================================================================
        // ========== INICIO DE LA APLICACIÃ“N
        // =================================================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('âœ… Dashboard KW Pro 5.3 cargado y listo');
            crearEstrellas();
            cargarTemaGuardado(); // â­ NUEVO: Cargar tema

            // Unir botones de forma segura
            document.getElementById('btn-gerente').addEventListener('click', iniciarVistaGerente);
            document.getElementById('btn-agente').addEventListener('click', iniciarVistaAgente);
            document.getElementById('btn-logout-header').addEventListener('click', logout);
            console.log('Listeners de navegaciÃ³n principal asignados.');

            // Configurar lÃ³gica de filtros fijos
            setupStickyFilters('manager-filters-container', 'manager-filter-placeholder', 'main-header');
            setupStickyFilters('agent-filters-container', 'agent-filter-placeholder', 'agent-header');
        });
        
        function crearEstrellas() {
            const container = document.getElementById('stars');
            if (!container || container.children.length > 0) return;
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const size = Math.random() * 3 + 1;
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                container.appendChild(star);
            }
        }
        
        // ===== NAVEGACIÃ“N PRINCIPAL =====
        function mostrarVista(vistaId) {
            console.log('ğŸ“ Mostrando vista:', vistaId);
            document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
            const vista = document.getElementById(vistaId);
            if (vista) {
                vista.classList.add('active');
            } else {
                console.error('âŒ Vista no encontrada:', vistaId);
            }
        }
        
        function iniciarVistaGerente() {
    console.log('ğŸ‘” Iniciando vista gerente...');
    
    // 1. Intentar poner pantalla completa automÃ¡ticamente al hacer clic
    toggleFullScreen(); 

    // 2. Resto de la lÃ³gica normal
    mostrarVista('view-manager');
    cargarDatosGerente(periodoActual);
}
        
        function iniciarVistaAgente() {
    console.log('ğŸ¡ Iniciando vista agente...');
    
    // 1. Intentar poner pantalla completa automÃ¡ticamente al hacer clic
    toggleFullScreen();

    // 2. Cambiar vista
    mostrarVista('view-agent');
    
    // 3. Cargar agentes en el selector
    setTimeout(() => {
        poblarSelectAgentes('agent-select');
    }, 100);
}
        
        function logout() {
            console.log('ğŸ‘‹ Cerrando sesiÃ³n...');
            mostrarVista('view-login');
            agenteActual = null;
            datosAgenteCompletos = null;
            datosGlobales = [];
            datosFiltrados = [];
        }
        
        // ===== VISTA GERENTE =====
        // --- FUNCIÃ“N DE CARGA MAESTRA (REPARADA) ---
// --- CARGA DE DATOS SINCRONIZADA Y BLINDADA ---
// Variable global nueva para guardar los histÃ³ricos individuales
let historialAgentesCache = {}; 

function cargarDatosGerente(periodo) {
    console.log('ğŸ“Š Cargando dashboard...');
    periodoActual = periodo;
    cerrarModal();
    
    const content = document.getElementById('content');
    if (!content) {
        console.error('âŒ Elemento content no encontrado');
        return;
    }
    
    content.innerHTML = `<div class="loading"><div class="loader"></div><div>Cargando mÃ©tricas...</div></div>`;
    
    // Obtener aÃ±o contable
    google.script.run
        .withSuccessHandler(function(aÃ±oContable) {
            const aÃ±oAnterior = aÃ±oContable - 1;
            
            // Actualizar texto de carga con aÃ±os correctos
            const loadingDiv = content.querySelector('.loading div:last-child');
            if (loadingDiv) {
                loadingDiv.textContent = `Conectando mÃ©tricas ${aÃ±oContable} vs ${aÃ±oAnterior}...`;
            }
            
            const filtros = calcularFiltrosPeriodo(periodo, 'gerente');
            
            // Cargar histÃ³rico del aÃ±o ANTERIOR (no actual)
            google.script.run
                .withSuccessHandler(function(histAgentes) {
                    historialAgentesCache = histAgentes || {};
                    const numAgentes = Object.keys(historialAgentesCache).length;
                    console.log(`âœ… HistÃ³ricos ${aÃ±oAnterior}: ${numAgentes} agentes`);
                    
                    // Cargar TODOS los datos
                    google.script.run
                        .withSuccessHandler(function(datos) {
                            console.log('âœ… Datos recibidos');
                            
                            if (!datos || !datos.agentes) {
                                console.error('âŒ Datos invÃ¡lidos');
                                if (content) {
                                    content.innerHTML = '<div style="padding:50px; text-align:center; color:red;">Error al cargar datos</div>';
                                }
                                return;
                            }
                            
                            // Asignar datos
                            datosGlobales = datos.agentes;
                            datosAgregadosEquipo = datos.evolucionMensualEquipo;
                            datosFiltrados = datosGlobales;
                            window.datosHistoricos2024 = datos.evolucionMensual2024 || {};
                            window.transaccionesGlobales = datos.transacciones || [];
                            window.datosBeneficioGlobal = datos.beneficioNeto;
                            window.beneficioNetoGlobal = datos.beneficioNeto?.beneficioNeto || 0;
                            window.datosTransaccionesGlobal = datos.estadisticasTransacciones;
                            window.totalTransaccionesGlobal = datos.estadisticasTransacciones?.stats?.total || 0;
                            
                            // FacturaciÃ³n Pasada con validaciÃ³n
                            if (datos.facturacionPasada && datos.facturacionPasada.kpis) {
                                window.facturacionPasadaGlobal = datos.facturacionPasada;
                                console.log('âœ… FacturaciÃ³n Pasada: GCI=' + datos.facturacionPasada.kpis.gci);
                            } else {
                                console.warn('âš ï¸ FacturaciÃ³n Pasada vacÃ­a');
                                window.facturacionPasadaGlobal = {
                                    kpis: {
                                        citasCaptacion: 0, exclusivasVenta: 0, captAbierto: 0, citasComprador: 0,
                                        casasEnsenadas: 0, exclusivasCompr: 0, llamadas: 0, captAlquiler: 0,
                                        leadVendedor: 0, tresBs: 0, bajadasPrecio: 0, leadComprador: 0,
                                        propuestasCompra: 0, leadSeguimiento: 0, arras: 0, ventas: 0, gci: 0
                                    },
                                    origenes: []
                                };
                            }
                            
                            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            // ğŸ†• CARGAR OBJETIVOS GLOBALES DEL MODELO ECONÃ“MICO
                            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            google.script.run
                                .withSuccessHandler(function(objetivos) {
                                    window.objetivosGlobalesOficina = objetivos;
                                    console.log('ğŸ¯ Objetivos globales:', objetivos ? 'Modelo EconÃ³mico ACTIVO' : 'Usando suma de agentes');
                                    
                                    // Ahora sÃ­ renderizar
                                    console.log('ğŸ¨ Renderizando');
                                    renderizarDashboardGerente();
                                })
                                .withFailureHandler(function(error) {
                                    console.warn('âš ï¸ Error cargando objetivos globales:', error);
                                    window.objetivosGlobalesOficina = null;
                                    
                                    // Renderizar de todos modos
                                    console.log('ğŸ¨ Renderizando (sin objetivos globales)');
                                    renderizarDashboardGerente();
                                })
                                .obtenerObjetivosGlobalesOficina();
                            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        })
                        .withFailureHandler(function(error) {
                            console.error('âŒ Error datos:', error);
                            if (content) {
                                content.innerHTML = `<div style="padding:50px; text-align:center; color:red;">Error: ${error.message || error}</div>`;
                            }
                        })
                        .obtenerDatosDashboardCompleto(filtros);
                })
                .withFailureHandler(function(error) {
                    console.error('âŒ Error histÃ³ricos:', error);
                    historialAgentesCache = {};
                    // Continuar sin histÃ³ricos
                })
                .obtenerTodosHistoricosAgentes(aÃ±oAnterior);
        })
        .withFailureHandler(function(error) {
            console.error('âŒ Error aÃ±o contable:', error);
            // Fallback: continuar con aÃ±o del sistema
            const aÃ±oSistema = new Date().getFullYear();
            console.log('âš ï¸ Usando aÃ±o del sistema: ' + aÃ±oSistema);
        })
        .obtenerAÃ±oContable();
}
        
        function calcularFiltrosPeriodo(periodo, vista = 'gerente') {
            const hoy = new Date();
            let fechaInicio, fechaFin;
            fechaFin = new Date(hoy);
            
            const inicioEl = document.getElementById(`${vista}-fecha-inicio`);
            const finEl = document.getElementById(`${vista}-fecha-fin`);

            switch(periodo) {
                case 'dia':
                    fechaInicio = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
                    break;
                case 'semana':
                    fechaInicio = new Date(hoy.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'mes':
                    fechaInicio = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
                    break;
                case 'trimestre':
                    const mesActual = hoy.getMonth();
                    const inicioTrimestre = Math.floor(mesActual / 3) * 3;
                    fechaInicio = new Date(hoy.getFullYear(), inicioTrimestre, 1);
                    break;
                case 'semestre':
                    const inicioSemestre = hoy.getMonth() < 6 ? 0 : 6;
                    fechaInicio = new Date(hoy.getFullYear(), inicioSemestre, 1);
                    break;
                case 'ano':
                    fechaInicio = new Date(hoy.getFullYear(), 0, 1);
                    break;
                default: // 'custom'
                    const inicio = (vista === 'agente' ? agenteFechaInicio : gerenteFechaInicio) || `${new Date().getFullYear()}-01-01`;
                    const fin = (vista === 'agente' ? agenteFechaFin : gerenteFechaFin) || hoy.toISOString().split('T')[0];
                    fechaInicio = new Date(inicio + "T00:00:00"); // Asegurar zona horaria local
                    fechaFin = new Date(fin + "T23:59:59"); // Asegurar zona horaria local
                    break;
            }
            return {
                fechaInicio: fechaInicio.toISOString().split('T')[0],
                fechaFin: fechaFin.toISOString().split('T')[0]
            };
        }

        function aplicarFiltroGerenteCustom() {
            periodoActual = 'custom';
            gerenteFechaInicio = document.getElementById('gerente-fecha-inicio').value;
            gerenteFechaFin = document.getElementById('gerente-fecha-fin').value;
            document.querySelectorAll('#modal-filtros-body .filtro-btn').forEach(btn => btn.classList.remove('active'));
            cargarDatosGerente('custom');
        }
        
        function renderizarDashboardGerente() {
            console.log('ğŸ¨ Renderizando dashboard gerente');
            const html = `
                <div class="header" id="main-header">
                    <div class="header-content">
                        <div>
                            <h1>ğŸ“Š DASHBOARD GERENTE</h1>
                            <div class="subtitle">CONTROL TOTAL DEL EQUIPO</div>
                        </div>
                        <div class="header-buttons">
                            <button class="btn" onclick="mostrarModalFiltros('gerente')">ğŸ“… Filtros</button>
                            <button class="btn btn-ia" onclick="analizarRendimientoIA()">âœ¨ Analizar Equipo</button>
                            <button class="btn btn-primary-action" onclick="mostrarModalAcciones()">â• Centro de Acciones</button>
                            
                            <button class="btn" onclick="mostrarModalTemas()">ğŸ¨ Tema</button>
                            <button class="btn" onclick="toggleFullScreen()">â†”ï¸</button>
                            <button class="btn" onclick="tomarCaptura()">ğŸ“¸</button>
                            <button class="btn" onclick="window.print()">ğŸ–¨ï¸</button>
                            
                            <button class="btn-refresh" onclick="cargarDatosGerente(periodoActual)">ğŸ”„ ACTUALIZAR</button>
                            <button class="btn-logout" onclick="logout()">â¬…ï¸ SALIR</button>
                        </div>
                    </div>
                </div>
                
                <div id="manager-filters-container" class="filtros-rapidos" style="display: none;">
                ${renderizarFiltrosRapidos("gerente")}
                </div>

                ${renderizarSignosVitales()}
                <div class="vista-tabs">
                <button id="tab-mando" class="tab-btn active" onclick="cambiarVistaGerente('mando', this)">ğŸ¯ Centro de Mando</button>
                    <button id="tab-tarjetas" class="tab-btn active" onclick="cambiarVistaGerente('tarjetas', this)">ğŸ´ Tarjetas</button>
                    <button id="tab-rankings" class="tab-btn" onclick="cambiarVistaGerente('rankings', this)">ğŸ† Rankings</button>
                    <button id="tab-ratios" class="tab-btn" onclick="cambiarVistaGerente('ratios', this)">ğŸ“Š Tabla Ratios</button>
                    <button class="tab-btn" id="tab-transacciones" onclick="cambiarVistaGerente('transacciones')">ğŸ’° Transacciones</button>
<button class="tab-btn" id="tab-embudos" onclick="cambiarVistaGerente('embudos')">ğŸ¯ Embudos</button>
<button class="tab-btn" id="tab-correlaciones" onclick="cambiarVistaGerente('correlaciones')">ğŸ”¬ Correlaciones</button>
<button class="tab-btn" id="tab-graficos" onclick="cambiarVistaGerente('graficos')">ğŸ“ˆ GrÃ¡ficos</button>
<button class="tab-btn" id="tab-origenes" onclick="cambiarVistaGerente('origenes', this)">ğŸ¯ AnÃ¡lisis OrÃ­genes</button>
                </div>
                <div id="selection-controls" style="display: flex; gap: 10px; margin-bottom: 20px; align-items: center; position: relative; z-index: 5;">
                    <button id="btn-toggle-select" class="btn" onclick="toggleSeleccionMultiAgente(this)">Seleccionar Varios</button>
                    <button id="btn-group-action" class="btn btn-ia" style="display:none;" onclick="compararGrupoAgentes()">âš–ï¸ Comparar Grupo</button>
                </div>
                <div id="vistaContenido"></div>
                `;
            document.getElementById('content').innerHTML = html;
            
            setupStickyFilters('manager-filters-container', 'manager-filter-placeholder', 'main-header');
            
            cambiarVistaGerente(vistaActualGerente, document.getElementById(`tab-${vistaActualGerente}`));
        }
        
        function renderizarFiltrosRapidos(vista) {
            const periodos = [
                { id: 'dia', label: 'DÃ­a' },
                { id: 'semana', label: 'Semana' },
                { id: 'mes', label: 'Mes' },
                { id: 'trimestre', label: 'Trimestre' },
                { id: 'semestre', label: 'Semestre' },
                { id: 'ano', label: 'AÃ±o' }
            ];
            const periodoActivo = vista === 'gerente' ? periodoActual : periodoAgenteActual;
            const funcionClick = vista === 'gerente' ? 'cargarDatosGerente' : 'filtrarDatosAgente';
            const funcionCustom = vista === 'gerente' ? 'aplicarFiltroGerenteCustom()' : 'aplicarFiltroAgenteCustom()';
            const idPrefix = vista === 'gerente' ? 'gerente' : 'agente';
            const hoy = new Date().toISOString().split('T')[0];
            
            let fechaInicio, fechaFin;
            if (vista === 'agente') {
                fechaInicio = agenteFechaInicio || `${new Date().getFullYear()}-01-01`;
                fechaFin = agenteFechaFin || hoy;
            } else {
                fechaInicio = gerenteFechaInicio || `${new Date().getFullYear()}-01-01`;
                fechaFin = gerenteFechaFin || hoy;
            }

            let html = '<div class="filtros-buttons">';
            periodos.forEach(p => {
                const active = periodoActivo === p.id ? 'active' : '';
                html += `<button id="${idPrefix}-filtro-${p.id}" class="filtro-btn ${active}" onclick="${funcionClick}('${p.id}')">${p.label}</button>`;
            });
            
            html += `
                <div class="filtro-custom-date">
                    <label for="${idPrefix}-fecha-inicio">Desde:</label>
                    <input type="date" id="${idPrefix}-fecha-inicio" class="form-input" value="${fechaInicio}">
                    <label for="${idPrefix}-fecha-fin">Hasta:</label>
                    <input type="date" id="${idPrefix}-fecha-fin" class="form-input" value="${fechaFin}">
                    <button type="button" class="btn btn-primary-action" onclick="${funcionCustom}">OK</button>
                </div>
            `;
            
            html += '</div>';
            return html;
        }
        
        function renderizarSignosVitales() {
    if (!datosFiltrados || datosFiltrados.length === 0) return '';
    
    let teamKpiData = {};
    
    const kpiKeys = Object.keys(kpiNames);
    kpiKeys.forEach(key => {
        let sum = 0;
        let count = 0;
        datosFiltrados.forEach(d => {
            let val;
            if (key === 'cumplimientoGlobal') val = parseFloat(d.cumplimientoGlobal);
            else if (d.ratios && d.ratios[key] !== undefined) val = parseFloat(d.ratios[key]);
            else if (d.realizado && d.realizado[key] !== undefined) val = parseFloat(d.realizado[key]);
            
            if (!isNaN(val) && isFinite(val)) {
                sum += val;
                count++;
            }
        });
        
        if (['gci', 'citasCaptacion', 'exclusivasVenta', 'exclusivasComprador', 'captacionesAbierto', 'citasCompradores', 'casasEnsenadas', 'leadsCompradores', 'actividadTotal', 'llamadas', 'volumenNegocio', 'captacionesAlquiler', 'leadVendedor', 'tresBs', 'bajadasPrecio', 'leadComprador', 'propuestasCompra', 'leadSeguimiento', 'arras'].includes(key)) {
            teamKpiData[key] = sum;
        } else if (key === 'cumplimientoGlobal') {
            teamKpiData[key] = count > 0 ? (sum / count) : 0;
        } else {
            teamKpiData[key] = count > 0 ? (sum / count) : 0;
        }
    });
    
    // âœ… AÃ‘ADIR: Cargar beneficioNeto y totalTransacciones desde variables globales
    teamKpiData.beneficioNeto = window.beneficioNetoGlobal || 0;
    teamKpiData.totalTransacciones = window.totalTransaccionesGlobal || 0;

    return `
        <div class="signos-vitales">
            <div class="signos-title">ğŸ©º SIGNOS VITALES DEL EQUIPO (Click para ver grÃ¡fico)</div>
            ${renderSignosVitalesGrid(teamKpiData, null)}    
        </div>
    `;
}


// --- 1. REJILLA DE SIGNOS VITALES CON COMPARATIVA YTD DETALLADA ---
function renderSignosVitalesGrid(kpiData, idAgente) {
    const isTeam = !idAgente; 
    let html = '<div class="signos-grid">';
    
    // 1. Calcular Factor de Tiempo (PonderaciÃ³n YTD)
    const hoy = new Date();
    const inicioAnio = new Date(hoy.getFullYear(), 0, 1);
    const diasTranscurridos = Math.ceil((hoy - inicioAnio) / (1000 * 60 * 60 * 24));
    const factor = Math.max(diasTranscurridos / 365, 0.01); 

    // 2. Obtener histÃ³rico
    let hist = null;
    
    if (isTeam) {
        if (typeof facturacionPasadaGlobal !== 'undefined' && 
            facturacionPasadaGlobal && 
            facturacionPasadaGlobal.kpis) {
            
            const k = facturacionPasadaGlobal.kpis;
            hist = { 
                gci: k.gci || 0,
                citasCaptacion: k.citasCaptacion || 0,
                exclusivasVenta: k.exclusivasVenta || 0,
                captacionesAbierto: k.captAbierto || 0,
                citasCompradores: k.citasComprador || 0,
                exclusivasComprador: k.exclusivasCompr || 0,
                casasEnsenadas: k.casasEnsenadas || 0,
                totalTransacciones: k.ventas || 0,
                llamadas: k.llamadas || 0,
                captacionesAlquiler: k.captAlquiler || 0,
                leadVendedor: k.leadVendedor || 0,
                tresBs: k.tresBs || 0,
                bajadasPrecio: k.bajadasPrecio || 0,
                leadComprador: k.leadComprador || 0,
                propuestasCompra: k.propuestasCompra || 0,
                leadSeguimiento: k.leadSeguimiento || 0,
                arras: k.arras || 0
            };
        }
    } else {
        if (typeof historialAgentesCache !== 'undefined' && historialAgentesCache[idAgente]) {
            hist = historialAgentesCache[idAgente];
        }
    }

    // 3. Mapeo de claves histÃ³rico
    const mapHistKeys = {
        'gci': 'gci',
        'citasCaptacion': 'citasCaptacion',
        'exclusivasVenta': 'exclusivasVenta',
        'captacionesAbierto': 'captacionesAbierto',
        'citasCompradores': 'citasCompradores',
        'exclusivasComprador': 'exclusivasComprador',
        'casasEnsenadas': 'casasEnsenadas',
        'totalTransacciones': 'totalTransacciones',
        'llamadas': 'llamadas',
        'captacionesAlquiler': 'captacionesAlquiler',
        'leadVendedor': 'leadVendedor',
        'tresBs': 'tresBs',
        'bajadasPrecio': 'bajadasPrecio',
        'leadComprador': 'leadComprador',
        'propuestasCompra': 'propuestasCompra',
        'leadSeguimiento': 'leadSeguimiento',
        'arras': 'arras'
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 4. ğŸ†• CALCULAR SUMA DE OBJETIVOS DE AGENTES (para fallback)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let sumaObjetivosAgentes = {};
    if (isTeam && datosFiltrados && datosFiltrados.length > 0) {
        datosFiltrados.forEach(agente => {
            if (agente.objetivos) {
                Object.keys(agente.objetivos).forEach(k => {
                    if (!sumaObjetivosAgentes[k]) sumaObjetivosAgentes[k] = 0;
                    sumaObjetivosAgentes[k] += parseFloat(agente.objetivos[k]) || 0;
                });
            }
        });
    }
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Object.keys(kpiNames).forEach(key => {
        const valor = (kpiData[key] !== undefined && kpiData[key] !== null) ? kpiData[key] : 0;
        
        const metricsImportantes = [
            'gci', 'actividadTotal', 'cumplimientoGlobal', 'beneficioNeto', 
            'totalTransacciones', 'llamadas', 'leadsCompradores', 'volumenNegocio', 
            'citasCaptacion', 'exclusivasVenta', 'casasEnsenadas', 'citasCompradores', 
            'exclusivasComprador', 'captacionesAbierto',
            'captacionesAlquiler', 'leadVendedor', 'tresBs', 'bajadasPrecio',
            'leadComprador', 'propuestasCompra', 'leadSeguimiento', 'arras'
        ];
        
        if (valor === 0 && !metricsImportantes.includes(key)) return;
        
        const meta = getKpiMetadata(key, valor);
        
        // LÃ³gica de click
        let funcionClic = "";
        if (key === 'beneficioNeto' && isTeam) funcionClic = `mostrarGraficoBeneficio()`;
        else if (key === 'totalTransacciones' && isTeam) funcionClic = `mostrarGraficoTransacciones()`;
        else if (isTeam) funcionClic = `mostrarAnalisisEquipo('${key}')`;
        else funcionClic = `mostrarGraficoAgente('${idAgente}', '${key}')`;
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // 5. ğŸ†• COMPARATIVA CON OBJETIVO (Global o Suma Agentes)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let objetivoHTML = "";
        if (isTeam) {
            const objetivoData = obtenerObjetivoKPI(key, sumaObjetivosAgentes[key]);
            const objetivo = objetivoData.valor;
            
            if (objetivo > 0) {
                const objetivoYTD = objetivo * factor; // Objetivo prorrateado al dÃ­a de hoy
                const pctCumplimiento = ((valor / objetivoYTD) * 100).toFixed(1);
                const colorObj = pctCumplimiento >= 100 ? '#22c55e' : (pctCumplimiento >= 70 ? '#f59e0b' : '#ef4444');
                const iconoFuente = objetivoData.fuente === 'oficina' ? 'ğŸ¢' : 'ğŸ‘¥';
                
                const objetivoFormat = meta.unidad === 'â‚¬' ? 
                    Math.round(objetivoYTD).toLocaleString('es-ES') + 'â‚¬' : 
                    Math.round(objetivoYTD);
                
                objetivoHTML = `
                    <div style="font-size:0.7em; color:${colorObj}; margin-top:4px; font-weight:bold;">
                        ${pctCumplimiento}% obj ${iconoFuente}
                    </div>
                    <div style="font-size:0.6em; color:#888; margin-top:2px;">
                        Meta YTD: ${objetivoFormat}
                    </div>
                `;
            }
        }
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // 6. COMPARATIVA CON AÃ‘O ANTERIOR
        let compHTML = "";
        const histKey = mapHistKeys[key];

        if (hist && histKey && hist[histKey] !== undefined) {
            const totalAnoPasado = hist[histKey] || 0;
            
            if (totalAnoPasado > 0) {
                const metaYTD = totalAnoPasado * factor; 
                const diff = valor - metaYTD;
                const pctCrecimiento = ((diff / metaYTD) * 100).toFixed(1);
                
                const esPositivo = diff >= 0;
                const color = esPositivo ? '#22c55e' : '#ff4444';
                const icono = esPositivo ? 'â–²' : 'â–¼';
                
                const valorAntFormat = meta.unidad === 'â‚¬' ? 
                    Math.round(metaYTD).toLocaleString('es-ES') + 'â‚¬' : 
                    Math.round(metaYTD);

                compHTML = `
                    <div style="font-size:0.65em; color:${color}; margin-top:4px; font-weight:bold; display:flex; justify-content:center; align-items:center; gap:4px;">
                        <span>${icono} ${Math.abs(pctCrecimiento)}%</span>
                        <span style="opacity:0.6; color:var(--color-text-secondary); font-weight:400;">(vs ${valorAntFormat})</span>
                    </div>
                `;
            }
        } else if (key.includes('conversion') || key.includes('ratio') || key.includes('Cumplimiento')) {
            compHTML = `<div style="font-size:0.65em; color:#888; margin-top:4px;">KPI Ratio</div>`;
        }

        // 7. Combinar objetivo + comparativa histÃ³rica
        const infoAdicional = objetivoHTML + compHTML;

        html += renderSignoCard(meta.icon, meta.label, valor, meta.unidad, meta.claseCritica, funcionClic, infoAdicional);
    });
    
    html += '</div>';
    return html;
}

// --- 2. DIBUJAR TARJETA INDIVIDUAL (CON SLOT PARA COMPARATIVA) ---
function renderSignoCard(icon, label, valor, unidad, claseCritica, funcionClic, extraHTML = "") {
    let valorFormateado = valor;
    const numVal = parseFloat(valor);
    
    if (!isNaN(numVal)) {
        if (unidad === 'â‚¬') valorFormateado = Math.round(numVal).toLocaleString('es-ES');
        else if (unidad === '%') valorFormateado = numVal.toFixed(1);
        else valorFormateado = numVal.toFixed(0);
    }
    
    return `
    <div class="signo-card ${claseCritica}" onclick="${funcionClic}" style="cursor:pointer; position:relative; z-index:10; transition:transform 0.2s;">
        <div class="signo-icon">${icon}</div>
        <div class="signo-label">${label}</div>
        <div class="signo-value ${claseCritica}">${valorFormateado}${unidad}</div>
        ${extraHTML} 
    </div>`;
}

        function getKpiMetadata(key, valor) {
    const v = parseFloat(valor);
    switch(key) {
        case 'cumplimientoGlobal': return { icon: 'â¤ï¸', label: 'Cumplimiento', unidad: '%', claseCritica: v < 90 ? 'critical' : '', thresholds: { bueno: 90, regular: 70 } };
        case 'conversionCaptacion': return { icon: 'ğŸ¯', label: 'ConversiÃ³n Capt.', unidad: '%', claseCritica: v < 30 ? 'critical' : '', thresholds: { bueno: 30, regular: 20 } };
        case 'ratioCierre': return { icon: 'ğŸ”¥', label: 'Ratio Cierre (GCI/Excl)', unidad: 'â‚¬', claseCritica: v < 2000 ? 'critical' : '', thresholds: { bueno: 3000, regular: 2000 } };
        case 'productividad': return { icon: 'âš¡', label: 'Productividad', unidad: '', claseCritica: v < 1.5 ? 'critical' : '', thresholds: { bueno: 1.5, regular: 1 } };
        case 'ticketPromedio': return { icon: 'ğŸ’°', label: 'Ticket Promedio', unidad: 'â‚¬', claseCritica: v < 2000 ? 'critical' : '', thresholds: { bueno: 3000, regular: 2000 } };
        case 'actividadTotal': return { icon: 'ğŸ“Š', label: 'Actividad Total', unidad: '', claseCritica: '', thresholds: null };
        case 'gci': return { icon: 'ğŸ’µ', label: 'GCI', unidad: 'â‚¬', claseCritica: '', thresholds: null };
        case 'citasCaptacion': return { icon: 'ğŸ“', label: 'Citas CaptaciÃ³n', unidad: '', claseCritica: '', thresholds: null };
        case 'exclusivasVenta': return { icon: 'ğŸ ', label: 'Exclusivas Venta', unidad: '', claseCritica: '', thresholds: null };
        case 'exclusivasComprador': return { icon: 'ğŸ”‘', label: 'Exclusivas Compr.', unidad: '', claseCritica: '', thresholds: null };
        case 'captacionesAbierto': return { icon: 'ğŸ˜ï¸', label: 'Capt. Abierto', unidad: '', claseCritica: '', thresholds: null };
        case 'citasCompradores': return { icon: 'ğŸ‘¥', label: 'Citas Compr.', unidad: '', claseCritica: '', thresholds: null };
        case 'casasEnsenadas': return { icon: 'ğŸ¡', label: 'Casas EnseÃ±adas', unidad: '', claseCritica: '', thresholds: null };
        case 'leadsCompradores': return { icon: 'ğŸ“§', label: 'Leads Compr.', unidad: '', claseCritica: '', thresholds: null };
        case 'llamadas': return { icon: 'ğŸ“', label: 'Llamadas', unidad: '', claseCritica: '', thresholds: null };
        case 'volumenNegocio': return { icon: 'ğŸ’¼', label: 'Volumen Negocio', unidad: 'â‚¬', claseCritica: '', thresholds: null };
        
        // âœ… NUEVOS KPIs
        case 'beneficioNeto': 
    const porcentajeBeneficio = window.datosBeneficioGlobal ? window.datosBeneficioGlobal.porcentajeBeneficio : 0;
    let colorBeneficio = '#ff6b6b'; // Rojo por defecto
    if (porcentajeBeneficio >= 40) colorBeneficio = '#22c55e'; // Verde
    else if (porcentajeBeneficio >= 25) colorBeneficio = '#ffd700'; // Naranja
    
    return { 
        icon: 'ğŸ’°', 
        label: 'Beneficio Neto', 
        unidad: 'â‚¬', 
        claseCritica: porcentajeBeneficio < 25 ? 'critical' : '', 
        thresholds: { bueno: 40, regular: 25 },
        colorCustom: colorBeneficio
    };
        case 'totalTransacciones': 
            return { 
                icon: 'ğŸ“Š', 
                label: 'Transacciones', 
                unidad: '', 
                claseCritica: v < 5 ? 'critical' : '', 
                thresholds: { bueno: 15, regular: 8 } 
            };

case 'captacionesAlquiler':
    return { icon: 'ğŸ¢', label: 'Capt. Alquiler', unidad: '', claseCritica: '', thresholds: null };

case 'leadVendedor':
    return { icon: 'ğŸ“±', label: 'Lead Vendedor', unidad: '', claseCritica: v > 5 ? '' : 'critical', thresholds: { bueno: 5, regular: 2 } };

case 'tresBs':
    return { icon: 'âš¡', label: '3Bs Activadas', unidad: '', claseCritica: v > 3 ? '' : 'critical', thresholds: { bueno: 3, regular: 1 } };

case 'bajadasPrecio':
    return { icon: 'ğŸ’¹', label: 'Bajadas Precio', unidad: '', claseCritica: '', thresholds: { bueno: 2, regular: 1 } };

case 'leadComprador':
    return { icon: 'ğŸ ', label: 'Lead Comprador', unidad: '', claseCritica: v > 5 ? '' : 'critical', thresholds: { bueno: 5, regular: 2 } };

case 'propuestasCompra':
    return { icon: 'ğŸ“„', label: 'Propuestas Compra', unidad: '', claseCritica: v > 3 ? '' : 'critical', thresholds: { bueno: 3, regular: 1 } };

case 'leadSeguimiento':
    return { icon: 'ğŸ¯', label: 'Lead Seguimiento', unidad: '', claseCritica: v > 10 ? '' : 'critical', thresholds: { bueno: 10, regular: 5 } };

case 'arras':
    return { icon: 'âœï¸', label: 'Arras Firmadas', unidad: '', claseCritica: v > 1 ? '' : 'critical', thresholds: { bueno: 1, regular: 0 } };
        
        default: return { icon: 'â“', label: key, unidad: '', claseCritica: '', thresholds: null };
    }
}
        
        function cambiarVistaGerente(vista, element) {
    console.log('ğŸ”„ Cambiando vista a:', vista);
    vistaActualGerente = vista;
    
    // âœ… REMOVER active de TODOS los botones de pestaÃ±as
    document.querySelectorAll('.vista-tabs .tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // âœ… AÃ‘ADIR active solo al elemento clicado
    if (element) {
        element.classList.add('active');
    }
    
    // Control de selecciÃ³n para vista tarjetas
    const selectionControls = document.getElementById('selection-controls');
    if (vista === 'tarjetas') {
        if (selectionControls) selectionControls.style.display = 'flex';
    } else {
        if (selectionControls) selectionControls.style.display = 'none';
    }

    // Renderizar la vista correspondiente
    const contenedor = document.getElementById('vistaContenido');
    
    if (vista === 'mando') {
        // âœ… NUEVO: Centro de Mando
        contenedor.innerHTML = renderizarCentroMando();
        inicializarGraficosMando();
    } else if (vista === 'tarjetas') {
        renderizarTarjetas();
    } else if (vista === 'rankings') {
        renderizarRankings();
    } else if (vista === 'ratios') {
        renderizarTablaRatios();
    } else if (vista === 'transacciones') {
        renderizarRegistroTransacciones();
    } else if (vista === 'embudos') {
        renderizarEmbudos(datosGlobales);
    } else if (vista === 'correlaciones') {
        renderizarCorrelaciones(datosGlobales);
    } else if (vista === 'graficos') {
        renderizarGraficosGenerales();
    } else if (vista === 'origenes') {
        renderizarAnalisisOrigenes();
    }
}
        
        // ===== TARJETAS AGENTE (Mejoradas) =====
        function renderizarTarjetas() {
            const container = document.getElementById('vistaContenido');
            let html = `<div class="agent-card-grid">`;
            datosFiltrados.forEach((agente, i) => {
                const c = agente.cumplimientos;
                const r = agente.realizado;
                const rt = agente.ratios;
                
                const gciF = Math.round(r.gci || 0).toLocaleString('es-ES');
                const cumpF = parseFloat(agente.cumplimientoGlobal).toFixed(1);
                const convF = parseFloat(rt.conversionCaptacion).toFixed(1);
                const ticketF = Math.round(rt.ticketPromedio).toLocaleString('es-ES');
                const exclV = Math.round(r.exclusivasVenta || 0);
                const exclVCump = Math.round(c.exclusivasVenta || 0);
                const citasC = Math.round(r.citasCaptacion || 0);
                const citasCCump = Math.round(c.citasCaptacion || 0);

                html += `
                    <div class="section agent-card ${seleccionMultiAgente ? '' : 'agent-card-clickable'}" style="animation: fadeInUp 0.5s ${i * 30}ms both;">
                        <div class="agent-card-header">
                            <div class="agent-card-header-left">
                                <input type="checkbox" class="agent-card-checkbox" data-agent-id="${agente.id}" style="display: ${seleccionMultiAgente ? 'block' : 'none'};">
                                <div class="agent-name" ${seleccionMultiAgente ? '' : `onclick="mostrarAnalisisDetallado('${agente.id}')"`}>${agente.agente}</div>
                            </div>
                            <div class="agent-actions">
                                <button class="btn-ia-agente" title="Analizar Agente con IA" onclick="analizarAgenteIA(event, '${agente.id}')">âœ¨</button>
                            </div>
                        </div>
                        <div class="agent-card-body" ${seleccionMultiAgente ? '' : `onclick="mostrarAnalisisDetallado('${agente.id}')"`}>
                            <div class="agent-stat-box">
                                <div class="agent-stat-label">GCI</div>
                                <div class="agent-stat-value">${gciF}<span class="unit">â‚¬</span></div>
                            </div>
                            <div class="agent-stat-box">
                                <div class="agent-stat-label">Cumplimiento</div>
                                <div class="agent-stat-value" style="color: ${agente.estadoClase === 'excelente' ? 'var(--color-accent-good)' : agente.estadoClase === 'bueno' ? 'var(--color-accent-warn)' : 'var(--color-accent-bad)'};">${cumpF}<span class="unit">%</span></div>
                            </div>
                            <div class="agent-stat-box">
                                <div class="agent-stat-label">ConversiÃ³n Capt.</div>
                                <div class="agent-stat-value">${convF}<span class="unit">%</span></div>
                            </div>
                            <div class="agent-stat-box">
                                <div class="agent-stat-label">Exclusivas Vta.</div>
                                <div class="agent-stat-value">${exclV} <span style="font-size: 0.6em; opacity: 0.7;">(${exclVCump}%)</span></div>
                            </div>
                            <div class="agent-stat-box">
                                <div class="agent-stat-label">Citas Capt.</div>
                                <div class="agent-stat-value">${citasC} <span style="font-size: 0.6em; opacity: 0.7;">(${citasCCump}%)</span></div>
                            </div>
                            <div class="agent-stat-box">
                                <div class="agent-stat-label">Ticket Promedio</div>
                                <div class="agent-stat-value">${ticketF}<span class="unit">â‚¬</span></div>
                            </div>
                        </div>
                        <div class="agent-card-footer" ${seleccionMultiAgente ? '' : `onclick="mostrarAnalisisDetallado('${agente.id}')"`}>
                            <div class="cumplimiento-bar">
                                <div class="cumplimiento-fill ${agente.estadoClase}" style="width:${Math.min(parseFloat(agente.cumplimientoGlobal), 150)}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function toggleSeleccionMultiAgente(button) {
            seleccionMultiAgente = !seleccionMultiAgente;
            const actionButton = document.getElementById('btn-group-action');
            
            if (seleccionMultiAgente) {
                button.textContent = 'Cancelar SelecciÃ³n';
                button.classList.add('active');
                actionButton.style.display = 'inline-block';
            } else {
                button.textContent = 'Seleccionar Varios';
                button.classList.remove('active');
                actionButton.style.display = 'none';
            }
            renderizarTarjetas();
        }

        function compararGrupoAgentes() {    
    const selectedIds = Array.from(document.querySelectorAll('.agent-card-checkbox:checked')).map(cb => cb.dataset.agentId);
    if (selectedIds.length < 2) {
        mostrarNotificacion("Selecciona al menos 2 agentes para comparar", "error");
        return;
    }
    console.log("Comparando grupo de agentes:", selectedIds);
    
    const agentesAComparar = datosGlobales.filter(d => selectedIds.includes(d.id));
    mostrarAnalisisComparativo(agentesAComparar);
}

function mostrarAnalisisComparativo(agentes) {
    abrirModalEncima('modal-comparativa-agentes');
    const container = document.getElementById('comparativa-content');
    
    container.innerHTML = '<div class="loading"><div class="loader"></div><p>Generando comparativa...</p></div>';
    
    const html = `
        <div class="section-title">âš–ï¸ Comparativa de ${agentes.length} Agentes</div>
        
        <div class="comparativa-grid" style="grid-template-columns: repeat(${Math.min(agentes.length, 3)}, 1fr);">
            ${agentes.map(a => `
                <div class="comparativa-card">
                    <h3 style="text-align:center; color:var(--color-primary); margin-bottom:15px;">${a.agente}</h3>
                    <div style="display:grid; gap:8px;">
                        ${renderComparativaMetrica('ğŸ’° GCI', a.realizado.gci, 'â‚¬')}
                        ${renderComparativaMetrica('ğŸ¤ Transacciones', a.ratios.totalTransacciones, '')}
                        ${renderComparativaMetrica('ğŸ“ Citas Capt.', a.realizado.citasCaptacion, '')}
                        ${renderComparativaMetrica('ğŸ  Exclusivas', a.realizado.exclusivasVenta, '')}
                        ${renderComparativaMetrica('ğŸ“Š Cumplimiento', a.cumplimientoGlobal, '%')}
                    </div>
                </div>
            `).join('')}
        </div>
        
        <div class="charts-grid" style="margin-top:30px;">
            <div class="chart-container" style="grid-column: 1 / -1;">
                <div class="chart-title">ğŸ“Š Comparativa GCI</div>
                <canvas id="chart-comparativa-gci"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">ğŸ“ Actividad de CaptaciÃ³n</div>
                <canvas id="chart-comparativa-captacion"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">ğŸ¡ Actividad de Comprador</div>
                <canvas id="chart-comparativa-comprador"></canvas>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    
    setTimeout(() => {
        crearGraficosComparativos(agentes);
    }, 100);
}

function renderComparativaMetrica(label, valor, unidad) {
    return `
        <div style="display:flex; justify-content:space-between; padding:8px; background:var(--color-surface); border-radius:8px;">
            <span style="color:var(--color-text-faded); font-size:0.9em;">${label}</span>
            <span style="font-weight:700; color:var(--color-text-primary);">${typeof valor === 'number' ? valor.toLocaleString('es-ES', {maximumFractionDigits:1}) : valor}${unidad}</span>
        </div>
    `;
}

function crearGraficosComparativos(agentes) {
    // GrÃ¡fico GCI
    new Chart(document.getElementById('chart-comparativa-gci'), {
        type: 'bar',
        data: {
            labels: agentes.map(a => a.agente),
            datasets: [{
                label: 'GCI',
                data: agentes.map(a => a.realizado.gci),
                backgroundColor: 'rgba(34, 197, 94, 0.8)'
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } }
        }
    });
    
    // GrÃ¡fico CaptaciÃ³n
    new Chart(document.getElementById('chart-comparativa-captacion'), {
        type: 'radar',
        data: {
            labels: ['Citas', 'Exclusivas', 'Abierto'],
            datasets: agentes.map((a, idx) => ({
                label: a.agente,
                data: [a.realizado.citasCaptacion, a.realizado.exclusivasVenta, a.realizado.captacionesAbierto],
                borderColor: `hsl(${idx * 360 / agentes.length}, 70%, 50%)`,
                backgroundColor: `hsla(${idx * 360 / agentes.length}, 70%, 50%, 0.2)`
            }))
        },
        options: { responsive: true }
    });
    
    // GrÃ¡fico Comprador
    new Chart(document.getElementById('chart-comparativa-comprador'), {
        type: 'radar',
        data: {
            labels: ['Citas Comp.', 'Visitas', 'Excl. Comp.'],
            datasets: agentes.map((a, idx) => ({
                label: a.agente,
                data: [a.realizado.citasCompradores, a.realizado.casasEnsenadas, a.realizado.exclusivasComprador],
                borderColor: `hsl(${idx * 360 / agentes.length}, 70%, 50%)`,
                backgroundColor: `hsla(${idx * 360 / agentes.length}, 70%, 50%, 0.2)`
            }))
        },
        options: { responsive: true }
    });
}
        
        // ===== PESTAÃ‘AS GERENTE (CONSTRUIDAS) =====
        
        function renderizarRankings() {
            const container = document.getElementById('vistaContenido');
            const porCumplimiento = [...datosFiltrados].sort((a, b) => parseFloat(b.cumplimientoGlobal) - parseFloat(a.cumplimientoGlobal));
            const porGCI = [...datosFiltrados].sort((a, b) => b.realizado.gci - a.realizado.gci);
            const porConversion = [...datosFiltrados].sort((a, b) => parseFloat(b.ratios.conversionCaptacion) - parseFloat(a.ratios.conversionCaptacion));
            const porCierre = [...datosFiltrados].sort((a, b) => parseFloat(b.ratios.ratioCierre) - parseFloat(a.ratios.ratioCierre));
            const porProductividad = [...datosFiltrados].sort((a, b) => parseFloat(b.ratios.productividad) - parseFloat(a.ratios.productividad));
            const porTicket = [...datosFiltrados].sort((a, b) => parseFloat(b.ratios.ticketPromedio) - parseFloat(a.ratios.ticketPromedio));
            
            let html = `
                <div class="section">
                    <div class="section-title">
                        ğŸ† RANKINGS DEL EQUIPO
                        <div class="top-selector">
                            <button onclick="cambiarTopN(3, 'rankings')" ${topN === 3 ? 'class="active"' : ''}>TOP 3</button>
                            <button onclick="cambiarTopN(5, 'rankings')" ${topN === 5 ? 'class="active"' : ''}>TOP 5</button>
                            <button onclick="cambiarTopN(10, 'rankings')" ${topN === 10 ? 'class="active"' : ''}>TOP 10</button>
                        </div>
                    </div>
                    <div class="comparativa-grid">
                        ${renderizarRanking('ğŸ¯ TOP CUMPLIMIENTO', porCumplimiento, d => d.cumplimientoGlobal + '%', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰')}
                        ${renderizarRanking('ğŸ’° TOP GCI', porGCI, d => Math.round(d.realizado.gci).toLocaleString('es-ES') + 'â‚¬', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰')}
                        ${renderizarRanking('ğŸ“ˆ TOP CONVERSIÃ“N', porConversion, d => d.ratios.conversionCaptacion + '%', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰')}
                        ${renderizarRanking('ğŸ”¥ TOP CIERRE (GCI/Excl)', porCierre, d => Math.round(d.ratios.ratioCierre).toLocaleString('es-ES') + 'â‚¬', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰')}
                        ${renderizarRanking('âš¡ TOP PRODUCTIVIDAD', porProductividad, d => d.ratios.productividad, 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰')}
                        ${renderizarRanking('ğŸ’ TOP TICKET', porTicket, d => Math.round(d.ratios.ticketPromedio).toLocaleString('es-ES') + 'â‚¬', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰')}
                    </div>
                </div>
                `;
            container.innerHTML = html;
        }
        
        function renderizarRanking(titulo, datos, formatValor, medal1, medal2, medal3) {
            const medallas = [medal1, medal2, medal3];
            let html = `
                <div class="comparativa-card">
                    <div class="comparativa-title">${titulo}</div>
                `;
            datos.slice(0, topN).forEach((d, i) => {
                const medalla = i < 3 ? medallas[i] : (i + 1) + '.';
                html += `
                    <div class="ranking-item" onclick="mostrarAnalisisDetallado('${d.id}')">
                        <div class="ranking-item-left">
                            <span class="ranking-item-pos" style="color: ${i === 0 ? '#FFD700' : i === 1 ? '#C0C0C0' : i === 2 ? '#CD7F32' : 'var(--color-text-primary)'};">${medalla}</span>
                            <span class="ranking-item-name">${d.agente}</span>
                        </div>
                        <span class="ranking-item-value">${formatValor(d)}</span>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }
        
        function cambiarTopN(n, vista) {
            topN = n;
            if (vista === 'rankings') renderizarRankings();
        }
        
        function renderizarTablaRatios() {
    const container = document.getElementById('vistaContenido');
    
    if (!datosFiltrados || datosFiltrados.length === 0) {
        container.innerHTML = '<div class="section"><div style="text-align:center; padding:50px; color:#888;">No hay datos disponibles</div></div>';
        return;
    }
    
    // Ordenar por cumplimiento
    const agentesOrdenados = [...datosFiltrados].sort((a, b) => parseFloat(b.cumplimientoGlobal) - parseFloat(a.cumplimientoGlobal));
    
    // Benchmarks de referencia
    const benchmarks = {
        citaAExclusiva: 65,
        citaAAbierto: 90,
        propiedadesXComprador: 7,
        compradoresXVenta: 12,
        propiedadesXVenta: 12,
        tresBsActivadas: 135,
        bajadasPrecio: 80,
        exclusivaAVenta: 90,
        abiertoAVenta: 20,
        alquileresCerrados: 90
    };
    
    // Calcular ratios del equipo
    const calcularRatioEquipo = (numeradorKey, denominadorKey, multiplicador = 100) => {
        let sumNum = 0, sumDen = 0;
        datosFiltrados.forEach(a => {
            const r = a.realizado || {};
            sumNum += parseFloat(r[numeradorKey]) || 0;
            sumDen += parseFloat(r[denominadorKey]) || 0;
        });
        return sumDen > 0 ? ((sumNum / sumDen) * multiplicador).toFixed(1) : 0;
    };
    
    const calcularSumaEquipo = (key) => {
        return datosFiltrados.reduce((sum, a) => sum + (parseFloat(a.realizado?.[key]) || 0), 0);
    };
    
    // Ratios del equipo
    const equipoRatios = {
        citaAExclusiva: calcularRatioEquipo('exclusivasVenta', 'citasCaptacion'),
        citaAAbierto: calcularRatioEquipo('captacionesAbierto', 'citasCaptacion'),
        propiedadesXComprador: (calcularSumaEquipo('casasEnsenadas') / Math.max(calcularSumaEquipo('citasCompradores'), 1)).toFixed(1),
        compradoresXVenta: (calcularSumaEquipo('citasCompradores') / Math.max(calcularSumaEquipo('arras'), 1)).toFixed(1),
        propiedadesXVenta: (calcularSumaEquipo('casasEnsenadas') / Math.max(calcularSumaEquipo('arras'), 1)).toFixed(1),
        tresBsActivadas: calcularRatioEquipo('tresBs', 'exclusivasVenta'),
        bajadasPrecio: calcularRatioEquipo('bajadasPrecio', 'exclusivasVenta'),
        exclusivaAVenta: calcularRatioEquipo('arras', 'exclusivasVenta'),
        propuestasXVenta: (calcularSumaEquipo('propuestasCompra') / Math.max(calcularSumaEquipo('arras'), 1)).toFixed(1),
        gci: calcularSumaEquipo('gci'),
        exclusivas: calcularSumaEquipo('exclusivasVenta'),
        abierto: calcularSumaEquipo('captacionesAbierto'),
        ventas: calcularSumaEquipo('arras')
    };
    
    // FunciÃ³n para color segÃºn benchmark
    const getColorBenchmark = (valor, benchmark, inverso = false) => {
        const v = parseFloat(valor) || 0;
        const pct = (v / benchmark) * 100;
        if (inverso) {
            return pct <= 100 ? '#22c55e' : pct <= 130 ? '#ffd700' : '#ff4444';
        }
        return pct >= 100 ? '#22c55e' : pct >= 70 ? '#ffd700' : '#ff4444';
    };
    
    const getIconoBenchmark = (valor, benchmark, inverso = false) => {
        const v = parseFloat(valor) || 0;
        const pct = (v / benchmark) * 100;
        if (inverso) {
            return pct <= 100 ? 'ğŸ”¥' : pct <= 130 ? 'âœ…' : 'âš ï¸';
        }
        return pct >= 100 ? 'ğŸ”¥' : pct >= 70 ? 'âœ…' : 'âš ï¸';
    };

    let html = `
        <div class="section-title">ğŸ“Š AnÃ¡lisis Completo de Ratios del Equipo</div>
        
        <!-- TABS DE CATEGORÃAS -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <button class="btn btn-primary-action" onclick="mostrarSeccionRatios('conversion')" id="tab-conversion">ğŸ“ ConversiÃ³n</button>
            <button class="btn" onclick="mostrarSeccionRatios('productividad')" id="tab-productividad">âš¡ Productividad</button>
            <button class="btn" onclick="mostrarSeccionRatios('cierre')" id="tab-cierre">ğŸ’° Cierre</button>
            <button class="btn" onclick="mostrarSeccionRatios('comisiones')" id="tab-comisiones">ğŸ’µ Comisiones</button>
            <button class="btn" onclick="mostrarSeccionRatios('todos')" id="tab-todos">ğŸ“‹ Ver Todo</button>
        </div>
        
        <!-- RESUMEN EQUIPO -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px;">
            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.2), rgba(102,126,234,0.05)); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid rgba(102,126,234,0.3);">
                <div style="font-size: 0.8em; color: #888;">ğŸ“ Cita â†’ Exclusiva</div>
                <div style="font-size: 2em; font-weight: 900; color: ${getColorBenchmark(equipoRatios.citaAExclusiva, benchmarks.citaAExclusiva)};">${equipoRatios.citaAExclusiva}%</div>
                <div style="font-size: 0.75em; color: #888;">Objetivo: ${benchmarks.citaAExclusiva}%</div>
            </div>
            <div style="background: linear-gradient(135deg, rgba(34,197,94,0.2), rgba(34,197,94,0.05)); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid rgba(34,197,94,0.3);">
                <div style="font-size: 0.8em; color: #888;">ğŸ  Exclusiva â†’ Venta</div>
                <div style="font-size: 2em; font-weight: 900; color: ${getColorBenchmark(equipoRatios.exclusivaAVenta, benchmarks.exclusivaAVenta)};">${equipoRatios.exclusivaAVenta}%</div>
                <div style="font-size: 0.75em; color: #888;">Objetivo: ${benchmarks.exclusivaAVenta}%</div>
            </div>
            <div style="background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,215,0,0.05)); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,215,0,0.3);">
                <div style="font-size: 0.8em; color: #888;">ğŸ…±ï¸ 3Bs Activadas</div>
                <div style="font-size: 2em; font-weight: 900; color: ${getColorBenchmark(equipoRatios.tresBsActivadas, benchmarks.tresBsActivadas)};">${equipoRatios.tresBsActivadas}%</div>
                <div style="font-size: 0.75em; color: #888;">Objetivo: ${benchmarks.tresBsActivadas}%</div>
            </div>
            <div style="background: linear-gradient(135deg, rgba(0,196,255,0.2), rgba(0,196,255,0.05)); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid rgba(0,196,255,0.3);">
                <div style="font-size: 0.8em; color: #888;">ğŸ¡ Propiedades/Venta</div>
                <div style="font-size: 2em; font-weight: 900; color: ${getColorBenchmark(equipoRatios.propiedadesXVenta, benchmarks.propiedadesXVenta, true)};">${equipoRatios.propiedadesXVenta}</div>
                <div style="font-size: 0.75em; color: #888;">Objetivo: â‰¤${benchmarks.propiedadesXVenta}</div>
            </div>
            <div style="background: linear-gradient(135deg, rgba(156,39,176,0.2), rgba(156,39,176,0.05)); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid rgba(156,39,176,0.3);">
                <div style="font-size: 0.8em; color: #888;">ğŸ‘¥ Compradores/Venta</div>
                <div style="font-size: 2em; font-weight: 900; color: ${getColorBenchmark(equipoRatios.compradoresXVenta, benchmarks.compradoresXVenta, true)};">${equipoRatios.compradoresXVenta}</div>
                <div style="font-size: 0.75em; color: #888;">Objetivo: â‰¤${benchmarks.compradoresXVenta}</div>
            </div>
        </div>
        
        <!-- LEYENDA -->
        <div style="display: flex; gap: 20px; margin-bottom: 15px; font-size: 0.8em; color: #888; flex-wrap: wrap; background: var(--color-surface); padding: 10px 15px; border-radius: 8px;">
            <span>ğŸ”¥ <span style="color:#22c55e;">Supera objetivo</span></span>
            <span>âœ… <span style="color:#ffd700;">Cerca del objetivo (â‰¥70%)</span></span>
            <span>âš ï¸ <span style="color:#ff4444;">Por debajo del objetivo</span></span>
            <span style="margin-left: auto; font-style: italic;">Click en fila para ver detalle del agente</span>
        </div>
        
        <!-- SECCIÃ“N CONVERSIÃ“N -->
        <div id="seccion-conversion" class="seccion-ratios">
            <div style="font-size: 1.1em; font-weight: 700; margin: 20px 0 15px; color: #667eea;">ğŸ“ RATIOS DE CONVERSIÃ“N</div>
            <div class="tabla-container" style="overflow-x: auto; margin-bottom: 25px;">
                <table class="tabla" style="min-width: 900px;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, rgba(102,126,234,0.3), rgba(102,126,234,0.1));">
                            <th style="position: sticky; left: 0; background: var(--color-surface); z-index: 10; min-width: 150px;">#  AGENTE</th>
                            <th style="text-align: center;">
                                <div>Citaâ†’Excl</div>
                                <div style="font-size: 0.7em; color: #888;">Obj: ${benchmarks.citaAExclusiva}%</div>
                            </th>
                            <th style="text-align: center;">
                                <div>Citaâ†’Abierto</div>
                                <div style="font-size: 0.7em; color: #888;">Obj: ${benchmarks.citaAAbierto}%</div>
                            </th>
                            <th style="text-align: center;">
                                <div>Exclâ†’Venta</div>
                                <div style="font-size: 0.7em; color: #888;">Obj: ${benchmarks.exclusivaAVenta}%</div>
                            </th>
                            <th style="text-align: center;">
                                <div>Abiertoâ†’Venta</div>
                                <div style="font-size: 0.7em; color: #888;">Obj: ${benchmarks.abiertoAVenta}%</div>
                            </th>
                            <th style="text-align: center;">
                                <div>Alquiler Cerrado</div>
                                <div style="font-size: 0.7em; color: #888;">Obj: ${benchmarks.alquileresCerrados}%</div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        ${generarFilasConversion(agentesOrdenados, benchmarks)}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- SECCIÃ“N PRODUCTIVIDAD -->
        <div id="seccion-productividad" class="seccion-ratios" style="display: none;">
            <div style="font-size: 1.1em; font-weight: 700; margin: 20px 0 15px; color: #22c55e;">âš¡ RATIOS DE PRODUCTIVIDAD</div>
            <div class="tabla-container" style="overflow-x: auto; margin-bottom: 25px;">
                <table class="tabla" style="min-width: 900px;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, rgba(34,197,94,0.3), rgba(34,197,94,0.1));">
                            <th style="position: sticky; left: 0; background: var(--color-surface); z-index: 10; min-width: 150px;">#  AGENTE</th>
                            <th style="text-align: center;">
                                <div>Propiedades/Comprador</div>
                                <div style="font-size: 0.7em; color: #888;">Obj: â‰¤${benchmarks.propiedadesXComprador}</div>
                            </th>
                            <th style="text-align: center;">
                                <div>Compradores/Venta</div>
                                <div style="font-size: 0.7em; color: #888;">Obj: â‰¤${benchmarks.compradoresXVenta}</div>
                            </th>
                            <th style="text-align: center;">
                                <div>Propiedades/Venta</div>
                                <div style="font-size: 0.7em; color: #888;">Obj: â‰¤${benchmarks.propiedadesXVenta}</div>
                            </th>
                            <th style="text-align: center;">
                                <div>Propuestas/Venta</div>
                                <div style="font-size: 0.7em; color: #888;">Eficiencia</div>
                            </th>
                            <th style="text-align: center;">
                                <div>Actividad Total</div>
                                <div style="font-size: 0.7em; color: #888;">Volumen</div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        ${generarFilasProductividad(agentesOrdenados, benchmarks)}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- SECCIÃ“N CIERRE -->
        <div id="seccion-cierre" class="seccion-ratios" style="display: none;">
            <div style="font-size: 1.1em; font-weight: 700; margin: 20px 0 15px; color: #ffd700;">ğŸ’° RATIOS DE CIERRE Y ACTIVACIÃ“N</div>
            <div class="tabla-container" style="overflow-x: auto; margin-bottom: 25px;">
                <table class="tabla" style="min-width: 900px;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, rgba(255,215,0,0.3), rgba(255,215,0,0.1));">
                            <th style="position: sticky; left: 0; background: var(--color-surface); z-index: 10; min-width: 150px;">#  AGENTE</th>
                            <th style="text-align: center;">
                                <div>3Bs Activadas</div>
                                <div style="font-size: 0.7em; color: #888;">Obj: ${benchmarks.tresBsActivadas}%</div>
                            </th>
                            <th style="text-align: center;">
                                <div>Bajadas Precio</div>
                                <div style="font-size: 0.7em; color: #888;">Obj: ${benchmarks.bajadasPrecio}%</div>
                            </th>
                            <th style="text-align: center;">
                                <div>Leadâ†’Seguimiento</div>
                                <div style="font-size: 0.7em; color: #888;">ConversiÃ³n</div>
                            </th>
                            <th style="text-align: center;">
                                <div>Arras Firmadas</div>
                                <div style="font-size: 0.7em; color: #888;">Cierres</div>
                            </th>
                            <th style="text-align: center;">
                                <div>% Cumplimiento</div>
                                <div style="font-size: 0.7em; color: #888;">Global</div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        ${generarFilasCierre(agentesOrdenados, benchmarks)}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- SECCIÃ“N COMISIONES -->
        <div id="seccion-comisiones" class="seccion-ratios" style="display: none;">
            <div style="font-size: 1.1em; font-weight: 700; margin: 20px 0 15px; color: #00c4ff;">ğŸ’µ COMISIONES MEDIAS POR TIPO</div>
            <div class="tabla-container" style="overflow-x: auto; margin-bottom: 25px;">
                <table class="tabla" style="min-width: 900px;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, rgba(0,196,255,0.3), rgba(0,196,255,0.1));">
                            <th style="position: sticky; left: 0; background: var(--color-surface); z-index: 10; min-width: 150px;">#  AGENTE</th>
                            <th style="text-align: center;">
                                <div>GCI Total</div>
                                <div style="font-size: 0.7em; color: #888;">Acumulado</div>
                            </th>
                            <th style="text-align: center;">
                                <div>ComisiÃ³n Media</div>
                                <div style="font-size: 0.7em; color: #888;">GCI/TransacciÃ³n</div>
                            </th>
                            <th style="text-align: center;">
                                <div>GCI/Exclusiva</div>
                                <div style="font-size: 0.7em; color: #888;">Rentabilidad</div>
                            </th>
                            <th style="text-align: center;">
                                <div>Volumen Negocio</div>
                                <div style="font-size: 0.7em; color: #888;">Total</div>
                            </th>
                            <th style="text-align: center;">
                                <div>Ticket Medio</div>
                                <div style="font-size: 0.7em; color: #888;">Vol/TransacciÃ³n</div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        ${generarFilasComisiones(agentesOrdenados)}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- BENCHMARKS DE REFERENCIA -->
        <div style="margin-top: 25px; background: var(--color-surface); padding: 20px; border-radius: 12px; border: 1px solid var(--color-border);">
            <div style="font-weight: 700; margin-bottom: 15px;">ğŸ“Œ Benchmarks KW EspaÃ±a - Objetivos de Referencia</div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; font-size: 0.85em;">
                <div>
                    <div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">ğŸ“ ConversiÃ³n</div>
                    <div>â€¢ Cita CaptaciÃ³n â†’ Exclusiva: <strong>${benchmarks.citaAExclusiva}%</strong></div>
                    <div>â€¢ Cita CaptaciÃ³n â†’ Abierto: <strong>${benchmarks.citaAAbierto}%</strong></div>
                    <div>â€¢ Exclusiva â†’ Venta: <strong>${benchmarks.exclusivaAVenta}%</strong></div>
                    <div>â€¢ Abierto â†’ Venta: <strong>${benchmarks.abiertoAVenta}%</strong></div>
                </div>
                <div>
                    <div style="font-weight: 600; color: #22c55e; margin-bottom: 8px;">âš¡ Productividad</div>
                    <div>â€¢ Propiedades por Comprador: <strong>â‰¤${benchmarks.propiedadesXComprador}</strong></div>
                    <div>â€¢ Compradores por Venta: <strong>â‰¤${benchmarks.compradoresXVenta}</strong></div>
                    <div>â€¢ Propiedades por Venta: <strong>â‰¤${benchmarks.propiedadesXVenta}</strong></div>
                </div>
                <div>
                    <div style="font-weight: 600; color: #ffd700; margin-bottom: 8px;">ğŸ’° ActivaciÃ³n</div>
                    <div>â€¢ 3Bs Activadas: <strong>${benchmarks.tresBsActivadas}%</strong> (sobre exclusivas)</div>
                    <div>â€¢ Bajadas de Precio: <strong>${benchmarks.bajadasPrecio}%</strong> (sobre exclusivas)</div>
                    <div>â€¢ Alquileres Cerrados: <strong>${benchmarks.alquileresCerrados}%</strong></div>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

// FunciÃ³n para cambiar secciones
function mostrarSeccionRatios(seccion) {
    // Ocultar todas las secciones
    document.querySelectorAll('.seccion-ratios').forEach(s => s.style.display = 'none');
    
    // Quitar clase activa de tabs
    document.querySelectorAll('[id^="tab-"]').forEach(t => t.classList.remove('btn-primary-action'));
    
    if (seccion === 'todos') {
        document.querySelectorAll('.seccion-ratios').forEach(s => s.style.display = 'block');
        document.getElementById('tab-todos').classList.add('btn-primary-action');
    } else {
        document.getElementById('seccion-' + seccion).style.display = 'block';
        document.getElementById('tab-' + seccion).classList.add('btn-primary-action');
    }
}

// Generadores de filas
function generarFilasConversion(agentes, benchmarks) {
    return agentes.map((a, idx) => {
        const r = a.realizado || {};
        const posicion = idx + 1;
        const medalla = posicion === 1 ? 'ğŸ¥‡' : posicion === 2 ? 'ğŸ¥ˆ' : posicion === 3 ? 'ğŸ¥‰' : posicion;
        
        const citaExcl = r.citasCaptacion > 0 ? ((r.exclusivasVenta / r.citasCaptacion) * 100).toFixed(1) : 0;
        const citaAbierto = r.citasCaptacion > 0 ? ((r.captacionesAbierto / r.citasCaptacion) * 100).toFixed(1) : 0;
        const exclVenta = r.exclusivasVenta > 0 ? ((r.arras / r.exclusivasVenta) * 100).toFixed(1) : 0;
        const abiertoVenta = r.captacionesAbierto > 0 ? (((r.arras || 0) / r.captacionesAbierto) * 100).toFixed(1) : 0;
        const alquilerCerrado = r.captacionesAlquiler > 0 ? 90 : 0; // Placeholder
        
        const getColor = (v, b) => parseFloat(v) >= b ? '#22c55e' : parseFloat(v) >= b * 0.7 ? '#ffd700' : '#ff4444';
        
        return `
            <tr onclick="mostrarAnalisisDetallado('${a.id}')" style="cursor: pointer;" onmouseover="this.style.background='rgba(102,126,234,0.1)'" onmouseout="this.style.background=''">
                <td style="position: sticky; left: 0; background: var(--color-surface); z-index: 5;">
                    <span style="font-size: 1.1em; margin-right: 8px;">${medalla}</span>
                    <strong>${a.agente}</strong>
                </td>
                <td style="text-align: center; color: ${getColor(citaExcl, benchmarks.citaAExclusiva)}; font-weight: 700;">${citaExcl}%</td>
                <td style="text-align: center; color: ${getColor(citaAbierto, benchmarks.citaAAbierto)}; font-weight: 700;">${citaAbierto}%</td>
                <td style="text-align: center; color: ${getColor(exclVenta, benchmarks.exclusivaAVenta)}; font-weight: 700;">${exclVenta}%</td>
                <td style="text-align: center; color: ${getColor(abiertoVenta, benchmarks.abiertoAVenta)}; font-weight: 700;">${abiertoVenta}%</td>
                <td style="text-align: center; color: #888;">${alquilerCerrado}%</td>
            </tr>
        `;
    }).join('');
}

function generarFilasProductividad(agentes, benchmarks) {
    return agentes.map((a, idx) => {
        const r = a.realizado || {};
        const posicion = idx + 1;
        const medalla = posicion === 1 ? 'ğŸ¥‡' : posicion === 2 ? 'ğŸ¥ˆ' : posicion === 3 ? 'ğŸ¥‰' : posicion;
        
        const propXComp = r.citasCompradores > 0 ? (r.casasEnsenadas / r.citasCompradores).toFixed(1) : 0;
        const compXVenta = r.arras > 0 ? (r.citasCompradores / r.arras).toFixed(1) : 0;
        const propXVenta = r.arras > 0 ? (r.casasEnsenadas / r.arras).toFixed(1) : 0;
        const propuestasXVenta = r.arras > 0 ? (r.propuestasCompra / r.arras).toFixed(1) : 0;
        const actividad = (r.citasCaptacion || 0) + (r.citasCompradores || 0) + (r.llamadas || 0);
        
        // Para productividad, menor es mejor
        const getColorInv = (v, b) => parseFloat(v) <= b ? '#22c55e' : parseFloat(v) <= b * 1.3 ? '#ffd700' : '#ff4444';
        
        return `
            <tr onclick="mostrarAnalisisDetallado('${a.id}')" style="cursor: pointer;" onmouseover="this.style.background='rgba(34,197,94,0.1)'" onmouseout="this.style.background=''">
                <td style="position: sticky; left: 0; background: var(--color-surface); z-index: 5;">
                    <span style="font-size: 1.1em; margin-right: 8px;">${medalla}</span>
                    <strong>${a.agente}</strong>
                </td>
                <td style="text-align: center; color: ${getColorInv(propXComp, benchmarks.propiedadesXComprador)}; font-weight: 700;">${propXComp}</td>
                <td style="text-align: center; color: ${getColorInv(compXVenta, benchmarks.compradoresXVenta)}; font-weight: 700;">${compXVenta}</td>
                <td style="text-align: center; color: ${getColorInv(propXVenta, benchmarks.propiedadesXVenta)}; font-weight: 700;">${propXVenta}</td>
                <td style="text-align: center; font-weight: 700;">${propuestasXVenta}</td>
                <td style="text-align: center; color: #00c4ff; font-weight: 700;">${actividad}</td>
            </tr>
        `;
    }).join('');
}

function generarFilasCierre(agentes, benchmarks) {
    return agentes.map((a, idx) => {
        const r = a.realizado || {};
        const posicion = idx + 1;
        const medalla = posicion === 1 ? 'ğŸ¥‡' : posicion === 2 ? 'ğŸ¥ˆ' : posicion === 3 ? 'ğŸ¥‰' : posicion;
        
        const tresBs = r.exclusivasVenta > 0 ? ((r.tresBs / r.exclusivasVenta) * 100).toFixed(1) : 0;
        const bajadas = r.exclusivasVenta > 0 ? ((r.bajadasPrecio / r.exclusivasVenta) * 100).toFixed(1) : 0;
        const leadSeg = r.leadVendedor > 0 ? ((r.leadSeguimiento / r.leadVendedor) * 100).toFixed(1) : 0;
        
        const getColor = (v, b) => parseFloat(v) >= b ? '#22c55e' : parseFloat(v) >= b * 0.7 ? '#ffd700' : '#ff4444';
        const colorCumpl = parseFloat(a.cumplimientoGlobal) >= 90 ? '#22c55e' : parseFloat(a.cumplimientoGlobal) >= 70 ? '#ffd700' : '#ff4444';
        
        return `
            <tr onclick="mostrarAnalisisDetallado('${a.id}')" style="cursor: pointer;" onmouseover="this.style.background='rgba(255,215,0,0.1)'" onmouseout="this.style.background=''">
                <td style="position: sticky; left: 0; background: var(--color-surface); z-index: 5;">
                    <span style="font-size: 1.1em; margin-right: 8px;">${medalla}</span>
                    <strong>${a.agente}</strong>
                </td>
                <td style="text-align: center; color: ${getColor(tresBs, benchmarks.tresBsActivadas)}; font-weight: 700;">${tresBs}%</td>
                <td style="text-align: center; color: ${getColor(bajadas, benchmarks.bajadasPrecio)}; font-weight: 700;">${bajadas}%</td>
                <td style="text-align: center; font-weight: 700;">${leadSeg}%</td>
                <td style="text-align: center; font-weight: 700; color: #22c55e;">${r.arras || 0}</td>
                <td style="text-align: center; font-weight: 900; font-size: 1.2em; color: ${colorCumpl};">${a.cumplimientoGlobal}%</td>
            </tr>
        `;
    }).join('');
}

function generarFilasComisiones(agentes) {
    return agentes.map((a, idx) => {
        const r = a.realizado || {};
        const posicion = idx + 1;
        const medalla = posicion === 1 ? 'ğŸ¥‡' : posicion === 2 ? 'ğŸ¥ˆ' : posicion === 3 ? 'ğŸ¥‰' : posicion;
        
        const gci = r.gci || 0;
        const ventas = r.arras || 0;
        const exclusivas = r.exclusivasVenta || 0;
        const volumen = r.volumenNegocio || 0;
        
        const comisionMedia = ventas > 0 ? (gci / ventas).toFixed(0) : 0;
        const gciExcl = exclusivas > 0 ? (gci / exclusivas).toFixed(0) : 0;
        const ticketMedio = ventas > 0 ? (volumen / ventas).toFixed(0) : 0;
        
        return `
            <tr onclick="mostrarAnalisisDetallado('${a.id}')" style="cursor: pointer;" onmouseover="this.style.background='rgba(0,196,255,0.1)'" onmouseout="this.style.background=''">
                <td style="position: sticky; left: 0; background: var(--color-surface); z-index: 5;">
                    <span style="font-size: 1.1em; margin-right: 8px;">${medalla}</span>
                    <strong>${a.agente}</strong>
                </td>
                <td style="text-align: center; color: #22c55e; font-weight: 700;">${gci.toLocaleString('es-ES')}â‚¬</td>
                <td style="text-align: center; font-weight: 700;">${parseInt(comisionMedia).toLocaleString('es-ES')}â‚¬</td>
                <td style="text-align: center; font-weight: 700;">${parseInt(gciExcl).toLocaleString('es-ES')}â‚¬</td>
                <td style="text-align: center; color: #00c4ff; font-weight: 700;">${volumen.toLocaleString('es-ES')}â‚¬</td>
                <td style="text-align: center; font-weight: 700;">${parseInt(ticketMedio).toLocaleString('es-ES')}â‚¬</td>
            </tr>
        `;
    }).join('');
}
        
        // Variable global para el filtro de mes
let filtroMesTransacciones = 'todos';

// Variables globales para filtros
let filtroMesTx = 'todos';
let filtroAgenteTx = 'todos';

function renderizarRegistroTransacciones() {
    const container = document.getElementById('vistaContenido');
    
    container.innerHTML = '<div class="loading"><div class="loader"></div><div>Cargando transacciones...</div></div>';
    
    const filtros = calcularFiltrosPeriodo(periodoActual, 'gerente');
    
    google.script.run
        .withSuccessHandler(function(resultado) {
            if (!resultado.success) {
                container.innerHTML = '<div class="section"><div style="text-align:center; padding:50px; color:#ff6b6b;">âŒ Error al cargar transacciones</div></div>';
                return;
            }
            
            const transacciones = resultado.transacciones || [];
            window.transaccionesGlobales = transacciones;
            
            // Selectores
            const agentesUnicos = [...new Set(transacciones.map(t => t.agente))].sort();
            const tiposUnicos = [...new Set(transacciones.map(t => t.tipo))].sort();
            const ladosUnicos = [...new Set(transacciones.map(t => t.lado))].sort();
            
            let optAgente = `<option value="todos">ğŸ‘¤ Todos</option>`;
            agentesUnicos.forEach(a => optAgente += `<option value="${a}" ${window.filtroAgenteTx == a ? 'selected' : ''}>${a}</option>`);
            
            let optTipo = `<option value="todos">ğŸ“‹ Todos</option>`;
            tiposUnicos.forEach(t => optTipo += `<option value="${t}" ${window.filtroTipoTx == t ? 'selected' : ''}>${t}</option>`);
            
            let optLado = `<option value="todos">ğŸ”„ Todos</option>`;
            ladosUnicos.forEach(l => optLado += `<option value="${l}" ${window.filtroLadoTx == l ? 'selected' : ''}>${l}</option>`);
            
            // Filtrado
            let datos = transacciones;
            
            if (window.filtroAgenteTx && window.filtroAgenteTx !== 'todos') {
                datos = datos.filter(t => t.agente === window.filtroAgenteTx);
            }
            if (window.filtroTipoTx && window.filtroTipoTx !== 'todos') {
                datos = datos.filter(t => t.tipo === window.filtroTipoTx);
            }
            if (window.filtroLadoTx && window.filtroLadoTx !== 'todos') {
                datos = datos.filter(t => t.lado === window.filtroLadoTx);
            }
            if (window.filtroFechaInicioTx) {
                const fechaInicio = new Date(window.filtroFechaInicioTx);
                datos = datos.filter(t => parsearFecha(t.fecha) >= fechaInicio);
            }
            if (window.filtroFechaFinTx) {
                const fechaFin = new Date(window.filtroFechaFinTx);
                datos = datos.filter(t => parsearFecha(t.fecha) <= fechaFin);
            }
            
            // EstadÃ­sticas
const totalGCI = datos.reduce((s, t) => s + (t.gci || 0), 0);
const totalVolumen = datos.reduce((s, t) => s + (t.volumenNegocio || 0), 0);
const totalComis = datos.reduce((s, t) => s + (t.comision || 0), 0);
const transaccionesActivas = datos.filter(t => !t.descripcion.includes('[ANULADA]'));

// âœ… NUEVO: Calcular % Descuento promedio
let sumaDescuentos = 0;
let countDescuentos = 0;
datos.forEach(t => {
    const pCapt = parseFloat(t.precioCaptacion) || 0;
    const pVenta = parseFloat(t.volumenNegocio) || 0;
    if (pCapt > 0 && pVenta > 0) {
        sumaDescuentos += ((pCapt - pVenta) / pCapt) * 100;
        countDescuentos++;
    }
});
const pctDescuentoMedio = countDescuentos > 0 ? (sumaDescuentos / countDescuentos) : 0;
const colorDescuento = pctDescuentoMedio <= 5 ? '#22c55e' : (pctDescuentoMedio <= 10 ? '#ffc107' : '#ef4444');
            
            // EstadÃ­sticas por tipo
            const statsPorTipo = {};
            datos.forEach(t => {
                if (!statsPorTipo[t.tipo]) statsPorTipo[t.tipo] = { count: 0, gci: 0, volumen: 0 };
                statsPorTipo[t.tipo].count++;
                statsPorTipo[t.tipo].gci += t.gci || 0;
                statsPorTipo[t.tipo].volumen += t.volumenNegocio || 0;
            });
            
            // EstadÃ­sticas por agente (top 5)
            const statsPorAgente = {};
            datos.forEach(t => {
                if (!statsPorAgente[t.agente]) statsPorAgente[t.agente] = { count: 0, gci: 0 };
                statsPorAgente[t.agente].count++;
                statsPorAgente[t.agente].gci += t.gci || 0;
            });
            const topAgentes = Object.entries(statsPorAgente)
                .sort((a, b) => b[1].gci - a[1].gci)
                .slice(0, 5);
            
            // EstadÃ­sticas mensuales
            const statsPorMes = {};
            datos.forEach(t => {
                const fecha = parsearFecha(t.fecha);
                if (fecha) {
                    const mes = fecha.getMonth();
                    if (!statsPorMes[mes]) statsPorMes[mes] = { count: 0, gci: 0 };
                    statsPorMes[mes].count++;
                    statsPorMes[mes].gci += t.gci || 0;
                }
            });
            
            const nombresMeses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];

            let html = `
                <div class="section-title">ğŸ“‹ Registro de Transacciones</div>
                
                <!-- DASHBOARD RÃPIDO -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, rgba(34,197,94,0.2), rgba(34,197,94,0.05)); padding: 20px; border-radius: 15px; text-align: center; border: 1px solid rgba(34,197,94,0.3);">
                        <div style="font-size: 0.85em; color: #888;">ğŸ’° GCI Total</div>
                        <div style="font-size: 2.2em; font-weight: 900; color: #22c55e;">${totalGCI.toLocaleString('es-ES')}â‚¬</div>
                        <div style="font-size: 0.8em; color: #888;">${transaccionesActivas.length} transacciones</div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(0,196,255,0.2), rgba(0,196,255,0.05)); padding: 20px; border-radius: 15px; text-align: center; border: 1px solid rgba(0,196,255,0.3);">
                        <div style="font-size: 0.85em; color: #888;">ğŸ’¼ Volumen Total</div>
                        <div style="font-size: 2.2em; font-weight: 900; color: #00c4ff;">${(totalVolumen / 1000000).toFixed(2)}Mâ‚¬</div>
                        <div style="font-size: 0.8em; color: #888;">Valor inmuebles</div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,215,0,0.05)); padding: 20px; border-radius: 15px; text-align: center; border: 1px solid rgba(255,215,0,0.3);">
                        <div style="font-size: 0.85em; color: #888;">ğŸ¯ Ticket Medio</div>
                        <div style="font-size: 2.2em; font-weight: 900; color: #ffd700;">${transaccionesActivas.length > 0 ? Math.round(totalGCI / transaccionesActivas.length).toLocaleString('es-ES') : 0}â‚¬</div>
                        <div style="font-size: 0.8em; color: #888;">GCI por operaciÃ³n</div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(156,39,176,0.2), rgba(156,39,176,0.05)); padding: 20px; border-radius: 15px; text-align: center; border: 1px solid rgba(156,39,176,0.3);">
                        <div style="font-size: 0.85em; color: #888;">ğŸ“Š % ComisiÃ³n</div>
                        <div style="font-size: 2.2em; font-weight: 900; color: #9c27b0;">${totalVolumen > 0 ? ((totalGCI / totalVolumen) * 100).toFixed(2) : 0}%</div>
                        <div style="font-size: 0.8em; color: #888;">ComisiÃ³n media</div>
                    </div>
                </div>
                <div style="background: linear-gradient(135deg, rgba(239,68,68,0.2), rgba(239,68,68,0.05)); padding: 20px; border-radius: 15px; text-align: center; border: 1px solid rgba(239,68,68,0.3);">
    <div style="font-size: 0.85em; color: #888;">ğŸ“‰ % Dto. Medio</div>
    <div style="font-size: 2.2em; font-weight: 900; color: ${colorDescuento};">${pctDescuentoMedio.toFixed(1)}%</div>
    <div style="font-size: 0.8em; color: #888;">${countDescuentos} con P.Capt</div>
</div>
                
                <!-- GRÃFICOS RÃPIDOS -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px;">
                    
                    <!-- Por Tipo -->
                    <div style="background: var(--color-surface); padding: 20px; border-radius: 12px; border: 1px solid var(--color-border);">
                        <div style="font-weight: 700; margin-bottom: 15px;">ğŸ“Š Por Tipo de OperaciÃ³n</div>
                        ${Object.entries(statsPorTipo).map(([tipo, stats]) => {
                            const pct = totalGCI > 0 ? (stats.gci / totalGCI * 100).toFixed(1) : 0;
                            const colores = {
                                'Venta': '#22c55e',
                                'Compra': '#00c4ff',
                                'Alquiler': '#ffd700',
                                'Referido': '#9c27b0'
                            };
                            const color = colores[tipo] || '#667eea';
                            return `
                                <div style="margin-bottom: 10px;">
                                    <div style="display: flex; justify-content: space-between; font-size: 0.85em; margin-bottom: 4px;">
                                        <span>${tipo} (${stats.count})</span>
                                        <span style="font-weight: 700; color: ${color};">${stats.gci.toLocaleString('es-ES')}â‚¬</span>
                                    </div>
                                    <div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                                        <div style="width: ${pct}%; height: 100%; background: ${color}; border-radius: 4px;"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Top Agentes -->
                    <div style="background: var(--color-surface); padding: 20px; border-radius: 12px; border: 1px solid var(--color-border);">
                        <div style="font-weight: 700; margin-bottom: 15px;">ğŸ† Top 5 Agentes</div>
                        ${topAgentes.map(([agente, stats], idx) => {
                            const medalla = idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : `${idx + 1}.`;
                            const pct = totalGCI > 0 ? (stats.gci / totalGCI * 100).toFixed(1) : 0;
                            return `
                                <div style="display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--color-border);">
                                    <span style="font-size: 1.2em;">${medalla}</span>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600;">${agente}</div>
                                        <div style="font-size: 0.75em; color: #888;">${stats.count} transacciones</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: 700; color: #22c55e;">${stats.gci.toLocaleString('es-ES')}â‚¬</div>
                                        <div style="font-size: 0.75em; color: #888;">${pct}%</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <!-- FILTROS -->
                <div style="background: var(--color-surface); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid var(--color-border);">
                    <div style="font-weight: 700; margin-bottom: 15px;">ğŸ” Filtros</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end;">
                        <div class="form-grupo">
                            <label class="form-label">Desde</label>
                            <input type="date" class="form-input" value="${window.filtroFechaInicioTx || ''}" 
                                onchange="window.filtroFechaInicioTx = this.value; renderizarRegistroTransacciones();">
                        </div>
                        <div class="form-grupo">
                            <label class="form-label">Hasta</label>
                            <input type="date" class="form-input" value="${window.filtroFechaFinTx || ''}" 
                                onchange="window.filtroFechaFinTx = this.value; renderizarRegistroTransacciones();">
                        </div>
                        <div class="form-grupo">
                            <label class="form-label">Agente</label>
                            <select class="form-select" onchange="window.filtroAgenteTx = this.value; renderizarRegistroTransacciones();">${optAgente}</select>
                        </div>
                        <div class="form-grupo">
                            <label class="form-label">Tipo</label>
                            <select class="form-select" onchange="window.filtroTipoTx = this.value; renderizarRegistroTransacciones();">${optTipo}</select>
                        </div>
                        <div class="form-grupo">
                            <label class="form-label">Lado</label>
                            <select class="form-select" onchange="window.filtroLadoTx = this.value; renderizarRegistroTransacciones();">${optLado}</select>
                        </div>
                        <button class="btn" onclick="limpiarFiltrosTransacciones()" style="padding: 12px 15px;">ğŸ”„ Limpiar</button>
                        <button class="btn btn-primary-action" onclick="exportarTransaccionesCSV()" style="padding: 12px 15px;">ğŸ“‚ CSV</button>
                    </div>
                </div>
                
                <!-- TABLA -->
                <div style="background: var(--color-surface); padding: 20px; border-radius: 15px; border: 1px solid var(--color-border);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div style="font-weight: 700;">ğŸ“‹ ${datos.length} transacciones ${datos.length !== transacciones.length ? `(de ${transacciones.length} totales)` : ''}</div>
                        <div style="font-size: 0.85em; color: #888;">
                            GCI filtrado: <strong style="color: #22c55e;">${totalGCI.toLocaleString('es-ES')}â‚¬</strong>
                        </div>
                    </div>
                    
                    <div class="tabla-container" style="max-height: 500px; overflow-y: auto;">
                        <table class="tabla" style="font-size: 0.85em;">
                            <thead style="position: sticky; top: 0; background: var(--color-surface); z-index: 5;">
    <tr>
        <th style="width: 80px;">ID</th>
        <th style="width: 90px;">Fecha</th>
        <th>Agente</th>
        <th style="width: 80px;">Tipo</th>
        <th style="width: 80px;">Lado</th>
        <th style="text-align: right;">GCI</th>
        <th style="text-align: right;">P.Capt</th>
        <th style="text-align: right;">P.Venta</th>
        <th style="text-align: right;">ğŸ“‰ Desc.</th>
        <th style="text-align: right;">% Com.</th>
        <th style="width: 60px;">Acciones</th>
    </tr>
</thead>
                            <tbody>
                                ${datos.map(t => {
    const esAnulada = t.descripcion.includes('[ANULADA]');
    const estiloFila = esAnulada ? 'opacity: 0.4; text-decoration: line-through;' : '';
    const colorTipo = {
        'Venta': 'rgba(34,197,94,0.2)',
        'Compra': 'rgba(0,196,255,0.2)',
        'Alquiler': 'rgba(255,215,0,0.2)',
        'Referido': 'rgba(156,39,176,0.2)'
    };
    
    // Color del descuento
    const descuento = parseFloat(t.pctDescuento) || 0;
    const colorDescuento = descuento > 10 ? '#ef4444' : descuento > 5 ? '#ffc107' : '#22c55e';
    
    return `
        <tr style="${estiloFila}">
            <td style="font-family: monospace; font-size: 0.9em;">${t.id}</td>
            <td>${t.fecha}</td>
            <td style="font-weight: 600;">${t.agente}</td>
            <td><span style="background: ${colorTipo[t.tipo] || 'rgba(102,126,234,0.2)'}; padding: 3px 8px; border-radius: 5px; font-size: 0.85em;">${t.tipo}</span></td>
            <td>${t.lado}</td>
            <td style="text-align: right; color: #22c55e; font-weight: 700;">${t.gci.toLocaleString('es-ES')}â‚¬</td>
            <td style="text-align: right; color: #888;">${t.precioCaptacion > 0 ? t.precioCaptacion.toLocaleString('es-ES') + 'â‚¬' : '-'}</td>
            <td style="text-align: right; color: #00c4ff;">${t.volumenNegocio.toLocaleString('es-ES')}â‚¬</td>
            <td style="text-align: right; color: ${colorDescuento}; font-weight: 600;">${t.precioCaptacion > 0 ? descuento.toFixed(1) + '%' : '-'}</td>
            <td style="text-align: right;">${t.pctComision}%</td>
            <td style="text-align: center; white-space: nowrap;">
                ${!esAnulada ? `
                    <button class="btn" onclick="editarTransaccionModal('${t.id}', ${t.gci}, ${t.comision}, ${t.pctComision})" 
                        style="padding: 4px 8px; font-size: 0.8em;" title="Editar">âœï¸</button>
                    <button class="btn" onclick="anularTransaccionConfirm('${t.id}')" 
                        style="padding: 4px 8px; font-size: 0.8em; background: rgba(255,68,68,0.2);" title="Anular">âŒ</button>
                ` : '<span style="color: #ff4444; font-size: 0.8em;">ANULADA</span>'}
            </td>
        </tr>
    `;
}).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        })
        .withFailureHandler(function(error) {
            container.innerHTML = `<div class="section"><div style="text-align:center; padding:50px; color:#ff6b6b;">âŒ Error: ${error.message}</div></div>`;
        })
        .obtenerTodasTransacciones(filtros);
}

function limpiarFiltrosTransacciones() {
    window.filtroAgenteTx = null;
    window.filtroTipoTx = null;
    window.filtroLadoTx = null;
    window.filtroFechaInicioTx = null;
    window.filtroFechaFinTx = null;
    renderizarRegistroTransacciones();
}

// FUNCIÃ“N AUXILIAR: Parsear fecha desde formato dd/MM/yyyy
function parsearFecha(fechaStr) {
    const partes = fechaStr.split('/');
    return new Date(partes[2], partes[1] - 1, partes[0]);
}

// FUNCIÃ“N: Limpiar filtros
function limpiarFiltrosTransacciones() {
    window.filtroAgenteTx = 'todos';
    window.filtroTipoTx = 'todos';
    window.filtroFechaInicioTx = '';
    window.filtroFechaFinTx = '';
    renderizarRegistroTransacciones();
}

// FUNCIÃ“N: Exportar a CSV
function exportarTransaccionesCSV() {
    const transacciones = window.transaccionesGlobales || [];
    
    if (transacciones.length === 0) {
        mostrarNotificacion('No hay transacciones para exportar', 'error');
        return;
    }
    
    // Aplicar filtros actuales
    let datos = transacciones;
    
    if (window.filtroAgenteTx && window.filtroAgenteTx !== 'todos') {
        datos = datos.filter(t => t.agente === window.filtroAgenteTx);
    }
    
    if (window.filtroTipoTx && window.filtroTipoTx !== 'todos') {
        datos = datos.filter(t => t.tipo === window.filtroTipoTx);
    }
    
    if (window.filtroFechaInicioTx) {
        const fechaInicio = new Date(window.filtroFechaInicioTx);
        datos = datos.filter(t => parsearFecha(t.fecha) >= fechaInicio);
    }
    
    if (window.filtroFechaFinTx) {
        const fechaFin = new Date(window.filtroFechaFinTx);
        datos = datos.filter(t => parsearFecha(t.fecha) <= fechaFin);
    }
    
    // Construir CSV
    let csv = 'ID;Fecha;Agente;Tipo;Lado;GCI;Volumen_Negocio;Comision;Pct_Comision;Descripcion\n';
    
    datos.forEach(t => {
        csv += `${t.id};${t.fecha};${t.agente};${t.tipo};${t.lado};${t.gci};${t.volumenNegocio};${t.comision};${t.pctComision};${t.descripcion.replace(/;/g, ',')}\n`;
    });
    
    // Descargar archivo
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `Transacciones_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    mostrarNotificacion(`âœ… Exportadas ${datos.length} transacciones`, 'success');
}
       // --- RENDERIZADO MAESTRO: 360Âº DE TU NEGOCIO ---
// --- RENDERIZADO MAESTRO CON PROYECCIÃ“N DE CIERRE (FORECAST) ---
function renderizarGraficosGenerales() {
    const container = document.getElementById('vistaContenido');
    
    // 1. Calcular PonderaciÃ³n Temporal
    const hoy = new Date();
    const dias = Math.ceil((hoy - new Date(hoy.getFullYear(),0,1)) / 86400000);
    const factor = Math.max(dias / 365, 0.01); 
    
    // 2. Datos Actuales (Real 2025)
    // Aseguramos que datosFiltrados existe
    const dataSegura = datosFiltrados || [];
    
    const act = {
        gci: dataSegura.reduce((s, d) => s + (d.realizado.gci||0), 0),
        ventas: window.transaccionesGlobales ? window.transaccionesGlobales.length : 0,
        citasCapt: dataSegura.reduce((s, d) => s + (d.realizado.citasCaptacion||0), 0),
        exclVenta: dataSegura.reduce((s, d) => s + (d.realizado.exclusivasVenta||0), 0),
        captAbierto: dataSegura.reduce((s, d) => s + (d.realizado.captacionesAbierto||0), 0),
        citasComp: dataSegura.reduce((s, d) => s + (d.realizado.citasCompradores||0), 0),
        exclComp: dataSegura.reduce((s, d) => s + (d.realizado.exclusivasComprador||0), 0),
        visitas: dataSegura.reduce((s, d) => s + (d.realizado.casasEnsenadas||0), 0)
    };

    // 3. Datos HistÃ³ricos (Total AÃ±o Anterior desde FacturaciÃ³n Pasada)
let histTotal = { gci:0, ventas:0, citasCapt:0, exclVenta:0, captAbierto:0, citasComp:0, exclComp:0, visitas:0 };

// âœ… USAR facturacionPasadaGlobal (sistema nuevo)
if (facturacionPasadaGlobal && facturacionPasadaGlobal.kpis) {
    const k = facturacionPasadaGlobal.kpis;
    histTotal.gci = k.gci || 0;
    histTotal.ventas = k.ventas || 0;
    histTotal.citasCapt = k.citasCaptacion || 0;
    histTotal.exclVenta = k.exclusivasVenta || 0;
    histTotal.captAbierto = k.captAbierto || 0;
    histTotal.citasComp = k.citasComprador || 0;
    histTotal.exclComp = k.exclusivasCompr || 0;
    histTotal.visitas = k.casasEnsenadas || 0;
    console.log('âœ… Usando FacturaciÃ³n Pasada para grÃ¡ficos generales:', histTotal);
}
// FALLBACK: Usar historial mensual agregado
else if (typeof historialAgentesCache !== 'undefined' && historialAgentesCache) {
    Object.values(historialAgentesCache).forEach(h => {
        histTotal.gci += h.gci||0; 
        histTotal.ventas += h.ventas||0;
        histTotal.citasCapt += h.citasCapt||0; 
        histTotal.exclVenta += h.exclVenta||0;
        histTotal.captAbierto += h.captAbierto||0; 
        histTotal.citasComp += h.citasComp||0;
        histTotal.exclComp += h.exclComp||0; 
        histTotal.visitas += h.visitas||0;
    });
    console.log('âœ… Usando historial de agentes (fallback)');
}

    // 4. CÃLCULO DE PROYECCIÃ“N
    const proyeccion = {
        gci: act.gci / factor,
        ventas: act.ventas / factor
    };

    const diffProy = proyeccion.gci - histTotal.gci;
    const pctProy = histTotal.gci > 0 ? (diffProy / histTotal.gci) * 100 : 100;
    const colorProy = diffProy >= 0 ? '#22c55e' : '#ff4444';
    const iconoProy = diffProy >= 0 ? 'ğŸš€' : 'âš ï¸';

    // Meta YTD
    const meta = {};
    Object.keys(histTotal).forEach(k => meta[k] = histTotal[k] * factor);

    const html = `
        <div style="background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 25px; margin-bottom: 30px; display:flex; justify-content:space-around; align-items:center; flex-wrap:wrap; gap:20px;">
            <div style="text-align:center;">
                <div style="font-size:0.9em; color:#aaa; margin-bottom:5px;">FACTURACIÃ“N ACTUAL (YTD)</div>
                <div style="font-size:2.5em; font-weight:900; color:var(--color-text-primary);">${act.gci.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</div>
                <div style="font-size:0.8em; color:#888;">DÃ­a ${Math.ceil(dias)} (${(factor*100).toFixed(1)}%)</div>
            </div>
            <div style="font-size:3em; opacity:0.5;">â”</div>
            <div style="text-align:center;">
                <div style="font-size:0.9em; color:${colorProy}; margin-bottom:5px; font-weight:bold;">ğŸ”® PROYECCIÃ“N CIERRE 2025</div>
                <div style="font-size:3.5em; font-weight:900; color:${colorProy}; text-shadow: 0 0 20px ${colorProy}44;">${proyeccion.gci.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</div>
                <div style="font-size:0.9em; color:#ccc;">
                    vs ${histTotal.gci.toLocaleString()}â‚¬ (2024) <span style="color:${colorProy}; font-weight:bold; margin-left:10px;">${iconoProy} ${pctProy.toFixed(1)}%</span>
                </div>
            </div>
        </div>

        <div class="section-title">ğŸ“Š Comparativa YTD</div>
        
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:10px; margin-bottom:30px;">
            ${renderMiniGrowthCard("ğŸ’° GCI", act.gci, meta.gci, "â‚¬")}
            ${renderMiniGrowthCard("ğŸ¤ Ventas", act.ventas, meta.ventas, "")}
            ${renderMiniGrowthCard("ğŸ“ Citas Capt.", act.citasCapt, meta.citasCapt, "")}
            ${renderMiniGrowthCard("ğŸ  Excl. Venta", act.exclVenta, meta.exclVenta, "")}
            ${renderMiniGrowthCard("ğŸ˜ï¸ Abierto", act.captAbierto, meta.captAbierto, "")}
            ${renderMiniGrowthCard("ğŸ‘¥ Citas Comp.", act.citasComp, meta.citasComp, "")}
            ${renderMiniGrowthCard("ğŸ”‘ Excl. Comp.", act.exclComp, meta.exclComp, "")}
            ${renderMiniGrowthCard("ğŸ¡ Visitas", act.visitas, meta.visitas, "")}
        </div>

        <div class="charts-grid">
    <div class="chart-container" style="grid-column: 1 / -1; height: 450px;">
        <div class="chart-title">ğŸ“Š Volumen YTD: 2025 vs 2024</div>
        <canvas id="chart-yoy-completo"></canvas>
    </div>
</div>

<div class="section-title">ğŸ† AnÃ¡lisis de Talento y Productividad</div>
<div class="charts-grid">
    <div class="chart-container" style="height: 450px;">
        <div class="chart-title">ğŸ§  Matriz de Talento (Skill vs Will)</div>
        <canvas id="chart-skill-will"></canvas>
    </div>
    <div class="chart-container" style="height: 450px;">
        <div class="chart-title">âš¡ Top 10 GCI</div>
        <canvas id="chart-productividad"></canvas>
    </div>
</div>

<div class="section-title">ğŸ“ˆ EvoluciÃ³n Temporal</div>
<div class="charts-grid">
    <div class="chart-container" style="grid-column: 1 / -1; height: 400px;">
        <div class="chart-title">ğŸ“ EvoluciÃ³n Mensual: Citas CaptaciÃ³n</div>
        <canvas id="chart-evolucion-citas"></canvas>
    </div>
    <div class="chart-container" style="grid-column: 1 / -1; height: 400px;">
        <div class="chart-title">ğŸ¡ EvoluciÃ³n Mensual: Casas EnseÃ±adas</div>
        <canvas id="chart-evolucion-visitas"></canvas>
    </div>
</div>

<div class="section-title">ğŸ” AnÃ¡lisis Operativo</div>
<div class="charts-grid">
     <div class="chart-container"><div class="chart-title">ğŸ’° DistribuciÃ³n GCI por Agente</div><canvas id="chart-gci"></canvas></div>
     <div class="chart-container"><div class="chart-title">ğŸ“Š Cumplimiento por Agente</div><canvas id="chart-cumplimiento"></canvas></div>
     <div class="chart-container"><div class="chart-title">ğŸ¯ Tasas de ConversiÃ³n</div><canvas id="chart-conversion"></canvas></div>
     <div class="chart-container"><div class="chart-title">ğŸ  Mix Exclusivas vs Abierto</div><canvas id="chart-exclusivas"></canvas></div>
</div>

<div class="section-title">ğŸ­ AnÃ¡lisis de Actividad</div>
<div class="charts-grid">
    <div class="chart-container" style="height: 400px;">
        <div class="chart-title">ğŸ”¥ Velocidad de CaptaciÃ³n (Citas/Exclusivas)</div>
        <canvas id="chart-velocidad-captacion"></canvas>
    </div>
    <div class="chart-container" style="height: 400px;">
        <div class="chart-title">âš–ï¸ Balance Vendedor vs Comprador</div>
        <canvas id="chart-balance-roles"></canvas>
    </div>
    <div class="chart-container" style="height: 400px;">
        <div class="chart-title">ğŸ“ˆ Eficiencia Visitas â†’ GCI</div>
        <canvas id="chart-eficiencia-visitas"></canvas>
    </div>
    <div class="chart-container" style="height: 400px;">
        <div class="chart-title">ğŸ¯ Top 5 Mejores Ratios</div>
        <canvas id="chart-top-ratios"></canvas>
    </div>
</div>
    `;
    container.innerHTML = html;
    
    setTimeout(() => {
    crearGraficoYoYCompleto(act, meta);
    crearGraficoSkillWill();
    crearGraficoProductividad();
    crearGraficoEvolucionCitas();
    crearGraficoEvolucionVisitas();
    crearGraficoGCI();
    crearGraficoCumplimiento();
    crearGraficoConversion();
    crearGraficoExclusivas();
    crearGraficoVelocidadCaptacion();
    crearGraficoBalanceRoles();
    crearGraficoEficienciaVisitas();
    crearGraficoTopRatios();
}, 300);
}

// Helper para tarjeta pequeÃ±a
function renderMiniGrowthCard(titulo, act, meta, unit) {
    const diff = act - meta;
    const pct = meta > 0 ? ((diff / meta) * 100) : 100;
    const color = diff >= 0 ? 'var(--color-accent-good)' : 'var(--color-accent-bad)';
    const icon = diff >= 0 ? 'â¬†' : 'â¬‡';
    
    return `
    <div style="background:var(--color-surface); border:1px solid var(--color-border); border-radius:10px; padding:12px; text-align:center;">
        <div style="font-size:0.75em; color:var(--color-text-faded); text-transform:uppercase; font-weight:600;">${titulo}</div>
        <div style="font-size:1.4em; font-weight:900; color:var(--color-text-primary); margin:8px 0;">${Math.round(act).toLocaleString()}${unit}</div>
        <div style="font-size:0.85em; color:${color}; font-weight:700;">
            ${icon} ${Math.abs(pct).toFixed(0)}%
        </div>
        <div style="font-size:0.7em; color:var(--color-text-faded); margin-top:4px;">
            vs ${Math.round(meta).toLocaleString()}${unit}
        </div>
    </div>`;
}

function renderGrowthCard(titulo, actual, meta, metricas, unidad) {
    return `
    <div style="background:var(--color-surface); padding:15px; border-radius:12px; border:1px solid var(--color-border); text-align:center;">
        <div style="font-size:0.8em; color:var(--color-text-secondary); text-transform:uppercase; letter-spacing:1px;">${titulo}</div>
        <div style="font-size:1.8em; font-weight:900; color:var(--color-text-primary); margin:5px 0;">${actual.toLocaleString()}${unidad}</div>
        <div style="font-size:0.75em; color:#888; border-top:1px solid var(--color-border); padding-top:5px;">
            Vs AÃ±o Pasado (YTD): ${Math.round(meta).toLocaleString()}${unidad}
        </div>
        <div style="font-size:1.1em; font-weight:bold; color:${metricas.color}; margin-top:5px;">
            ${metricas.icon} ${metricas.pct}%
        </div>
    </div>`;
}

        function actualizarChartDefaults() {
            const theme = document.body.dataset.theme;
            if (theme === 'claro' || theme === 'kw-claro') {
                Chart.defaults.color = '#555';
                Chart.defaults.borderColor = 'rgba(0, 0, 0, 0.1)';
            } else {
                Chart.defaults.color = 'rgba(255, 255, 255, 0.7)';
                Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
            }
            // Destruir y recrear grÃ¡ficos visibles
            Object.values(chartInstances).forEach(chart => {
                if (chart) chart.destroy();
            });
            
            if(document.getElementById('view-manager').classList.contains('active') && vistaActualGerente === 'graficos') {
                renderizarGraficosGenerales();
            }
            // AÃ±adir lÃ³gica para recrear grÃ¡ficos de agente si es necesario
        }


        // --- BLOQUE DE GRÃFICOS CON ZOOM ---

// FunciÃ³n genÃ©rica para abrir el zoom
function ampliarGrafico(chartId, titulo) {
    const originalChart = chartInstances[chartId];
    if (!originalChart) return;

    // Reutilizamos el modal de anÃ¡lisis para mostrar el grÃ¡fico grande
    const modalBody = document.getElementById('modal-analisis-body');
    modalBody.innerHTML = `
        <h2 style="text-align: center; margin-bottom: 20px; color: var(--color-primary);">ğŸ” ${titulo}</h2>
        <div style="height: 70vh; width: 100%; position: relative;">
            <canvas id="canvas-ampliado"></canvas>
        </div>
    `;
    
    // Usamos la nueva funciÃ³n de abrir encima
    abrirModalEncima('modal-analisis');

    setTimeout(() => {
        const ctx = document.getElementById('canvas-ampliado');
        new Chart(ctx, {
            type: originalChart.config.type,
            data: originalChart.config.data,
            options: {
                ...originalChart.config.options,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { position: 'top' },
                    tooltip: { enabled: true }
                },
                // Quitamos el onClick en el grande para que no se abra a sÃ­ mismo infinitamente
                onClick: null 
            }
        });
    }, 100);
}
// === GESTIÃ“N DE MODALES SIN PARPADEO (APILADOS) ===

// FunciÃ³n genÃ©rica para abrir un modal encima del anterior
function abrirModalEncima(idModal) {
    const modal = document.getElementById(idModal);
    if (modal) {
        modal.style.zIndex = "1050"; // Z-Index superior al base (1000)
        modal.classList.add('active');
        // NO aÃ±adimos 'modal-open' al body porque ya la tiene del modal padre
    }
}

// FunciÃ³n para cerrar SOLO el modal actual (sin tocar el de abajo)
function cerrarModalHijo(idModal) {
    const modal = document.getElementById(idModal);
    if (modal) {
        modal.classList.remove('active');
        // NO quitamos la clase del body para que el scroll del padre siga funcionando
    }
}

function crearGraficoCumplimiento() {
    const ctx = document.getElementById('chart-cumplimiento');
    if (!ctx) return;
    if (chartInstances.cumplimiento) chartInstances.cumplimiento.destroy();
    chartInstances.cumplimiento = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: datosFiltrados.map(d => d.agente),
            datasets: [{
                label: 'Cumplimiento %',
                data: datosFiltrados.map(d => parseFloat(d.cumplimientoGlobal)),
                backgroundColor: datosFiltrados.map(d => d.estadoClase === 'excelente' ? 'var(--color-accent-good)' : d.estadoClase === 'bueno' ? 'var(--color-accent-warn)' : 'var(--color-accent-bad)'),
            }]
        },
        options: { 
            responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, 
            scales: { y: { beginAtZero: true, max: 150 }, x: {} },
            onClick: () => ampliarGrafico('cumplimiento', 'Cumplimiento Detallado')
        }
    });
}

function crearGraficoConversion() {
    const ctx = document.getElementById('chart-conversion');
    if (!ctx) return;
    if (chartInstances.conversion) chartInstances.conversion.destroy();
    chartInstances.conversion = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: datosFiltrados.map(d => d.agente),
            datasets: [
                { label: 'ConversiÃ³n %', data: datosFiltrados.map(d => parseFloat(d.ratios.conversionCaptacion)), backgroundColor: 'rgba(0, 255, 136, 0.2)', borderColor: 'var(--color-accent-good)', borderWidth: 2 },
                { label: 'Cierre (GCI/Excl)', data: datosFiltrados.map(d => parseFloat(d.ratios.ratioCierre)), backgroundColor: 'rgba(255, 215, 0, 0.2)', borderColor: 'var(--color-accent-warn)', borderWidth: 2 }
            ]
        },
        options: { 
            responsive: true, maintainAspectRatio: false, scales: { r: { min: 0 } },
            onClick: () => ampliarGrafico('conversion', 'Radar de ConversiÃ³n')
        }
    });
}

function crearGraficoGCI() {
    const ctx = document.getElementById('chart-gci');
    if (!ctx) return;
    if (chartInstances.gci) chartInstances.gci.destroy();
    chartInstances.gci = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: datosFiltrados.map(d => d.agente),
            datasets: [{ 
                data: datosFiltrados.map(d => d.realizado.gci),
                backgroundColor: ['rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(255, 206, 86, 0.8)', 'rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8)', 'rgba(255, 159, 64, 0.8)', 'rgba(0, 255, 136, 0.8)', 'rgba(255, 68, 68, 0.8)']
            }]
        },
        options: { 
            responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'right' } },
            onClick: () => ampliarGrafico('gci', 'DistribuciÃ³n de GCI')
        }
    });
}

function crearGraficoActividadGCI() {
    const ctx = document.getElementById('chart-actividad-gci');
    if (!ctx) return;
    if (chartInstances.actividadGci) chartInstances.actividadGci.destroy();
    chartInstances.actividadGci = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Agentes',
                data: datosFiltrados.map(d => ({ x: d.ratios.actividadTotal, y: d.realizado.gci, agente: d.agente })),
                backgroundColor: datosFiltrados.map(d => d.estadoClase === 'excelente' ? 'var(--color-accent-good)' : d.estadoClase === 'bueno' ? 'var(--color-accent-warn)' : 'var(--color-accent-bad)'),
                pointRadius: 8
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => `${ctx.raw.agente}: Act ${ctx.parsed.x}, GCI ${ctx.parsed.y.toFixed(0)}â‚¬` } } },
            scales: { y: { beginAtZero: true, title: { display: true, text: 'GCI (â‚¬)' } }, x: { beginAtZero: true, title: { display: true, text: 'Actividad' } } },
            onClick: () => ampliarGrafico('actividadGci', 'Actividad vs GCI')
        }
    });
}

function crearGraficoExclusivas() {
    const ctx = document.getElementById('chart-exclusivas');
    if (!ctx) return;
    if (chartInstances.exclusivas) chartInstances.exclusivas.destroy();
    chartInstances.exclusivas = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: datosFiltrados.map(d => d.agente),
            datasets: [
                { label: 'Excl. Venta', data: datosFiltrados.map(d => d.realizado.exclusivasVenta), backgroundColor: 'rgba(255, 99, 132, 0.8)' },
                { label: 'Excl. Comprador', data: datosFiltrados.map(d => d.realizado.exclusivasComprador), backgroundColor: 'rgba(54, 162, 235, 0.8)' },
                { label: 'Capt. Abierto', data: datosFiltrados.map(d => d.realizado.captacionesAbierto), backgroundColor: 'rgba(255, 206, 86, 0.8)' }
            ]
        },
        options: { 
            responsive: true, maintainAspectRatio: false, scales: { y: { stacked: true, beginAtZero: true }, x: { stacked: true } },
            onClick: () => ampliarGrafico('exclusivas', 'Desglose de Exclusivas')
        }
    });
}

function crearGraficoTickets() {
    const ctx = document.getElementById('chart-tickets');
    if (!ctx) return;
    if (chartInstances.tickets) chartInstances.tickets.destroy();
    chartInstances.tickets = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: datosFiltrados.map(d => d.agente),
            datasets: [{
                label: 'Ticket Promedio (â‚¬)',
                data: datosFiltrados.map(d => parseFloat(d.ratios.ticketPromedio)),
                backgroundColor: datosFiltrados.map(d => parseFloat(d.ratios.ticketPromedio) >= 3000 ? 'var(--color-accent-good)' : parseFloat(d.ratios.ticketPromedio) >= 2000 ? 'var(--color-accent-warn)' : 'var(--color-accent-bad)'),
            }]
        },
        options: { 
            responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: {} },
            onClick: () => ampliarGrafico('tickets', 'Ranking Ticket Promedio')
        }
    });
}
        
        // ===== ANÃLISIS DETALLADO (MODALES) =====
        
        // --- FICHA AGENTE CON PROYECCIÃ“N INDIVIDUAL ---
function mostrarAnalisisDetallado(idAgente) {
    const agente = datosGlobales.find(d => d.id === idAgente);
    if (!agente) return;
    
    const modalBody = document.getElementById('modal-analisis-body');
    
    const real = agente.realizado;
    const obj = agente.objetivos;
    const cump = agente.cumplimientos;
    const ratios = agente.ratios;
    const evol = agente.evolucionMensual;
    
    const hoy = new Date();
    const inicioAnio = new Date(hoy.getFullYear(), 0, 1);
    const diasTranscurridos = Math.ceil((hoy - inicioAnio) / (1000 * 60 * 60 * 24));
    const diasEnAnio = 365;
    const factorTiempo = Math.max(diasTranscurridos / diasEnAnio, 0.01);
    const mesActual = hoy.getMonth();
    
    const transaccionesAgente = (window.transaccionesGlobales || []).filter(t => t.agente === agente.agente);
    const numTransacciones = transaccionesAgente.length;
    const volumenNegocio = transaccionesAgente.reduce((sum, t) => sum + (parseFloat(t.volumenNegocio) || 0), 0);
    const comisionesAgente = transaccionesAgente.reduce((sum, t) => sum + (parseFloat(t.comision) || 0), 0);
    const sueldoFijo = agente.sueldoFijo || 0;
    const beneficioNeto = (real.gci || 0) - comisionesAgente - sueldoFijo;
    
    const hist = historialAgentesCache[idAgente] || null;
    
    const cumplimientoGlobal = parseFloat(agente.cumplimientoGlobal) || 0;
    const colorCumplimiento = cumplimientoGlobal >= 90 ? '#22c55e' : cumplimientoGlobal >= 70 ? '#ffd700' : '#ff6b6b';
    const estadoTexto = cumplimientoGlobal >= 90 ? 'ğŸ”¥ EXCELENTE' : cumplimientoGlobal >= 70 ? 'ğŸ‘ EN CAMINO' : 'âš ï¸ NECESITA IMPULSO';

    const kpisCompletos = calcularKpisConAcumulados(real, obj, evol, factorTiempo, mesActual);
    
    // ğŸ†• AÃ‘ADIR DATOS AÃ‘O ANTERIOR A CADA KPI
    if (hist && Object.keys(hist).length > 0) {
        const mapeoHistorico = {
            'gci': hist.gci || 0,
            'citasCaptacion': hist.citasCapt || 0,
            'exclusivasVenta': hist.exclVenta || 0,
            'exclusivasComprador': hist.exclComp || 0,
            'captacionesAbierto': hist.captAbierto || 0,
            'captacionesAlquiler': hist.captAlquiler || 0,
            'citasCompradores': hist.citasComp || 0,
            'casasEnsenadas': hist.visitas || 0,
            'llamadas': hist.llamadas || 0,
            'leadVendedor': hist.leadVendedor || 0,
            'leadComprador': hist.leadComprador || 0,
            'leadsCompradores': hist.leadsCompradores || 0,
            'tresBs': hist.tresBs || 0,
            'bajadasPrecio': hist.bajadasPrecio || 0,
            'propuestasCompra': hist.propuestas || 0,
            'leadSeguimiento': hist.leadSeguimiento || 0,
            'arras': hist.arras || 0,
            'ventas': hist.ventas || 0,
            'volumenNegocio': hist.volumenNegocio || 0
        };
        
        console.log('ğŸ“Š HistÃ³rico del agente aplicado:', mapeoHistorico);
        
        kpisCompletos.forEach(kpi => {
            kpi.anoAnterior = mapeoHistorico[kpi.key] || 0;
        });
    }

    modalBody.innerHTML = `
        <!-- HEADER -->
        <div style="background: linear-gradient(135deg, rgba(102,126,234,0.15), rgba(255,107,107,0.15)); padding: 25px; border-radius: 20px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 20px;">
                <div>
                    <h1 style="margin: 0; font-size: 2em; color: var(--color-text-primary);">ğŸ‘¤ ${agente.agente}</h1>
                    <div style="font-size: 0.95em; color: #aaa; margin-top: 5px;">ID: ${agente.id} | DÃ­a ${diasTranscurridos} de ${diasEnAnio} (${(factorTiempo * 100).toFixed(1)}% del aÃ±o)</div>
                    <div style="margin-top: 10px; padding: 6px 14px; background: ${colorCumplimiento}22; border-radius: 20px; display: inline-block;">
                        <span style="color: ${colorCumplimiento}; font-weight: bold;">${estadoTexto}</span>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.85em; color: #aaa;">CUMPLIMIENTO GLOBAL</div>
                    <div style="font-size: 3.5em; font-weight: 900; color: ${colorCumplimiento}; line-height: 1;">
                        ${cumplimientoGlobal.toFixed(1)}%
                    </div>
                    <div style="width: 160px; height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; margin-top: 8px;">
                        <div style="width: ${Math.min(cumplimientoGlobal, 100)}%; height: 100%; background: ${colorCumplimiento}; border-radius: 10px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MÃ‰TRICAS DESTACADAS -->
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 20px;">
            ${renderMetricaDestacada('ğŸ’° GCI Actual', real.gci, 'â‚¬', '#22c55e')}
            ${renderMetricaDestacada('ğŸ”® ProyecciÃ³n', (real.gci || 0) / factorTiempo, 'â‚¬', '#667eea')}
            ${renderMetricaDestacada('ğŸ¤ Transacciones', numTransacciones, '', '#ffd700')}
            ${renderMetricaDestacada('ğŸ“Š Vol. Negocio', volumenNegocio, 'â‚¬', '#00bcd4')}
            ${renderMetricaDestacada('ğŸ’µ Beneficio Neto', beneficioNeto, 'â‚¬', beneficioNeto >= 0 ? '#22c55e' : '#ff6b6b')}
        </div>

        <!-- LEYENDA -->
        <div style="background: var(--color-surface); padding: 12px 20px; border-radius: 10px; margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 20px; font-size: 0.85em;">
            <div><span style="display: inline-block; width: 12px; height: 12px; background: #22c55e; border-radius: 2px; margin-right: 6px;"></span>Realizado</div>
            <div><span style="display: inline-block; width: 12px; height: 12px; background: #667eea; border-radius: 2px; margin-right: 6px;"></span>Obj. a la Fecha</div>
            <div><span style="display: inline-block; width: 12px; height: 12px; background: #ff6b6b; border-radius: 2px; margin-right: 6px;"></span>Obj. Acumulado (con dÃ©ficit)</div>
            <div><span style="display: inline-block; width: 12px; height: 12px; background: #ffd700; border-radius: 2px; margin-right: 6px;"></span>Obj. Anual</div>
        </div>

        <!-- KPIs COMPLETOS -->
        <div class="section-title">ğŸ“Š Todos los KPIs - Progreso Detallado (${kpisCompletos.length} mÃ©tricas)</div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 12px; margin-bottom: 25px;">
            ${kpisCompletos.length > 0 ? kpisCompletos.map(kpi => renderKpiCompletoCard(kpi)).join('') : '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #888;">No hay KPIs con objetivos configurados</div>'}
        </div>

        <!-- COMPARATIVA AÃ‘O ANTERIOR AMPLIADA -->
        ${hist ? `
            <div class="section-title">ğŸ“Š Comparativa vs AÃ±o Anterior (a la fecha)</div>
            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-bottom: 25px;">
                ${renderComparativaAnteriorMejorada('ğŸ’° GCI', real.gci, hist.gci, factorTiempo)}
                ${renderComparativaAnteriorMejorada('ğŸ“ Citas Capt.', real.citasCaptacion, hist.citasCapt, factorTiempo)}
                ${renderComparativaAnteriorMejorada('ğŸ  Exclusivas V.', real.exclusivasVenta, hist.exclVenta, factorTiempo)}
                ${renderComparativaAnteriorMejorada('ğŸ”‘ Exclusivas C.', real.exclusivasComprador, hist.exclComprador, factorTiempo)}
                ${renderComparativaAnteriorMejorada('ğŸ¡ Casas EnseÃ±.', real.casasEnsenadas, hist.visitas, factorTiempo)}
                ${renderComparativaAnteriorMejorada('ğŸ‘¥ Citas Comp.', real.citasCompradores, hist.citasComp, factorTiempo)}
                ${renderComparativaAnteriorMejorada('ğŸ“ Llamadas', real.llamadas, hist.llamadas, factorTiempo)}
                ${renderComparativaAnteriorMejorada('ğŸ‘¥ Leads Comp.', real.leadsCompradores, hist.leads, factorTiempo)}
                ${renderComparativaAnteriorMejorada('ğŸ“‹ Lead Vend.', real.leadVendedor, hist.leadVendedor, factorTiempo)}
                ${renderComparativaAnteriorMejorada('ğŸ“ Propuestas', real.propuestasCompra, hist.propuestas, factorTiempo)}
                ${renderComparativaAnteriorMejorada('ğŸ“„ Arras', real.arras, hist.arras, factorTiempo)}
                ${renderComparativaAnteriorMejorada('ğŸ¤ Transacc.', numTransacciones, hist.transacciones, factorTiempo)}
            </div>
        ` : ''}

        <!-- RATIOS DE CONVERSIÃ“N AMPLIADOS -->
        <div class="section-title">ğŸ¯ Ratios de ConversiÃ³n</div>
        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-bottom: 25px;">
            ${renderRatioCardMini('Conv. CaptaciÃ³n', ratios?.conversionCaptacion, '%')}
            ${renderRatioCardMini('Conv. Comprador', ratios?.conversionComprador, '%')}
            ${renderRatioCardMini('% Exclusivas', ratios?.pctExclusivas, '%')}
            ${renderRatioCardMini('Ticket Promedio', ratios?.ticketPromedio, 'â‚¬')}
            ${renderRatioCardMini('Citas/Lead Vend.', real.leadVendedor > 0 ? (real.citasCaptacion / real.leadVendedor * 100) : 0, '%')}
            ${renderRatioCardMini('Excl./Cita', real.citasCaptacion > 0 ? (real.exclusivasVenta / real.citasCaptacion * 100) : 0, '%')}
            ${renderRatioCardMini('Arras/Propuesta', real.propuestasCompra > 0 ? (real.arras / real.propuestasCompra * 100) : 0, '%')}
            ${renderRatioCardMini('Visitas/Lead C.', real.leadsCompradores > 0 ? (real.casasEnsenadas / real.leadsCompradores) : 0, 'x')}
            ${renderRatioCardMini('GCI/TransacciÃ³n', numTransacciones > 0 ? ((real.gci || 0) / numTransacciones) : 0, 'â‚¬')}
            ${renderRatioCardMini('Vol./TransacciÃ³n', numTransacciones > 0 ? (volumenNegocio / numTransacciones) : 0, 'â‚¬')}
            ${renderRatioCardMini('Actividad Diaria', diasTranscurridos > 0 ? ((real.citasCaptacion || 0) + (real.casasEnsenadas || 0)) / diasTranscurridos : 0, '/dÃ­a')}
            ${renderRatioCardMini('Efectividad', obj.gci > 0 ? ((real.gci || 0) / obj.gci * 100) : 0, '%')}
        </div>

        <!-- ANÃLISIS AUTOMÃTICO -->
        <div class="section-title">ğŸ§  AnÃ¡lisis AutomÃ¡tico</div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px;">
            <div style="background: rgba(34,197,94,0.08); padding: 18px; border-radius: 12px; border-left: 4px solid #22c55e;">
                <div style="font-size: 0.95em; color: #22c55e; font-weight: bold; margin-bottom: 10px;">âœ… PUNTOS FUERTES</div>
                ${generarPuntosFuertesAuto(kpisCompletos)}
            </div>
            <div style="background: rgba(255,107,107,0.08); padding: 18px; border-radius: 12px; border-left: 4px solid #ff6b6b;">
                <div style="font-size: 0.95em; color: #ff6b6b; font-weight: bold; margin-bottom: 10px;">âš ï¸ ÃREAS DE MEJORA</div>
                ${generarAreasMejoraAuto(kpisCompletos)}
            </div>
        </div>

        <!-- GRÃFICOS DE EVOLUCIÃ“N - TODOS LOS KPIs -->
        <div class="section-title">ğŸ“ˆ EvoluciÃ³n Mensual - Todos los KPIs</div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px;">
            ${generarTodosGraficosEvolucion(kpisCompletos)}
        </div>
    `;
    
    abrirModalEncima('modal-analisis');

    // Renderizar todos los grÃ¡ficos
    setTimeout(() => {
        kpisCompletos.forEach(kpi => {
            renderizarGraficoDetalleAgente('chart-detalle-' + kpi.key, agente, kpi.key, hist);
        });
    }, 150);
}

// ğŸ†• Nueva funciÃ³n para comparativa aÃ±o anterior mejorada
function renderComparativaAnteriorMejorada(titulo, actual, anterior, factorTiempo) {
    const anteriorAFecha = (anterior || 0) * factorTiempo;
    const diff = (actual || 0) - anteriorAFecha;
    const pct = anteriorAFecha > 0 ? ((diff / anteriorAFecha) * 100).toFixed(0) : 0;
    const color = diff >= 0 ? '#22c55e' : '#ff6b6b';
    const icono = diff >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
    
    return `
        <div style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 10px; padding: 10px; text-align: center;">
            <div style="font-size: 0.7em; color: #aaa; margin-bottom: 4px;">${titulo}</div>
            <div style="font-size: 1.3em; margin: 4px 0;">${icono}</div>
            <div style="font-size: 1em; color: ${color}; font-weight: bold;">${pct >= 0 ? '+' : ''}${pct}%</div>
            <div style="font-size: 0.65em; color: #666;">${Math.round(actual || 0)} vs ${Math.round(anteriorAFecha)}</div>
        </div>
    `;
}

// ğŸ†• Generar contenedores para todos los grÃ¡ficos
function generarTodosGraficosEvolucion(kpisCompletos) {
    return kpisCompletos.map(kpi => `
        <div class="chart-container" style="height: 260px; background: var(--color-surface); padding: 15px; border-radius: 12px;">
            <div style="font-weight: bold; margin-bottom: 8px; font-size: 0.9em;">${kpi.nombre}</div>
            <canvas id="chart-detalle-${kpi.key}"></canvas>
        </div>
    `).join('');
}

// ===== FUNCIÃ“N CLAVE: Calcular KPIs con Objetivos Acumulados =====
function calcularKpisConAcumulados(real, obj, evol, factorTiempo, mesActual) {
    
    // ğŸ” DEBUG: Ver quÃ© viene del backend
    console.log('ğŸ“Š DEBUG - Realizado:', real);
    console.log('ğŸ“Š DEBUG - Objetivos:', obj);
    console.log('ğŸ“Š DEBUG - EvoluciÃ³n:', evol);
    
    // Lista completa de KPIs con mapeo de claves alternativas
    const listaKpis = [
        { key: 'gci', altKeys: ['GCI', 'gci'], nombre: 'ğŸ’° GCI', unidad: 'â‚¬' },
        { key: 'citasCaptacion', altKeys: ['citasCaptacion', 'citasCapt', 'citas_captacion', 'citas'], nombre: 'ğŸ“ Citas CaptaciÃ³n', unidad: '' },
        { key: 'exclusivasVenta', altKeys: ['exclusivasVenta', 'exclVenta', 'exclusivas_venta', 'exclusivas'], nombre: 'ğŸ  Exclusivas Venta', unidad: '' },
        { key: 'exclusivasComprador', altKeys: ['exclusivasComprador', 'exclComp', 'exclusivas_comprador'], nombre: 'ğŸ”‘ Exclusivas Comprador', unidad: '' },
        { key: 'captacionesAbierto', altKeys: ['captacionesAbierto', 'captAbierto', 'capt_abierto', 'abierto'], nombre: 'ğŸ˜ï¸ Captaciones Abierto', unidad: '' },
        { key: 'citasCompradores', altKeys: ['citasCompradores', 'citasComp', 'citas_compradores', 'visitas_comp'], nombre: 'ğŸ‘¥ Citas Compradores', unidad: '' },
        { key: 'casasEnsenadas', altKeys: ['casasEnsenadas', 'visitas', 'casas_ensenadas', 'enseÃ±adas'], nombre: 'ğŸ¡ Casas EnseÃ±adas', unidad: '' },
        { key: 'llamadas', altKeys: ['llamadas', 'Llamadas'], nombre: 'ğŸ“ Llamadas', unidad: '' },
        { key: 'leadsCompradores', altKeys: ['leadsCompradores', 'leads_compradores', 'leads'], nombre: 'ğŸ‘¥ Leads Compradores', unidad: '' },
        { key: 'volumenNegocio', altKeys: ['volumenNegocio', 'volumen_negocio', 'volumen'], nombre: 'ğŸ“Š Volumen Negocio', unidad: 'â‚¬' },
        { key: 'captacionesAlquiler', altKeys: ['captacionesAlquiler', 'captAlquiler', 'alquiler'], nombre: 'ğŸ¢ Capt. Alquiler', unidad: '' },
        { key: 'leadVendedor', altKeys: ['leadVendedor', 'lead_vendedor'], nombre: 'ğŸ“‹ Lead Vendedor', unidad: '' },
        { key: 'tresBs', altKeys: ['tresBs', 'tres_bs', '3bs'], nombre: 'ğŸ¯ 3 Bs', unidad: '' },
        { key: 'bajadasPrecio', altKeys: ['bajadasPrecio', 'bajadas_precio', 'bajadas'], nombre: 'ğŸ“‰ Bajadas Precio', unidad: '' },
        { key: 'leadComprador', altKeys: ['leadComprador', 'lead_comprador'], nombre: 'ğŸ‘¤ Lead Comprador', unidad: '' },
        { key: 'propuestasCompra', altKeys: ['propuestasCompra', 'propuestas_compra', 'propuestas'], nombre: 'ğŸ“ Propuestas Compra', unidad: '' },
        { key: 'leadSeguimiento', altKeys: ['leadSeguimiento', 'lead_seguimiento', 'seguimiento'], nombre: 'ğŸ”„ Lead Seguimiento', unidad: '' },
        { key: 'arras', altKeys: ['arras', 'Arras', 'arras_firmadas'], nombre: 'ğŸ“„ Arras Firmadas', unidad: '' },
        { key: 'ventas', altKeys: ['ventas', 'totalTransacciones', 'transacciones'], nombre: 'ğŸ¤ Ventas/Cierres', unidad: '' }
    ];
    
    // FunciÃ³n para buscar valor con claves alternativas
    function buscarValor(objeto, altKeys) {
        if (!objeto) return 0;
        for (const key of altKeys) {
            if (objeto[key] !== undefined && objeto[key] !== null) {
                return parseFloat(objeto[key]) || 0;
            }
        }
        return 0;
    }
    
    const resultado = [];
    
    listaKpis.forEach(kpi => {
        // Buscar valores con claves alternativas
        const realizado = buscarValor(real, kpi.altKeys);
        const objetivoAnual = buscarValor(obj, kpi.altKeys);
        
        // âœ… MOSTRAR TODOS los KPIs que tienen objetivo O realizado > 0
        if (objetivoAnual === 0 && realizado === 0) {
            return; // Solo saltar si AMBOS son 0
        }
        
        // Objetivo mensual base
        const objetivoMesBase = objetivoAnual / 12;
        
        // Objetivo proporcional a la fecha
        const objetivoFecha = objetivoAnual * factorTiempo;
        
        // ===== CALCULAR DÃ‰FICIT Y OBJETIVO DEL MES ACTUAL =====
        let deficitArrastrado = 0;
        let realizadoHastaMesAnterior = 0;
        
        // Buscar evoluciÃ³n mensual con claves alternativas
        let evolKpi = null;
        if (evol) {
            for (const altKey of kpi.altKeys) {
                if (evol[altKey]) {
                    evolKpi = evol[altKey];
                    break;
                }
            }
        }
        
        if (evolKpi && evolKpi.realizado) {
            const realizadoMensual = evolKpi.realizado || [];
            const objetivoMensual = evolKpi.objetivo || [];
            
            // Calcular hasta el mes ANTERIOR (no incluir mes actual)
            for (let m = 0; m < mesActual; m++) {
                const objMes = objetivoMensual[m] || objetivoMesBase;
                const realMes = realizadoMensual[m] || 0;
                
                realizadoHastaMesAnterior += realMes;
                
                // Si hizo menos del objetivo, se acumula el dÃ©ficit
                if (realMes < objMes) {
                    deficitArrastrado += (objMes - realMes);
                }
            }
        } else {
            // Sin evoluciÃ³n mensual: calcular proporcional
            const objetivoHastaMesAnterior = objetivoMesBase * mesActual;
            deficitArrastrado = Math.max(objetivoHastaMesAnterior - realizado, 0);
        }
        
        // ===== OBJETIVO ESTE MES =====
        const objetivoEsteMes = objetivoMesBase + deficitArrastrado;
        
        // ===== LO QUE FALTA PARA CUMPLIR EL AÃ‘O =====
        const faltaParaAnio = Math.max(objetivoAnual - realizado, 0);
        
        // ===== MESES RESTANTES =====
        const mesesRestantes = 12 - mesActual;
        
        // ===== OBJETIVO MENSUAL PROMEDIO RESTANTE =====
        const objetivoMensualRestante = mesesRestantes > 0 ? faltaParaAnio / mesesRestantes : 0;
        
        // ===== PROYECCIÃ“N ANUAL =====
        const proyeccion = factorTiempo > 0 ? realizado / factorTiempo : 0;
        
        // ===== CUMPLIMIENTOS =====
        const cumplimientoFecha = objetivoFecha > 0 ? (realizado / objetivoFecha) * 100 : (realizado > 0 ? 100 : 0);
        const cumplimientoAnual = objetivoAnual > 0 ? (realizado / objetivoAnual) * 100 : (realizado > 0 ? 100 : 0);
        
        // ===== DIFERENCIA =====
        const diferencia = realizado - objetivoFecha;
        
        // ===== ESTADO =====
        let estado = 'bajo';
        if (cumplimientoFecha >= 100) estado = 'excelente';
        else if (cumplimientoFecha >= 80) estado = 'bueno';
        else if (cumplimientoFecha >= 60) estado = 'medio';
        
        resultado.push({
            key: kpi.key,
            nombre: kpi.nombre,
            unidad: kpi.unidad,
            realizado: realizado,
            objetivoAnual: objetivoAnual,
            objetivoFecha: objetivoFecha,
            objetivoMesBase: objetivoMesBase,
            objetivoEsteMes: objetivoEsteMes,
            deficitArrastrado: deficitArrastrado,
            faltaParaAnio: faltaParaAnio,
            objetivoMensualRestante: objetivoMensualRestante,
            proyeccion: proyeccion,
            cumplimientoFecha: cumplimientoFecha,
            cumplimientoAnual: cumplimientoAnual,
            diferencia: diferencia,
            estado: estado,
            mesesRestantes: mesesRestantes
        });
    });
    
    console.log('ğŸ“Š KPIs calculados:', resultado.length, resultado);
    
    return resultado;
}

// ===== TARJETA KPI COMPLETA =====
function renderKpiCompletoCard(kpi) {
    const colorEstado = {
        'excelente': '#22c55e',  // Verde mÃ¡s suave
        'bueno': '#00bcd4',
        'medio': '#ffd700',
        'bajo': '#ff6b6b'
    };
    const color = colorEstado[kpi.estado] || '#888';
    
    const iconoDir = kpi.diferencia >= 0 ? 'â–²' : 'â–¼';
    const colorDif = kpi.diferencia >= 0 ? '#22c55e' : '#ff6b6b';
    
    // Formatear nÃºmeros
    const fmt = (v) => {
        if (v === undefined || v === null) return '0';
        if (kpi.unidad === 'â‚¬') return Math.round(v).toLocaleString('es-ES') + 'â‚¬';
        return Math.round(v).toLocaleString('es-ES');
    };
    
    // Nombre del mes actual
    const nombresMeses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    const mesActual = new Date().getMonth();
    const nombreMesActual = nombresMeses[mesActual];
    
    // ğŸ†• AÃ‘O ANTERIOR Y AÃ‘O ANTERIOR A LA FECHA (ponderado)
    const anoAnterior = kpi.anoAnterior || 0;
    const hoy = new Date();
    const diasTranscurridos = Math.ceil((hoy - new Date(hoy.getFullYear(), 0, 1)) / (1000 * 60 * 60 * 24));
    const factorTiempo = diasTranscurridos / 365;
    const anoAnteriorAFecha = anoAnterior * factorTiempo; // Ponderado a la fecha
    
    const diffVsAnoAnterior = kpi.realizado - anoAnterior;
    const diffVsAnoAnteriorAFecha = kpi.realizado - anoAnteriorAFecha;
    const pctVsAnoAnterior = anoAnterior > 0 ? ((diffVsAnoAnterior / anoAnterior) * 100) : 0;
    const pctVsAnoAnteriorAFecha = anoAnteriorAFecha > 0 ? ((diffVsAnoAnteriorAFecha / anoAnteriorAFecha) * 100) : 0;
    const colorAnoAntFecha = diffVsAnoAnteriorAFecha >= 0 ? '#22c55e' : '#ff6b6b';
    const iconoAnoAnt = diffVsAnoAnteriorAFecha >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
    
    return `
        <div onclick="mostrarDetalleKPI('${kpi.key}')" 
             style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 12px; padding: 14px; position: relative; overflow: hidden; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;"
             onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.3)'"
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
            <!-- Barra de progreso de fondo -->
            <div style="position: absolute; bottom: 0; left: 0; width: 100%; height: ${Math.min(kpi.cumplimientoFecha, 100)}%; background: ${color}; opacity: 0.08;"></div>
            
            <div style="position: relative; z-index: 1;">
                <!-- TÃ­tulo y % -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div style="font-size: 0.85em; color: #aaa; font-weight: 600;">${kpi.nombre}</div>
                    <div style="font-size: 0.85em; color: ${color}; font-weight: bold;">
                        ${kpi.cumplimientoFecha.toFixed(0)}% a la fecha
                    </div>
                </div>
                
                <!-- REALIZADO GRANDE -->
                <div style="display: flex; align-items: baseline; gap: 10px; margin-bottom: 10px;">
                    <div style="font-size: 2em; font-weight: 900; color: var(--color-text-primary);">
                        ${fmt(kpi.realizado)}
                    </div>
                    <div style="font-size: 0.9em; color: ${colorDif};">
                        ${iconoDir} ${fmt(Math.abs(kpi.diferencia))} vs fecha
                    </div>
                </div>
                
                <!-- ğŸ†• COMPARATIVA AÃ‘O ANTERIOR A LA FECHA -->
                ${anoAnterior > 0 ? `
                <div style="background: linear-gradient(135deg, rgba(102,126,234,0.15), rgba(102,126,234,0.05)); padding: 8px 10px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <div style="font-size: 0.75em; color: #667eea;">
                            ${iconoAnoAnt} vs AÃ±o Anterior (a la fecha)
                        </div>
                        <span style="font-size: 0.85em; font-weight: bold; color: ${colorAnoAntFecha};">
                            ${pctVsAnoAnteriorAFecha >= 0 ? '+' : ''}${pctVsAnoAnteriorAFecha.toFixed(0)}%
                        </span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.72em; color: #888;">
                        <span>AÃ±o ant. a fecha: ${fmt(anoAnteriorAFecha)}</span>
                        <span>Total ${new Date().getFullYear()-1}: ${fmt(anoAnterior)}</span>
                    </div>
                </div>
                ` : ''}
                
                <!-- ğŸ”¥ OBJETIVO ESTE MES -->
                <div style="background: linear-gradient(135deg, rgba(255,107,107,0.2), rgba(255,107,107,0.05)); padding: 10px 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(255,107,107,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 0.75em; color: #ff6b6b; font-weight: bold;">ğŸ¯ OBJETIVO ${nombreMesActual.toUpperCase()}</div>
                            <div style="font-size: 1.4em; font-weight: 900; color: var(--color-text-primary);">
                                ${fmt(kpi.objetivoEsteMes)}
                            </div>
                        </div>
                        ${kpi.deficitArrastrado > 0 ? `
                            <div style="text-align: right;">
                                <div style="font-size: 0.7em; color: #888;">Base: ${fmt(kpi.objetivoMesBase)}</div>
                                <div style="font-size: 0.7em; color: #ff6b6b;">+ DÃ©ficit: ${fmt(kpi.deficitArrastrado)}</div>
                            </div>
                        ` : `
                            <div style="font-size: 0.75em; color: #22c55e;">âœ“ Sin dÃ©ficit</div>
                        `}
                    </div>
                </div>
                
                <!-- Desglose adicional -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; font-size: 0.72em;">
                    <div style="background: rgba(102,126,234,0.12); padding: 6px 8px; border-radius: 6px;">
                        <div style="color: #667eea; font-weight: bold;">ğŸ“… Obj. Fecha</div>
                        <div style="color: var(--color-text-primary);">${fmt(kpi.objetivoFecha)}</div>
                    </div>
                    <div style="background: rgba(255,215,0,0.12); padding: 6px 8px; border-radius: 6px;">
                        <div style="color: #ffd700; font-weight: bold;">ğŸ¯ Obj. Anual</div>
                        <div style="color: var(--color-text-primary);">${fmt(kpi.objetivoAnual)}</div>
                    </div>
                    <div style="background: rgba(0,188,212,0.12); padding: 6px 8px; border-radius: 6px;">
                        <div style="color: #00bcd4; font-weight: bold;">ğŸ”® ProyecciÃ³n</div>
                        <div style="color: var(--color-text-primary);">${fmt(kpi.proyeccion)}</div>
                    </div>
                    <div style="background: rgba(156,39,176,0.12); padding: 6px 8px; border-radius: 6px;">
                        <div style="color: #9c27b0; font-weight: bold;">ğŸ“Š Falta AÃ±o</div>
                        <div style="color: var(--color-text-primary);">${fmt(kpi.faltaParaAnio)}</div>
                    </div>
                </div>
                
                <!-- Info meses restantes si hay dÃ©ficit -->
                ${kpi.faltaParaAnio > 0 && kpi.mesesRestantes > 0 ? `
                    <div style="margin-top: 8px; padding: 6px 10px; background: rgba(156,39,176,0.15); border-radius: 6px; font-size: 0.72em; text-align: center;">
                        <span style="color: #9c27b0;">ğŸ“† Para cumplir el aÃ±o: <strong>${fmt(kpi.objetivoMensualRestante)}/mes</strong> x ${kpi.mesesRestantes} meses</span>
                    </div>
                ` : ''}
                
                <!-- Barra de progreso anual -->
                <div style="margin-top: 10px;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.7em; color: #888; margin-bottom: 3px;">
                        <span>Progreso Anual</span>
                        <span>${kpi.cumplimientoAnual.toFixed(0)}%</span>
                    </div>
                    <div style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                        <div style="width: ${Math.min(kpi.cumplimientoAnual, 100)}%; height: 100%; background: ${color};"></div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// ===== FUNCIONES AUXILIARES =====

function renderMetricaDestacada(titulo, valor, unidad, color) {
    const fmt = unidad === 'â‚¬' ? Math.round(valor || 0).toLocaleString('es-ES') + 'â‚¬' : Math.round(valor || 0).toLocaleString('es-ES');
    return `
        <div style="background: ${color}15; padding: 15px; border-radius: 12px; border: 1px solid ${color}33; text-align: center;">
            <div style="font-size: 0.75em; color: #aaa;">${titulo}</div>
            <div style="font-size: 1.5em; font-weight: 900; color: ${color}; margin-top: 5px;">${fmt}</div>
        </div>
    `;
}

function renderComparativaAnterior(titulo, actual, anterior) {
    const diff = (actual || 0) - (anterior || 0);
    const pct = anterior > 0 ? ((diff / anterior) * 100).toFixed(1) : 0;
    const color = diff >= 0 ? '#22c55e' : '#ff6b6b';
    const icono = diff >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
    
    return `
        <div style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 10px; padding: 12px; text-align: center;">
            <div style="font-size: 0.75em; color: #aaa;">${titulo}</div>
            <div style="font-size: 1.8em; margin: 5px 0;">${icono}</div>
            <div style="font-size: 1.1em; color: ${color}; font-weight: bold;">${pct >= 0 ? '+' : ''}${pct}%</div>
            <div style="font-size: 0.7em; color: #666;">${Math.round(actual || 0).toLocaleString('es-ES')} vs ${Math.round(anterior || 0).toLocaleString('es-ES')}</div>
        </div>
    `;
}

function renderRatioCardMini(titulo, valor, unidad) {
    return `
        <div style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 10px; padding: 12px; text-align: center;">
            <div style="font-size: 0.75em; color: #aaa;">${titulo}</div>
            <div style="font-size: 1.5em; font-weight: 900; color: #667eea; margin-top: 5px;">${(valor || 0).toFixed(1)}${unidad}</div>
        </div>
    `;
}

function generarPuntosFuertesAuto(kpis) {
    const fuertes = kpis
        .filter(k => k.cumplimientoFecha >= 80)
        .sort((a, b) => b.cumplimientoFecha - a.cumplimientoFecha)
        .slice(0, 4);
    
    if (fuertes.length === 0) {
        return '<div style="color: #888; font-style: italic;">Trabajando para alcanzar objetivos...</div>';
    }
    
    return fuertes.map(k => `
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <span>âœ…</span>
            <span style="flex: 1; font-size: 0.9em;">${k.nombre.replace(/^.{1,2}\s/, '')}</span>
            <span style="color: #22c55e; font-weight: bold; font-size: 0.9em;">${k.cumplimientoFecha.toFixed(0)}%</span>
        </div>
    `).join('');
}

function generarAreasMejoraAuto(kpis) {
    const mejoras = kpis
        .filter(k => k.cumplimientoFecha < 70 && k.objetivoAnual > 0)
        .sort((a, b) => a.cumplimientoFecha - b.cumplimientoFecha)
        .slice(0, 4);
    
    if (mejoras.length === 0) {
        return '<div style="color: #22c55e; font-style: italic;">Â¡Sin Ã¡reas crÃ­ticas! ğŸ‰</div>';
    }
    
    return mejoras.map(k => `
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <span>âš ï¸</span>
            <span style="flex: 1; font-size: 0.9em;">${k.nombre.replace(/^.{1,2}\s/, '')}</span>
            <span style="color: #ff6b6b; font-weight: bold; font-size: 0.9em;">${k.cumplimientoFecha.toFixed(0)}%</span>
        </div>
    `).join('');
}

function renderizarGraficoDetalleAgente(canvasId, agente, kpiKey, hist) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    
    if (chartInstances[canvasId]) {
        chartInstances[canvasId].destroy();
    }
    
    // âœ… FORZAR LABELS EN ORDEN CORRECTO
    const labels = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    
    const evol = agente.evolucionMensual;
    
    // Obtener datos y verificar orden
    let dataReal = new Array(12).fill(0);
    let dataObj = new Array(12).fill(0);
    
    if (evol && evol[kpiKey]) {
        const labelsBackend = evol.labels || [];
        
        if (labelsBackend.length > 0 && labelsBackend[0] === 'Dic') {
            // Reordenar
            const realOrig = evol[kpiKey].realizado || [];
            const objOrig = evol[kpiKey].objetivo || [];
            
            if (realOrig.length === 12) {
                dataReal = [...realOrig.slice(1), realOrig[0]];
            }
            if (objOrig.length === 12) {
                dataObj = [...objOrig.slice(1), objOrig[0]];
            }
        } else {
            dataReal = evol[kpiKey].realizado || new Array(12).fill(0);
            dataObj = evol[kpiKey].objetivo || new Array(12).fill(0);
        }
    }
    
    // HistÃ³rico del aÃ±o anterior
    let dataHist = new Array(12).fill(0);
    if (hist) {
        const mapKeys = {
    'gci': 'gci',
    'citasCaptacion': 'citasCapt',
    'exclusivasVenta': 'exclVenta',
    'exclusivasComprador': 'exclComp',
    'captacionesAbierto': 'captAbierto',
    'captacionesAlquiler': 'captAlquiler',
    'citasCompradores': 'citasComp',
    'casasEnsenadas': 'visitas',
    'llamadas': 'llamadas',
    'leadVendedor': 'leadVendedor',
    'leadComprador': 'leadComprador',
    'leadsCompradores': 'leadsCompradores',
    'tresBs': 'tresBs',
    'bajadasPrecio': 'bajadasPrecio',
    'propuestasCompra': 'propuestas',
    'leadSeguimiento': 'leadSeguimiento',
    'arras': 'arras',
    'ventas': 'ventas',
    'volumenNegocio': 'volumenNegocio'
};
        const histKey = mapKeys[kpiKey];
        if (histKey && hist[histKey]) {
            const valorMensual = hist[histKey] / 12;
            dataHist = new Array(12).fill(valorMensual);
        }
    }
    
    const datasets = [
        { label: 'Realizado', data: dataReal, backgroundColor: 'rgba(0, 255, 136, 0.7)', borderColor: '#22c55e', borderWidth: 2, order: 3 }
    ];
    
    if (dataHist.reduce((a, b) => a + b, 0) > 0) {
        datasets.push({ label: 'AÃ±o Anterior', data: dataHist, backgroundColor: 'rgba(102, 126, 234, 0.5)', borderColor: '#667eea', borderWidth: 1, order: 2 });
    }
    
    datasets.push({ label: 'Objetivo', data: dataObj, type: 'line', borderColor: '#ffd700', borderWidth: 2, pointRadius: 3, tension: 0.3, order: 1 });
    
    chartInstances[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: { labels: labels, datasets: datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { font: { size: 9 } } },
                x: { grid: { display: false }, ticks: { font: { size: 9 } } }
            },
            plugins: { legend: { display: true, position: 'top', labels: { font: { size: 9 }, boxWidth: 10 } } }
        }
    });
}

// --- FUNCIÃ“N DE DIBUJO DEL GRÃFICO COMPARATIVO AGENTE ---
// --- GRÃFICO COMPARATIVO AGENTE (8 MÃ‰TRICAS - ESTILO GLOBAL) ---
function crearGraficoComparativoAgente(canvasId, agente, hist, factor) {
    const ctx = document.getElementById(canvasId);
    if(!ctx) return;
    if(chartInstances[canvasId]) chartInstances[canvasId].destroy();

    // 1. Calcular Ventas Reales (Cierres) del Agente
    // Buscamos en la lista global de transacciones cuÃ¡ntas pertenecen a este agente
    const ventasReales = window.transaccionesGlobales ? 
        window.transaccionesGlobales.filter(t => t.agente === agente.agente).length : 0;

    // 2. Preparar Datos Actuales (2025 Real YTD)
    const r = agente.realizado;
    const dataActual = [
        r.citasCaptacion || 0,
        r.exclusivasVenta || 0,
        r.captacionesAbierto || 0,
        r.citasCompradores || 0,
        r.exclusivasComprador || 0,
        r.casasEnsenadas || 0,
        ventasReales,
        r.gci || 0 // GCI al final
    ];

    // 3. Preparar Datos HistÃ³ricos (2024 Ponderado)
    // Aplicamos el factor tiempo a todo para comparar "peras con peras"
    const h = hist;
    const dataMeta = [
        (h.citasCapt || 0) * factor,
        (h.exclVenta || 0) * factor,
        (h.captAbierto || 0) * factor,
        (h.citasComp || 0) * factor,
        (h.exclComp || 0) * factor,
        (h.visitas || 0) * factor,
        (h.ventas || 0) * factor,
        (h.gci || 0) * factor
    ];

    const labels = ['Citas Capt', 'Excl Venta', 'Abierto', 'Citas Comp', 'Excl Comp', 'Visitas', 'Ventas', 'GCI (â‚¬)'];

    // 4. ConfiguraciÃ³n del GrÃ¡fico
    chartInstances[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Real 2025 (YTD)',
                    data: dataActual,
                    // Pintamos el GCI de azul y el resto de verde para diferenciar dinero de unidades
                    backgroundColor: (c) => c.dataIndex === 7 ? 'rgba(102, 126, 234, 0.8)' : 'rgba(0, 255, 136, 0.8)',
                    borderWidth: 0,
                    yAxisID: 'y'
                },
                {
                    label: 'AÃ±o Pasado (Ponderado)',
                    data: dataMeta,
                    backgroundColor: 'rgba(255, 255, 255, 0.15)', // Gris transparente
                    borderColor: '#aaa',
                    borderWidth: 1,
                    borderDash: [5, 5], // LÃ­nea discontinua para indicar "referencia"
                    yAxisID: 'y'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { // Eje Izquierdo: VOLUMEN
                    type: 'linear',
                    position: 'left',
                    beginAtZero: true,
                    title: { display: true, text: 'Unidades' },
                    grid: { color: 'rgba(255,255,255,0.05)' }
                },
                y1: { // Eje Derecho: DINERO (GCI)
                    type: 'linear',
                    position: 'right',
                    beginAtZero: true,
                    grid: { drawOnChartArea: false }, // Limpiamos el fondo
                    ticks: { callback: (v) => v/1000 + 'kâ‚¬' } // Formato miles
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: (c) => {
                            let val = c.raw;
                            // Formato moneda solo para el Ãºltimo dato (GCI)
                            if(c.dataIndex === 7) return c.dataset.label + ': ' + val.toLocaleString('es-ES', {maximumFractionDigits:0}) + 'â‚¬';
                            return c.dataset.label + ': ' + Math.round(val);
                        },
                        footer: (items) => {
                            // Calcular % Crecimiento en el tooltip
                            if(items.length < 2) return "";
                            const act = items[0].raw;
                            const meta = items[1].raw;
                            if(meta > 0) {
                                const pct = ((act - meta) / meta) * 100;
                                return `Crecimiento: ${pct > 0 ? '+' : ''}${pct.toFixed(1)}%`;
                            }
                            return "";
                        }
                    }
                }
            }
        }
    });

    // TRUCO VISUAL: Separar el GCI al eje derecho (y1)
    // Chart.js dibuja todo en 'y' por defecto. Forzamos al GCI a usar 'y1' visualmente ocultando su barra en 'y' y creando un dataset falso solo para Ã©l si fuera necesario, 
    // pero con esta configuraciÃ³n de doble eje y escalas automÃ¡ticas suele ajustarse bien.
    // Si ves que el GCI "aplasta" a las otras barras, usa este ajuste final:
    
    const chart = chartInstances[canvasId];
    // Creamos datasets separados para GCI para asignarlos al eje Y1
    chart.data.datasets = [
        {
            label: 'Actividad (Unidades)',
            data: dataActual.map((v,i) => i===7 ? null : v), // Todo menos GCI
            backgroundColor: 'rgba(0, 255, 136, 0.8)',
            yAxisID: 'y',
            order: 1
        },
        {
            label: 'Meta Actividad',
            data: dataMeta.map((v,i) => i===7 ? null : v),
            backgroundColor: 'rgba(255, 255, 255, 0.1)',
            borderColor: '#aaa', borderWidth: 1, borderDash:[5,5],
            yAxisID: 'y',
            order: 2
        },
        {
            label: 'GCI Real (â‚¬)',
            data: dataActual.map((v,i) => i===7 ? v : null), // Solo GCI
            backgroundColor: 'rgba(102, 126, 234, 0.9)',
            yAxisID: 'y1',
            order: 0
        },
        {
            label: 'GCI Pasado (â‚¬)',
            data: dataMeta.map((v,i) => i===7 ? v : null),
            backgroundColor: 'rgba(102, 126, 234, 0.2)',
            borderColor: '#667eea', borderWidth: 1,
            yAxisID: 'y1',
            order: 3
        }
    ];
    chart.update();
}
        
        function mostrarAnalisisComparativo(agentes) {    
            const modalBody = document.getElementById('modal-analisis-body');
            const kpiKeys = ['cumplimientoGlobal', 'gci', 'conversionCaptacion', 'ratioCierre', 'ticketPromedio', 'actividadTotal'];
            const labels = agentes.map(a => a.agente);

            modalBody.innerHTML = `
                <h2 style="text-align: center; margin-bottom: 30px; font-size: 2em;">âš–ï¸ Comparativa de Grupo</h2>
                <div class="chart-container" style="height: 60vh;">
                    <canvas id="modal-chart-detalle"></canvas>
                </div>
                <div class="tabla-container" style="margin-top: 20px;">
                    <table class="tabla">
                        <thead>
                            <tr>
                                <th>MÃ©trica</th>
                                ${labels.map(l => `<th>${l}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${kpiKeys.map(key => {
                                const meta = getKpiMetadata(key, 0);
                                return `
                                    <tr>
                                        <td style="text-align: left; font-weight: bold;">${meta.icon} ${meta.label}</td>
                                        ${agentes.map(a => {
                                            const kpiData = { ...a.ratios, ...a.realizado, cumplimientoGlobal: a.cumplimientoGlobal };
                                            const valor = kpiData[key] || 0;
                                            const valStr = meta.unidad === 'â‚¬' ? Math.round(valor).toLocaleString('es-ES') : valor.toFixed(1);
                                            return `<td class="${meta.thresholds ? getClase(valor, meta.thresholds.bueno, meta.thresholds.regular) : ''}">${valStr}${meta.unidad}</td>`
                                        }).join('')}
                                    </tr>
                                `
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('modal-analisis').classList.add('active');
            document.body.classList.add('modal-open');

            // Crear grÃ¡fico
            setTimeout(() => {
                const ctx = document.getElementById('modal-chart-detalle');
                if (!ctx) return;
                if (chartInstances['modal-chart-detalle']) chartInstances['modal-chart-detalle'].destroy();
                
                chartInstances['modal-chart-detalle'] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: kpiKeys.map(k => kpiNames[k] || k),
                        datasets: agentes.map((agente, index) => {
                            const baseColor = ['99, 132', '162, 235', '206, 86', '192, 192', '102, 255', '159, 64'][index % 6];
                            return {
                                label: agente.agente,
                                data: kpiKeys.map(key => {
                                    const kpiData = { ...agente.ratios, ...agente.realizado, cumplimientoGlobal: agente.cumplimientoGlobal };
                                    return kpiData[key] || 0;
                                }),
                                backgroundColor: `rgba(255, ${baseColor}, 0.8)`,
                                borderColor: `rgba(255, ${baseColor}, 1)`,
                                borderWidth: 1
                            }
                        })
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, type: 'logarithmic' },    
                            x: {}
                        }
                    }
                });
            }, 100);
        }


        // =========================================================
// ğŸ“Š FIX DEFINITIVO: GRÃFICO DE EQUIPO (SUMA EN TIEMPO REAL)
// =========================================================

function mostrarAnalisisEquipo(kpiKey) {
    const kpiLabel = kpiNames[kpiKey] || kpiKey;
    const modalBody = document.getElementById('modal-analisis-body');

    // ===== 1. LABELS SIEMPRE EN ORDEN CORRECTO =====
    const labels = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    
    // ===== 2. OBTENER DATOS REALIZADOS =====
    let realizadoMensual = new Array(12).fill(0);
    let objetivoMensualAgentes = new Array(12).fill(0);
    
    if (datosAgregadosEquipo && datosAgregadosEquipo[kpiKey]) {
        const datos = datosAgregadosEquipo[kpiKey];
        const labelsBackend = datosAgregadosEquipo.labels || [];
        
        if (labelsBackend.length > 0 && labelsBackend[0] === 'Dic') {
            console.log('âš ï¸ Reordenando datos de Dic-Nov a Ene-Dic');
            const realizadoOriginal = datos.realizado || [];
            const objetivoOriginal = datos.objetivo || [];
            
            if (realizadoOriginal.length === 12) {
                realizadoMensual = [...realizadoOriginal.slice(1), realizadoOriginal[0]];
            }
            if (objetivoOriginal.length === 12) {
                objetivoMensualAgentes = [...objetivoOriginal.slice(1), objetivoOriginal[0]];
            }
        } else {
            realizadoMensual = datos.realizado || new Array(12).fill(0);
            objetivoMensualAgentes = datos.objetivo || new Array(12).fill(0);
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ†• 3. OBTENER OBJETIVO: GLOBAL DE OFICINA O SUMA DE AGENTES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const mapeoClaves = {
        'gci': 'gci',
        'citasCaptacion': 'citasCaptacion',
        'exclusivasVenta': 'exclusivasVenta',
        'captacionesAbierto': 'captAbierto',
        'citasCompradores': 'citasComprador',
        'casasEnsenadas': 'casasEnsenadas',
        'exclusivasComprador': 'exclusivasCompr',
        'llamadas': 'llamadas',
        'volumenNegocio': 'volumenNegocio',
        'captacionesAlquiler': 'captAlquiler',
        'leadVendedor': 'leadVendedor',
        'tresBs': 'tresBs',
        'bajadasPrecio': 'bajadasPrecio',
        'leadComprador': 'leadComprador',
        'propuestasCompra': 'propuestasCompra',
        'leadSeguimiento': 'leadSeguimiento',
        'arras': 'arras',
        'totalTransacciones': 'ventas'
    };
    
    const claveModelo = mapeoClaves[kpiKey] || kpiKey;
    let objetivoAnual = 0;
    let fuenteObjetivo = 'agentes'; // Por defecto suma de agentes
    
    // Intentar objetivo global de oficina primero
    if (window.objetivosGlobalesOficina && 
        window.objetivosGlobalesOficina[claveModelo] !== null && 
        window.objetivosGlobalesOficina[claveModelo] !== undefined &&
        window.objetivosGlobalesOficina[claveModelo] !== '' &&
        parseFloat(window.objetivosGlobalesOficina[claveModelo]) > 0) {
        
        objetivoAnual = parseFloat(window.objetivosGlobalesOficina[claveModelo]);
        fuenteObjetivo = 'oficina';
        console.log(`ğŸ¢ ${kpiKey}: Usando objetivo GLOBAL de oficina = ${objetivoAnual}`);
    } else {
        // Fallback: suma de objetivos de agentes
        objetivoAnual = objetivoMensualAgentes.reduce((a, b) => a + b, 0);
        console.log(`ğŸ‘¥ ${kpiKey}: Usando SUMA de agentes = ${objetivoAnual}`);
    }
    
    // Distribuir objetivo anual en meses (uniforme o proporcional a agentes)
    let objetivoMensual = new Array(12).fill(0);
    if (objetivoAnual > 0) {
        if (fuenteObjetivo === 'oficina') {
            // DistribuciÃ³n uniforme para objetivo de oficina
            const objetivoMesBase = objetivoAnual / 12;
            objetivoMensual = new Array(12).fill(objetivoMesBase);
        } else {
            // Usar distribuciÃ³n de agentes
            objetivoMensual = objetivoMensualAgentes;
        }
    }
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    console.log('ğŸ“Š Labels:', labels);
    console.log('ğŸ“Š Realizado:', realizadoMensual);
    console.log('ğŸ“Š Objetivo (' + fuenteObjetivo + '):', objetivoMensual);
    
    // ===== 4. FACTOR TIEMPO =====
    const hoy = new Date();
    const inicioAnio = new Date(hoy.getFullYear(), 0, 1);
    const diasTranscurridos = Math.ceil((hoy - inicioAnio) / (1000 * 60 * 60 * 24));
    const diasEnAnio = 365;
    const factorTiempo = Math.max(diasTranscurridos / diasEnAnio, 0.01);
    const mesActual = hoy.getMonth();
    
    const nombresMeses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    const nombreMesActual = nombresMeses[mesActual];

    // ===== 5. CALCULAR TOTALES =====
    const realizadoTotal = realizadoMensual.reduce((a, b) => a + b, 0);
    const objetivoMesBase = objetivoAnual / 12;
    const objetivoFecha = objetivoAnual * factorTiempo;
    
    // ===== 6. CALCULAR DÃ‰FICIT ACUMULADO =====
    let deficitArrastrado = 0;
    for (let m = 0; m < mesActual; m++) {
        const objMes = objetivoMensual[m] || objetivoMesBase;
        const realMes = realizadoMensual[m] || 0;
        
        if (realMes < objMes) {
            deficitArrastrado += (objMes - realMes);
        }
    }
    
    const objetivoEsteMes = (objetivoMensual[mesActual] || objetivoMesBase) + deficitArrastrado;
    const realizadoEsteMes = realizadoMensual[mesActual] || 0;
    
    // ===== 7. CÃLCULOS ADICIONALES =====
    const faltaParaAnio = Math.max(objetivoAnual - realizadoTotal, 0);
    const mesesRestantes = 12 - mesActual;
    const objetivoMensualRestante = mesesRestantes > 0 ? faltaParaAnio / mesesRestantes : 0;
    const proyeccion = factorTiempo > 0 ? realizadoTotal / factorTiempo : 0;
    
    const cumplimientoFecha = objetivoFecha > 0 ? (realizadoTotal / objetivoFecha) * 100 : 0;
    const cumplimientoAnual = objetivoAnual > 0 ? (realizadoTotal / objetivoAnual) * 100 : 0;
    const cumplimientoMes = objetivoEsteMes > 0 ? (realizadoEsteMes / objetivoEsteMes) * 100 : 0;
    
    const diferencia = realizadoTotal - objetivoFecha;
    
    const colorCumplimiento = cumplimientoFecha >= 90 ? '#22c55e' : cumplimientoFecha >= 70 ? '#ffd700' : '#ff6b6b';
    const colorDiferencia = diferencia >= 0 ? '#22c55e' : '#ff6b6b';
    const iconoDiferencia = diferencia >= 0 ? 'â–²' : 'â–¼';
    
    // ===== 8. HISTÃ“RICO AÃ‘O ANTERIOR =====
    let historicoTotal = 0;
    let historicoMensual = new Array(12).fill(0);
    let tieneHistorico = false;

    if (facturacionPasadaGlobal && facturacionPasadaGlobal.kpis) {
        const mapKeys = {
            'gci': 'gci',
            'citasCaptacion': 'citasCaptacion',
            'exclusivasVenta': 'exclusivasVenta',
            'captacionesAbierto': 'captAbierto',
            'citasCompradores': 'citasComprador',
            'exclusivasComprador': 'exclusivasCompr',
            'casasEnsenadas': 'casasEnsenadas',
            'totalTransacciones': 'ventas',
            'llamadas': 'llamadas',
            'captacionesAlquiler': 'captAlquiler',
            'leadVendedor': 'leadVendedor',
            'tresBs': 'tresBs',
            'bajadasPrecio': 'bajadasPrecio',
            'leadComprador': 'leadComprador',
            'propuestasCompra': 'propuestasCompra',
            'leadSeguimiento': 'leadSeguimiento',
            'arras': 'arras',
            'ventas': 'ventas',
            'volumenNegocio': 'volumenNegocio'
        };
        
        const histKey = mapKeys[kpiKey];
        if (histKey && facturacionPasadaGlobal.kpis[histKey] !== undefined) {
            historicoTotal = facturacionPasadaGlobal.kpis[histKey] || 0;
            const valorMensual = historicoTotal / 12;
            historicoMensual = new Array(12).fill(valorMensual);
            tieneHistorico = historicoTotal > 0;
        }
    }
    
    let pctCrecimiento = 0;
    let colorCrecimiento = '#888';
    if (tieneHistorico && historicoTotal > 0) {
        pctCrecimiento = ((proyeccion - historicoTotal) / historicoTotal) * 100;
        colorCrecimiento = pctCrecimiento >= 0 ? '#22c55e' : '#ff6b6b';
    }

    // ===== 9. FORMATEAR NÃšMEROS =====
    const esMoneda = kpiKey === 'gci' || kpiKey === 'volumenNegocio';
    const fmt = (v) => {
        const num = Math.round(v || 0);
        return esMoneda ? num.toLocaleString('es-ES') + 'â‚¬' : num.toLocaleString('es-ES');
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ†• Indicador de fuente del objetivo
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const iconoFuente = fuenteObjetivo === 'oficina' ? 'ğŸ¢' : 'ğŸ‘¥';
    const textoFuente = fuenteObjetivo === 'oficina' ? 'Objetivo Oficina' : 'Suma Agentes';

    // ===== 10. RENDERIZAR HTML =====
    modalBody.innerHTML = `
        <!-- HEADER -->
        <div style="background: linear-gradient(135deg, rgba(102,126,234,0.15), rgba(255,107,107,0.15)); padding: 25px; border-radius: 20px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 20px;">
                <div>
                    <h1 style="margin: 0; font-size: 2em; color: var(--color-text-primary);">ğŸ“Š ${kpiLabel}</h1>
                    <div style="font-size: 0.95em; color: #aaa; margin-top: 5px;">Equipo Completo | DÃ­a ${diasTranscurridos} de ${diasEnAnio} (${(factorTiempo * 100).toFixed(1)}% del aÃ±o)</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.85em; color: #aaa;">CUMPLIMIENTO A LA FECHA</div>
                    <div style="font-size: 3.5em; font-weight: 900; color: ${colorCumplimiento}; line-height: 1;">
                        ${cumplimientoFecha.toFixed(0)}%
                    </div>
                    <div style="width: 160px; height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; margin-top: 8px;">
                        <div style="width: ${Math.min(cumplimientoFecha, 100)}%; height: 100%; background: ${colorCumplimiento}; border-radius: 10px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MÃ‰TRICAS PRINCIPALES -->
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 20px;">
            <div style="background: rgba(0,255,136,0.15); padding: 15px; border-radius: 12px; border: 1px solid rgba(0,255,136,0.3); text-align: center;">
                <div style="font-size: 0.75em; color: #aaa;">âœ… REALIZADO</div>
                <div style="font-size: 1.6em; font-weight: 900; color: #22c55e; margin-top: 5px;">${fmt(realizadoTotal)}</div>
                <div style="font-size: 0.75em; color: ${colorDiferencia}; margin-top: 3px;">${iconoDiferencia} ${fmt(Math.abs(diferencia))} vs fecha</div>
            </div>
            <div style="background: rgba(102,126,234,0.15); padding: 15px; border-radius: 12px; border: 1px solid rgba(102,126,234,0.3); text-align: center;">
                <div style="font-size: 0.75em; color: #aaa;">ğŸ“… OBJ. FECHA</div>
                <div style="font-size: 1.6em; font-weight: 900; color: #667eea; margin-top: 5px;">${fmt(objetivoFecha)}</div>
            </div>
            <div style="background: rgba(255,215,0,0.15); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,215,0,0.3); text-align: center;">
                <div style="font-size: 0.75em; color: #aaa;">${iconoFuente} OBJ. ANUAL</div>
                <div style="font-size: 1.6em; font-weight: 900; color: #ffd700; margin-top: 5px;">${fmt(objetivoAnual)}</div>
                <div style="font-size: 0.65em; color: #888; margin-top: 3px;">${textoFuente}</div>
            </div>
            <div style="background: rgba(0,188,212,0.15); padding: 15px; border-radius: 12px; border: 1px solid rgba(0,188,212,0.3); text-align: center;">
                <div style="font-size: 0.75em; color: #aaa;">ğŸ”® PROYECCIÃ“N</div>
                <div style="font-size: 1.6em; font-weight: 900; color: #00bcd4; margin-top: 5px;">${fmt(proyeccion)}</div>
                ${tieneHistorico ? `<div style="font-size: 0.7em; color: ${colorCrecimiento}; margin-top: 3px;">${pctCrecimiento >= 0 ? '+' : ''}${pctCrecimiento.toFixed(1)}% vs aÃ±o ant.</div>` : ''}
            </div>
            <div style="background: rgba(156,39,176,0.15); padding: 15px; border-radius: 12px; border: 1px solid rgba(156,39,176,0.3); text-align: center;">
                <div style="font-size: 0.75em; color: #aaa;">ğŸ“Š FALTA AÃ‘O</div>
                <div style="font-size: 1.6em; font-weight: 900; color: #9c27b0; margin-top: 5px;">${fmt(faltaParaAnio)}</div>
            </div>
        </div>

        <!-- ğŸ”¥ OBJETIVO ESTE MES (DESTACADO) -->
        <div style="background: linear-gradient(135deg, rgba(255,107,107,0.2), rgba(255,107,107,0.05)); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid rgba(255,107,107,0.4);">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div>
                    <div style="font-size: 0.9em; color: #ff6b6b; font-weight: bold;">ğŸ¯ OBJETIVO ${nombreMesActual.toUpperCase()} (con dÃ©ficit acumulado)</div>
                    <div style="font-size: 2.5em; font-weight: 900; color: var(--color-text-primary); margin-top: 5px;">
                        ${fmt(objetivoEsteMes)}
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.8em; color: #888;">Base mensual: <strong>${fmt(objetivoMensual[mesActual] || objetivoMesBase)}</strong></div>
                    ${deficitArrastrado > 0 ? `<div style="font-size: 0.8em; color: #ff6b6b;">+ DÃ©ficit arrastrado: <strong>${fmt(deficitArrastrado)}</strong></div>` : '<div style="font-size: 0.8em; color: #22c55e;">âœ“ Sin dÃ©ficit acumulado</div>'}
                </div>
                <div style="background: rgba(0,0,0,0.2); padding: 15px 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.75em; color: #aaa;">REALIZADO ESTE MES</div>
                    <div style="font-size: 1.8em; font-weight: 900; color: ${cumplimientoMes >= 80 ? '#22c55e' : cumplimientoMes >= 50 ? '#ffd700' : '#ff6b6b'};">
                        ${fmt(realizadoEsteMes)}
                    </div>
                    <div style="font-size: 0.8em; color: #888;">${cumplimientoMes.toFixed(0)}% del objetivo</div>
                </div>
            </div>
        </div>

        <!-- INFO MESES RESTANTES -->
        ${faltaParaAnio > 0 && mesesRestantes > 0 ? `
            <div style="background: rgba(156,39,176,0.15); padding: 12px 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                <span style="color: #9c27b0; font-size: 0.95em;">
                    ğŸ“† Para cumplir el objetivo anual: <strong>${fmt(objetivoMensualRestante)}</strong> por mes durante los prÃ³ximos <strong>${mesesRestantes}</strong> meses
                </span>
            </div>
        ` : ''}

        <!-- GRÃFICO PRINCIPAL -->
        <div class="section-title">ğŸ“ˆ EvoluciÃ³n Mensual</div>
        <div class="chart-container" style="height: 400px; background: var(--color-surface); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <canvas id="modal-chart-detalle"></canvas>
        </div>

        <!-- DESGLOSE MENSUAL -->
        <div class="section-title">ğŸ“‹ Desglose por Mes</div>
        <div style="overflow-x: auto; margin-bottom: 20px;">
            <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                <thead>
                    <tr style="background: var(--color-surface);">
                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid var(--color-border);">Mes</th>
                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid var(--color-border);">Objetivo</th>
                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid var(--color-border);">Realizado</th>
                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid var(--color-border);">Diferencia</th>
                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid var(--color-border);">Cumpl.</th>
                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid var(--color-border);">Acumulado</th>
                    </tr>
                </thead>
                <tbody>
                    ${generarFilasDesgloseMensual(labels, objetivoMensual, realizadoMensual, objetivoMesBase, mesActual, esMoneda)}
                </tbody>
            </table>
        </div>

        <!-- COMPARATIVA AÃ‘O ANTERIOR -->
        ${tieneHistorico ? `
            <div class="section-title">ğŸ“Š Comparativa vs AÃ±o Anterior</div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                <div style="background: var(--color-surface); padding: 15px; border-radius: 12px; text-align: center; border: 1px solid var(--color-border);">
                    <div style="font-size: 0.8em; color: #aaa;">AÃ±o Actual (ProyecciÃ³n)</div>
                    <div style="font-size: 1.6em; font-weight: 900; color: #22c55e; margin: 10px 0;">${fmt(proyeccion)}</div>
                </div>
                <div style="background: var(--color-surface); padding: 15px; border-radius: 12px; text-align: center; border: 1px solid var(--color-border);">
                    <div style="font-size: 0.8em; color: #aaa;">AÃ±o Anterior</div>
                    <div style="font-size: 1.6em; font-weight: 900; color: #667eea; margin: 10px 0;">${fmt(historicoTotal)}</div>
                </div>
                <div style="background: var(--color-surface); padding: 15px; border-radius: 12px; text-align: center; border: 1px solid var(--color-border);">
                    <div style="font-size: 0.8em; color: #aaa;">Crecimiento</div>
                    <div style="font-size: 1.6em; font-weight: 900; color: ${colorCrecimiento}; margin: 10px 0;">
                        ${pctCrecimiento >= 0 ? '+' : ''}${pctCrecimiento.toFixed(1)}%
                    </div>
                </div>
            </div>
        ` : ''}

        ${getKpiLegend(kpiKey)}
    `;

    abrirModalEncima('modal-analisis');

    // ===== 11. PINTAR GRÃFICO =====
    setTimeout(() => {
        const ctx = document.getElementById('modal-chart-detalle');
        if (!ctx) return;
        
        if (chartInstances['modal-chart-detalle']) {
            chartInstances['modal-chart-detalle'].destroy();
        }
        
        const datasets = [
            {
                label: 'âœ… Realizado',
                data: realizadoMensual,
                backgroundColor: 'rgba(0, 255, 136, 0.8)',
                borderColor: '#22c55e',
                borderWidth: 2,
                order: 3,
                barThickness: 'flex',
                maxBarThickness: 40
            }
        ];
        
        if (tieneHistorico) {
            datasets.push({
                label: 'ğŸ“Š AÃ±o Anterior',
                data: historicoMensual,
                backgroundColor: 'rgba(102, 126, 234, 0.6)',
                borderColor: '#667eea',
                borderWidth: 2,
                order: 2,
                barThickness: 'flex',
                maxBarThickness: 40
            });
        }
        
        datasets.push({
            label: `ğŸ¯ Objetivo (${textoFuente})`,
            data: objetivoMensual,
            type: 'line',
            borderColor: '#ffd700',
            borderWidth: 3,
            pointRadius: 5,
            pointBackgroundColor: '#ffd700',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            order: 1,
            tension: 0.3
        });
        
        chartInstances['modal-chart-detalle'] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        grid: { 
                            color: 'rgba(255,255,255,0.05)',
                            lineWidth: 1
                        },
                        ticks: {
                            color: 'var(--color-text-secondary)',
                            font: { size: 12, weight: '600' },
                            callback: function(value) {
                                return value.toLocaleString('es-ES', {maximumFractionDigits:0});
                            }
                        }
                    },
                    x: { 
                        grid: { display: false },
                        ticks: {
                            color: 'var(--color-text-primary)',
                            font: { size: 13, weight: 'bold' }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: 'var(--color-text-primary)',
                            font: { size: 14, weight: 'bold' },
                            padding: 20,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.9)',
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 13 },
                        padding: 12,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                label += context.parsed.y.toLocaleString('es-ES', {maximumFractionDigits:0});
                                if (esMoneda) label += 'â‚¬';
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }, 200);
}

// ===== FUNCIÃ“N AUXILIAR: Generar tabla de desglose mensual =====
function generarFilasDesgloseMensual(labels, objetivoMensual, realizadoMensual, objetivoMesBase, mesActual, esMoneda) {
    let html = '';
    let acumuladoObj = 0;
    let acumuladoReal = 0;
    let deficitAcum = 0;
    
    const fmt = (v) => {
        const num = Math.round(v || 0);
        return esMoneda ? num.toLocaleString('es-ES') + 'â‚¬' : num.toLocaleString('es-ES');
    };
    
    for (let i = 0; i < 12; i++) {
        const obj = objetivoMensual[i] || objetivoMesBase;
        const real = realizadoMensual[i] || 0;
        const diff = real - obj;
        const cumpl = obj > 0 ? (real / obj) * 100 : 0;
        
        acumuladoObj += obj;
        acumuladoReal += real;
        
        // Calcular objetivo con dÃ©ficit para este mes
        const objConDeficit = obj + deficitAcum;
        
        // Actualizar dÃ©ficit para el siguiente mes
        if (real < objConDeficit) {
            deficitAcum = objConDeficit - real;
        } else {
            deficitAcum = 0;
        }
        
        const colorDiff = diff >= 0 ? '#22c55e' : '#ff6b6b';
        const colorCumpl = cumpl >= 90 ? '#22c55e' : cumpl >= 70 ? '#ffd700' : '#ff6b6b';
        const esActual = i === mesActual;
        const esFuturo = i > mesActual;
        
        html += `
            <tr style="background: ${esActual ? 'rgba(255,107,107,0.15)' : esFuturo ? 'rgba(255,255,255,0.02)' : 'transparent'}; ${esFuturo ? 'opacity: 0.5;' : ''}">
                <td style="padding: 8px 10px; border-bottom: 1px solid var(--color-border);">
                    ${esActual ? 'ğŸ‘‰ ' : ''}${labels[i]}
                    ${esActual ? '<span style="font-size:0.7em; color:#ff6b6b;"> (ACTUAL)</span>' : ''}
                </td>
                <td style="padding: 8px 10px; border-bottom: 1px solid var(--color-border); text-align: right;">
                    ${fmt(obj)}
                    ${deficitAcum > 0 && i === mesActual ? `<br><span style="font-size:0.7em; color:#ff6b6b;">+${fmt(deficitAcum)} dÃ©ficit</span>` : ''}
                </td>
                <td style="padding: 8px 10px; border-bottom: 1px solid var(--color-border); text-align: right; font-weight: bold;">
                    ${esFuturo ? '-' : fmt(real)}
                </td>
                <td style="padding: 8px 10px; border-bottom: 1px solid var(--color-border); text-align: right; color: ${colorDiff};">
                    ${esFuturo ? '-' : (diff >= 0 ? '+' : '') + fmt(diff)}
                </td>
                <td style="padding: 8px 10px; border-bottom: 1px solid var(--color-border); text-align: right; color: ${colorCumpl}; font-weight: bold;">
                    ${esFuturo ? '-' : cumpl.toFixed(0) + '%'}
                </td>
                <td style="padding: 8px 10px; border-bottom: 1px solid var(--color-border); text-align: right; font-size: 0.85em; color: #888;">
                    ${esFuturo ? '-' : fmt(acumuladoReal) + ' / ' + fmt(acumuladoObj)}
                </td>
            </tr>
        `;
    }
    
    // Fila de totales
    const diffTotal = acumuladoReal - acumuladoObj;
    const cumplTotal = acumuladoObj > 0 ? (acumuladoReal / acumuladoObj) * 100 : 0;
    
    html += `
        <tr style="background: var(--color-surface); font-weight: bold;">
            <td style="padding: 10px; border-top: 2px solid var(--color-border);">TOTAL</td>
            <td style="padding: 10px; border-top: 2px solid var(--color-border); text-align: right;">${fmt(acumuladoObj)}</td>
            <td style="padding: 10px; border-top: 2px solid var(--color-border); text-align: right; color: #22c55e;">${fmt(acumuladoReal)}</td>
            <td style="padding: 10px; border-top: 2px solid var(--color-border); text-align: right; color: ${diffTotal >= 0 ? '#22c55e' : '#ff6b6b'};">${(diffTotal >= 0 ? '+' : '') + fmt(diffTotal)}</td>
            <td style="padding: 10px; border-top: 2px solid var(--color-border); text-align: right; color: ${cumplTotal >= 90 ? '#22c55e' : cumplTotal >= 70 ? '#ffd700' : '#ff6b6b'};">${cumplTotal.toFixed(0)}%</td>
            <td style="padding: 10px; border-top: 2px solid var(--color-border);"></td>
        </tr>
    `;
    
    return html;
}

        function crearGraficoDetalle(canvasId, labels, dataRealizado, dataObjetivo, labelRealizado, labelObjetivo) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
            
            chartInstances[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: labelRealizado,
                            data: dataRealizado,
                            borderColor: 'var(--color-accent-good)',
                            backgroundColor: 'rgba(0, 255, 136, 0.2)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: labelObjetivo,
                            data: dataObjetivo,
                            borderColor: 'var(--color-accent-warn)',
                            borderDash: [5, 5],
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true },
                        x: {}
                    }
                }
            });
        }

        function getKpiLegend(kpiKey) {
            const meta = getKpiMetadata(kpiKey, 0);
            if (!meta.thresholds) return '';    

            const t = meta.thresholds;
            const unit = meta.unidad;

            return `
                <div class="kpi-legend">
                    <div class="kpi-legend-title">Leyenda de Ratio</div>
                    <div class="kpi-legend-item">
                        <div class="kpi-legend-color" style="background: var(--color-accent-good);"></div>
                        <div><strong>Bueno:</strong> &gt; ${t.bueno}${unit}</div>
                        </div>
                    <div class="kpi-legend-item">
                        <div class="kpi-legend-color" style="background: var(--color-accent-warn);"></div>
                        <div><strong>Regular:</strong> ${t.regular}${unit} - ${t.bueno}${unit}</div>
                    </div>
                    <div class="kpi-legend-item">
                        <div class="kpi-legend-color" style="background: var(--color-accent-bad);"></div>
                        <div><strong>Bajo:</strong> &lt; ${t.regular}${unit}</div>
                    </div>
                </div>
            `;
        }
        
        // ===================================
        // ===== VISTA AGENTE (REPARADA) =====
        // ===================================
        
        function poblarSelectorAgentes(selectId) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    // Limpiar opciones existentes excepto la primera (placeholder)
    const firstOption = select.querySelector('option:first-child');
    select.innerHTML = '';
    if (firstOption) select.appendChild(firstOption);
    
    // Cargar agentes
    google.script.run
        .withSuccessHandler(function(agentes) {
            if (!agentes || agentes.length === 0) {
                console.warn('No se encontraron agentes');
                return;
            }
            
            agentes.forEach(agente => {
                const option = document.createElement('option');
                option.value = agente[0]; // ID
                option.textContent = agente[1]; // Nombre
                select.appendChild(option);
            });
        })
        .withFailureHandler(function(error) {
            console.error('Error cargando agentes:', error);
        })
        .obtenerListaAgentes();
}
        
        function seleccionarAgente() {
            const select = document.getElementById('agent-select');
            const idAgente = select.value;
            const nombreAgente = select.options[select.selectedIndex]?.text || '';
            if (!idAgente) {
                document.getElementById('agent-content').style.display = 'none';
                return;
            }
            agenteActual = { id: idAgente, nombre: nombreAgente };
            document.getElementById('agent-subtitle').innerText = nombreAgente;
            document.getElementById('agent-content').style.display = 'block';
            document.getElementById('form-agent-id').value = idAgente;
            document.getElementById('form-agent-name').value = nombreAgente;
            document.getElementById('form-fecha').valueAsDate = new Date();
            
            filtrarDatosAgente('ano');
        }

        function filtrarDatosAgente(periodo) {
            periodoAgenteActual = periodo;
            agenteFechaInicio = null;
            agenteFechaFin = null;
            cerrarModal();    
            cargarDashboardAgente();
        }
        
        function aplicarFiltroAgenteCustom() {
            periodoAgenteActual = 'custom';
            agenteFechaInicio = document.getElementById('agente-fecha-inicio').value;
            agenteFechaFin = document.getElementById('agente-fecha-fin').value;
            
            cerrarModal();
            cargarDashboardAgente();
        }
        
        /**
         * [REPARACIÃ“N VISTA AGENTE]
         * Esta funciÃ³n ahora usa obtenerDatosDashboard (como la vista gerente) y filtra
         * los resultados en el cliente, evitando la funciÃ³n GS que fallaba (obtenerDatosAgenteCompleto).
         */
        function cargarDashboardAgente() {
            if (!agenteActual) {
                console.warn("No hay agente seleccionado.");
                return;
            }
            console.log(`ğŸ“Š Cargando dashboard para: ${agenteActual.nombre}, Periodo: ${periodoAgenteActual}`);
            const container = document.getElementById('agent-dashboard-content');
            if (!container) return;
            container.innerHTML = '<div class="loading"><div class="loader"></div><div>Cargando tu dashboard...</div></div>';
            
            const filtros = calcularFiltrosPeriodo(periodoAgenteActual, 'agente');
            
            // [REPARACIÃ“N LÃ“GICA] Llamar a la funciÃ³n que SÃ funciona (la del gerente)
            google.script.run
                .withSuccessHandler(function(datos) {
                    console.log('âœ… Datos (reales) del GERENTE recibidos:', datos);
                    
                    // [REPARACIÃ“N LÃ“GICA] Filtrar solo el agente actual
                    const datosDelAgente = datos.agentes.find(a => a.id === agenteActual.id);
                    
                    if (!datosDelAgente) {
                         throw new Error("No se encontraron datos para el ID " + agenteActual.id);
                    }
                    
                    datosAgenteCompletos = datosDelAgente; // Guardar solo los datos del agente
                    renderizarDashboardAgente();
                })
                .withFailureHandler(function(error) {
                    // [REPARACIÃ“N A] Muestra el error especÃ­fico del servidor en la interfaz
                    console.error('âŒ Error cargando datos del agente:', error);
                    container.innerHTML = `
                        <div class="section" style="text-align: center; padding: 40px; color: var(--color-accent-bad);">
                            <h2>âŒ Error de rendimiento</h2>
                            <p>No se pudieron cargar los datos.</p>
                            <p>Detalle: ${error.message || error}</p>
                            <button class="btn btn-refresh" onclick="cargarDashboardAgente()">ğŸ”„ REINTENTAR</button>
                        </div>
                    `;
                })
                .obtenerDatosDashboard(filtros); // <-- Llamada cambiada
        }
        
        function renderizarDashboardAgente() {
            const container = document.getElementById('agent-dashboard-content');
            if (!container) return;

            if (!datosAgenteCompletos || !datosAgenteCompletos.ratios) {
                container.innerHTML = `<div style="padding: 20px; text-align: center; color: var(--color-accent-bad);">Error: No se pudieron cargar los datos de rendimiento.</div>`;
                return;
            }
            
            // [REPARACIÃ“N CLAVE JS] Aseguramos que los 14 KPIs estÃ©n presentes y sean numÃ©ricos
            const agenteKpiData = {};
            Object.keys(kpiNames).forEach(key => {
                let valor = 0;
                if (key === 'cumplimientoGlobal') {
                    valor = parseFloat(datosAgenteCompletos.cumplimientoGlobal) || 0;
                } else if (datosAgenteCompletos.ratios.hasOwnProperty(key)) {
                    valor = datosAgenteCompletos.ratios[key];
                } else if (datosAgenteCompletos.realizado.hasOwnProperty(key)) {
                    valor = datosAgenteCompletos.realizado[key];
                }
                agenteKpiData[key] = isNaN(valor) || !isFinite(valor) ? 0 : valor; // Final safety check
            });
            
            const periodoLabel = periodoAgenteActual === 'custom' ? `de ${agenteFechaInicio} a ${agenteFechaFin}` : `del perÃ­odo: ${periodoAgenteActual.toUpperCase()}`;

            let html = `
                <div class="signos-vitales">
                    <div class="signos-title">ğŸ¯ TU RENDIMIENTO (${periodoLabel})</div>
                    ${renderSignosVitalesGrid(agenteKpiData, agenteActual.id)}
                </div>
                
               <div class="section-title">ğŸ“‰ EvoluciÃ³n Mensual</div>
<div class="charts-grid">
    <div class="chart-container" style="height: 400px; grid-column: 1 / -1;">
        <div class="chart-title">ğŸ’° GCI vs Objetivo</div>
        <canvas id="agent-gci-chart"></canvas>
    </div>
    <div class="chart-container" style="height: 350px;">
        <div class="chart-title">ğŸ“ Citas CaptaciÃ³n</div>
        <canvas id="agent-citas-chart"></canvas>
    </div>
    <div class="chart-container" style="height: 350px;">
        <div class="chart-title">ğŸ  Exclusivas Venta</div>
        <canvas id="agent-exclusivas-chart"></canvas>
    </div>
    <div class="chart-container" style="height: 350px;">
        <div class="chart-title">ğŸ¡ Casas EnseÃ±adas</div>
        <canvas id="agent-visitas-chart"></canvas>
    </div>
    <div class="chart-container" style="height: 350px;">
        <div class="chart-title">ğŸ“Š Actividad Total</div>
        <canvas id="agent-actividad-chart"></canvas>
    </div>
</div>
            `;
            container.innerHTML = html;    
            
            // Renderizar el grÃ¡fico
            setTimeout(() => {
    const evolucion = datosAgenteCompletos.evolucionMensual;
    if (evolucion) {
        // GrÃ¡fico GCI
        if (evolucion.gci) {
            crearGraficoDetalle('agent-gci-chart', evolucion.labels, 
                evolucion.gci.realizado, evolucion.gci.objetivo, 
                'GCI Realizado', 'Objetivo GCI');
        }
        
        // GrÃ¡fico Citas
        if (evolucion.citasCaptacion) {
            crearGraficoDetalle('agent-citas-chart', evolucion.labels, 
                evolucion.citasCaptacion.realizado, evolucion.citasCaptacion.objetivo, 
                'Citas Realizadas', 'Objetivo');
        }
        
        // GrÃ¡fico Exclusivas
        if (evolucion.exclusivasVenta) {
            crearGraficoDetalle('agent-exclusivas-chart', evolucion.labels, 
                evolucion.exclusivasVenta.realizado, evolucion.exclusivasVenta.objetivo, 
                'Exclusivas', 'Objetivo');
        }
        
        // GrÃ¡fico Visitas
        if (evolucion.casasEnsenadas) {
            crearGraficoDetalle('agent-visitas-chart', evolucion.labels, 
                evolucion.casasEnsenadas.realizado, evolucion.casasEnsenadas.objetivo, 
                'Visitas', 'Objetivo');
        }
        
        // GrÃ¡fico Actividad Total
        const actividadRealizado = evolucion.citasCaptacion?.realizado.map((c, i) => 
            (c || 0) + (evolucion.exclusivasVenta?.realizado[i] || 0) + (evolucion.casasEnsenadas?.realizado[i] || 0)
        );
        const actividadObjetivo = evolucion.citasCaptacion?.objetivo.map((c, i) => 
            (c || 0) + (evolucion.exclusivasVenta?.objetivo[i] || 0) + (evolucion.casasEnsenadas?.objetivo[i] || 0)
        );
        
        if (actividadRealizado && actividadObjetivo) {
            crearGraficoDetalle('agent-actividad-chart', evolucion.labels, 
                actividadRealizado, actividadObjetivo, 
                'Actividad Total', 'Objetivo Total');
        }
    }
}, 100);
        }
        
        function renderPendientesCard(periodoKey, datos) {
            const p = datos.pendientesPorPeriodo;
            // Si los datos de pendiente no existen (porque usamos la funciÃ³n de gerente), salir
            if (!p) return ''; 

            const dataPeriodo = p[periodoKey];
            if (!dataPeriodo) return '';

            const titleMap = { semana: 'Semana Actual', mes: 'Mes Actual', ano: 'AÃ±o Actual' };
            
            let rows = ['citasCaptacion', 'exclusivasVenta', 'gci'].map(key => {
                const meta = getKpiMetadata(key, 0);
                const pendiente = dataPeriodo.pendientes[key] || 0;
                const diario = dataPeriodo.promedioDiario[key] || 0;
                // Aseguramos que Pendiente y Diario son nÃºmeros vÃ¡lidos para mostrar
                const pendienteSeguro = isNaN(pendiente) || !isFinite(pendiente) ? 0 : pendiente;
                const diarioSeguro = isNaN(diario) || !isFinite(diario) ? 0 : diario;

                const unidad = meta.unidad === 'â‚¬' ? 'â‚¬' : '';

                return `
                    <tr>
                        <td style="text-align: left;">${meta.icon} ${meta.label}</td>
                        <td>${(meta.unidad === 'â‚¬' ? Math.round(pendienteSeguro) : Math.round(pendienteSeguro)).toLocaleString('es-ES')}${unidad}</td>
                        <td>${(meta.unidad === 'â‚¬' ? diarioSeguro.toFixed(0) : diarioSeguro.toFixed(1))}${unidad}/dÃ­a</td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="comparativa-card" style="padding: 15px;">
                    <div class="comparativa-title">${titleMap[periodoKey]} (${dataPeriodo.diasRestantes} dÃ­as restantes)</div>
                    <table class="tabla" style="font-size: 0.9em;">
                        <thead><tr><th>KPI</th><th>Pendiente</th><th>Diario</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                    <div style="margin-top: 10px; font-size: 0.8em; color: var(--color-text-faded);">
                        Periodo: ${new Date(dataPeriodo.fechaInicio).toLocaleDateString('es-ES')} - ${new Date(dataPeriodo.fechaFin).toLocaleDateString('es-ES')}
                    </div>
                </div>
            `;
        }

        function guardarActividad(event) {
    event.preventDefault();
    const datos = {
        fecha: document.getElementById('form-fecha').value,
        idAgente: document.getElementById('form-agent-id').value,
        nombreAgente: document.getElementById('form-agent-name').value,
        citasCaptacion: parseInt(document.getElementById('form-citas-captacion').value) || 0,
        exclusivasVenta: parseInt(document.getElementById('form-exclusivas-venta').value) || 0,
        exclusivasComprador: parseInt(document.getElementById('form-exclusivas-comprador').value) || 0,
        captacionesAbierto: parseInt(document.getElementById('form-captaciones-abierto').value) || 0,
        citasCompradores: parseInt(document.getElementById('form-citas-compradores').value) || 0,
        casasEnsenadas: parseInt(document.getElementById('form-casas-ensenadas').value) || 0,
        leadsCompradores: parseInt(document.getElementById('form-leads-compradores').value) || 0,
llamadas: parseInt(document.getElementById('form-llamadas').value) || 0,
captacionesAlquiler: parseInt(document.getElementById('form-captaciones-alquiler').value) || 0,
leadVendedor: parseInt(document.getElementById('form-lead-vendedor').value) || 0,
tresBs: parseInt(document.getElementById('form-3bs').value) || 0,
bajadasPrecio: parseInt(document.getElementById('form-bajadas-precio').value) || 0,
leadComprador: parseInt(document.getElementById('form-lead-comprador').value) || 0,
propuestasCompra: parseInt(document.getElementById('form-propuestas-compra').value) || 0,
leadSeguimiento: parseInt(document.getElementById('form-lead-seguimiento').value) || 0,
arras: parseInt(document.getElementById('form-arras').value) || 0,
gci: parseFloat(document.getElementById('form-gci').value) || 0,
        volumenNegocio: 0,
        notas: "Registro de Agente"
    };
    
    // Decidir si guardar nueva o actualizar existente
    const funcionALlamar = modoEdicionActividad ? 'actualizarActividad' : 'guardarActividad';
    const mensajeAccion = modoEdicionActividad ? 'actualizada' : 'guardada';
    
    console.log(`ğŸ’¾ ${modoEdicionActividad ? 'Actualizando' : 'Guardando'} actividad (Agente)...`, datos);
    
    google.script.run
        .withSuccessHandler(function(respuesta) {
            console.log('âœ… Actividad ' + mensajeAccion + ':', respuesta.message);
            const msg = document.getElementById('form-success-message');
            msg.textContent = `âœ… Actividad ${mensajeAccion} correctamente`;
            msg.style.display = 'block';
            
            setTimeout(() => {
    msg.style.display = 'none';
    // NO recalcular automÃ¡ticamente - solo limpiar formulario
    
    limpiarFormularioActividad();
    ocultarAvisoActividadExistente();
    cambiarBotonAGuardar();
    modoEdicionActividad = false;
}, 2000);
        })
        .withFailureHandler(mostrarError)
        [funcionALlamar](datos);
}
        
        // ===== GESTIÃ“N GERENTE (FORMULARIOS) =====
        
        function mostrarModalAcciones() {
            cerrarModal();
            document.getElementById('modal-acciones').classList.add('active');
            document.body.classList.add('modal-open');
        }

        function poblarSelectAgentes(selectId) {
    const select = document.getElementById(selectId);
    if (!select) {
        console.error(`Select ${selectId} no encontrado`);
        return;
    }
    
    const esMultiple = select.multiple;
    
    // CASO 1: Si ya tenemos datosGlobales cargados (vista gerente activa)
    if (datosGlobales && datosGlobales.length > 0) {
        select.innerHTML = esMultiple ? '' : '<option value="">-- Elige un agente --</option>';
        
        datosGlobales.forEach(agente => {
            const nombre = agente.nombre || agente.agente || 'Agente Desconocido';
            const option = document.createElement('option');
            option.value = agente.id;
            option.textContent = nombre;
            select.appendChild(option);
        });
        
        console.log(`âœ… ${datosGlobales.length} agentes cargados en ${selectId} desde datosGlobales`);
        return;
    }
    
    // CASO 2: No tenemos datosGlobales, llamar al backend
    select.disabled = true;
    select.innerHTML = '<option>Cargando agentes...</option>';
    
    google.script.run
        .withSuccessHandler(function(agentes) {
            select.disabled = false;
            
            if (!agentes || agentes.length === 0) {
                select.innerHTML = '<option value="">âŒ No hay agentes</option>';
                console.warn('No se encontraron agentes');
                return;
            }
            
            select.innerHTML = esMultiple ? '' : '<option value="">-- Elige un agente --</option>';
            
            agentes.forEach(agente => {
                const option = document.createElement('option');
                option.value = agente[0]; // ID
                option.textContent = agente[1]; // Nombre
                select.appendChild(option);
            });
            
            console.log(`âœ… ${agentes.length} agentes cargados en ${selectId} desde backend`);
        })
        .withFailureHandler(function(error) {
            select.disabled = false;
            select.innerHTML = '<option value="">âŒ Error al cargar</option>';
            console.error('Error cargando agentes:', error);
        })
        .obtenerListaAgentes();
}
        
        function mostrarModalTransaccion() {
            
            document.getElementById('modal-transaccion').classList.add('active');
            document.body.classList.add('modal-open');
            
            // Poblar el selector de agentes para aÃ±adir
            poblarSelectAgentes('tx-agente-select');
            
            // Resetear el formulario
            document.getElementById('form-transaccion').reset();
            document.getElementById('transaccion-fecha').valueAsDate = new Date();
            agentesParaTransaccion = [];
            renderListaAgentesTx();
            actualizarGCIRestante();
             // ğŸ†• CARGAR ORÃGENES EN EL SELECT
    google.script.run
        .withSuccessHandler(function(origenes) {
            const select = document.getElementById('tx-origen-lead');
            select.innerHTML = '<option value="">-- Seleccionar origen --</option>';
            origenes.forEach(origen => {
                select.innerHTML += `<option value="${origen}">${origen}</option>`;
            });
        })
        .obtenerOrigenesNegocio();
        }
        
        function mostrarModalActividad() {
            
            document.getElementById('modal-actividad').classList.add('active');
            document.body.classList.add('modal-open');
            poblarSelectAgentes('actividad-agente-select');
            document.getElementById('gerente-form-fecha').valueAsDate = new Date();
        }

        function mostrarModalObjetivos() {
    abrirModalEncima('modal-objetivos');
    poblarSelectAgentes('objetivos-agente-select');
    document.getElementById('objetivos-container').style.display = 'none';
}

        function mostrarModalNuevoAgente() {
    // Abrimos usando el sistema de capas
    abrirModalEncima('modal-nuevo-agente');
    // Reseteamos el formulario para que aparezca limpio
    document.getElementById('form-nuevo-agente').reset();
}

        // â­ REPARADO: LÃ³gica de filtros
        function mostrarModalFiltros(vista) {
            cerrarModal();
            const modalBody = document.getElementById('modal-filtros-body');
            
            // 1. Renderizar el contenido PRIMERO
            if (vista === 'gerente') {
                modalBody.innerHTML = renderizarFiltrosRapidos('gerente');
            } else {
                modalBody.innerHTML = renderizarFiltrosRapidos('agente');
            }
            
            // 2. Asignar tÃ­tulo
            document.getElementById('modal-filtros-title').innerText = `Aplicar Filtros (${vista === 'gerente' ? 'Gerente' : 'Agente'})`;
            
            // 3. Mostrar el modal AHORA
            document.getElementById('modal-filtros').classList.add('active');
            document.body.classList.add('modal-open');
        }
        // =========================================================
// ğŸ› ï¸ FUNCIONES DE APERTURA DE MODALES (RECUPERADAS)
// =========================================================


function mostrarModalModeloPresupuestario() {
    document.getElementById('modal-modelo-presupuestario').classList.add('active');
    document.body.classList.add('modal-open');
    
    const year = new Date().getFullYear();
    
    mostrarNotificacion('Cargando datos presupuestarios...', 'success');
    
    google.script.run
        .withSuccessHandler(datos => {
            console.log('ğŸ“Š DATOS PRESUPUESTARIOS RECIBIDOS:', datos);
            console.log('ğŸ“Š GCI Mensual:', datos?.gciMensual);
            console.log('ğŸ“Š Gastos Operativos:', datos?.gastosOperativos);
            console.log('ğŸ“Š Gastos Ventas:', datos?.gastosVentas);
            console.log('ğŸ“Š AnÃ¡lisis Mensual:', datos?.analisisMensual);
            
            if (!datos) {
                mostrarNotificacion('No hay datos disponibles', 'error');
                return;
            }
            
            // Verificar que los contenedores existen
            console.log('ğŸ“Š Container cards:', document.getElementById('presup-cards-anual'));
            console.log('ğŸ“Š Container tabla:', document.getElementById('presup-tabla-body'));
            console.log('ğŸ“Š Canvas barras:', document.getElementById('chart-presup-barras'));
            console.log('ğŸ“Š Canvas lineas:', document.getElementById('chart-presup-lineas'));
            
            // Renderizar anÃ¡lisis anual
            renderizarAnalisisPresupuestario(datos);
            
            // Renderizar grÃ¡ficos
            renderizarGraficosPresupuesto(datos);
            
            // Renderizar tabla mensual
            renderizarTablaPresupuesto(datos);
            
            mostrarNotificacion('Datos cargados correctamente', 'success');
        })
        .withFailureHandler(err => {
            console.error('âŒ ERROR:', err);
            mostrarNotificacion('Error al cargar datos: ' + err.message, 'error');
        })
        .obtenerDatosPresupuestarios(year);
}

function mostrarModalModeloOrganizativo() {
    abrirModalEncima('modal-modelo-organizativo');
    google.script.run.withSuccessHandler(function(datos) {
        if (datos) {
            document.getElementById('org-team-leader').value = datos.teamLeader || '';
            document.getElementById('org-lider-ventas').value = datos.liderVentas || '';
            document.getElementById('org-lider-captacion').value = datos.liderCaptacion || '';
            document.getElementById('org-agente-1').value = datos.agentes[0] || '';
            document.getElementById('org-agente-2').value = datos.agentes[1] || '';
            document.getElementById('org-agente-3').value = datos.agentes[2] || '';
            document.getElementById('org-agente-4').value = datos.agentes[3] || '';
        }
    }).obtenerOrganigrama();
}

function mostrarModalPlantillaGPS() {
    abrirModalEncima('modal-plantilla-gps');
    const nombre = (agenteActual && agenteActual.nombre) ? agenteActual.nombre : "Agente";
    if(!document.getElementById('gps-display-name').value) {
         document.getElementById('gps-display-name').value = nombre;
    }
    cargarDatosGPS();
}

function mostrarModalRentabilidad() {
    abrirModalEncima('modal-rentabilidad');
    setTimeout(cargarRentabilidadAgentes, 200);
}

        // ===================================
        // â­ LÃ“GICA MODAL TRANSACCIONES
        // ===================================
        function actualizarGCIRestante() {
            const gciTotal = parseFloat(document.getElementById('transaccion-gci-total').value) || 0;
            const gciAsignado = agentesParaTransaccion.reduce((sum, agente) => sum + agente.gci, 0);
            const restante = gciTotal - gciAsignado;
            
            const display = document.getElementById('transaccion-gci-restante');
            const submitBtn = document.getElementById('form-transaccion-submit');

            display.innerHTML = `Total Asignado: ${gciAsignado.toLocaleString('es-ES', {style:'currency', currency:'EUR'})}    
                                   (Restante: ${restante.toLocaleString('es-ES', {style:'currency', currency:'EUR'})})`;
            
            // Validar (permitir un pequeÃ±o margen de error por decimales)
            if (Math.abs(restante) < 0.01 && gciAsignado > 0) {
                display.className = 'completo';
                submitBtn.disabled = false;
                submitBtn.style.opacity = 1;
            } else {
                display.className = 'incompleto';
                submitBtn.disabled = true;
                submitBtn.style.opacity = 0.5;
            }
        }

        function agregarAgenteATransaccion() {
    const select = document.getElementById('tx-agente-select');
    const id = select.value;
    const nombre = select.options[select.selectedIndex]?.text;
    const lado = document.getElementById('tx-lado-select').value;
    const gciParcial = parseFloat(document.getElementById('tx-gci-parcial').value) || 0;
    
    // ğŸ†• CAPTURAR NUEVOS CAMPOS
    const tipoCaptacion = document.getElementById('tx-tipo-captacion').value;
    const origenLead = document.getElementById('tx-origen-lead').value;
    
    // Capturar comisiÃ³n
    const comisionPct = parseFloat(document.getElementById('tx-comision-pct').value) || 40;
    const comisionImporte = parseFloat(document.getElementById('tx-comision-importe').value) || 0;

    if (!id) { mostrarError({ message: 'Por favor, selecciona un agente.' }); return; }
    if (gciParcial <= 0) { mostrarError({ message: 'GCI debe ser mayor que 0.' }); return; }
    if (!origenLead) { mostrarError({ message: 'Por favor, selecciona el origen del lead.' }); return; }

    // AÃ±adir al array con los nuevos datos
    agentesParaTransaccion.push({ 
        id, 
        nombre, 
        lado, 
        gci: gciParcial,
        comisionPct: comisionPct,
        comisionImporte: comisionImporte,
        campoModificado: window.ultimoCampoComisionTx || 'pct',
        // ğŸ†• NUEVOS CAMPOS
        tipoCaptacion: tipoCaptacion,
        origenLead: origenLead
    });

    renderListaAgentesTx();
    actualizarGCIRestante();
    
    // Resetear campos
    select.value = '';
    document.getElementById('tx-gci-parcial').value = '';
    document.getElementById('tx-origen-lead').value = '';
}
        function renderListaAgentesTx() {
            const container = document.getElementById('transaccion-agentes-lista');
            if (agentesParaTransaccion.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--color-text-faded);">AÃ±ade agentes a esta transacciÃ³n...</p>';
                return;
            }

            container.innerHTML = agentesParaTransaccion.map((agente, index) => {
                return `
                    <div class="agente-item-transaccion">
                        <div>
                            <strong class="agente-item-transaccion-info">${agente.nombre} <span>(${agente.lado})</span></strong>
                        </div>
                        <div>
                            <span class="agente-item-transaccion-gci">${agente.gci.toLocaleString('es-ES', {style:'currency', currency:'EUR'})}</span>
                            <button type="button" class="btn-eliminar-agente-tx" onclick="eliminarAgenteDeTransaccion(${index})">&times;</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function eliminarAgenteDeTransaccion(index) {
            agentesParaTransaccion.splice(index, 1);
            renderListaAgentesTx();
            actualizarGCIRestante();
        }

        function guardarTransaccionGCI(event) {
            event.preventDefault();
            
            const gciTotal = parseFloat(document.getElementById('transaccion-gci-total').value) || 0;
            const gciAsignado = agentesParaTransaccion.reduce((sum, agente) => sum + agente.gci, 0);

            if (agentesParaTransaccion.length === 0) {
                // [REPARACIÃ“N C] Cambiado alert a mostrarError
                mostrarError({ message: "Debes aÃ±adir al menos un agente a la transacciÃ³n." });
                return;
            }
            
            if (Math.abs(gciTotal - gciAsignado) > 0.01 || gciTotal === 0) {
                // [REPARACIÃ“N C] Cambiado alert a mostrarError
                mostrarError({ message: "El GCI Total no coincide con el GCI asignado a los agentes. Por favor, revisa los importes." });
                return;
            }
            
            // Construir el objeto que espera el .gs
            const datosTransaccion = {
    fecha: document.getElementById('transaccion-fecha').value,
    gciTotal: parseFloat(document.getElementById('transaccion-gci-total').value) || 0,
    precioCaptacion: parseFloat(document.getElementById('transaccion-precio-captacion').value) || 0,
    precioVenta: parseFloat(document.getElementById('transaccion-precio-venta').value) || 0,
    tipo: document.getElementById('transaccion-tipo').value,
    descripcion: document.getElementById('transaccion-descripcion').value,
    agentes: agentesParaTransaccion  // âœ… VARIABLE CORREGIDA
};

            console.log('ğŸ’¾ Guardando TransacciÃ³n (Nueva)...', datosTransaccion);
            
            google.script.run
                .withSuccessHandler(function(respuesta) {
                    // [REPARACIÃ“N B] Eliminado el alert para evitar la inyecciÃ³n HTML.
                    console.log('âœ… TransacciÃ³n guardada:', respuesta.message);
                    cerrarModal(); // Cerrar modal antes de recargar
                    cargarDatosGerente(periodoActual); // Recargar datos
                })
                .withFailureHandler(mostrarError)
                .guardarTransaccionGCI(datosTransaccion); // Enviar el objeto complejo
        }
        // ===================================
        // FIN LÃ“GICA TRANSACCIONES
        // ===================================

        function guardarActividadGerente(event) {
    event.preventDefault();
    const selectAgente = document.getElementById('actividad-agente-select');
    const idAgente = selectAgente.value;
    const nombreAgente = selectAgente.options[selectAgente.selectedIndex]?.text;
    
    const datos = {
        fecha: document.getElementById('gerente-form-fecha').value,
        idAgente: idAgente,
        nombreAgente: nombreAgente,
        citasCaptacion: parseInt(document.getElementById('gerente-form-citas-captacion').value) || 0,
        exclusivasVenta: parseInt(document.getElementById('gerente-form-exclusivas-venta').value) || 0,
        exclusivasComprador: parseInt(document.getElementById('gerente-form-exclusivas-comprador').value) || 0,
        captacionesAbierto: parseInt(document.getElementById('gerente-form-captaciones-abierto').value) || 0,
        citasCompradores: parseInt(document.getElementById('gerente-form-citas-compradores').value) || 0,
        casasEnsenadas: parseInt(document.getElementById('gerente-form-casas-ensenadas').value) || 0,
        leadsCompradores: parseInt(document.getElementById('gerente-form-leads-compradores').value) || 0,
        llamadas: parseInt(document.getElementById('gerente-form-llamadas').value) || 0,
captacionesAlquiler: parseInt(document.getElementById('gerente-form-captaciones-alquiler').value) || 0,
leadVendedor: parseInt(document.getElementById('gerente-form-lead-vendedor').value) || 0,
tresBs: parseInt(document.getElementById('gerente-form-3bs').value) || 0,
bajadasPrecio: parseInt(document.getElementById('gerente-form-bajadas-precio').value) || 0,
leadComprador: parseInt(document.getElementById('gerente-form-lead-comprador').value) || 0,
propuestasCompra: parseInt(document.getElementById('gerente-form-propuestas-compra').value) || 0,
leadSeguimiento: parseInt(document.getElementById('gerente-form-lead-seguimiento').value) || 0,
arras: parseInt(document.getElementById('gerente-form-arras').value) || 0,
gci: parseFloat(document.getElementById('gerente-form-gci').value) || 0,
        volumenNegocio: 0,
        notas: "Registro de Gerente"
    };

    // Decidir si guardar nueva o actualizar existente
    const funcionALlamar = modoEdicionActividadGerente ? 'actualizarActividad' : 'guardarActividad';
    const mensajeAccion = modoEdicionActividadGerente ? 'actualizada' : 'guardada';
    
    console.log(`ğŸ’¾ ${modoEdicionActividadGerente ? 'Actualizando' : 'Guardando'} actividad (Gerente)...`, datos);
    
    google.script.run
        .withSuccessHandler(function(respuesta) {
            console.log('âœ… Actividad ' + mensajeAccion + ':', respuesta.message);
            mostrarNotificacion(`âœ… Actividad ${mensajeAccion} correctamente`, 'success');
            
            // Resetear modo ediciÃ³n
            modoEdicionActividadGerente = false;
            
            // Limpiar formulario
limpiarFormularioActividadGerente();
ocultarAvisoActividadExistenteGerente();
cambiarBotonAGuardarGerente();

// NO recalcular automÃ¡ticamente
        })
        .withFailureHandler(mostrarError)
        [funcionALlamar](datos);
}
        
        function crearAgente(event) {
    event.preventDefault();
    const agente = {
        nombre: document.getElementById('nuevo-nombre').value,
        email: document.getElementById('nuevo-email').value,
        telefono: document.getElementById('nuevo-telefono').value,
        sueldoFijo: document.getElementById('nuevo-sueldo').value, // <--- NUEVO CAMPO
        objetivosAcumulados: document.getElementById('nuevo-objetivos-acumulados').value,
    };
    
    console.log('ğŸ‘¤ Creando agente...', agente);
    // ... resto de la funciÃ³n igual (google.script.run...)
    google.script.run
        .withSuccessHandler(function(respuesta) {
            mostrarNotificacion('âœ… Agente creado correctamente');
            cerrarModal();
            cargarDatosGerente(periodoActual);
        })
        .withFailureHandler(mostrarError)
        .crearNuevoAgente(agente);
}
        
        // =========================================================
        // ========= FUNCIONES DE OBJETIVOS (REPARADAS) ==========
        // =========================================================

        function cargarObjetivosActuales() {
    const idAgente = document.getElementById('objetivos-agente-select').value;
    
    // â•â• CARGAR PANEL MODELO ECONÃ“MICO AGENTE â•â•
    cargarMEAgente(idAgente);
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    if (!idAgente) {
        document.getElementById('objetivos-container').style.display = 'none';
        return;
    }
    
    console.log(`ğŸ¯ Cargando objetivos para ${idAgente}`);
    
    google.script.run
        .withSuccessHandler(function(respuesta) {
            console.log('âœ… Objetivos recibidos:', respuesta);
            
            const obj = respuesta.objetivosAnuales || {};
            const distribucion = respuesta.distribucion || [8, 8, 9, 9, 10, 10, 9, 5, 9, 9, 8, 6];

            // KPIs Principales
            document.getElementById('obj-gci').value = obj.gci || 96000;
            document.getElementById('obj-citasCaptacion').value = obj.citasCaptacion || 180;
            document.getElementById('obj-exclusivasVenta').value = obj.exclusivasVenta || 60;
            document.getElementById('obj-exclusivasComprador').value = obj.exclusivasComprador || 48;
            document.getElementById('obj-captacionesAbierto').value = obj.captacionesAbierto || 36;
            document.getElementById('obj-citasCompradores').value = obj.citasCompradores || 120;
            document.getElementById('obj-casasEnsenadas').value = obj.casasEnsenadas || 96;
            document.getElementById('obj-leadsCompradores').value = obj.leadsCompradores || 240;
            document.getElementById('obj-llamadas').value = obj.llamadas || 600;
            document.getElementById('obj-volumenNegocio').value = obj.volumenNegocio || 1200000;
            
            // KPIs Adicionales
            document.getElementById('obj-captacionesAlquiler').value = obj.captacionesAlquiler || 12;
            document.getElementById('obj-leadVendedor').value = obj.leadVendedor || 120;
            document.getElementById('obj-tresBs').value = obj.tresBs || 60;
            document.getElementById('obj-bajadasPrecio').value = obj.bajadasPrecio || 24;
            document.getElementById('obj-leadComprador').value = obj.leadComprador || 120;
            document.getElementById('obj-propuestasCompra').value = obj.propuestasCompra || 36;
            document.getElementById('obj-leadSeguimiento').value = obj.leadSeguimiento || 480;
            document.getElementById('obj-arras').value = obj.arras || 12;

            // DistribuciÃ³n mensual
            for (let i = 0; i < 12; i++) {
                document.getElementById(`dist-${i}`).value = distribucion[i];
            }
            
            calcularTotalDistribucion();
            document.getElementById('objetivos-container').style.display = 'block';
        })
        .withFailureHandler(mostrarError)
        .obtenerObjetivosAgenteActual(idAgente, new Date().getFullYear());
}
/**
 * Obtiene el objetivo de un KPI: primero intenta objetivo global, si no existe usa suma de agentes
 * @param {string} kpiKey - Clave del KPI (ej: 'gci', 'citasCaptacion')
 * @returns {number} - Valor del objetivo
 */
/**
 * Obtiene el objetivo de un KPI: primero objetivo global, si no existe usa suma de agentes
 */
function obtenerObjetivoKPI(kpiKey, sumaAgentes) {
    // Mapeo de claves del sistema a claves del modelo econÃ³mico
    const mapeoClaves = {
        'gci': 'gci',
        'citasCaptacion': 'citasCaptacion',
        'exclusivasVenta': 'exclusivasVenta',
        'captacionesAbierto': 'captAbierto',
        'citasCompradores': 'citasComprador',
        'casasEnsenadas': 'casasEnsenadas',
        'exclusivasComprador': 'exclusivasCompr',
        'llamadas': 'llamadas',
        'volumenNegocio': 'volumenNegocio',
        'captacionesAlquiler': 'captAlquiler',
        'leadVendedor': 'leadVendedor',
        'tresBs': 'tresBs',
        'bajadasPrecio': 'bajadasPrecio',
        'leadComprador': 'leadComprador',
        'propuestasCompra': 'propuestasCompra',
        'leadSeguimiento': 'leadSeguimiento',
        'arras': 'arras',
        'totalTransacciones': 'ventas'
    };
    
    const claveModelo = mapeoClaves[kpiKey] || kpiKey;
    
    // 1. Intentar objetivo global (si existe y tiene valor > 0)
    if (window.objetivosGlobalesOficina && 
        window.objetivosGlobalesOficina[claveModelo] !== null && 
        window.objetivosGlobalesOficina[claveModelo] !== undefined &&
        window.objetivosGlobalesOficina[claveModelo] !== '' &&
        parseFloat(window.objetivosGlobalesOficina[claveModelo]) > 0) {
        
        return {
            valor: parseFloat(window.objetivosGlobalesOficina[claveModelo]),
            fuente: 'oficina'
        };
    }
    
    // 2. Fallback: suma de objetivos de agentes
    return {
        valor: sumaAgentes || 0,
        fuente: 'agentes'
    };
}

/**
 * Calcula la suma de objetivos de todos los agentes para un KPI
 */
function calcularSumaObjetivosAgentes(kpiKey) {
    if (!window.objetivosAgentesCache || !Array.isArray(window.objetivosAgentesCache)) {
        return 0;
    }
    
    let suma = 0;
    window.objetivosAgentesCache.forEach(agente => {
        if (agente.objetivos && agente.objetivos[kpiKey]) {
            suma += parseFloat(agente.objetivos[kpiKey]) || 0;
        }
    });
    
    return suma;
}
        function calcularTotalDistribucion() {
            let total = 0;
            const inputs = document.querySelectorAll('.dist-mes');
            inputs.forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            
            total = parseFloat(total.toFixed(1));    
            
            const totalEl = document.getElementById('distribucion-total');
            totalEl.textContent = `Total: ${total}%`;
            
            totalEl.classList.toggle('invalid', (total < 99.9 || total > 100.1));
        }
        
        function guardarObjetivosAgente(event) {
    event.preventDefault();
    
    // Validar distribuciÃ³n
    let totalDist = 0;
    const distribucionMensual = [];
    for(let i = 0; i < 12; i++) {
        const val = parseFloat(document.getElementById(`dist-${i}`).value) || 0;
        distribucionMensual.push(val);
        totalDist += val;
    }
    
    if (totalDist < 99.9 || totalDist > 100.1) {
        mostrarError({ message: `Error: La distribuciÃ³n mensual suma ${totalDist.toFixed(1)}%. Debe sumar exactamente 100%.` });
        return;
    }
    
    const idAgente = document.getElementById('objetivos-agente-select').value;
    
    const datosParaGS = {
        idAgente: idAgente,
        year: new Date().getFullYear(),
        distribucion: distribucionMensual,
        objetivosAnuales: {
            // KPIs Principales
            gci: parseInt(document.getElementById('obj-gci').value) || 0,
            citasCaptacion: parseInt(document.getElementById('obj-citasCaptacion').value) || 0,
            exclusivasVenta: parseInt(document.getElementById('obj-exclusivasVenta').value) || 0,
            exclusivasComprador: parseInt(document.getElementById('obj-exclusivasComprador').value) || 0,
            captacionesAbierto: parseInt(document.getElementById('obj-captacionesAbierto').value) || 0,
            citasCompradores: parseInt(document.getElementById('obj-citasCompradores').value) || 0,
            casasEnsenadas: parseInt(document.getElementById('obj-casasEnsenadas').value) || 0,
            leadsCompradores: parseInt(document.getElementById('obj-leadsCompradores').value) || 0,
            llamadas: parseInt(document.getElementById('obj-llamadas').value) || 0,
            volumenNegocio: parseInt(document.getElementById('obj-volumenNegocio').value) || 0,
            
            // KPIs Adicionales
            captacionesAlquiler: parseInt(document.getElementById('obj-captacionesAlquiler').value) || 0,
            leadVendedor: parseInt(document.getElementById('obj-leadVendedor').value) || 0,
            tresBs: parseInt(document.getElementById('obj-tresBs').value) || 0,
            bajadasPrecio: parseInt(document.getElementById('obj-bajadasPrecio').value) || 0,
            leadComprador: parseInt(document.getElementById('obj-leadComprador').value) || 0,
            propuestasCompra: parseInt(document.getElementById('obj-propuestasCompra').value) || 0,
            leadSeguimiento: parseInt(document.getElementById('obj-leadSeguimiento').value) || 0,
            arras: parseInt(document.getElementById('obj-arras').value) || 0
        }
    };
    
    console.log(`ğŸ’¾ Guardando objetivos para ${idAgente}...`, datosParaGS);
    
    google.script.run
        .withSuccessHandler(function(respuesta) {
            console.log('âœ… Objetivos guardados:', respuesta.message);
            cerrarModal();
            cargarDatosGerente(periodoActual);
        })
        .withFailureHandler(mostrarError)
        .actualizarObjetivosAgente(datosParaGS);
}

        // ===== ASISTENTE IA =====
        
        function analizarRendimientoIA() {
            const modalContent = document.getElementById('modal-ia-content');
            modalContent.innerHTML = '<div class="loading"><div class="loader"></div><div>ğŸ¤– Analizando rendimiento del equipo...</div></div>';
            document.getElementById('modal-ia').classList.add('active');
            document.body.classList.add('modal-open');

            const datosParaIA = datosFiltrados.map(d => ({
                agente: d.agente,
                cumplimiento: d.cumplimientoGlobal,
                gci: d.realizado.gci,
                conversion: d.ratios.conversionCaptacion,
                cierre: d.ratios.ratioCierre,
                ticket: d.ratios.ticketPromedio,
                actividad: d.ratios.actividadTotal
            }));
            
            google.script.run
                .withSuccessHandler(function(respuesta) {
                    modalContent.innerHTML = respuesta;
                })
                .withFailureHandler(mostrarErrorIA)
                .analizarEquipoIA(datosParaIA, periodoActual);
        }

        function analizarAgenteIA(event, idAgente) {
            if(event) event.stopPropagation();
            
            const modalContent = document.getElementById('modal-ia-content');
            modalContent.innerHTML = '<div class="loading"><div class="loader"></div><div>ğŸ¤– Analizando rendimiento del agente...</div></div>';
            document.getElementById('modal-ia').classList.add('active');
            document.body.classList.add('modal-open');

            let agente;
            if (agenteActual && agenteActual.id === idAgente) {
                agente = datosAgenteCompletos; // Desde la vista Agente
            } else {
                agente = datosGlobales.find(d => d.id === idAgente); // Desde la vista Gerente
            }

            if (!agente) {
                mostrarErrorIA({ message: "No se encontraron datos para este agente." });
                return;
            }
            
            google.script.run
                .withSuccessHandler(function(respuesta) {
                    modalContent.innerHTML = respuesta;
                })
                .withFailureHandler(mostrarErrorIA)
                .analizarAgenteIA(agente, periodoActual);
        }

        // ===== UTILIDADES =====
        // 1. MODIFICAR funciÃ³n cerrarModal en el Script
function cerrarModal(idModalAbreDespues = null) {
    // Cierra todos
    document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
    document.body.classList.remove('modal-open');

    // Si le decimos que abra otro al cerrar este, lo hace
    if (idModalAbreDespues) {
        setTimeout(() => {
            document.getElementById(idModalAbreDespues).classList.add('active');
            document.body.classList.add('modal-open');
        }, 100); // PequeÃ±o retardo para que sea suave
    }
}

        function setupStickyFilters(filterId, placeholderId, headerId) {
            const filterBar = document.getElementById(filterId);
            const placeholder = document.getElementById(placeholderId);
            const header = document.getElementById(headerId);
            if (!filterBar || !placeholder || !header) return;

            const offset = header.offsetHeight + 15;    
            placeholder.style.height = `${filterBar.offsetHeight}px`;

            const mainContainer = filterBar.closest('.container');
            
            const onScroll = () => {
                if (!mainContainer) return;
                const rect = header.getBoundingClientRect();
                const headerBottom = rect.bottom;

                if (headerBottom <= 15) {    
                    if (!filterBar.classList.contains('is-sticky')) {
                        placeholder.style.display = 'block';
                        filterBar.classList.add('is-sticky');
                    }
                } else {
                    if (filterBar.classList.contains('is-sticky')) {
                        placeholder.style.display = 'none';
                        filterBar.classList.remove('is-sticky');
                    }
                }
            };
            window.addEventListener('scroll', onScroll, { passive: true });
        }

        function mostrarError(error) {
            console.error('âŒ Error en Google Apps Script:', error);
            const msg = error.message || JSON.stringify(error);
            const modalContent = document.getElementById('modal-ia-content');
            modalContent.innerHTML = `<div style="color: var(--color-accent-bad);"><h3>âŒ Error de ConexiÃ³n</h3><p>${msg}</p><p>La respuesta del servidor no tiene el formato esperado. Por favor, revisa tu conexiÃ³n o contacta al administrador.</p></div>`;
            document.getElementById('modal-ia').classList.add('active');
            document.body.classList.add('modal-open');
        }

        function mostrarErrorIA(error) {
            console.error('âŒ Error en IA:', error);
            const msg = error.message || JSON.stringify(error);
            const modalContent = document.getElementById('modal-ia-content');
            modalContent.innerHTML = `<div style="color: var(--color-accent-bad);"><h3>âŒ Error del Asistente IA</h3><p>${msg}</p></div>`;
        }
        
        const scrollTopButton = document.getElementById('scrollTopButton');
        if (scrollTopButton) {
            window.onscroll = function() {
                if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
                    scrollTopButton.style.display = "flex";
                } else {
                    scrollTopButton.style.display = "none";
                }
            };
        }
        
        function scrollToTop() {
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        // ========================================
        // â­ NUEVAS FUNCIONES DE UTILIDAD (TEMAS, ETC) â­
        // ========================================

        function mostrarModalTemas() {
            cerrarModal();
            document.getElementById('modal-temas').classList.add('active');
            document.body.classList.add('modal-open');
        }

        function aplicarTema(themeName) {
            console.log('ğŸ¨ Aplicando tema:', themeName);
            document.body.dataset.theme = themeName;
            localStorage.setItem('dashboardTheme', themeName);
            actualizarChartDefaults();
            cerrarModal();
        }

        function cargarTemaGuardado() {
            const savedTheme = localStorage.getItem('dashboardTheme') || 'kw-dark';
            document.body.dataset.theme = savedTheme;
            actualizarChartDefaults();
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement &&    // Standard
                !document.mozFullScreenElement && // Firefox
                !document.webkitFullscreenElement && // Chrome, Safari y Opera
                !document.msFullscreenElement) {  // IE/Edge
                
                const elem = document.documentElement;    
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.mozRequestFullScreen) { /* Firefox */
                    elem.mozRequestFullScreen();
                } else if (elem.webkitRequestFullscreen) { /* Chrome, Safari y Opera */
                    elem.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
                } else if (elem.msRequestFullscreen) { /* IE/Edge */
                    elem.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) { /* Firefox */
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) { /* Chrome, Safari y Opera */
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { /* IE/Edge */
                    document.msExitFullscreen();
                }
            }
        }

        function tomarCaptura() {
            const loader = document.getElementById('loader-overlay');
            const target = document.querySelector('.view-container.active');
            if (!target) return;

            loader.style.display = 'flex';    

            const stickyFilter = target.querySelector('.filtros-rapidos.is-sticky');
            const scrollTopBtn = document.getElementById('scrollTopButton');
            if (stickyFilter) stickyFilter.style.display = 'none';
            if (scrollTopBtn) scrollTopBtn.style.display = 'none';

            html2canvas(target, {
                backgroundColor: getComputedStyle(document.body).getPropertyValue('--color-bg'),
                useCORS: true,
                logging: false,
                onclone: (doc) => {
                    const bg = doc.querySelector('.animated-bg');
                    const stars = doc.querySelector('.stars');
                    if (bg) bg.style.display = 'none';
                    if (stars) stars.style.display = 'none';
                }
            }).then(canvas => {
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().split('T')[0];
                link.download = `dashboard-kw-${timestamp}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                loader.style.display = 'none';
                if (stickyFilter) stickyFilter.style.display = 'flex';    
                if (scrollTopBtn) scrollTopBtn.style.display = 'flex';

            }).catch(err => {
                console.error('Error al generar la captura:', err);
                loader.style.display = 'none';
                if (stickyFilter) stickyFilter.style.display = 'flex';
                if (scrollTopBtn) scrollTopBtn.style.display = 'flex';
                // [REPARACIÃ“N C] Cambiado alert a mostrarError
                mostrarError({ message: 'Hubo un error al generar la captura de pantalla.' });
            });
        }

        </script>
        <script>
          // Variable global para rastrear Ãºltimo campo modificado
window.ultimoCampoComisionTx = 'pct';
        /* --- UTIL: evita inyecciÃ³n al insertar texto dinÃ¡mico --- */
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        /* Lanza la peticiÃ³n al servidor y maneja errores */
        function loadAgentes() {
            const container = document.getElementById('agentesContainer');
            if (container) container.innerHTML = '<div class="loader">Cargando agentesâ€¦</div>';

            google.script.run
                .withSuccessHandler(renderAgentes)
                .withFailureHandler(function(err){
                    console.error('Error obtenerListaAgentes:', err);
                    if (container) {
                        container.innerHTML = '<div class="error">Error al cargar agentes. Revisa permisos/hojas. ' +
                                                (err && err.message ? escapeHtml(err.message) : '') + '</div>';
                    }
                })
                .obtenerListaAgentes(); 
        }
        // ============================================
// FUNCIONES DE FORMATO
// ============================================

function formatearMoneda(valor) {
    if (valor === null || valor === undefined) return '0â‚¬';
    var num = parseFloat(valor) || 0;
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1).replace('.', ',') + 'Mâ‚¬';
    } else if (num >= 1000) {
        return Math.round(num / 1000) + 'Kâ‚¬';
    }
    return Math.round(num).toLocaleString('es-ES') + 'â‚¬';
}

function formatearMonedaCompleta(valor) {
    if (valor === null || valor === undefined) return '0 â‚¬';
    return parseFloat(valor).toLocaleString('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' â‚¬';
}

        /* Renderiza la lista de agentes de forma resiliente */
        function renderAgentes(agentes) {
            const container = document.getElementById('agentesContainer');
            if (!container) return;

            if (!Array.isArray(agentes) || agentes.length === 0) {
                container.innerHTML = '<div class="info">No hay agentes disponibles.</div>';
                return;
            }

            // ConstrucciÃ³n responsive: usa flexbox y tarjetas
            container.innerHTML = '';
            agentes.forEach(a => {
                const nombre = a.nombre || a.agente || 'Agente sin nombre';
                const email = a.email ? `<div class="agent-email">${escapeHtml(a.email)}</div>` : '';
                const acum = a.objetivosAcumulados ? 'SÃ­' : 'No';

                const card = document.createElement('div');
                card.className = 'agent-card';
                card.innerHTML = `
                    <div class="agent-card-inner">
                        <h3 class="agent-name">${escapeHtml(nombre)}</h3>
                        ${email}
                        <div class="agent-meta">ID: <span class="meta-val">${escapeHtml(a.id||'')}</span> Â· Objetivos acumulados: <span class="meta-val">${escapeHtml(acum)}</span></div>
                        <div class="agent-actions">
                            <button class="btn small" onclick="openAgentDetail('${escapeHtml(a.id||'')}', '${escapeHtml(nombre)}')">Abrir</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        /* Ejemplo de funciÃ³n que abre detalle (puedes personalizar) */
        function openAgentDetail(id, nombre) {
            // usa esto para mostrar la vista de agente o poner el id en un formulario
            console.log('Abrir detalle agente', id, nombre);
            // ej. fill a form, mostrar modal, llamar obtenerDatosDashboard({agentId: id})
            // AquÃ­ solo un ejemplo rÃ¡pido:
            const detalle = document.getElementById('agentDetail');
            if (detalle) detalle.innerHTML = `<h4>Detalle: ${escapeHtml(nombre)}</h4><p>ID: ${escapeHtml(id)}</p>`;
        }

        /* Auto carga al cargar la pÃ¡gina */
        document.addEventListener('DOMContentLoaded', loadAgentes);
        function mostrarModalModeloEconomico() {
    document.getElementById('modal-modelo-economico').classList.add('active');
    document.body.classList.add('modal-open');
}


function mostrarModalModeloOrganizativo() {
    
    document.getElementById('modal-modelo-organizativo').classList.add('active');
    document.body.classList.add('modal-open');
    
    // Cargar organigrama actual si existe
    google.script.run
        .withSuccessHandler(function(datos) {
            if (datos) {
                document.getElementById('org-team-leader').value = datos.teamLeader || '';
                document.getElementById('org-lider-ventas').value = datos.liderVentas || '';
                document.getElementById('org-lider-captacion').value = datos.liderCaptacion || '';
                document.getElementById('org-agente-1').value = datos.agentes[0] || '';
                document.getElementById('org-agente-2').value = datos.agentes[1] || '';
                document.getElementById('org-agente-3').value = datos.agentes[2] || '';
                document.getElementById('org-agente-4').value = datos.agentes[3] || '';
            }
        })
        .withFailureHandler(function(err) {
            console.log('No hay organigrama previo:', err);
        })
        .obtenerOrganigrama();
}

// === LOGICA GPS 1-3-5 ===

function mostrarModalPlantillaGPS() {
    
    document.getElementById('modal-plantilla-gps').classList.add('active');
    document.body.classList.add('modal-open');
    
    // Poner nombre del agente en el papel
    const nombre = agenteActual ? agenteActual.nombre : "Agente";
    document.getElementById('gps-display-name').textContent = nombre;

    // Cargar datos guardados
    cargarDatosGPS();
}

function guardarDatosGPS() {
    // 1. Obtener el nombre escrito en el papel
    const nombreEscrito = document.getElementById('gps-display-name').value;
    const anioEscrito = document.getElementById('gps-display-year').value;

    // 2. Definir identidad para guardar
    let idParaGuardar = 'GERENTE'; 
    let nombreParaGuardar = nombreEscrito || 'Gerente';

    // Si hay un agente logueado (Vista Agente), usamos su ID real
    if (typeof agenteActual !== 'undefined' && agenteActual) {
        idParaGuardar = agenteActual.id;
        nombreParaGuardar = agenteActual.nombre; // O respetamos si cambiÃ³ el nombre en el input
    } 
    else {
        // MODO GERENTE: Generamos un ID basado en el nombre escrito para diferenciar versiones
        // Ej: Si escribes "Juan Perez", el ID serÃ¡ "GPS_JUAN_PEREZ"
        if (nombreEscrito && nombreEscrito.trim() !== "") {
            idParaGuardar = 'GPS_' + nombreEscrito.trim().replace(/\s+/g, '_').toUpperCase();
        }
    }

    const contenido = {
        meta_nombre: nombreParaGuardar,
        meta_anio: anioEscrito,
        
        oneThing: document.getElementById('gps-onething').value,
        p1: {
            titulo: document.getElementById('gps-p1-title').value,
            s1: document.getElementById('gps-p1-s1').value,
            s2: document.getElementById('gps-p1-s2').value,
            s3: document.getElementById('gps-p1-s3').value,
            s4: document.getElementById('gps-p1-s4').value,
            s5: document.getElementById('gps-p1-s5').value
        },
        p2: {
            titulo: document.getElementById('gps-p2-title').value,
            s1: document.getElementById('gps-p2-s1').value,
            s2: document.getElementById('gps-p2-s2').value,
            s3: document.getElementById('gps-p2-s3').value,
            s4: document.getElementById('gps-p2-s4').value,
            s5: document.getElementById('gps-p2-s5').value
        },
        p3: {
            titulo: document.getElementById('gps-p3-title').value,
            s1: document.getElementById('gps-p3-s1').value,
            s2: document.getElementById('gps-p3-s2').value,
            s3: document.getElementById('gps-p3-s3').value,
            s4: document.getElementById('gps-p3-s4').value,
            s5: document.getElementById('gps-p3-s5').value
        }
    };

    const datos = {
        idAgente: idParaGuardar,
        nombreAgente: nombreParaGuardar,
        contenido: contenido
    };

    mostrarNotificacion(" ğŸ’¾  Guardando GPS...");

    google.script.run
        .withSuccessHandler(res => {
             mostrarNotificacion(" âœ… " + res.message);
        })
        .withFailureHandler(err => {
             mostrarNotificacion(" âŒ Error: " + err.message, true);
        })
        .guardarGPS135(datos);
}

function cargarDatosGPS() {
    if (!agenteActual) return;

    google.script.run
        .withSuccessHandler(function(res) {
            const data = res.contenido;
            if (data) {
                // Rellenar campos
                document.getElementById('gps-onething').value = data.oneThing || '';
                
                document.getElementById('gps-p1-title').value = data.p1?.titulo || '';
                document.getElementById('gps-p1-s1').value = data.p1?.s1 || '';
                document.getElementById('gps-p1-s2').value = data.p1?.s2 || '';
                document.getElementById('gps-p1-s3').value = data.p1?.s3 || '';
                document.getElementById('gps-p1-s4').value = data.p1?.s4 || '';
                document.getElementById('gps-p1-s5').value = data.p1?.s5 || '';

                document.getElementById('gps-p2-title').value = data.p2?.titulo || '';
                document.getElementById('gps-p2-s1').value = data.p2?.s1 || '';
                document.getElementById('gps-p2-s2').value = data.p2?.s2 || '';
                document.getElementById('gps-p2-s3').value = data.p2?.s3 || '';
                document.getElementById('gps-p2-s4').value = data.p2?.s4 || '';
                document.getElementById('gps-p2-s5').value = data.p2?.s5 || '';

                document.getElementById('gps-p3-title').value = data.p3?.titulo || '';
                document.getElementById('gps-p3-s1').value = data.p3?.s1 || '';
                document.getElementById('gps-p3-s2').value = data.p3?.s2 || '';
                document.getElementById('gps-p3-s3').value = data.p3?.s3 || '';
                document.getElementById('gps-p3-s4').value = data.p3?.s4 || '';
                document.getElementById('gps-p3-s5').value = data.p3?.s5 || '';
            } else {
                // Limpiar si es nuevo
                document.querySelectorAll('.gps-input-line, .gps-input-area').forEach(el => el.value = '');
            }
        })
        .obtenerGPS135(agenteActual.id);
}

function imprimirGPS() {
    document.body.classList.add('print-mode-gps'); // Activa modo GPS
    window.print();
    // Quitar la clase despuÃ©s de imprimir para que vuelva a la normalidad
    setTimeout(() => {
        document.body.classList.remove('print-mode-gps');
    }, 1000);
}

function mostrarModalRentabilidad() {
    
    document.getElementById('modal-rentabilidad').classList.add('active');
    document.body.classList.add('modal-open');
    
    setTimeout(() => {
        cargarRentabilidadAgentes();
    }, 100);
}



// ==========================================
// MODELO ECONÃ“MICO - FUNCIONES
// ==========================================

/**
 * Actualiza el slider de vendedores
 */
function actualizarSplitVendedores(valor) {
    const pctVend = parseInt(valor);
    const pctComp = 100 - pctVend;
    
    document.getElementById('me-pct-vend-label').textContent = pctVend + '%';
    document.getElementById('me-pct-vend-input').value = pctVend;
    document.getElementById('me-pct-comp-label').textContent = pctComp + '%';
}

function actualizarSliderVendedores(valor) {
    let pctVend = parseInt(valor) || 0;
    pctVend = Math.max(0, Math.min(100, pctVend));
    
    document.getElementById('me-pct-vendedores').value = pctVend;
    actualizarSplitVendedores(pctVend);
}

/**
 * Toggle objetivos globales
 */
function toggleObjetivosGlobales() {
    const checkbox = document.getElementById('me-usar-obj-globales');
    const container = document.getElementById('me-obj-globales-container');
    container.style.display = checkbox.checked ? 'block' : 'none';
}

/**
 * Toggle switch de objetivos activos
 */
function toggleObjetivosActivos() {
    const activo = document.getElementById('me-activo').checked;
    const estadoDiv = document.getElementById('me-estado-activo');
    
    if (activo) {
        estadoDiv.innerHTML = 'âœ… ACTIVO';
        estadoDiv.style.background = 'rgba(34,197,94,0.2)';
        estadoDiv.style.color = '#22c55e';
    } else {
        estadoDiv.innerHTML = 'â¸ï¸ INACTIVO';
        estadoDiv.style.background = 'rgba(156,39,176,0.2)';
        estadoDiv.style.color = '#9c27b0';
    }
}

/**
 * Toggle secciÃ³n de objetivos personalizados
 */
function toggleSeccionObjetivos() {
    const campos = document.getElementById('me-obj-campos');
    const toggle = document.getElementById('me-obj-toggle');
    
    if (campos.style.display === 'none') {
        campos.style.display = 'block';
        toggle.textContent = 'â–²';
    } else {
        campos.style.display = 'none';
        toggle.textContent = 'â–¼';
    }
}

/**
 * Calcula el modelo econÃ³mico
 */
function calcularModeloEconomico() {
    // Obtener valores de las 6 preguntas
    const beneficio = parseFloat(document.getElementById('me-beneficio').value) || 0;
    const comisionMedia = parseFloat(document.getElementById('me-comision-media').value) || 0;
    const ratioCitaCapt = (parseFloat(document.getElementById('me-ratio-cita-capt').value) || 0) / 100;
    const ratioCaptVenta = (parseFloat(document.getElementById('me-ratio-capt-venta').value) || 0) / 100;
    const compradoresPorVenta = parseFloat(document.getElementById('me-compradores-venta').value) || 1;
    const casasPorVenta = parseFloat(document.getElementById('me-casas-venta').value) || 1;
    
    const pctVendedores = (parseFloat(document.getElementById('me-pct-vend-input').value) || 50) / 100;
    const pctCompradores = 1 - pctVendedores;
    
    if (beneficio <= 0 || comisionMedia <= 0) {
        mostrarNotificacion('âš ï¸ Completa el Beneficio y la ComisiÃ³n Media', 'error');
        return;
    }
    
    // CÃLCULOS
    const gciTotal = beneficio / 0.40;
    const costesVentas = gciTotal * 0.30;
    const costesOperativos = gciTotal * 0.30;
    const totalTransacciones = Math.ceil(gciTotal / comisionMedia);
    
    // VENDEDORES
    const gciVendedores = gciTotal * pctVendedores;
    const ventasCaptaciones = Math.ceil(gciVendedores / comisionMedia);
    const captacionesNecesarias = ratioCaptVenta > 0 ? Math.ceil(ventasCaptaciones / ratioCaptVenta) : 0;
    const citasNecesarias = ratioCitaCapt > 0 ? Math.ceil(captacionesNecesarias / ratioCitaCapt) : 0;
    const citasMes = Math.ceil(citasNecesarias / 12);
    const citasSemana = Math.ceil(citasNecesarias / 52);
    
    // COMPRADORES
    const gciCompradores = gciTotal * pctCompradores;
    const ventasCompradores = Math.ceil(gciCompradores / comisionMedia);
    const clientesConVisitas = ventasCompradores * compradoresPorVenta;
    const casasEnsenadas = ventasCompradores * casasPorVenta;
    const casasMes = Math.ceil(casasEnsenadas / 12);
    const casasSemana = Math.ceil(casasEnsenadas / 52);
    const casasDia = Math.ceil(casasEnsenadas / 260);
    
    // Formateo
    const fmt = (n) => Math.round(n).toLocaleString('es-ES');
    const fmtEur = (n) => fmt(n) + 'â‚¬';
    
    // MOSTRAR RESULTADOS
    document.getElementById('me-res-gci').textContent = fmtEur(gciTotal);
    document.getElementById('me-res-costes-ventas').textContent = fmtEur(costesVentas);
    document.getElementById('me-res-costes-ops').textContent = fmtEur(costesOperativos);
    document.getElementById('me-res-beneficio').textContent = fmtEur(beneficio);
    document.getElementById('me-res-comision').textContent = fmtEur(comisionMedia);
    document.getElementById('me-res-transacciones').textContent = fmt(totalTransacciones);
    
    // Vendedores
    document.getElementById('me-res-pct-vend').textContent = `${Math.round(pctVendedores * 100)}% = ${fmtEur(gciVendedores)}`;
    document.getElementById('me-res-ventas-capt').textContent = fmt(ventasCaptaciones);
    document.getElementById('me-res-captaciones').textContent = fmt(captacionesNecesarias);
    document.getElementById('me-res-citas').textContent = fmt(citasNecesarias);
    document.getElementById('me-res-citas-mes').textContent = fmt(citasMes);
    document.getElementById('me-res-citas-semana').textContent = fmt(citasSemana);
    
    // Compradores
    document.getElementById('me-res-pct-comp').textContent = `${Math.round(pctCompradores * 100)}% = ${fmtEur(gciCompradores)}`;
    document.getElementById('me-res-ventas-comp').textContent = fmt(ventasCompradores);
    document.getElementById('me-res-clientes').textContent = fmt(clientesConVisitas);
    document.getElementById('me-res-casas-total').textContent = fmt(casasEnsenadas);
    document.getElementById('me-res-casas-mes').textContent = fmt(casasMes);
    document.getElementById('me-res-casas-semana').textContent = fmt(casasSemana);
    document.getElementById('me-res-casas-dia').textContent = fmt(casasDia);
    
    // PRE-RELLENAR OBJETIVOS CALCULADOS
    document.getElementById('me-obj-gci').value = Math.round(gciTotal);
    document.getElementById('me-obj-citas-capt').value = citasNecesarias;
    document.getElementById('me-obj-excl-venta').value = captacionesNecesarias;
    document.getElementById('me-obj-ventas').value = totalTransacciones;
    document.getElementById('me-obj-citas-comp').value = Math.round(clientesConVisitas);
    document.getElementById('me-obj-casas').value = Math.round(casasEnsenadas);
    
    // Mostrar resultados
    document.getElementById('me-resultados').style.display = 'block';
    
    // Guardar en variable global
    window.modeloEconomicoCalculado = {
        beneficio, comisionMedia, ratioCitaCapt, ratioCaptVenta,
        compradoresPorVenta, casasPorVenta, pctVendedores,
        gciTotal, totalTransacciones, citasNecesarias, captacionesNecesarias,
        casasEnsenadas, clientesConVisitas
    };
    
    mostrarNotificacion('âœ… Modelo calculado', 'success');
}

/**
 * Guarda el modelo econÃ³mico
 */
function guardarModeloEconomico() {
    if (!window.modeloEconomicoCalculado) {
        mostrarNotificacion('âš ï¸ Primero calcula el modelo', 'error');
        return;
    }
    
    const calc = window.modeloEconomicoCalculado;
    const activo = document.getElementById('me-activo').checked;
    
    const getVal = (id) => {
        const el = document.getElementById(id);
        const val = el ? parseFloat(el.value) : null;
        return val > 0 ? val : null;
    };
    
    const datos = {
        activo: activo,
        beneficio: calc.beneficio,
        comisionMedia: calc.comisionMedia,
        ratioCitaCapt: calc.ratioCitaCapt * 100,
        ratioCaptVenta: calc.ratioCaptVenta * 100,
        compradoresPorVenta: calc.compradoresPorVenta,
        casasPorVenta: calc.casasPorVenta,
        pctVendedores: calc.pctVendedores * 100,
        calculados: {
            gci: calc.gciTotal,
            transacciones: calc.totalTransacciones,
            citas: calc.citasNecesarias,
            captaciones: calc.captacionesNecesarias,
            casas: calc.casasEnsenadas,
            clientes: calc.clientesConVisitas
        },
        objetivos: {
            gci: getVal('me-obj-gci'),
            citasCaptacion: getVal('me-obj-citas-capt'),
            exclusivasVenta: getVal('me-obj-excl-venta'),
            captAbierto: getVal('me-obj-capt-abierto'),
            citasComprador: getVal('me-obj-citas-comp'),
            casasEnsenadas: getVal('me-obj-casas'),
            exclusivasCompr: getVal('me-obj-excl-comp'),
            llamadas: getVal('me-obj-llamadas'),
            captAlquiler: getVal('me-obj-capt-alq'),
            leadVendedor: getVal('me-obj-lead-vend'),
            tresBs: getVal('me-obj-3bs'),
            bajadasPrecio: getVal('me-obj-bajadas'),
            leadComprador: getVal('me-obj-lead-comp'),
            propuestasCompra: getVal('me-obj-propuestas'),
            leadSeguimiento: getVal('me-obj-lead-seg'),
            arras: getVal('me-obj-arras'),
            ventas: getVal('me-obj-ventas'),
            volumenNegocio: getVal('me-obj-volumen')
        }
    };
    
    console.log('ğŸ’¾ Guardando modelo:', datos);
    
    google.script.run
        .withSuccessHandler(function(resultado) {
            if (resultado.success) {
                mostrarNotificacion('âœ… Modelo econÃ³mico guardado', 'success');
                
                // Actualizar variable global si estÃ¡ activo
                if (activo) {
                    window.objetivosGlobalesOficina = datos.objetivos;
                } else {
                    window.objetivosGlobalesOficina = null;
                }
                
                cerrarModalSuperior('modal-modelo-economico');
            } else {
                mostrarNotificacion('âŒ ' + resultado.message, 'error');
            }
        })
        .withFailureHandler(function(error) {
            mostrarNotificacion('âŒ Error: ' + error, 'error');
        })
        .guardarModeloEconomico(datos);
}

/**
 * Carga el modelo econÃ³mico al abrir el modal
 */
function cargarModeloEconomico() {
    google.script.run
        .withSuccessHandler(function(datos) {
            if (!datos) {
                console.log('â„¹ï¸ No hay modelo guardado');
                document.getElementById('me-activo').checked = false;
                toggleObjetivosActivos();
                return;
            }
            
            console.log('ğŸ“Š Modelo cargado:', datos);
            
            // Checkbox activo
            document.getElementById('me-activo').checked = datos.activo;
            toggleObjetivosActivos();
            
            // 6 Preguntas
            if (document.getElementById('me-beneficio')) document.getElementById('me-beneficio').value = datos.beneficio || '';
            if (document.getElementById('me-comision-media')) document.getElementById('me-comision-media').value = datos.comisionMedia || '';
            if (document.getElementById('me-ratio-cita-capt')) document.getElementById('me-ratio-cita-capt').value = datos.ratioCitaCapt || '';
            if (document.getElementById('me-ratio-capt-venta')) document.getElementById('me-ratio-capt-venta').value = datos.ratioCaptVenta || '';
            if (document.getElementById('me-compradores-venta')) document.getElementById('me-compradores-venta').value = datos.compradoresPorVenta || '';
            if (document.getElementById('me-casas-venta')) document.getElementById('me-casas-venta').value = datos.casasPorVenta || '';
            
            // Split
            if (datos.pctVendedores) {
                actualizarSliderVendedores(datos.pctVendedores);
            }
            
            // Objetivos guardados
            if (datos.objetivos) {
                const obj = datos.objetivos;
                if (obj.gci) document.getElementById('me-obj-gci').value = obj.gci;
                if (obj.citasCaptacion) document.getElementById('me-obj-citas-capt').value = obj.citasCaptacion;
                if (obj.exclusivasVenta) document.getElementById('me-obj-excl-venta').value = obj.exclusivasVenta;
                if (obj.captAbierto) document.getElementById('me-obj-capt-abierto').value = obj.captAbierto;
                if (obj.citasComprador) document.getElementById('me-obj-citas-comp').value = obj.citasComprador;
                if (obj.casasEnsenadas) document.getElementById('me-obj-casas').value = obj.casasEnsenadas;
                if (obj.exclusivasCompr) document.getElementById('me-obj-excl-comp').value = obj.exclusivasCompr;
                if (obj.llamadas) document.getElementById('me-obj-llamadas').value = obj.llamadas;
                if (obj.captAlquiler) document.getElementById('me-obj-capt-alq').value = obj.captAlquiler;
                if (obj.leadVendedor) document.getElementById('me-obj-lead-vend').value = obj.leadVendedor;
                if (obj.tresBs) document.getElementById('me-obj-3bs').value = obj.tresBs;
                if (obj.bajadasPrecio) document.getElementById('me-obj-bajadas').value = obj.bajadasPrecio;
                if (obj.leadComprador) document.getElementById('me-obj-lead-comp').value = obj.leadComprador;
                if (obj.propuestasCompra) document.getElementById('me-obj-propuestas').value = obj.propuestasCompra;
                if (obj.leadSeguimiento) document.getElementById('me-obj-lead-seg').value = obj.leadSeguimiento;
                if (obj.arras) document.getElementById('me-obj-arras').value = obj.arras;
                if (obj.ventas) document.getElementById('me-obj-ventas').value = obj.ventas;
                if (obj.volumenNegocio) document.getElementById('me-obj-volumen').value = obj.volumenNegocio;
            }
            
            // Si hay datos completos, calcular
            if (datos.beneficio && datos.comisionMedia) {
                calcularModeloEconomico();
            }
        })
        .withFailureHandler(function(error) {
            console.error('Error cargando modelo:', error);
        })
        .obtenerModeloEconomico();
}

/**
 * Abre el modal del modelo econÃ³mico
 */
function mostrarModalModeloEconomico() {
    cerrarModalSuperior('modal-acciones');
    document.getElementById('modal-modelo-economico').classList.add('active');
    document.body.classList.add('modal-open');
    
    // Resetear vista de resultados
    const resultados = document.getElementById('me-resultados');
    if (resultados) resultados.style.display = 'none';
    
    // Cargar datos guardados del modelo
    cargarModeloEconomico();
    
    // Cargar cuadre de objetivos despuÃ©s de un momento
    setTimeout(function() {
        if (typeof cargarCuadreObjetivos === 'function') {
            cargarCuadreObjetivos();
        }
    }, 500);
}

let datosPresupuestoGlobal = null; // Variable para guardar los datos al hacer clic

function cargarModeloPresupuestario() {
    const ctx = document.getElementById('chart-presupuestario');
    
    // Mostrar "Cargando..." visualmente (opcional, ayuda a saber que estÃ¡ pensando)
    if (chartInstances['presupuestario']) {
        chartInstances['presupuestario'].clear(); 
    }

    // LLAMADA AL SERVIDOR (Google Script)
    google.script.run
      .withSuccessHandler(function(datos) {
          console.log("DATOS RECIBIDOS DEL SERVIDOR:", datos); // <--- Mira la consola (F12) para ver esto
          datosPresupuestoGlobal = datos; 
          
          // Calcular Beneficio Neto (GCI - GastosVentas - GastosOperativos)
          const beneficio = datos.gciMensual.map((gci, i) => {
              return gci - datos.gastosVentas[i] - datos.gastosOperativos[i];
          });

          if (chartInstances['presupuestario']) chartInstances['presupuestario'].destroy();

          chartInstances['presupuestario'] = new Chart(ctx, {
              type: 'bar',
              data: {
                  labels: datos.meses,
                  datasets: [
                      {
                          label: 'GCI Real (Ingresos)',
                          data: datos.gciMensual,
                          backgroundColor: 'rgba(0, 255, 136, 0.3)',
                          borderColor: 'rgba(0, 255, 136, 1)',
                          borderWidth: 1,
                          stack: 'Ingresos',
                          order: 1
                      },
                      {
                          label: 'Comisiones (Gastos Ventas)', 
                          data: datos.gastosVentas,
                          backgroundColor: 'rgba(255, 215, 0, 0.8)', // AMARILLO
                          stack: 'Gastos'
                      },
                      {
                          label: 'Gastos Operativos', 
                          data: datos.gastosOperativos,
                          backgroundColor: 'rgba(255, 68, 68, 0.8)', // ROJO
                          stack: 'Gastos'
                      },
                      {
                          label: 'Beneficio Neto',
                          data: beneficio,
                          type: 'line',
                          borderColor: 'rgba(102, 126, 234, 1)', // AZUL
                          borderWidth: 3,
                          pointBackgroundColor: '#fff',
                          pointRadius: 4,
                          order: 0 
                      }
                  ]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  interaction: {
                      mode: 'index',
                      intersect: false,
                  },
                  plugins: {
                      legend: { position: 'top' },
                      tooltip: {
                          callbacks: {
                              footer: () => ' ğŸ‘‡ Haz click para ver detalles'
                          }
                      }
                  },
                  onClick: (evt, elements) => {
                      // LÃ³gica del click para ver detalles
                      const chart = chartInstances['presupuestario'];
                      const points = chart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);

                      if (points.length) {
                          const firstPoint = points[0];
                          const mesIndex = firstPoint.index;
                          const datasetIndex = firstPoint.datasetIndex;
                          
                          // datasetIndex 1 = Comisiones, datasetIndex 2 = Operativos
                          if (datasetIndex === 1) {
                              mostrarDetalleGastos('VENTAS', mesIndex);
                          } else if (datasetIndex === 2) {
                              mostrarDetalleGastos('OPERATIVOS', mesIndex);
                          }
                      }
                  },
                  scales: {
                      y: { beginAtZero: true, stacked: true }, // Apilado
                      x: { stacked: true } 
                  }
              }
          });
      })
      .withFailureHandler(function(error) {
          console.error("Error:", error);
          alert("Error al cargar datos: " + error.message);
      })
      .obtenerDatosPresupuestarios(new Date().getFullYear());
}

function mostrarDetalleGastos(tipo, mesIndex) {
    if (!datosPresupuestoGlobal) return;
    
    const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    const nombreMes = meses[mesIndex];
    
    let listaItems = [];
    let titulo = "";
    
    if (tipo === 'VENTAS') {
        titulo = ` ğŸ’°  Comisiones Pagadas - ${nombreMes}`;
        listaItems = datosPresupuestoGlobal.detallesVentas[mesIndex];
    } else {
        titulo = ` ğŸ’¸  Gastos Operativos - ${nombreMes}`;
        listaItems = datosPresupuestoGlobal.detallesOperativos[mesIndex];
    }

    document.getElementById('detalle-titulo').innerText = titulo;
    const tbody = document.getElementById('detalle-tabla-body');
    tbody.innerHTML = '';
    
    let total = 0;

    if (listaItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No hay registros.</td></tr>';
    } else {
        listaItems.forEach(item => {
            total += item.importe;
            tbody.innerHTML += `
                <tr>
                    <td>${item.fecha}</td>
                    <td><strong>${item.concepto}</strong></td>
                    <td>${item.desc}</td>
                    <td style="text-align:right;">${item.importe.toLocaleString('es-ES', {minimumFractionDigits: 2})} â‚¬</td>
                </tr>
            `;
        });
    }
    
    document.getElementById('detalle-total').innerText = total.toLocaleString('es-ES', {style:'currency', currency:'EUR'});
    
    // Mostrar el modal pequeÃ±o sobre el grande
    document.getElementById('modal-detalle-gasto-mes').classList.add('active');
}

function guardarOrganigrama() {
    const organigrama = {
        teamLeader: document.getElementById('org-team-leader').value,
        liderVentas: document.getElementById('org-lider-ventas').value,
        liderCaptacion: document.getElementById('org-lider-captacion').value,
        agentes: [
            document.getElementById('org-agente-1').value,
            document.getElementById('org-agente-2').value,
            document.getElementById('org-agente-3').value,
            document.getElementById('org-agente-4').value
        ]
    };
    
    console.log('ğŸ’¾ Guardando organigrama:', organigrama);
    
    google.script.run
        .withSuccessHandler(function(respuesta) {
            alert('âœ… Organigrama guardado correctamente');
            cerrarModal();
        })
        .withFailureHandler(function(error) {
            alert('âŒ Error al guardar: ' + error.message);
        })
        .guardarOrganigrama(organigrama);
}

// --- FACTURACIÃ“N PASADA ---
function calcularFacturacionPasada() {
    const fuentes = ['ei', 'ref', 'bd', 'pros', 'port'];
    fuentes.forEach(f => {
        const v = parseFloat(document.getElementById(`fp-${f}-hon-v`).value)||0;
        const c = parseFloat(document.getElementById(`fp-${f}-hon-c`).value)||0;
        document.getElementById(`fp-${f}-total`).innerText = (v+c).toLocaleString('es-ES') + "â‚¬";
    });
}

// --- FUNCIÃ“N DE CARGA DE DATOS (RENTABILIDAD) ---
function cargarRentabilidadAgentes() {
    const container = document.getElementById('rentabilidad-content');
    // Leer estado del interruptor
    const toggle = document.getElementById('rentabilidad-toggle');
    const esProyeccion = toggle ? toggle.checked : false;
    
    container.innerHTML = '<div class="loader"></div><div>Calculando rentabilidad...</div>';

    google.script.run
        .withSuccessHandler(function(res) {
            if (!res || !res.success || !res.datos || res.datos.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center;">No hay datos financieros disponibles.</div>';
                return;
            }

            // 1. CALCULAR TOTALES GENERALES
            const totalFijo = res.datos.reduce((s, d) => s + (d[2] || 0), 0);
            const totalComision = res.datos.reduce((s, d) => s + (d[3] || 0), 0);
            const totalGCI = res.datos.reduce((s, d) => s + (d[6] || 0), 0);
            const totalBeneficio = res.datos.reduce((s, d) => s + (d[9] || 0), 0);
            const roiGlobal = totalGCI > 0 ? ((totalBeneficio / totalGCI) * 100) : 0;
            
            // 2. PREPARAR DATOS PARA GRÃFICOS
            const labels = res.datos.map(d => d[1]); // Nombres
            const dataGCI = res.datos.map(d => d[6]); // GCI
            const dataCoste = res.datos.map(d => d[2] + d[3]); // Fijo + Variable
            const dataValorHora = res.datos.map(d => d[8]); // Valor Hora
            
            // 3. GENERAR HTML CON RESUMEN EJECUTIVO
            let html = `
                <div style="text-align:right; font-size:0.9em; color:var(--color-accent-good); margin-bottom:15px; font-weight:700;">
                    ğŸ“Š VISTA: ${res.modo || 'A LA FECHA'}
                </div>
                
                <!-- RESUMEN EJECUTIVO -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: var(--color-surface); padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 0.85em; color: #aaa;">ğŸ’° GCI Total</div>
                        <div style="font-size: 1.8em; font-weight: 700; color: var(--color-accent-good);">
                            ${totalGCI.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬
                        </div>
                    </div>
                    
                    <div style="background: var(--color-surface); padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 0.85em; color: #aaa;">ğŸ’¸ Comisiones</div>
                        <div style="font-size: 1.8em; font-weight: 700; color: #ff6b6b;">
                            ${totalComision.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬
                        </div>
                        <div style="font-size: 0.75em; color: #aaa; margin-top: 3px;">
                            ${totalGCI > 0 ? ((totalComision / totalGCI) * 100).toFixed(1) : 0}% del GCI
                        </div>
                    </div>
                    
                    <div style="background: var(--color-surface); padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 0.85em; color: #aaa;">ğŸ¢ Sueldos Fijos</div>
                        <div style="font-size: 1.8em; font-weight: 700; color: #ffd700;">
                            ${totalFijo.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬
                        </div>
                    </div>
                    
                    <div style="background: var(--color-surface); padding: 15px; border-radius: 10px; text-align: center; border: 2px solid ${totalBeneficio >= 0 ? '#22c55e' : '#ff6b6b'};">
                        <div style="font-size: 0.85em; color: ${totalBeneficio >= 0 ? '#22c55e' : '#ff6b6b'};">âœ… Beneficio Neto</div>
                        <div style="font-size: 1.8em; font-weight: 700; color: ${totalBeneficio >= 0 ? '#22c55e' : '#ff6b6b'};">
                            ${totalBeneficio.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬
                        </div>
                        <div style="font-size: 0.75em; color: ${totalBeneficio >= 0 ? '#22c55e' : '#ff6b6b'}; margin-top: 3px; font-weight: 700;">
                            ROI: ${roiGlobal.toFixed(1)}%
                        </div>
                    </div>
                </div>
                
                <!-- TABLA DETALLADA -->
                <div class="tabla-container">
                    <table class="tabla" style="font-size: 0.9em;">
                        <thead>
                            <tr style="background: rgba(255,255,255,0.05);">
                                <th style="text-align:left;">AGENTE</th>
                                <th>FIJO</th>
                                <th>COMISIÃ“N</th>
                                <th>% COMIS.</th>
                                <th style="color:var(--color-accent-bad)">COSTE TOTAL</th>
                                <th style="color:var(--color-accent-good)">GCI</th>
                                <th>BENEFICIO</th>
                                <th>ROI %</th>
                                <th>COSTE/H</th>
                                <th>VALOR/H</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            res.datos.forEach(fila => {
                const costeTotal = fila[2] + fila[3];
                const pctComision = fila[6] > 0 ? ((fila[3] / fila[6]) * 100) : 0;
                const claseBeneficio = fila[9] >= 0 ? 'ratio-excelente' : 'ratio-bajo';
                const colorROI = fila[7] >= 50 ? '#22c55e' : fila[7] >= 30 ? '#ffd700' : '#ff6b6b';
                
                html += `
                    <tr>
                        <td style="text-align:left; font-weight:bold;">${fila[1]}</td>
                        <td>${(fila[2]||0).toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</td>
                        <td style="color:#ff6b6b; font-weight:700;">${(fila[3]||0).toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</td>
                        <td style="text-align:center; color:#ff6b6b;">${pctComision.toFixed(1)}%</td>
                        <td style="color:#ff6b6b;">${costeTotal.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</td>
                        <td style="color:#22c55e; font-weight:bold;">${(fila[6]||0).toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</td>
                        <td class="${claseBeneficio}" style="font-weight:900; font-size:1.05em;">${(fila[9]||0).toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</td>
                        <td style="color:${colorROI}; font-weight:700; text-align:center;">${(fila[7]||0).toFixed(0)}%</td>
                        <td style="text-align:center;">${(fila[5]||0).toFixed(1)}â‚¬</td>
                        <td style="font-weight:bold; text-align:center;">${(fila[8]||0).toFixed(1)}â‚¬</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                        <tfoot>
                            <tr style="background: var(--color-surface); font-weight: bold; font-size: 1.05em; border-top: 2px solid rgba(255,255,255,0.2);">
                                <td style="text-align:left;">TOTAL</td>
                                <td>${totalFijo.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</td>
                                <td style="color:#ff6b6b; font-weight:900;">${totalComision.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</td>
                                <td style="text-align:center; color:#ff6b6b;">${totalGCI > 0 ? ((totalComision / totalGCI) * 100).toFixed(1) : 0}%</td>
                                <td style="color:#ff6b6b;">${(totalFijo + totalComision).toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</td>
                                <td style="color:#22c55e; font-weight:900;">${totalGCI.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</td>
                                <td style="color:${totalBeneficio >= 0 ? '#22c55e' : '#ff6b6b'}; font-weight:900;">${totalBeneficio.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</td>
                                <td style="color:${roiGlobal >= 50 ? '#22c55e' : roiGlobal >= 30 ? '#ffd700' : '#ff6b6b'}; font-weight:900; text-align:center;">${roiGlobal.toFixed(1)}%</td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <!-- NOTAS EXPLICATIVAS -->
                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-top: 20px; font-size: 0.85em; line-height: 1.8;">
                    <strong>ğŸ“Š FÃ³rmulas:</strong><br>
                    â€¢ <strong>ComisiÃ³n</strong> = GCI Ã— % ComisiÃ³n (dato real de cada transacciÃ³n)<br>
                    â€¢ <strong>Coste Total</strong> = Sueldo Fijo + Comisiones<br>
                    â€¢ <strong>Beneficio Neto</strong> = GCI - Coste Total<br>
                    â€¢ <strong>ROI</strong> = (Beneficio Neto / GCI) Ã— 100<br><br>
                    <strong>ğŸ¯ InterpretaciÃ³n ROI:</strong><br>
                    <span style="color:#22c55e;">â‰¥50%</span>: Excelente | 
                    <span style="color:#ffd700;">30-50%</span>: Aceptable | 
                    <span style="color:#ff6b6b;"><30%</span>: Revisar
                </div>
            `;
            
            container.innerHTML = html;

            // 3. LLAMADA A LA FUNCIÃ“N DE DIBUJO (CORREGIDA)
            setTimeout(() => {
                renderizarGraficosRentabilidad(labels, dataGCI, dataCoste, dataValorHora);
            }, 100);
        })
        .withFailureHandler(function(err){
            console.error("Error Rentabilidad:", err);
            container.innerHTML = `<div style="color:red">Error: ${err.message}</div>`;
        })
        .calcularRentabilidadAgentes(new Date().getFullYear(), esProyeccion);
}

// --- FUNCIÃ“N DE DIBUJO DE GRÃFICOS (PEGA ESTO TAMBIÃ‰N) ---
function renderizarGraficosRentabilidad(labels, dataGCI, dataCoste, dataValorHora) {
    // GRÃFICO 1: GCI vs COSTE
    const ctx1 = document.getElementById('chart-rentabilidad-barras');
    if (ctx1) {
        if (chartInstances.rent1) chartInstances.rent1.destroy();
        
        chartInstances.rent1 = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'GCI Generado',
                        data: dataGCI,
                        backgroundColor: 'rgba(0, 255, 136, 0.6)', // Verde KW
                        borderColor: '#22c55e',
                        borderWidth: 1
                    },
                    {
                        label: 'Coste Total',
                        data: dataCoste,
                        backgroundColor: 'rgba(255, 68, 68, 0.6)', // Rojo Alerta
                        borderColor: '#ff4444',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' } },
                scales: { y: { beginAtZero: true } },
                onClick: () => ampliarGrafico('rent1', 'ğŸ’° Detalle GCI vs Coste')
            }
        });
    }

    // GRÃFICO 2: VALOR POR HORA
    const ctx2 = document.getElementById('chart-rentabilidad-valor');
    if (ctx2) {
        if (chartInstances.rent2) chartInstances.rent2.destroy();

        chartInstances.rent2 = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Valor Generado / Hora (â‚¬)',
                    data: dataValorHora,
                    backgroundColor: 'rgba(102, 126, 234, 0.6)', // Azul IA
                    borderColor: '#667eea',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y', // GrÃ¡fico horizontal
                plugins: { legend: { display: false } },
                scales: { x: { beginAtZero: true } },
                onClick: () => ampliarGrafico('rent2', 'âš¡ Ranking de Eficiencia (â‚¬/hora)')
            }
        });
    }
}
function mostrarModalRegistrarGasto() {
    // PRIMERO: Abrir el modal INMEDIATAMENTE (no esperar)
    document.getElementById('modal-registrar-gasto').classList.add('active');
    document.body.classList.add('modal-open');
    document.getElementById('form-gasto').reset();
    document.getElementById('gasto-fecha').valueAsDate = new Date();
    
    // SEGUNDO: Cargar partidas en paralelo (en segundo plano)
    // Solo si el datalist estÃ¡ vacÃ­o (primera vez)
    const datalist = document.getElementById('partidas-list');
    if (datalist.children.length === 0) {
        google.script.run
            .withSuccessHandler(function(partidas) {
                datalist.innerHTML = '';
                partidas.forEach(partida => {
                    datalist.innerHTML += `<option value="${partida}">`;
                });
            })
            .withFailureHandler(function(error) {
                console.error('Error al cargar partidas:', error);
                // El modal ya estÃ¡ abierto, el usuario puede escribir manualmente
            })
            .obtenerPartidasGastos();
    }
}
function guardarGasto(event) {
    event.preventDefault();
    const datos = {
        fecha: document.getElementById('gasto-fecha').value,
        partida: document.getElementById('gasto-partida').value,
        descripcion: document.getElementById('gasto-descripcion').value,
        importe: document.getElementById('gasto-importe').value
    };

    google.script.run
        .withSuccessHandler(function(res) {
            alert(' âœ… ' + res.message);
            mostrarModalRegistrarGasto(); // Limpiar y seguir registrando
        })
        .withFailureHandler(function(err) {
            mostrarError(err);
        })
        .guardarGastoOperativo(datos);
}
// --- ESTA ES LA FUNCIÃ“N QUE FALTA ---
function mostrarNotificacion(mensaje, esError = false) {
    const x = document.getElementById("app-notification");
    if (!x) return;
    
    x.textContent = mensaje;
    x.className = "show " + (esError ? "error" : "success");
    
    // Ocultar despuÃ©s de 3 segundos
    setTimeout(function(){ 
        x.className = x.className.replace("show", ""); 
        // Limpiar clases de color
        setTimeout(() => { x.className = ""; }, 300);
    }, 3000);
}
// --- FUNCIÃ“N PARA EXPORTAR A CSV ---
function exportarTransaccionesCSV() {
    const transacciones = window.transaccionesGlobales || [];
    
    // Verificar si hay datos
    if (transacciones.length === 0) {
        mostrarNotificacion("No hay datos para exportar", true);
        return;
    }

    // 1. Aplicar el filtro actual (si hay uno seleccionado)
    let datosExportar = transacciones;
    // Aseguramos que la variable filtroMesTransacciones exista, si no, asumimos 'todos'
    const filtroActual = (typeof filtroMesTransacciones !== 'undefined') ? filtroMesTransacciones : 'todos';

    if (filtroActual !== 'todos') {
        datosExportar = transacciones.filter(t => new Date(t.fecha).getMonth() == filtroActual);
    }

    if (datosExportar.length === 0) {
        mostrarNotificacion("La selecciÃ³n actual estÃ¡ vacÃ­a", true);
        return;
    }

    // 2. Crear cabeceras CSV
    let csvContent = "Fecha,Agente,Tipo,Lado,Descripcion,GCI,Comision\n";

    // 3. Recorrer datos y formatear
    datosExportar.forEach(t => {
        const fechaObj = new Date(t.fecha);
        const fechaStr = !isNaN(fechaObj) ? fechaObj.toLocaleDateString('es-ES') : t.fecha;
        
        // Limpiar descripciÃ³n de comas para no romper las columnas del CSV
        const descLimpia = (t.descripcion || "").replace(/,/g, " "); 
        const tipoLimpio = (t.tipo || "").replace(/,/g, " ");

        const fila = [
            fechaStr,
            t.agente,
            tipoLimpio,
            t.lado,
            descLimpia,
            (t.gci || 0).toFixed(2),      // Exportamos nÃºmero limpio
            (t.comision || 0).toFixed(2)
        ].join(",");
        
        csvContent += fila + "\n";
    });

    // 4. Generar descarga con codificaciÃ³n correcta para tildes (BOM)
    const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    
    // Nombre del archivo dinÃ¡mico segÃºn el mes
    const nombresMeses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    const sufijo = (filtroActual !== 'todos' && nombresMeses[filtroActual]) ? `_${nombresMeses[filtroActual]}` : '_anual';
    
    link.setAttribute("href", url);
    link.setAttribute("download", `transacciones_kw${sufijo}.csv`);
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    mostrarNotificacion(" âœ…  CSV descargado correctamente");
}
// --- LOGICA ORGANIGRAMA 7 NIVELES ---

function mostrarModalModeloOrganizativo() {
    abrirModalEncima('modal-modelo-organizativo');
    
    // Cargamos datos del servidor
    google.script.run.withSuccessHandler(jsonTexto => {
        if (jsonTexto) {
            try {
                const datos = JSON.parse(jsonTexto);
                // Recorremos todos los inputs del modal y si hay dato guardado, lo ponemos
                const inputs = document.querySelectorAll('.org-role-input');
                inputs.forEach(input => {
                    if (datos[input.id]) {
                        input.value = datos[input.id];
                    }
                });
            } catch (e) {
                console.error("Error al parsear organigrama", e);
            }
        }
    }).obtenerOrganigramaJSON();
}

function guardarOrganigramaCompleto() {
    const inputs = document.querySelectorAll('.org-role-input');
    const datos = {};
    
    // Guardamos cada casilla con su ID como clave
    inputs.forEach(input => {
        if(input.value.trim() !== "") {
            datos[input.id] = input.value;
        }
    });

    const jsonTexto = JSON.stringify(datos);
    mostrarNotificacion("ğŸ’¾ Guardando Organigrama...");

    google.script.run
        .withSuccessHandler(() => {
            mostrarNotificacion("âœ… Modelo Organizativo Guardado");
            // Opcional: cerrarModalSuperior('modal-modelo-organizativo');
        })
        .withFailureHandler(err => mostrarNotificacion("âŒ Error: " + err.message, true))
        .guardarOrganigramaJSON(jsonTexto);
}
// ==========================================
// ğŸ§  NUEVAS HERRAMIENTAS DE CONSULTORÃA
// ==========================================

// --- GESTIÃ“N DE DATOS HISTÃ“RICOS COMPLETOS ---
let datosHistoricosCache = null;

function mostrarModalFacturacionPasada() {
    cerrarModalSuperior('modal-acciones');
    abrirModalEncima('modal-facturacion-pasada');
    
    // Obtener aÃ±o contable
    google.script.run
        .withSuccessHandler(function(aÃ±oContable) {
            const aÃ±oAnterior = aÃ±oContable - 1;
            
            // Guardar aÃ±o para el guardado
            document.getElementById('modal-facturacion-pasada').dataset.aÃ±o = aÃ±oAnterior;
            
            // Actualizar tÃ­tulo
            const titulo = document.querySelector('#modal-facturacion-pasada .section-title');
            if (titulo) {
                titulo.textContent = `ğŸ“Š Datos HistÃ³ricos ${aÃ±oAnterior} (Base Comparativa)`;
            }
            
            // Cargar orÃ­genes dinÃ¡micamente
            google.script.run
                .withSuccessHandler(function(origenes) {
                    const tbody = document.getElementById('tabla-origenes-negocio');
                    let html = '';
                    
                    origenes.forEach((origen, idx) => {
                        html += `
                            <tr>
                                <td style="text-align:left;">${origen}</td>
                                <td><input type="number" id="fp-origen-${idx}-capt" class="form-input" value="0" min="0"></td>
                                <td><input type="number" id="fp-origen-${idx}-gci" class="form-input" value="0" min="0" step="0.01" oninput="calcularPorcentajesFuentes()"></td>
                                <td id="fp-origen-${idx}-pct" style="font-weight:700;">0%</td>
                            </tr>
                        `;
                    });
                    
                    tbody.innerHTML = html;
                    
                    // CARGAR DATOS GUARDADOS
                    google.script.run
                        .withSuccessHandler(function(datosCompletos) {
                            console.log('ğŸ“Š Datos recibidos:', datosCompletos);
                            
                            if (datosCompletos && datosCompletos.kpis) {
                                const k = datosCompletos.kpis;
                                console.log('ğŸ“Š KPIs:', k);
                                
                                // USAR IDs CORRECTOS (hist-*)
                                if (document.getElementById('hist-citas')) document.getElementById('hist-citas').value = k.citasCaptacion || 0;
                                if (document.getElementById('hist-exclusivas')) document.getElementById('hist-exclusivas').value = k.exclusivasVenta || 0;
                                if (document.getElementById('hist-abierto')) document.getElementById('hist-abierto').value = k.captAbierto || 0;
                                if (document.getElementById('hist-citas-comp')) document.getElementById('hist-citas-comp').value = k.citasComprador || 0;
                                if (document.getElementById('hist-visitas')) document.getElementById('hist-visitas').value = k.casasEnsenadas || 0;
                                if (document.getElementById('hist-exclusivas-comp')) document.getElementById('hist-exclusivas-comp').value = k.exclusivasCompr || 0;
                                if (document.getElementById('hist-llamadas')) document.getElementById('hist-llamadas').value = k.llamadas || 0;
                                if (document.getElementById('hist-capt-alquiler')) document.getElementById('hist-capt-alquiler').value = k.captAlquiler || 0;
                                if (document.getElementById('hist-lead-vendedor')) document.getElementById('hist-lead-vendedor').value = k.leadVendedor || 0;
                                if (document.getElementById('hist-3bs')) document.getElementById('hist-3bs').value = k.tresBs || 0;
                                if (document.getElementById('hist-bajadas-precio')) document.getElementById('hist-bajadas-precio').value = k.bajadasPrecio || 0;
                                if (document.getElementById('hist-lead-comprador')) document.getElementById('hist-lead-comprador').value = k.leadComprador || 0;
                                if (document.getElementById('hist-propuestas-compra')) document.getElementById('hist-propuestas-compra').value = k.propuestasCompra || 0;
                                if (document.getElementById('hist-lead-seguimiento')) document.getElementById('hist-lead-seguimiento').value = k.leadSeguimiento || 0;
                                if (document.getElementById('hist-arras')) document.getElementById('hist-arras').value = k.arras || 0;
                                if (document.getElementById('hist-ventas')) document.getElementById('hist-ventas').value = k.ventas || 0;
                                if (document.getElementById('hist-gci')) document.getElementById('hist-gci').value = k.gci || 0;
                                
                                console.log('âœ… KPIs cargados en formulario');
                            }
                            
                            if (datosCompletos && datosCompletos.origenes && datosCompletos.origenes.length > 0) {
                                datosCompletos.origenes.forEach((origen, idx) => {
                                    const captInput = document.getElementById(`fp-origen-${idx}-capt`);
                                    const gciInput = document.getElementById(`fp-origen-${idx}-gci`);
                                    
                                    if (captInput) captInput.value = origen.captaciones || 0;
                                    if (gciInput) gciInput.value = origen.gci || 0;
                                });
                                
                                calcularPorcentajesFuentes();
                                console.log('âœ… OrÃ­genes cargados');
                            }
                        })
                        .withFailureHandler(function(error) {
                            console.error('âŒ Error cargando datos:', error);
                        })
                        .obtenerFacturacionPasadaCompleta(aÃ±oAnterior);
                })
                .obtenerOrigenesNegocio();
        })
        .obtenerAÃ±oContable();
}

function guardarDatosHistoricos() {
    console.log('ğŸ’¾ Guardando FacturaciÃ³n Pasada...');
    
    // Obtener aÃ±o del modal
    const aÃ±o = parseInt(document.getElementById('modal-facturacion-pasada').dataset.aÃ±o);
    
    if (!aÃ±o) {
        mostrarNotificacion('Error: No se pudo determinar el aÃ±o', 'error');
        return;
    }
    
    // Recopilar datos
    const datosCompletos = {
        aÃ±o: aÃ±o,
        // CAMPOS ORIGINALES
        citasCaptacion: parseFloat(document.getElementById('hist-citas')?.value) || 0,
        exclusivasVenta: parseFloat(document.getElementById('hist-exclusivas')?.value) || 0,
        captAbierto: parseFloat(document.getElementById('hist-abierto')?.value) || 0,
        citasComprador: parseFloat(document.getElementById('hist-citas-comp')?.value) || 0,
        casasEnsenadas: parseFloat(document.getElementById('hist-visitas')?.value) || 0,
        exclusivasCompr: parseFloat(document.getElementById('hist-exclusivas-comp')?.value) || 0,
        llamadas: parseFloat(document.getElementById('hist-llamadas')?.value) || 0,
        
        // ğŸ†• NUEVOS CAMPOS
        captAlquiler: parseFloat(document.getElementById('hist-capt-alquiler')?.value) || 0,
        leadVendedor: parseFloat(document.getElementById('hist-lead-vendedor')?.value) || 0,
        tresBs: parseFloat(document.getElementById('hist-3bs')?.value) || 0,
        bajadasPrecio: parseFloat(document.getElementById('hist-bajadas-precio')?.value) || 0,
        leadComprador: parseFloat(document.getElementById('hist-lead-comprador')?.value) || 0,
        propuestasCompra: parseFloat(document.getElementById('hist-propuestas-compra')?.value) || 0,
        leadSeguimiento: parseFloat(document.getElementById('hist-lead-seguimiento')?.value) || 0,
        arras: parseFloat(document.getElementById('hist-arras')?.value) || 0,
        
        // FINALES
        ventas: parseFloat(document.getElementById('hist-ventas')?.value) || 0,
        gci: parseFloat(document.getElementById('hist-gci')?.value) || 0,
        
        // ORÃGENES DE NEGOCIO
        origenes: []
    };
    
    // Leer orÃ­genes/fuentes
    google.script.run
        .withSuccessHandler(function(origenes) {
            origenes.forEach((nombreOrigen, idx) => {
                const captInput = document.getElementById(`fp-origen-${idx}-capt`);
                const gciInput = document.getElementById(`fp-origen-${idx}-gci`);
                const pctCell = document.getElementById(`fp-origen-${idx}-pct`);
                
                datosCompletos.origenes.push({
                    fuente: nombreOrigen,
                    captaciones: captInput ? parseFloat(captInput.value) || 0 : 0,
                    gci: gciInput ? parseFloat(gciInput.value) || 0 : 0,
                    porcentaje: pctCell ? parseFloat(pctCell.textContent) || 0 : 0
                });
            });
            
            // Guardar en backend
            google.script.run
                .withSuccessHandler(function(resultado) {
                    if (resultado.success) {
                        mostrarNotificacion('âœ… FacturaciÃ³n Pasada Guardada', 'success');
                        
                        // Recargar grÃ¡ficos si estamos en esa vista
                        if (typeof vistaActualGerente !== 'undefined' && vistaActualGerente === 'graficos') {
                            renderizarGraficosGenerales();
                        }
                    } else {
                        mostrarNotificacion('âŒ ' + resultado.message, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    mostrarNotificacion('âŒ Error al guardar: ' + error, 'error');
                })
                .guardarFacturacionPasadaDesdeModal(datosCompletos);
        })
        .obtenerOrigenesNegocio();
}

// ============================================
// MEJORA 2: Calcular porcentajes para 19 partidas (Ã­ndices 0-18)
// ============================================

function calcularPorcentajesFuentes() {
    let totalGCI = 0;
    let totalCapt = 0;
    
    // Sumar todas las partidas (19 orÃ­genes: Ã­ndices 0-18)
    for (let i = 0; i < 19; i++) {
        const captInput = document.getElementById(`fp-origen-${i}-capt`);  // âœ… ParÃ©ntesis aÃ±adido
        const gciInput = document.getElementById(`fp-origen-${i}-gci`);    // âœ… ParÃ©ntesis aÃ±adido
        
        if (captInput) totalCapt += parseFloat(captInput.value) || 0;
        if (gciInput) totalGCI += parseFloat(gciInput.value) || 0;
    }
    
    // Calcular porcentajes individuales
    for (let i = 0; i < 19; i++) {
        const gciInput = document.getElementById(`fp-origen-${i}-gci`);    // âœ… ParÃ©ntesis aÃ±adido
        const pctCell = document.getElementById(`fp-origen-${i}-pct`);     // âœ… ParÃ©ntesis aÃ±adido
        
        if (gciInput && pctCell) {
            const gci = parseFloat(gciInput.value) || 0;
            const pct = totalGCI > 0 ? ((gci / totalGCI) * 100).toFixed(1) : 0;
            pctCell.textContent = pct + '%';
        }
    }
    
    // Actualizar totales del footer
    const totalCaptCell = document.getElementById('fp-total-capt');
    const totalGCICell = document.getElementById('fp-total-gci');
    
    if (totalCaptCell) totalCaptCell.textContent = totalCapt.toFixed(0);
    if (totalGCICell) totalGCICell.textContent = totalGCI.toFixed(0) + 'â‚¬';
}

function crearGraficoYoYCompleto(act, meta) {
    const ctx = document.getElementById('chart-yoy-completo');
    if (!ctx) return;
    
    if (chartInstances['chart-yoy-completo']) {
        chartInstances['chart-yoy-completo'].destroy();
    }
    
    const labels = ['GCI', 'Citas Capt.', 'Excl. Venta', 'Abierto', 'Citas Comp.', 'Excl. Comp.', 'Visitas', 'Ventas'];
    
    const dataActual = [
        act.gci,
        act.citasCapt,
        act.exclVenta,
        act.captAbierto,
        act.citasComp,
        act.exclComp,
        act.visitas,
        act.ventas
    ];
    
    const dataMeta = [
        meta.gci,
        meta.citasCapt,
        meta.exclVenta,
        meta.captAbierto,
        meta.citasComp,
        meta.exclComp,
        meta.visitas,
        meta.ventas
    ];
    
    chartInstances['chart-yoy-completo'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'âœ… Realizado 2025',
                    data: dataActual,
                    backgroundColor: 'rgba(0, 255, 136, 0.8)',
                    borderColor: '#22c55e',
                    borderWidth: 2,
                    barThickness: 60
                },
                {
                    label: 'ğŸ“Š Meta YTD (AÃ±o Anterior)',
                    data: dataMeta,
                    backgroundColor: 'rgba(102, 126, 234, 0.6)',
                    borderColor: '#667eea',
                    borderWidth: 2,
                    barThickness: 60
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255,255,255,0.05)'
                    },
                    ticks: {
                        color: 'var(--color-text-secondary)',
                        font: { size: 12, weight: '600' },
                        callback: function(value) {
                            return value.toLocaleString('es-ES', {maximumFractionDigits:0});
                        }
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: {
                        color: 'var(--color-text-primary)',
                        font: { size: 13, weight: 'bold' }
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: 'var(--color-text-primary)',
                        font: { size: 14, weight: 'bold' },
                        padding: 20,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.9)',
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    padding: 12,
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            label += context.parsed.y.toLocaleString('es-ES', {maximumFractionDigits:0});
                            return label;
                        }
                    }
                }
            }
        }
    });
}

// 2. MATRIZ SKILL VS WILL (CORREGIDA VISUALIZACIÃ“N)
function crearGraficoSkillWill() {
    const ctx = document.getElementById('chart-skill-will');
    if(!ctx) return;
    if(chartInstances.skillWill) chartInstances.skillWill.destroy();

    // Calcular medias para los cuadrantes
    let totalAct = 0, totalConv = 0, count = 0;
    const dataPoints = datosFiltrados.map(d => {
        const act = parseFloat(d.ratios.actividadTotal) || 0;
        // ConversiÃ³n Cita->Exclusiva es la mÃ©trica de habilidad mÃ¡s pura
        const conv = parseFloat(d.ratios.conversionCaptacion) || 0; 
        totalAct += act;
        totalConv += conv;
        count++;
        return { x: act, y: conv, agent: d.agente };
    });

    const avgAct = count > 0 ? totalAct / count : 10;
    const avgConv = count > 0 ? totalConv / count : 10;

    chartInstances.skillWill = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Agentes',
                data: dataPoints,
                backgroundColor: (c) => {
                    const v = c.raw;
                    if(!v) return '#ccc';
                    if(v.x >= avgAct && v.y >= avgConv) return '#22c55e'; // Estrella
                    if(v.x >= avgAct && v.y < avgConv) return '#ffd700';  // Trabajador
                    if(v.x < avgAct && v.y >= avgConv) return '#667eea';  // Talento
                    return '#ff4444'; // Alerta
                },
                pointRadius: 15,
                pointHoverRadius: 20,
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (ctx) => `${ctx.raw.agent}: Actividad ${ctx.raw.x} / ConversiÃ³n ${ctx.raw.y}%`
                    }
                },
                annotation: { // LÃ­neas de cuadrante
                    annotations: {
                        lineV: { type: 'line', xMin: avgAct, xMax: avgAct, borderColor: 'rgba(255,255,255,0.3)', borderWidth: 2, borderDash: [5,5] },
                        lineH: { type: 'line', yMin: avgConv, yMax: avgConv, borderColor: 'rgba(255,255,255,0.3)', borderWidth: 2, borderDash: [5,5] }
                    }
                }
            },
            scales: {
                x: { title: { display: true, text: 'VOLUNTAD (Actividad Total)', color:'#aaa' }, grid: { color: '#222' }, min: 0 },
                y: { title: { display: true, text: 'HABILIDAD (ConversiÃ³n %)', color:'#aaa' }, grid: { color: '#222' }, min: 0 }
            },
            onClick: () => ampliarGrafico('skillWill', 'Matriz Habilidad vs Voluntad')
        }
    });
}
// ==========================================
// ğŸ› ï¸ REPARACIÃ“N: LÃ“GICA HISTÃ“RICO (SWITCH)
// ==========================================

// 1. Variable Global de Estado (Â¡Importante!)
var modoHist = 'ANUAL'; // Usamos var para asegurar que sea global

// 2. FunciÃ³n del Interruptor (Switch)
function setModoHistorico(modo) {
    const panelAnual = document.getElementById('hist-panel-anual');
    const panelMensual = document.getElementById('hist-panel-mensual');
    const btnAnual = document.getElementById('btn-hist-anual');
    const btnMensual = document.getElementById('btn-hist-mensual');
    
    if (modo === 'ANUAL') {
        panelAnual.style.display = 'block';
        panelMensual.style.display = 'none';
        btnAnual.style.background = 'var(--color-primary)';
        btnAnual.style.opacity = '1';
        btnMensual.style.background = 'transparent';
        btnMensual.style.opacity = '0.6';
    } else {
        panelAnual.style.display = 'none';
        panelMensual.style.display = 'block';
        btnAnual.style.background = 'transparent';
        btnAnual.style.opacity = '0.6';
        btnMensual.style.background = 'var(--color-primary)';
        btnMensual.style.opacity = '1';
        
        // Generar tabla mensual
        generarTablaMensualHistorico();
    }
}

function generarTablaMensualHistorico() {
    const tbody = document.getElementById('hist-tabla-body');
    if (!tbody) return;
    
    const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                   'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    
    let html = '';
    
    meses.forEach((mes, idx) => {
        const m = idx + 1;
        html += `
            <tr>
                <td style="position:sticky; left:0; background: var(--color-surface); font-weight: bold; z-index:1;">${mes}</td>
                <td><input type="number" id="hm-gci-${m}" class="form-input-mini" style="width:70px;"></td>
                <td><input type="number" id="hm-ventas-${m}" class="form-input-mini" style="width:50px;"></td>
                <td><input type="number" id="hm-volumen-${m}" class="form-input-mini" style="width:80px;"></td>
                <td><input type="number" id="hm-citasCapt-${m}" class="form-input-mini" style="width:50px;"></td>
                <td><input type="number" id="hm-exclVenta-${m}" class="form-input-mini" style="width:50px;"></td>
                <td><input type="number" id="hm-captAbierto-${m}" class="form-input-mini" style="width:50px;"></td>
                <td><input type="number" id="hm-captAlq-${m}" class="form-input-mini" style="width:50px;"></td>
                <td><input type="number" id="hm-leadVendedor-${m}" class="form-input-mini" style="width:50px;"></td>
                <td><input type="number" id="hm-3bs-${m}" class="form-input-mini" style="width:50px;"></td>
                <td><input type="number" id="hm-bajadas-${m}" class="form-input-mini" style="width:50px;"></td>
                <td><input type="number" id="hm-llamadas-${m}" class="form-input-mini" style="width:50px;"></td>
                <td><input type="number" id="hm-citasComp-${m}" class="form-input-mini" style="width:50px;"></td>
                <td><input type="number" id="hm-exclComp-${m}" class="form-input-mini" style="width:50px;"></td>
                <td><input type="number" id="hm-visitas-${m}" class="form-input-mini" style="width:50px;"></td>
                <td><input type="number" id="hm-leadComprador-${m}" class="form-input-mini" style="width:50px;"></td>
                <td><input type="number" id="hm-leadsCompradores-${m}" class="form-input-mini" style="width:50px;"></td>
                <td><input type="number" id="hm-propuestas-${m}" class="form-input-mini" style="width:50px;"></td>
                <td><input type="number" id="hm-leadSeguimiento-${m}" class="form-input-mini" style="width:50px;"></td>
                <td><input type="number" id="hm-arras-${m}" class="form-input-mini" style="width:50px;"></td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
    
    // AÃ±adir listeners para totales
    const campos = ['gci', 'ventas', 'volumen', 'citasCapt', 'exclVenta', 'captAbierto', 'captAlq', 
                    'leadVendedor', '3bs', 'bajadas', 'llamadas', 'citasComp', 'exclComp', 'visitas',
                    'leadComprador', 'leadsCompradores', 'propuestas', 'leadSeguimiento', 'arras'];
    
    campos.forEach(campo => {
        for (let m = 1; m <= 12; m++) {
            const input = document.getElementById(`hm-${campo}-${m}`);
            if (input) {
                input.addEventListener('input', () => calcularTotalesMensual(campo));
            }
        }
    });
}

function calcularTotalesMensual(campo) {
    let total = 0;
    for (let m = 1; m <= 12; m++) {
        const input = document.getElementById(`hm-${campo}-${m}`);
        if (input) total += parseFloat(input.value) || 0;
    }
    
    const totalCell = document.getElementById(`hm-total-${campo}`);
    if (totalCell) {
        totalCell.textContent = (campo === 'gci' || campo === 'volumen') 
            ? Math.round(total).toLocaleString('es-ES') + 'â‚¬'
            : Math.round(total).toLocaleString('es-ES');
    }
}

function calcularTotalesMensual(campo) {
    let total = 0;
    for (let m = 1; m <= 12; m++) {
        const input = document.getElementById(`hm-${campo}-${m}`);
        if (input) {
            total += parseFloat(input.value) || 0;
        }
    }
    
    const totalCell = document.getElementById(`hm-total-${campo}`);
    if (totalCell) {
        if (campo === 'gci' || campo === 'volumen') {
            totalCell.textContent = Math.round(total).toLocaleString('es-ES') + 'â‚¬';
        } else {
            totalCell.textContent = Math.round(total).toLocaleString('es-ES');
        }
    }
}

// 4. FunciÃ³n de Apertura (Asegurando que carga agentes)
function mostrarModalCargaHistorico() {
    abrirModalEncima('modal-carga-historico');
    poblarSelectAgentes('hist-agente-select');
    // Por defecto anual
    setModoHistorico('ANUAL');
    // Intentar cargar datos si ya hay agente seleccionado por defecto
    setTimeout(cargarDatosHistoricosExistentes, 500);
}

function cargarDatosHistoricosExistentes() {
    const selectAgente = document.getElementById('hist-agente-select');
    const selectAnio = document.getElementById('hist-anio');
    
    if (!selectAgente || !selectAnio) return;
    
    const idAgente = selectAgente.value;
    const anio = parseInt(selectAnio.value);
    
    if (!idAgente) {
        limpiarFormularioHistorico();
        return;
    }
    
    console.log('ğŸ“– Cargando histÃ³rico:', idAgente, anio);
    
    google.script.run
        .withSuccessHandler(function(datos) {
            if (!datos || !datos.totales) {
                console.log('âš ï¸ Sin histÃ³rico previo');
                limpiarFormularioHistorico();
                mostrarNotificacion('â„¹ï¸ No hay histÃ³rico previo para este agente/aÃ±o', 'info');
                return;
            }
            
            console.log('âœ… HistÃ³rico cargado:', datos);
            poblarFormularioHistorico(datos);
            mostrarNotificacion('âœ… HistÃ³rico cargado correctamente', 'success');
        })
        .withFailureHandler(function(error) {
            console.error('âŒ Error:', error);
            limpiarFormularioHistorico();
            mostrarNotificacion('âŒ Error al cargar histÃ³rico', 'error');
        })
        .obtenerHistoricoAgente(idAgente, anio);  // âœ… FunciÃ³n correcta
}

/**
 * Puebla formulario con datos (19 campos)
 */
function poblarFormularioHistorico(datos) {
    const t = datos.totales;
    
    // Panel ANUAL - PRINCIPALES
    if (document.getElementById('ha-gci')) document.getElementById('ha-gci').value = t.gci || 0;
    if (document.getElementById('ha-ventas')) document.getElementById('ha-ventas').value = t.ventas || 0;
    if (document.getElementById('ha-volumen')) document.getElementById('ha-volumen').value = t.volumenNegocio || 0;
    
    // Panel ANUAL - CAPTACIÃ“N
    if (document.getElementById('ha-citasCapt')) document.getElementById('ha-citasCapt').value = t.citasCapt || 0;
    if (document.getElementById('ha-exclVenta')) document.getElementById('ha-exclVenta').value = t.exclVenta || 0;
    if (document.getElementById('ha-captAbierto')) document.getElementById('ha-captAbierto').value = t.captAbierto || 0;
    if (document.getElementById('ha-captAlq')) document.getElementById('ha-captAlq').value = t.captAlquiler || 0;
    if (document.getElementById('ha-leadVendedor')) document.getElementById('ha-leadVendedor').value = t.leadVendedor || 0;
    if (document.getElementById('ha-3bs')) document.getElementById('ha-3bs').value = t.tresBs || 0;
    if (document.getElementById('ha-bajadas')) document.getElementById('ha-bajadas').value = t.bajadasPrecio || 0;
    if (document.getElementById('ha-llamadas')) document.getElementById('ha-llamadas').value = t.llamadas || 0;
    
    // Panel ANUAL - COMPRADOR
    if (document.getElementById('ha-citasComp')) document.getElementById('ha-citasComp').value = t.citasComp || 0;
    if (document.getElementById('ha-exclComp')) document.getElementById('ha-exclComp').value = t.exclComp || 0;
    if (document.getElementById('ha-visitas')) document.getElementById('ha-visitas').value = t.visitas || 0;
    if (document.getElementById('ha-leadComprador')) document.getElementById('ha-leadComprador').value = t.leadComprador || 0;
    if (document.getElementById('ha-leadsCompradores')) document.getElementById('ha-leadsCompradores').value = t.leadsCompradores || 0;
    if (document.getElementById('ha-propuestas')) document.getElementById('ha-propuestas').value = t.propuestas || 0;
    if (document.getElementById('ha-leadSeguimiento')) document.getElementById('ha-leadSeguimiento').value = t.leadSeguimiento || 0;
    
    // Panel ANUAL - CIERRE
    if (document.getElementById('ha-arras')) document.getElementById('ha-arras').value = t.arras || 0;
    
    console.log('âœ… Panel ANUAL poblado');
    
    // Panel MENSUAL
    if (datos.mensual && Array.isArray(datos.mensual)) {
        const camposMensual = [
            { id: 'gci', key: 'gci' },
            { id: 'ventas', key: 'ventas' },
            { id: 'volumen', key: 'volumenNegocio' },
            { id: 'citasCapt', key: 'citasCapt' },
            { id: 'exclVenta', key: 'exclVenta' },
            { id: 'captAbierto', key: 'captAbierto' },
            { id: 'captAlq', key: 'captAlquiler' },
            { id: 'leadVendedor', key: 'leadVendedor' },
            { id: '3bs', key: 'tresBs' },
            { id: 'bajadas', key: 'bajadasPrecio' },
            { id: 'llamadas', key: 'llamadas' },
            { id: 'citasComp', key: 'citasComp' },
            { id: 'exclComp', key: 'exclComp' },
            { id: 'visitas', key: 'visitas' },
            { id: 'leadComprador', key: 'leadComprador' },
            { id: 'leadsCompradores', key: 'leadsCompradores' },
            { id: 'propuestas', key: 'propuestas' },
            { id: 'leadSeguimiento', key: 'leadSeguimiento' },
            { id: 'arras', key: 'arras' }
        ];
        
        datos.mensual.forEach(mes => {
            const m = mes.mes;
            camposMensual.forEach(campo => {
                const input = document.getElementById(`hm-${campo.id}-${m}`);
                if (input) input.value = mes[campo.key] || 0;
            });
        });
        
        console.log('âœ… Panel MENSUAL poblado');
    }
}

/**
 * Limpia formulario (19 campos)
 */
function limpiarFormularioHistorico() {
    // IDs del panel ANUAL
    const camposAnuales = [
        'ha-gci', 'ha-ventas', 'ha-volumen',
        'ha-citasCapt', 'ha-exclVenta', 'ha-captAbierto', 'ha-captAlq',
        'ha-leadVendedor', 'ha-3bs', 'ha-bajadas', 'ha-llamadas',
        'ha-citasComp', 'ha-exclComp', 'ha-visitas',
        'ha-leadComprador', 'ha-leadsCompradores', 'ha-propuestas', 'ha-leadSeguimiento',
        'ha-arras'
    ];
    
    camposAnuales.forEach(id => {
        const input = document.getElementById(id);
        if (input) input.value = 0;
    });
    
    // IDs del panel MENSUAL
    const camposMes = [
        'gci', 'ventas', 'volumen',
        'citasCapt', 'exclVenta', 'captAbierto', 'captAlq',
        'leadVendedor', '3bs', 'bajadas', 'llamadas',
        'citasComp', 'exclComp', 'visitas',
        'leadComprador', 'leadsCompradores', 'propuestas', 'leadSeguimiento',
        'arras'
    ];
    
    for (let mes = 1; mes <= 12; mes++) {
        camposMes.forEach(campo => {
            const input = document.getElementById(`hm-${campo}-${mes}`);
            if (input) input.value = 0;
        });
    }
    
    console.log('ğŸ§¹ Formulario limpiado');
}

function guardarHistoricoAgenteHTML() {
    console.log('ğŸ’¾ Iniciando guardado...');
    
    const selectAgente = document.getElementById('hist-agente-select');
    const selectAnio = document.getElementById('hist-anio');
    
    if (!selectAgente || !selectAnio) {
        mostrarNotificacion('âŒ Formulario incompleto', 'error');
        return;
    }
    
    const idAgente = selectAgente.value;
    const anio = parseInt(selectAnio.value);
    
    if (!idAgente) {
        mostrarNotificacion('âš ï¸ Selecciona un agente', 'error');
        return;
    }
    
    const panelAnual = document.getElementById('hist-panel-anual');
    const modo = panelAnual.style.display !== 'none' ? 'ANUAL' : 'MENSUAL';
    
    let datosGuardar = {
        idAgente: idAgente,
        anio: anio,
        modo: modo
    };
    
    if (modo === 'ANUAL') {
        datosGuardar.totales = {
            gci: parseFloat(document.getElementById('ha-gci')?.value) || 0,
            ventas: parseInt(document.getElementById('ha-ventas')?.value) || 0,
            volumenNegocio: parseFloat(document.getElementById('ha-volumen')?.value) || 0,
            citasCapt: parseInt(document.getElementById('ha-citasCapt')?.value) || 0,
            exclVenta: parseInt(document.getElementById('ha-exclVenta')?.value) || 0,
            captAbierto: parseInt(document.getElementById('ha-captAbierto')?.value) || 0,
            captAlquiler: parseInt(document.getElementById('ha-captAlq')?.value) || 0,
            leadVendedor: parseInt(document.getElementById('ha-leadVendedor')?.value) || 0,
            tresBs: parseInt(document.getElementById('ha-3bs')?.value) || 0,
            bajadasPrecio: parseInt(document.getElementById('ha-bajadas')?.value) || 0,
            llamadas: parseInt(document.getElementById('ha-llamadas')?.value) || 0,
            citasComp: parseInt(document.getElementById('ha-citasComp')?.value) || 0,
            exclComp: parseInt(document.getElementById('ha-exclComp')?.value) || 0,
            visitas: parseInt(document.getElementById('ha-visitas')?.value) || 0,
            leadComprador: parseInt(document.getElementById('ha-leadComprador')?.value) || 0,
            leadsCompradores: parseInt(document.getElementById('ha-leadsCompradores')?.value) || 0,
            propuestas: parseInt(document.getElementById('ha-propuestas')?.value) || 0,
            leadSeguimiento: parseInt(document.getElementById('ha-leadSeguimiento')?.value) || 0,
            arras: parseInt(document.getElementById('ha-arras')?.value) || 0
        };
    } else {
        datosGuardar.mensual = [];
        for (let mes = 1; mes <= 12; mes++) {
            datosGuardar.mensual.push({
                mes: mes,
                gci: parseFloat(document.getElementById(`hm-gci-${mes}`)?.value) || 0,
                ventas: parseInt(document.getElementById(`hm-ventas-${mes}`)?.value) || 0,
                volumenNegocio: parseFloat(document.getElementById(`hm-volumen-${mes}`)?.value) || 0,
                citasCapt: parseInt(document.getElementById(`hm-citasCapt-${mes}`)?.value) || 0,
                exclVenta: parseInt(document.getElementById(`hm-exclVenta-${mes}`)?.value) || 0,
                captAbierto: parseInt(document.getElementById(`hm-captAbierto-${mes}`)?.value) || 0,
                captAlquiler: parseInt(document.getElementById(`hm-captAlq-${mes}`)?.value) || 0,
                leadVendedor: parseInt(document.getElementById(`hm-leadVendedor-${mes}`)?.value) || 0,
                tresBs: parseInt(document.getElementById(`hm-3bs-${mes}`)?.value) || 0,
                bajadasPrecio: parseInt(document.getElementById(`hm-bajadas-${mes}`)?.value) || 0,
                llamadas: parseInt(document.getElementById(`hm-llamadas-${mes}`)?.value) || 0,
                citasComp: parseInt(document.getElementById(`hm-citasComp-${mes}`)?.value) || 0,
                exclComp: parseInt(document.getElementById(`hm-exclComp-${mes}`)?.value) || 0,
                visitas: parseInt(document.getElementById(`hm-visitas-${mes}`)?.value) || 0,
                leadComprador: parseInt(document.getElementById(`hm-leadComprador-${mes}`)?.value) || 0,
                leadsCompradores: parseInt(document.getElementById(`hm-leadsCompradores-${mes}`)?.value) || 0,
                propuestas: parseInt(document.getElementById(`hm-propuestas-${mes}`)?.value) || 0,
                leadSeguimiento: parseInt(document.getElementById(`hm-leadSeguimiento-${mes}`)?.value) || 0,
                arras: parseInt(document.getElementById(`hm-arras-${mes}`)?.value) || 0
            });
        }
    }
    
    console.log('ğŸ“¦ Enviando:', datosGuardar);
    
    google.script.run
        .withSuccessHandler(function(resultado) {
            if (resultado.success) {
                mostrarNotificacion('âœ… ' + resultado.message, 'success');
                cerrarModalSuperior('modal-carga-historico');
                
                // Actualizar cache local
                if (!historialAgentesCache) historialAgentesCache = {};
                historialAgentesCache[idAgente] = datosGuardar.totales || calcularTotalesDesdeMensual(datosGuardar.mensual);
            } else {
                mostrarNotificacion('âŒ ' + resultado.message, 'error');
            }
        })
        .withFailureHandler(function(error) {
            console.error('âŒ Error:', error);
            mostrarNotificacion('âŒ Error: ' + error.message, 'error');
        })
        .guardarHistoricoAgenteHTML(datosGuardar);
}

function calcularTotalesDesdeMensual(mensual) {
    const totales = {};
    if (!mensual || mensual.length === 0) return totales;
    
    const campos = Object.keys(mensual[0]).filter(k => k !== 'mes');
    campos.forEach(campo => {
        totales[campo] = mensual.reduce((sum, m) => sum + (m[campo] || 0), 0);
    });
    return totales;
}

// Variable global para el embudo personalizado
window.embudoPersonalizado = {
    etapas: ['llamadas', 'citasCaptacion', 'exclusivasVenta', 'gci']
};

function renderizarEmbudos() {
    const container = document.getElementById('vistaContenido');
    
    // Lista de KPIs para constructor
    const kpisDisponibles = [
        { key: 'llamadas', label: 'ğŸ“ Llamadas', color: '#667eea' },
        { key: 'citasCaptacion', label: 'ğŸ“… Citas CaptaciÃ³n', color: '#ff6b6b' },
        { key: 'exclusivasVenta', label: 'ğŸ  Exclusivas Venta', color: '#ffd700' },
        { key: 'captacionesAbierto', label: 'ğŸ˜ï¸ Capt. Abierto', color: '#22c55e' },
        { key: 'leadsCompradores', label: 'ğŸ‘¥ Leads Compradores', color: '#00c4ff' },
        { key: 'citasCompradores', label: 'ğŸ“… Citas Compradores', color: '#9c27b0' },
        { key: 'exclusivasComprador', label: 'ğŸ”‘ Exclusivas Comprador', color: '#ff9800' },
        { key: 'casasEnsenadas', label: 'ğŸ¡ Casas EnseÃ±adas', color: '#4caf50' },
        { key: 'leadVendedor', label: 'ğŸ“‹ Lead Vendedor', color: '#2196f3' },
        { key: 'tresBs', label: 'ğŸ…±ï¸ 3Bs Activadas', color: '#795548' },
        { key: 'bajadasPrecio', label: 'ğŸ“‰ Bajadas Precio', color: '#607d8b' },
        { key: 'propuestasCompra', label: 'ğŸ“ Propuestas Compra', color: '#ff5722' },
        { key: 'arras', label: 'âœï¸ Arras/Ventas', color: '#8bc34a' },
        { key: 'gci', label: 'ğŸ’° GCI', color: '#22c55e' }
    ];
    
    const html = `
        <div class="section">
            <div class="section-title">ğŸ¯ AnÃ¡lisis de Embudos de ConversiÃ³n</div>
            
            <!-- EXPLICACIÃ“N GENERAL -->
            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(102,126,234,0.02)); padding: 20px; border-radius: 15px; margin-bottom: 25px; border-left: 4px solid #667eea;">
                <div style="font-size: 1.1em; font-weight: 700; margin-bottom: 10px;">ğŸ“š Â¿QuÃ© son los Embudos de ConversiÃ³n?</div>
                <p style="color: #aaa; margin: 0; line-height: 1.6;">
                    Los embudos muestran <strong style="color: #fff;">cuÃ¡ntas actividades necesitas en cada etapa</strong> para conseguir un resultado final. 
                    Por ejemplo: de 100 llamadas â†’ 30 citas â†’ 15 exclusivas â†’ 5 ventas. 
                    <strong style="color: #ffd700;">El objetivo es identificar dÃ³nde se "pierde" volumen</strong> y mejorar esas conversiones.
                </p>
            </div>
            
            <!-- DIAGNÃ“STICO RÃPIDO -->
            <div id="analisis-embudos" style="background: var(--color-surface); padding: 20px; border-radius: 15px; margin-bottom: 25px; border: 1px solid var(--color-border);">
                <div class="loading"><div class="loader"></div><div>Analizando embudos...</div></div>
            </div>
            
            <!-- CONSTRUCTOR DE EMBUDO PERSONALIZADO -->
            <div style="background: linear-gradient(135deg, rgba(156,39,176,0.15), rgba(156,39,176,0.05)); padding: 20px; border-radius: 15px; margin-bottom: 25px; border: 1px solid rgba(156,39,176,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <div style="font-size: 1.1em; font-weight: 700;">ğŸ› ï¸ Constructor de Embudo Personalizado</div>
                        <div style="font-size: 0.85em; color: #888; margin-top: 5px;">Crea tu propio embudo seleccionando las etapas que quieras analizar</div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="agregarEtapaEmbudo()" style="padding: 8px 15px;">â• AÃ±adir</button>
                        <button class="btn btn-primary-action" onclick="renderizarEmbudoPersonalizado()" style="padding: 8px 15px;">ğŸ”„ Generar</button>
                    </div>
                </div>
                <div id="constructor-etapas" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;"></div>
            </div>
            
            <!-- EMBUDO PERSONALIZADO -->
            <div id="embudo-personalizado-container" style="background: var(--color-surface); padding: 20px; border-radius: 15px; margin-bottom: 25px; border: 1px solid var(--color-border);">
                <div style="font-size: 1.1em; font-weight: 700; margin-bottom: 15px;">ğŸ¯ Tu Embudo Personalizado</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start;">
                    <div style="height: 300px;">
                        <canvas id="chart-embudo-personalizado"></canvas>
                    </div>
                    <div id="leyenda-personalizado" style="padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px;">
                        <div style="color: #888; text-align: center;">Selecciona etapas y haz clic en "Generar"</div>
                    </div>
                </div>
            </div>
            
            <!-- GRID DE EMBUDOS PREDEFINIDOS -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 25px;">
                
                <!-- EMBUDO CAPTACIÃ“N -->
                <div style="background: var(--color-surface); padding: 20px; border-radius: 15px; border: 1px solid var(--color-border);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <div style="font-size: 1.1em; font-weight: 700; color: #667eea;">ğŸ“ Embudo de CaptaciÃ³n</div>
                            <div style="font-size: 0.8em; color: #888; margin-top: 5px;">Proceso: Llamadas â†’ Citas â†’ Exclusivas â†’ Captaciones</div>
                        </div>
                    </div>
                    <div style="height: 250px; margin-bottom: 15px;">
                        <canvas id="chart-embudo-captacion"></canvas>
                    </div>
                    <div id="leyenda-captacion" style="font-size: 0.85em; line-height: 1.8; padding: 15px; background: rgba(102,126,234,0.1); border-radius: 8px;"></div>
                    <div style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px; font-size: 0.85em;">
                        <strong style="color: #667eea;">ğŸ’¡ Â¿CÃ³mo interpretarlo?</strong>
                        <p style="color: #aaa; margin: 8px 0 0;">
                            Este embudo muestra tu eficiencia para <strong>conseguir propiedades en cartera</strong>. 
                            Si pierdes mucho entre llamadas y citas, mejora tu pitch telefÃ³nico. 
                            Si pierdes entre citas y exclusivas, trabaja tus argumentos de captaciÃ³n.
                        </p>
                    </div>
                </div>
                
                <!-- EMBUDO COMPRADORES -->
                <div style="background: var(--color-surface); padding: 20px; border-radius: 15px; border: 1px solid var(--color-border);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <div style="font-size: 1.1em; font-weight: 700; color: #00c4ff;">ğŸ¡ Embudo de Compradores</div>
                            <div style="font-size: 0.8em; color: #888; margin-top: 5px;">Proceso: Leads â†’ Citas â†’ Exclusivas â†’ Visitas</div>
                        </div>
                    </div>
                    <div style="height: 250px; margin-bottom: 15px;">
                        <canvas id="chart-embudo-compradores"></canvas>
                    </div>
                    <div id="leyenda-compradores" style="font-size: 0.85em; line-height: 1.8; padding: 15px; background: rgba(0,196,255,0.1); border-radius: 8px;"></div>
                    <div style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px; font-size: 0.85em;">
                        <strong style="color: #00c4ff;">ğŸ’¡ Â¿CÃ³mo interpretarlo?</strong>
                        <p style="color: #aaa; margin: 8px 0 0;">
                            Este embudo mide tu eficiencia con <strong>compradores</strong>. 
                            El nÃºmero de casas enseÃ±adas por comprador indica si estÃ¡s cualificando bien. 
                            Muchas visitas sin cierre = mal perfilado del comprador o del producto.
                        </p>
                    </div>
                </div>
                
                <!-- EMBUDO CIERRE -->
                <div style="background: var(--color-surface); padding: 20px; border-radius: 15px; border: 1px solid var(--color-border);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <div style="font-size: 1.1em; font-weight: 700; color: #22c55e;">ğŸ’° Embudo de Cierre</div>
                            <div style="font-size: 0.8em; color: #888; margin-top: 5px;">Proceso: Exclusivas â†’ Propuestas â†’ Arras â†’ GCI</div>
                        </div>
                    </div>
                    <div style="height: 250px; margin-bottom: 15px;">
                        <canvas id="chart-embudo-cierre"></canvas>
                    </div>
                    <div id="leyenda-cierre" style="font-size: 0.85em; line-height: 1.8; padding: 15px; background: rgba(34,197,94,0.1); border-radius: 8px;"></div>
                    <div style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px; font-size: 0.85em;">
                        <strong style="color: #22c55e;">ğŸ’¡ Â¿CÃ³mo interpretarlo?</strong>
                        <p style="color: #aaa; margin: 8px 0 0;">
                            Este es el embudo del <strong>dinero</strong>. Muestra cuÃ¡ntas exclusivas necesitas para cerrar una venta. 
                            El ticket medio indica la calidad de tus operaciones. 
                            Un ratio bajo aquÃ­ significa que necesitas mÃ¡s captaciones o mejorar tu pricing.
                        </p>
                    </div>
                </div>
                
                <!-- MATRIZ DE CONVERSIONES -->
                <div style="background: var(--color-surface); padding: 20px; border-radius: 15px; border: 1px solid var(--color-border);">
                    <div style="margin-bottom: 15px;">
                        <div style="font-size: 1.1em; font-weight: 700; color: #ffd700;">ğŸ“Š Matriz de Conversiones vs Benchmarks</div>
                        <div style="font-size: 0.8em; color: #888; margin-top: 5px;">Compara tus ratios con los objetivos KW EspaÃ±a</div>
                    </div>
                    <div id="matriz-conversiones" style="max-height: 350px; overflow-y: auto;"></div>
                    <div style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px; font-size: 0.85em;">
                        <strong style="color: #ffd700;">ğŸ’¡ Â¿CÃ³mo usarla?</strong>
                        <p style="color: #aaa; margin: 8px 0 0;">
                            Los âŒ indican conversiones <strong>por debajo del benchmark</strong> - son tus prioridades de mejora. 
                            Los âœ… indican que estÃ¡s en objetivo. Los ğŸ”¥ son tus fortalezas.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    
    // Inicializar constructor
    inicializarConstructorEmbudo();
    
    // Cargar datos
    const filtros = calcularFiltrosPeriodo(periodoActual, 'gerente');
    
    google.script.run
        .withSuccessHandler(function(resultado) {
            if (!resultado.success) {
                document.getElementById('analisis-embudos').innerHTML = `<div style="color:#ff6b6b; text-align: center; padding: 20px;">âŒ Error: ${resultado.error}</div>`;
                return;
            }
            
            const e = resultado.embudos;
            window.datosEmbudoGlobal = e;
            
            renderizarDiagnosticoEmbudos(e);
            renderizarEmbudoPersonalizado();
            renderizarEmbudoCaptacion(e);
            renderizarEmbudoCompradores(e);
            renderizarEmbudoCierre(e);
            renderizarMatrizConversiones(e);
        })
        .withFailureHandler(function(error) {
            document.getElementById('analisis-embudos').innerHTML = `<div style="color:#ff6b6b; text-align: center; padding: 20px;">âŒ Error: ${error.message}</div>`;
        })
        .obtenerDatosEmbudo(filtros);
}

// Variable global para embudo personalizado
window.embudoPersonalizado = {
    etapas: ['llamadas', 'citasCaptacion', 'exclusivasVenta', 'arras']
};

function inicializarConstructorEmbudo() {
    const container = document.getElementById('constructor-etapas');
    if (!container) return;
    
    const kpis = [
        { key: 'llamadas', label: 'ğŸ“ Llamadas' },
        { key: 'citasCaptacion', label: 'ğŸ“… Citas Capt.' },
        { key: 'exclusivasVenta', label: 'ğŸ  Excl. Venta' },
        { key: 'captacionesAbierto', label: 'ğŸ˜ï¸ Capt. Abierto' },
        { key: 'leadsCompradores', label: 'ğŸ‘¥ Leads Comp.' },
        { key: 'citasCompradores', label: 'ğŸ“… Citas Comp.' },
        { key: 'exclusivasComprador', label: 'ğŸ”‘ Excl. Comp.' },
        { key: 'casasEnsenadas', label: 'ğŸ¡ Casas Ens.' },
        { key: 'tresBs', label: 'ğŸ…±ï¸ 3Bs' },
        { key: 'bajadasPrecio', label: 'ğŸ“‰ Bajadas' },
        { key: 'propuestasCompra', label: 'ğŸ“ Propuestas' },
        { key: 'arras', label: 'âœï¸ Arras' },
        { key: 'gci', label: 'ğŸ’° GCI' }
    ];
    
    let html = '';
    window.embudoPersonalizado.etapas.forEach((etapa, idx) => {
        const opciones = kpis.map(k => 
            `<option value="${k.key}" ${etapa === k.key ? 'selected' : ''}>${k.label}</option>`
        ).join('');
        
        html += `
            <div style="display: flex; align-items: center; gap: 5px; background: var(--color-surface); padding: 8px 12px; border-radius: 8px; border: 1px solid var(--color-border);">
                <span style="font-weight: 700; color: #9c27b0; font-size: 0.9em;">${idx + 1}</span>
                <select onchange="actualizarEtapaEmbudo(${idx}, this.value)" style="padding: 6px; border-radius: 6px; border: 1px solid var(--color-border); background: var(--color-bg); color: var(--color-text-primary); font-size: 0.85em;">
                    ${opciones}
                </select>
                ${idx > 1 ? `<button onclick="eliminarEtapaEmbudo(${idx})" style="background: none; border: none; color: #ff4444; cursor: pointer; font-size: 1.1em; padding: 0 5px;">Ã—</button>` : ''}
            </div>
            ${idx < window.embudoPersonalizado.etapas.length - 1 ? '<span style="color: #9c27b0; font-size: 1.3em;">â†’</span>' : ''}
        `;
    });
    
    container.innerHTML = html;
}

function agregarEtapaEmbudo() {
    if (window.embudoPersonalizado.etapas.length >= 8) {
        mostrarNotificacion('MÃ¡ximo 8 etapas', 'warning');
        return;
    }
    window.embudoPersonalizado.etapas.push('gci');
    inicializarConstructorEmbudo();
}

function eliminarEtapaEmbudo(idx) {
    if (window.embudoPersonalizado.etapas.length <= 2) {
        mostrarNotificacion('MÃ­nimo 2 etapas', 'warning');
        return;
    }
    window.embudoPersonalizado.etapas.splice(idx, 1);
    inicializarConstructorEmbudo();
}

function actualizarEtapaEmbudo(idx, valor) {
    window.embudoPersonalizado.etapas[idx] = valor;
}

function renderizarEmbudoPersonalizado() {
    const etapas = window.embudoPersonalizado.etapas;
    const e = window.datosEmbudoGlobal;
    
    if (!e) return;
    
    const obtenerValor = (key) => {
        const mapeo = {
            'llamadas': e.captacion?.etapa1_llamadas || 0,
            'citasCaptacion': e.captacion?.etapa2_citasCaptacion || 0,
            'exclusivasVenta': e.captacion?.etapa3_exclusivasVenta || 0,
            'captacionesAbierto': e.captacion?.etapa4_captacionesAbierto || 0,
            'leadsCompradores': e.compradores?.etapa1_leadsCompradores || 0,
            'citasCompradores': e.compradores?.etapa2_citasCompradores || 0,
            'exclusivasComprador': e.compradores?.etapa3_exclusivasComprador || 0,
            'casasEnsenadas': e.compradores?.etapa4_casasEnsenadas || 0,
            'tresBs': e.adicionales?.tresBs || 0,
            'bajadasPrecio': e.adicionales?.bajadasPrecio || 0,
            'propuestasCompra': e.adicionales?.propuestasCompra || 0,
            'arras': e.cierre?.transacciones || 0,
            'gci': e.cierre?.totalGCI || 0
        };
        return mapeo[key] || 0;
    };
    
    const obtenerLabel = (key) => {
        const labels = {
            'llamadas': 'Llamadas', 'citasCaptacion': 'Citas Capt.', 'exclusivasVenta': 'Excl. Venta',
            'captacionesAbierto': 'Capt. Abierto', 'leadsCompradores': 'Leads Comp.', 'citasCompradores': 'Citas Comp.',
            'exclusivasComprador': 'Excl. Comp.', 'casasEnsenadas': 'Casas Ens.', 'tresBs': '3Bs',
            'bajadasPrecio': 'Bajadas', 'propuestasCompra': 'Propuestas', 'arras': 'Arras/Ventas', 'gci': 'GCI (â‚¬)'
        };
        return labels[key] || key;
    };
    
    const colores = ['#667eea', '#ff6b6b', '#ffd700', '#22c55e', '#00c4ff', '#9c27b0', '#ff9800', '#4caf50'];
    const labels = etapas.map(obtenerLabel);
    const valores = etapas.map(obtenerValor);
    
    // Calcular conversiones
    let leyendaHTML = '<div style="font-weight: 700; margin-bottom: 15px; color: #9c27b0;">ğŸ“Š Conversiones entre etapas:</div>';
    
    for (let i = 0; i < etapas.length - 1; i++) {
        const conv = valores[i] > 0 ? ((valores[i + 1] / valores[i]) * 100).toFixed(1) : 0;
        const color = conv >= 50 ? '#22c55e' : conv >= 25 ? '#ffd700' : '#ff4444';
        const icono = conv >= 50 ? 'âœ…' : conv >= 25 ? 'âš ï¸' : 'âŒ';
        
        leyendaHTML += `
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--color-border);">
                <span>${labels[i]} â†’ ${labels[i+1]}</span>
                <span style="color: ${color}; font-weight: 700;">${icono} ${conv}%</span>
            </div>
        `;
    }
    
    const convGlobal = valores[0] > 0 ? ((valores[valores.length - 1] / valores[0]) * 100).toFixed(2) : 0;
    leyendaHTML += `
        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid var(--color-border);">
            <div style="text-align: center;">
                <div style="font-size: 0.85em; color: #888;">ConversiÃ³n Global</div>
                <div style="font-size: 1.8em; font-weight: 900; color: #9c27b0;">${convGlobal}%</div>
                <div style="font-size: 0.8em; color: #888;">${labels[0]} â†’ ${labels[labels.length - 1]}</div>
            </div>
        </div>
    `;
    
    document.getElementById('leyenda-personalizado').innerHTML = leyendaHTML;
    
    // GrÃ¡fico
    if (chartInstances['chart-embudo-personalizado']) {
        chartInstances['chart-embudo-personalizado'].destroy();
    }
    
    chartInstances['chart-embudo-personalizado'] = new Chart(document.getElementById('chart-embudo-personalizado'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                data: valores,
                backgroundColor: etapas.map((_, i) => colores[i % colores.length] + 'cc'),
                borderColor: etapas.map((_, i) => colores[i % colores.length]),
                borderWidth: 2
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                y: { ticks: { color: '#fff', font: { weight: 'bold' } }, grid: { display: false } }
            }
        }
    });
}

function renderizarDiagnosticoEmbudos(e) {
    const conversiones = [
        { nombre: 'Llamadas â†’ Citas Capt.', valor: parseFloat(e.captacion?.conversion_llamadas_citas) || 0, benchmark: 30 },
        { nombre: 'Citas â†’ Exclusivas', valor: parseFloat(e.captacion?.conversion_citas_exclusivas) || 0, benchmark: 60 },
        { nombre: 'Leads â†’ Citas Comp.', valor: parseFloat(e.compradores?.conversion_leads_citas) || 0, benchmark: 30 },
        { nombre: 'Exclusivas â†’ Ventas', valor: parseFloat(e.cierre?.conversion_exclusivas_ventas) || 0, benchmark: 30 }
    ];
    
    const minConv = conversiones.reduce((min, c) => c.valor < min.valor ? c : min);
    const maxConv = conversiones.reduce((max, c) => c.valor > max.valor ? c : max);
    const gciPorExcl = e.cierre?.totalExclusivas > 0 ? (e.cierre.totalGCI / e.cierre.totalExclusivas).toFixed(0) : 0;
    
    document.getElementById('analisis-embudos').innerHTML = `
        <div style="font-size: 1.1em; font-weight: 700; margin-bottom: 15px;">ğŸ” DiagnÃ³stico RÃ¡pido de tus Embudos</div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px;">
            <div style="background: rgba(255, 68, 68, 0.1); padding: 20px; border-radius: 12px; border-left: 4px solid #ff4444;">
                <div style="font-size: 0.85em; color: #ff6b6b; margin-bottom: 8px;">ğŸš¨ CUELLO DE BOTELLA</div>
                <div style="font-weight: 700; font-size: 1.1em;">${minConv.nombre}</div>
                <div style="font-size: 2em; color: #ff4444; font-weight: 900;">${minConv.valor}%</div>
                <div style="font-size: 0.8em; color: #888; margin-top: 5px;">Benchmark: ${minConv.benchmark}% â†’ Enfoca aquÃ­</div>
            </div>
            <div style="background: rgba(34, 197, 94, 0.1); padding: 20px; border-radius: 12px; border-left: 4px solid #22c55e;">
                <div style="font-size: 0.85em; color: #22c55e; margin-bottom: 8px;">âœ… TU FORTALEZA</div>
                <div style="font-weight: 700; font-size: 1.1em;">${maxConv.nombre}</div>
                <div style="font-size: 2em; color: #22c55e; font-weight: 900;">${maxConv.valor}%</div>
                <div style="font-size: 0.8em; color: #888; margin-top: 5px;">Benchmark: ${maxConv.benchmark}% â†’ Â¡Replica esto!</div>
            </div>
            <div style="background: rgba(255, 215, 0, 0.1); padding: 20px; border-radius: 12px; border-left: 4px solid #ffd700;">
                <div style="font-size: 0.85em; color: #ffd700; margin-bottom: 8px;">ğŸ’° RENTABILIDAD</div>
                <div style="font-weight: 700; font-size: 1.1em;">GCI por Exclusiva</div>
                <div style="font-size: 2em; color: #ffd700; font-weight: 900;">${parseInt(gciPorExcl).toLocaleString('es-ES')}â‚¬</div>
                <div style="font-size: 0.8em; color: #888; margin-top: 5px;">Ticket medio: ${e.cierre?.ticketPromedio || 0}â‚¬</div>
            </div>
        </div>
    `;
}

function renderizarEmbudoCaptacion(e) {
    if (chartInstances['chart-embudo-captacion']) chartInstances['chart-embudo-captacion'].destroy();
    
    const datos = [
        e.captacion?.etapa1_llamadas || 0,
        e.captacion?.etapa2_citasCaptacion || 0,
        e.captacion?.etapa3_exclusivasVenta || 0,
        e.captacion?.etapa4_captacionesAbierto || 0
    ];
    
    chartInstances['chart-embudo-captacion'] = new Chart(document.getElementById('chart-embudo-captacion'), {
        type: 'bar',
        data: {
            labels: ['ğŸ“ Llamadas', 'ğŸ“… Citas', 'ğŸ  Exclusivas', 'ğŸ˜ï¸ Abierto'],
            datasets: [{
                data: datos,
                backgroundColor: ['rgba(102,126,234,0.8)', 'rgba(255,107,107,0.8)', 'rgba(255,215,0,0.8)', 'rgba(34,197,94,0.8)'],
                borderColor: ['#667eea', '#ff6b6b', '#ffd700', '#22c55e'],
                borderWidth: 2
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                y: { ticks: { color: '#fff', font: { size: 12, weight: 'bold' } }, grid: { display: false } }
            }
        }
    });
    
    const conv1 = e.captacion?.conversion_llamadas_citas || 0;
    const conv2 = e.captacion?.conversion_citas_exclusivas || 0;
    const conv3 = e.captacion?.conversion_exclusivas_captaciones || 0;
    
    document.getElementById('leyenda-captacion').innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
            <div>
                <div style="font-size: 0.8em; color: #888;">Llamadas â†’ Citas</div>
                <div style="font-size: 1.3em; font-weight: 700; color: ${conv1 >= 30 ? '#22c55e' : '#ff4444'};">${conv1}%</div>
            </div>
            <div>
                <div style="font-size: 0.8em; color: #888;">Citas â†’ Exclusivas</div>
                <div style="font-size: 1.3em; font-weight: 700; color: ${conv2 >= 60 ? '#22c55e' : '#ff4444'};">${conv2}%</div>
            </div>
            <div>
                <div style="font-size: 0.8em; color: #888;">Excl. â†’ Captaciones</div>
                <div style="font-size: 1.3em; font-weight: 700; color: ${conv3 >= 40 ? '#22c55e' : '#ff4444'};">${conv3}%</div>
            </div>
        </div>
    `;
}

function renderizarEmbudoCompradores(e) {
    if (chartInstances['chart-embudo-compradores']) chartInstances['chart-embudo-compradores'].destroy();
    
    const datos = [
        e.compradores?.etapa1_leadsCompradores || 0,
        e.compradores?.etapa2_citasCompradores || 0,
        e.compradores?.etapa3_exclusivasComprador || 0,
        e.compradores?.etapa4_casasEnsenadas || 0
    ];
    
    chartInstances['chart-embudo-compradores'] = new Chart(document.getElementById('chart-embudo-compradores'), {
        type: 'bar',
        data: {
            labels: ['ğŸ‘¥ Leads', 'ğŸ“… Citas', 'ğŸ”‘ Exclusivas', 'ğŸ¡ Casas'],
            datasets: [{
                data: datos,
                backgroundColor: ['rgba(0,196,255,0.8)', 'rgba(102,126,234,0.8)', 'rgba(255,215,0,0.8)', 'rgba(34,197,94,0.8)'],
                borderColor: ['#00c4ff', '#667eea', '#ffd700', '#22c55e'],
                borderWidth: 2
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                y: { ticks: { color: '#fff', font: { size: 12, weight: 'bold' } }, grid: { display: false } }
            }
        }
    });
    
    const conv1 = e.compradores?.conversion_leads_citas || 0;
    const conv2 = e.compradores?.conversion_citas_exclusivas || 0;
    const casasPorComp = datos[1] > 0 ? (datos[3] / datos[1]).toFixed(1) : 0;
    
    document.getElementById('leyenda-compradores').innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
            <div>
                <div style="font-size: 0.8em; color: #888;">Leads â†’ Citas</div>
                <div style="font-size: 1.3em; font-weight: 700; color: ${conv1 >= 30 ? '#22c55e' : '#ff4444'};">${conv1}%</div>
            </div>
            <div>
                <div style="font-size: 0.8em; color: #888;">Citas â†’ Exclusivas</div>
                <div style="font-size: 1.3em; font-weight: 700; color: ${conv2 >= 50 ? '#22c55e' : '#ff4444'};">${conv2}%</div>
            </div>
            <div>
                <div style="font-size: 0.8em; color: #888;">Casas/Comprador</div>
                <div style="font-size: 1.3em; font-weight: 700; color: ${casasPorComp <= 8 ? '#22c55e' : '#ff4444'};">${casasPorComp}</div>
            </div>
        </div>
    `;
}

function renderizarEmbudoCierre(e) {
    if (chartInstances['chart-embudo-cierre']) chartInstances['chart-embudo-cierre'].destroy();
    
    const totalExcl = (e.captacion?.etapa3_exclusivasVenta || 0) + (e.compradores?.etapa3_exclusivasComprador || 0);
    const propuestas = e.adicionales?.propuestasCompra || 0;
    const arras = e.cierre?.transacciones || 0;
    const gci = (e.cierre?.totalGCI || 0) / 1000;
    
    chartInstances['chart-embudo-cierre'] = new Chart(document.getElementById('chart-embudo-cierre'), {
        type: 'bar',
        data: {
            labels: ['ğŸ  Exclusivas', 'ğŸ“ Propuestas', 'âœï¸ Arras', 'ğŸ’° GCI (Kâ‚¬)'],
            datasets: [{
                data: [totalExcl, propuestas, arras, gci],
                backgroundColor: ['rgba(255,215,0,0.8)', 'rgba(255,152,0,0.8)', 'rgba(139,195,74,0.8)', 'rgba(34,197,94,0.8)'],
                borderColor: ['#ffd700', '#ff9800', '#8bc34a', '#22c55e'],
                borderWidth: 2
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                y: { ticks: { color: '#fff', font: { size: 12, weight: 'bold' } }, grid: { display: false } }
            }
        }
    });
    
    const convCierre = e.cierre?.conversion_exclusivas_ventas || 0;
    const ticket = e.cierre?.ticketPromedio || 0;
    const gciPorExcl = totalExcl > 0 ? Math.round((e.cierre?.totalGCI || 0) / totalExcl) : 0;
    
    document.getElementById('leyenda-cierre').innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
            <div>
                <div style="font-size: 0.8em; color: #888;">Exclusiva â†’ Venta</div>
                <div style="font-size: 1.3em; font-weight: 700; color: ${convCierre >= 30 ? '#22c55e' : '#ff4444'};">${convCierre}%</div>
            </div>
            <div>
                <div style="font-size: 0.8em; color: #888;">GCI/Exclusiva</div>
                <div style="font-size: 1.3em; font-weight: 700; color: #22c55e;">${gciPorExcl.toLocaleString('es-ES')}â‚¬</div>
            </div>
            <div>
                <div style="font-size: 0.8em; color: #888;">Ticket Medio</div>
                <div style="font-size: 1.3em; font-weight: 700; color: #00c4ff;">${ticket.toLocaleString('es-ES')}â‚¬</div>
            </div>
        </div>
    `;
}

function renderizarMatrizConversiones(e) {
    const conversiones = [
        { de: 'ğŸ“ Llamadas', a: 'ğŸ“… Citas Capt.', valor: e.captacion?.conversion_llamadas_citas || 0, benchmark: 30 },
        { de: 'ğŸ“… Citas Capt.', a: 'ğŸ  Exclusivas V.', valor: e.captacion?.conversion_citas_exclusivas || 0, benchmark: 60 },
        { de: 'ğŸ  Exclusivas V.', a: 'ğŸ˜ï¸ Capt. Abierto', valor: e.captacion?.conversion_exclusivas_captaciones || 0, benchmark: 40 },
        { de: 'ğŸ‘¥ Leads Comp.', a: 'ğŸ“… Citas Comp.', valor: e.compradores?.conversion_leads_citas || 0, benchmark: 30 },
        { de: 'ğŸ“… Citas Comp.', a: 'ğŸ”‘ Exclusivas C.', valor: e.compradores?.conversion_citas_exclusivas || 0, benchmark: 50 },
        { de: 'ğŸ”‘ Exclusivas C.', a: 'ğŸ¡ Casas Ens.', valor: e.compradores?.conversion_exclusivas_visitas || 0, benchmark: 100 },
        { de: 'ğŸ  Total Exclusivas', a: 'âœï¸ Ventas', valor: e.cierre?.conversion_exclusivas_ventas || 0, benchmark: 30 }
    ];
    
    let html = '<table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">';
    html += '<thead><tr style="background: rgba(255,215,0,0.1);"><th style="padding: 10px; text-align: left;">De</th><th>â†’</th><th>A</th><th style="text-align: right;">Real</th><th style="text-align: right;">Obj.</th><th style="text-align: center;">Estado</th></tr></thead><tbody>';
    
    conversiones.forEach(c => {
        const pct = parseFloat(c.valor) || 0;
        let estado, color;
        
        if (pct >= c.benchmark * 1.2) { estado = 'ğŸ”¥'; color = '#22c55e'; }
        else if (pct >= c.benchmark) { estado = 'âœ…'; color = '#22c55e'; }
        else if (pct >= c.benchmark * 0.7) { estado = 'âš ï¸'; color = '#ffd700'; }
        else { estado = 'âŒ'; color = '#ff4444'; }
        
        html += `
            <tr style="border-bottom: 1px solid var(--color-border);">
                <td style="padding: 10px;">${c.de}</td>
                <td style="color: #888;">â†’</td>
                <td>${c.a}</td>
                <td style="text-align: right; font-weight: 700; color: ${color};">${pct}%</td>
                <td style="text-align: right; color: #888;">${c.benchmark}%</td>
                <td style="text-align: center; font-size: 1.3em;">${estado}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    document.getElementById('matriz-conversiones').innerHTML = html;
}

// ============================================
// RENDERIZAR CORRELACIONES
// ============================================

function renderizarCorrelaciones() {
    const container = document.getElementById('vistaContenido');
    
    container.innerHTML = `
        <div class="section">
            <div class="section-title">ğŸ”¬ Laboratorio de Correlaciones</div>
            
            <!-- EXPLICACIÃ“N -->
            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(102,126,234,0.02)); padding: 20px; border-radius: 15px; margin-bottom: 25px; border-left: 4px solid #667eea;">
                <div style="font-size: 1.1em; font-weight: 700; margin-bottom: 10px;">ğŸ“š Â¿QuÃ© es una CorrelaciÃ³n?</div>
                <p style="color: #aaa; margin: 0; line-height: 1.6;">
                    La correlaciÃ³n mide <strong style="color: #fff;">si dos variables se mueven juntas</strong>. 
                    Un valor de <strong style="color: #22c55e;">+1.0</strong> significa que siempre aumentan juntas. 
                    Un valor de <strong style="color: #ff4444;">-1.0</strong> significa que cuando una sube, la otra baja. 
                    Un valor cercano a <strong style="color: #888;">0</strong> significa que no tienen relaciÃ³n.
                </p>
            </div>
            
            <!-- SELECTOR DE VARIABLES -->
            <div style="background: var(--color-surface); padding: 20px; border-radius: 15px; margin-bottom: 25px; border: 1px solid var(--color-border);">
                <div style="font-weight: 700; margin-bottom: 15px;">ğŸ¯ Analiza tus propias correlaciones</div>
                <div style="display: grid; grid-template-columns: 1fr auto 1fr auto; gap: 15px; align-items: end;">
                    <div class="form-grupo">
                        <label class="form-label">Variable X (causa)</label>
                        <select id="corr-var-x" class="form-select">
                            <option value="llamadas">ğŸ“ Llamadas</option>
                            <option value="citasCaptacion">ğŸ“… Citas CaptaciÃ³n</option>
                            <option value="exclusivasVenta">ğŸ  Exclusivas Venta</option>
                            <option value="exclusivasComprador">ğŸ”‘ Exclusivas Comprador</option>
                            <option value="captacionesAbierto">ğŸ˜ï¸ Capt. Abierto</option>
                            <option value="citasCompradores">ğŸ“… Citas Compradores</option>
                            <option value="casasEnsenadas">ğŸ¡ Casas EnseÃ±adas</option>
                            <option value="leadsCompradores" selected>ğŸ‘¥ Leads Compradores</option>
                            <option value="gci">ğŸ’° GCI</option>
                            <option value="volumenNegocio">ğŸ’¼ Volumen Negocio</option>
                        </select>
                    </div>
                    <div style="font-size: 1.5em; color: #667eea; padding-bottom: 10px;">â†”</div>
                    <div class="form-grupo">
                        <label class="form-label">Variable Y (efecto)</label>
                        <select id="corr-var-y" class="form-select">
                            <option value="llamadas">ğŸ“ Llamadas</option>
                            <option value="citasCaptacion">ğŸ“… Citas CaptaciÃ³n</option>
                            <option value="exclusivasVenta">ğŸ  Exclusivas Venta</option>
                            <option value="exclusivasComprador">ğŸ”‘ Exclusivas Comprador</option>
                            <option value="captacionesAbierto">ğŸ˜ï¸ Capt. Abierto</option>
                            <option value="citasCompradores">ğŸ“… Citas Compradores</option>
                            <option value="casasEnsenadas">ğŸ¡ Casas EnseÃ±adas</option>
                            <option value="leadsCompradores">ğŸ‘¥ Leads Compradores</option>
                            <option value="gci" selected>ğŸ’° GCI</option>
                            <option value="volumenNegocio">ğŸ’¼ Volumen Negocio</option>
                        </select>
                    </div>
                    <button class="btn btn-primary-action" onclick="analizarCorrelacionPersonalizada()" style="padding: 12px 25px;">
                        ğŸ” Analizar
                    </button>
                </div>
                <div style="margin-top: 10px; font-size: 0.85em; color: #888;">
                    ğŸ’¡ Ejemplo: Â¿Las llamadas (X) impactan en el GCI (Y)?
                </div>
            </div>
            
            <!-- GRÃFICO SCATTER PERSONALIZADO -->
            <div id="scatter-personalizado" style="display: none; margin-bottom: 30px; background: var(--color-surface); padding: 20px; border-radius: 15px; border: 1px solid var(--color-border);">
                <div style="font-size: 1.1em; font-weight: 700; margin-bottom: 15px;" id="scatter-title">ğŸ“Š AnÃ¡lisis de CorrelaciÃ³n</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start;">
                    <div style="height: 350px;">
                        <canvas id="chart-scatter-custom"></canvas>
                    </div>
                    <div id="interpretacion-scatter" style="padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; min-height: 350px;"></div>
                </div>
            </div>
            
            <!-- LOADING -->
            <div id="correlaciones-loading" style="text-align: center; padding: 50px;">
                <div class="loader"></div>
                <div style="margin-top: 15px;">Calculando correlaciones...</div>
            </div>
            
            <!-- TOP 10 CORRELACIONES -->
            <div id="correlaciones-top10" style="display: none; margin-bottom: 30px;"></div>
            
            <!-- GUÃA DE INTERPRETACIÃ“N -->
            <div style="background: var(--color-surface); padding: 20px; border-radius: 15px; margin-bottom: 25px; border: 1px solid var(--color-border);">
                <div style="font-weight: 700; margin-bottom: 15px;">ğŸ“– GuÃ­a de InterpretaciÃ³n</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px;">
                    <div style="padding: 15px; background: rgba(34,197,94,0.1); border-radius: 10px; border-left: 4px solid #22c55e;">
                        <div style="color: #22c55e; font-weight: 700; margin-bottom: 8px;">âœ… Fuerte (0.7 a 1.0)</div>
                        <div style="font-size: 0.85em; color: #aaa;">Variables MUY conectadas. Cambiar una casi siempre afecta a la otra.</div>
                    </div>
                    <div style="padding: 15px; background: rgba(255,215,0,0.1); border-radius: 10px; border-left: 4px solid #ffd700;">
                        <div style="color: #ffd700; font-weight: 700; margin-bottom: 8px;">âš ï¸ Moderada (0.4 a 0.7)</div>
                        <div style="font-size: 0.85em; color: #aaa;">Hay conexiÃ³n pero otros factores tambiÃ©n influyen.</div>
                    </div>
                    <div style="padding: 15px; background: rgba(255,107,107,0.1); border-radius: 10px; border-left: 4px solid #ff6b6b;">
                        <div style="color: #ff6b6b; font-weight: 700; margin-bottom: 8px;">âŒ DÃ©bil (0.0 a 0.4)</div>
                        <div style="font-size: 0.85em; color: #aaa;">Poca o ninguna relaciÃ³n. Variables independientes.</div>
                    </div>
                    <div style="padding: 15px; background: rgba(102,126,234,0.1); border-radius: 10px; border-left: 4px solid #667eea;">
                        <div style="color: #667eea; font-weight: 700; margin-bottom: 8px;">ğŸ”„ Negativa (-1.0 a 0)</div>
                        <div style="font-size: 0.85em; color: #aaa;">RelaciÃ³n INVERSA. Cuando una sube, la otra baja.</div>
                    </div>
                </div>
            </div>
            
            <!-- MAPA DE CALOR -->
            <div id="heatmap-container" style="display: none; background: var(--color-surface); padding: 20px; border-radius: 15px; border: 1px solid var(--color-border);">
                <div style="font-size: 1.1em; font-weight: 700; margin-bottom: 15px;">ğŸ—ºï¸ Mapa de Calor - Todas las Correlaciones</div>
                <div id="heatmap-grid" style="overflow-x: auto;"></div>
            </div>
        </div>
    `;
    
    // Cargar datos
    const filtros = calcularFiltrosPeriodo(periodoActual, 'gerente');
    
    google.script.run
        .withSuccessHandler(function(resultado) {
            document.getElementById('correlaciones-loading').style.display = 'none';
            
            if (!resultado || !resultado.success) {
                document.getElementById('correlaciones-top10').innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #ff6b6b;">
                        âŒ Error: ${resultado?.error || 'Sin datos'}
                    </div>
                `;
                document.getElementById('correlaciones-top10').style.display = 'block';
                return;
            }
            
            // Guardar globalmente
            window.datosCorrelacionGlobal = resultado;
            
            console.log('ğŸ“Š Correlaciones cargadas:', resultado.n, 'registros,', resultado.datosAgentes?.length, 'agentes');
            
            // Renderizar
            renderizarTop10Correlaciones(resultado);
            renderizarHeatmapTabla(resultado);
        })
        .withFailureHandler(function(error) {
            document.getElementById('correlaciones-loading').style.display = 'none';
            document.getElementById('correlaciones-top10').innerHTML = `
                <div style="text-align: center; padding: 30px; color: #ff6b6b;">âŒ Error: ${error.message}</div>
            `;
            document.getElementById('correlaciones-top10').style.display = 'block';
        })
        .obtenerDatosCorrelacion(filtros);
}

function renderizarTop10Correlaciones(resultado) {
    const container = document.getElementById('correlaciones-top10');
    
    if (!resultado.topCorrelaciones || resultado.topCorrelaciones.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 30px; color: #888;">No hay suficientes datos para calcular correlaciones</div>';
        container.style.display = 'block';
        return;
    }
    
    // Nombres legibles
    const nombres = {
        'llamadas': 'ğŸ“ Llamadas',
        'citasCaptacion': 'ğŸ“… Citas CaptaciÃ³n',
        'exclusivasVenta': 'ğŸ  Exclusivas Venta',
        'exclusivasComprador': 'ğŸ”‘ Exclusivas Comprador',
        'captacionesAbierto': 'ğŸ˜ï¸ Capt. Abierto',
        'citasCompradores': 'ğŸ“… Citas Compradores',
        'casasEnsenadas': 'ğŸ¡ Casas EnseÃ±adas',
        'leadsCompradores': 'ğŸ‘¥ Leads Compradores',
        'gci': 'ğŸ’° GCI',
        'volumenNegocio': 'ğŸ’¼ Volumen Negocio'
    };
    
    let html = `
        <div style="font-size: 1.1em; font-weight: 700; margin-bottom: 15px;">
            ğŸ† Top 10 Correlaciones MÃ¡s Fuertes
            <span style="font-size: 0.8em; font-weight: 400; color: #888; margin-left: 10px;">
                (${resultado.n} registros analizados - Clic para ver grÃ¡fico)
            </span>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
    `;
    
    resultado.topCorrelaciones.forEach((c, idx) => {
        const absVal = Math.abs(c.valor);
        let color, badge, descripcion;
        
        if (absVal >= 0.7) {
            color = '#22c55e';
            badge = 'âœ… MUY FUERTE';
            descripcion = c.valor > 0 ? 'Suben juntas' : 'RelaciÃ³n inversa';
        } else if (absVal >= 0.4) {
            color = '#ffd700';
            badge = 'âš ï¸ MODERADA';
            descripcion = 'RelaciÃ³n notable';
        } else {
            color = '#ff6b6b';
            badge = 'âŒ DÃ‰BIL';
            descripcion = 'Poca relaciÃ³n';
        }
        
        const nombreX = nombres[c.kpi1] || c.kpi1;
        const nombreY = nombres[c.kpi2] || c.kpi2;
        
        html += `
            <div onclick="analizarCorrelacionDirecta('${c.kpi1}', '${c.kpi2}')" 
                 style="background: var(--color-surface); padding: 18px; border-radius: 12px; border-left: 4px solid ${color}; 
                        cursor: pointer; transition: all 0.3s; border: 1px solid var(--color-border);"
                 onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 10px 30px rgba(0,0,0,0.3)';"
                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-size: 0.85em; color: #888; font-weight: 700;">#${idx + 1}</span>
                    <span style="font-size: 0.75em; color: ${color}; font-weight: 700; background: ${color}22; padding: 3px 8px; border-radius: 4px;">${badge}</span>
                </div>
                <div style="font-weight: 700; margin-bottom: 8px; font-size: 0.9em; line-height: 1.4;">
                    ${nombreX}<br>
                    <span style="color: #667eea;">â†•</span> ${nombreY}
                </div>
                <div style="font-size: 2.2em; color: ${color}; font-weight: 900; margin: 10px 0;">${c.valor.toFixed(3)}</div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 0.8em; color: #aaa;">${descripcion}</span>
                    <span style="font-size: 0.75em; color: #667eea;">ğŸ‘† Ver grÃ¡fico</span>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
    container.style.display = 'block';
}

function renderizarHeatmapTabla(resultado) {
    const container = document.getElementById('heatmap-container');
    
    if (!resultado.matriz || !resultado.kpis || resultado.kpis.length === 0) {
        return;
    }
    
    container.style.display = 'block';
    
    const nombres = {
        'llamadas': 'Llamadas',
        'citasCaptacion': 'Citas Capt.',
        'exclusivasVenta': 'Excl. Venta',
        'exclusivasComprador': 'Excl. Comp.',
        'captacionesAbierto': 'Capt. Abierto',
        'citasCompradores': 'Citas Comp.',
        'casasEnsenadas': 'Casas Ens.',
        'leadsCompradores': 'Leads Comp.',
        'gci': 'GCI',
        'volumenNegocio': 'Volumen'
    };
    
    let html = '<table style="width: 100%; border-collapse: collapse; font-size: 0.75em;">';
    
    // Header
    html += '<thead><tr><th style="padding: 8px; background: var(--color-bg);"></th>';
    resultado.kpis.forEach(kpi => {
        html += `<th style="padding: 8px; background: var(--color-bg); text-align: center; writing-mode: vertical-lr; transform: rotate(180deg); height: 80px;">${nombres[kpi] || kpi}</th>`;
    });
    html += '</tr></thead><tbody>';
    
    // Filas
    resultado.kpis.forEach(kpi1 => {
        html += `<tr><td style="padding: 8px; font-weight: 700; background: var(--color-bg); white-space: nowrap;">${nombres[kpi1] || kpi1}</td>`;
        
        resultado.kpis.forEach(kpi2 => {
            const valor = resultado.matriz[kpi1]?.[kpi2] || 0;
            const absVal = Math.abs(valor);
            
            let bgColor, textColor;
            if (kpi1 === kpi2) {
                bgColor = 'rgba(102,126,234,0.3)';
                textColor = '#667eea';
            } else if (absVal >= 0.7) {
                bgColor = valor > 0 ? 'rgba(34,197,94,0.4)' : 'rgba(102,126,234,0.4)';
                textColor = valor > 0 ? '#22c55e' : '#667eea';
            } else if (absVal >= 0.4) {
                bgColor = 'rgba(255,215,0,0.3)';
                textColor = '#ffd700';
            } else {
                bgColor = 'rgba(150,150,150,0.1)';
                textColor = '#888';
            }
            
            const cursor = kpi1 !== kpi2 ? 'cursor: pointer;' : '';
            const onclick = kpi1 !== kpi2 ? `onclick="analizarCorrelacionDirecta('${kpi1}', '${kpi2}')"` : '';
            
            html += `<td ${onclick} style="padding: 8px; text-align: center; background: ${bgColor}; color: ${textColor}; font-weight: 700; ${cursor}" title="${nombres[kpi1]} â†” ${nombres[kpi2]}: ${valor.toFixed(3)}">${valor.toFixed(2)}</td>`;
        });
        
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    
    document.getElementById('heatmap-grid').innerHTML = html;
}

function analizarCorrelacionDirecta(varX, varY) {
    console.log('ğŸ¯ Clic en correlaciÃ³n:', varX, varY);
    document.getElementById('corr-var-x').value = varX;
    document.getElementById('corr-var-y').value = varY;
    analizarCorrelacionPersonalizada();
}

function analizarCorrelacionPersonalizada() {
    console.log('ğŸ” Iniciando anÃ¡lisis personalizado...');
    
    var varX = document.getElementById('corr-var-x').value;
    var varY = document.getElementById('corr-var-y').value;
    
    console.log('Variables seleccionadas:', varX, varY);
    
    if (varX === varY) {
        mostrarNotificacion('âš ï¸ Selecciona dos variables diferentes', 'warning');
        return;
    }
    
    if (!window.datosCorrelacionGlobal) {
        mostrarNotificacion('â³ Espera a que carguen los datos...', 'warning');
        return;
    }
    
    var resultado = window.datosCorrelacionGlobal;
    console.log('Datos disponibles:', resultado);
    
    if (!resultado.matriz || !resultado.matriz[varX]) {
        mostrarNotificacion('âš ï¸ No hay datos para esta combinaciÃ³n', 'warning');
        return;
    }
    
    var correlacion = resultado.matriz[varX][varY] || 0;
    var absCorr = Math.abs(correlacion);
    
    console.log('CorrelaciÃ³n encontrada:', correlacion);
    
    // Obtener datos para scatter desde el backend (datos diarios)
    var filtros = calcularFiltrosPeriodo(periodoActual, 'gerente');
    
    // Mostrar loading
    var scatterContainer = document.getElementById('scatter-personalizado');
    scatterContainer.style.display = 'block';
    document.getElementById('interpretacion-scatter').innerHTML = '<div class="loading"><div class="loader"></div><div>Cargando datos...</div></div>';
    
    var nombres = {
        'llamadas': 'ğŸ“ Llamadas', 'citasCaptacion': 'ğŸ“… Citas CaptaciÃ³n',
        'exclusivasVenta': 'ğŸ  Exclusivas Venta', 'exclusivasComprador': 'ğŸ”‘ Exclusivas Comprador',
        'captacionesAbierto': 'ğŸ˜ï¸ Capt. Abierto', 'citasCompradores': 'ğŸ“… Citas Compradores',
        'casasEnsenadas': 'ğŸ¡ Casas EnseÃ±adas', 'leadsCompradores': 'ğŸ‘¥ Leads Compradores',
        'gci': 'ğŸ’° GCI', 'volumenNegocio': 'ğŸ’¼ Volumen Negocio'
    };
    
    var nombreX = nombres[varX] || varX;
    var nombreY = nombres[varY] || varY;
    
    document.getElementById('scatter-title').textContent = 'ğŸ“Š ' + nombreX + ' vs ' + nombreY;
    
    // Llamar al backend para obtener datos crudos
    google.script.run
        .withSuccessHandler(function(datosScatter) {
            console.log('ğŸ“Š Datos scatter recibidos:', datosScatter);
            
            if (!datosScatter || !datosScatter.success || !datosScatter.puntos || datosScatter.puntos.length < 2) {
                document.getElementById('interpretacion-scatter').innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #888;">
                        <div style="font-size: 2em; margin-bottom: 15px;">ğŸ“Š</div>
                        <div>No hay suficientes datos para graficar</div>
                        <div style="font-size: 0.85em; margin-top: 10px;">Se necesitan al menos 2 registros con valores > 0</div>
                    </div>
                `;
                return;
            }
            
            var scatterData = datosScatter.puntos;
            console.log('âœ… Puntos para scatter:', scatterData.length);
            
            // Destruir grÃ¡fico anterior
            if (window.scatterChartInstance) {
                try { window.scatterChartInstance.destroy(); } catch(e) {}
                window.scatterChartInstance = null;
            }
            
            var canvas = document.getElementById('chart-scatter-custom');
            
            // Color segÃºn correlaciÃ³n
            var colorPuntos = 'rgba(255,107,107,0.7)';
            if (absCorr >= 0.7) {
                colorPuntos = correlacion > 0 ? 'rgba(34,197,94,0.7)' : 'rgba(102,126,234,0.7)';
            } else if (absCorr >= 0.4) {
                colorPuntos = 'rgba(255,215,0,0.7)';
            }
            
            try {
                window.scatterChartInstance = new Chart(canvas, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Datos diarios',
                            data: scatterData,
                            backgroundColor: colorPuntos,
                            borderColor: '#fff',
                            borderWidth: 1,
                            pointRadius: 6,
                            pointHoverRadius: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
    displayColors: false,
    callbacks: {
        title: function(context) {
            var punto = scatterData[context[0].dataIndex];
            return 'Semana: ' + punto.fecha;
        },
        label: function(context) {
            return [
                nombreX + ': ' + context.parsed.x.toLocaleString('es-ES'),
                nombreY + ': ' + context.parsed.y.toLocaleString('es-ES')
            ];
        }
    }
}
                        },
                        scales: {
                            x: {
                                title: { display: true, text: nombreX, color: '#fff', font: { size: 13, weight: 'bold' } },
                                ticks: { color: '#aaa' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            },
                            y: {
                                title: { display: true, text: nombreY, color: '#fff', font: { size: 13, weight: 'bold' } },
                                ticks: { color: '#aaa' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            }
                        }
                    }
                });
                
                console.log('âœ… GrÃ¡fico scatter creado');
                
            } catch(e) {
                console.error('âŒ Error creando chart:', e);
            }
            
            // InterpretaciÃ³n
            renderizarInterpretacionCorrelacion(correlacion, nombreX, nombreY, scatterData.length);
            
            // Scroll
            setTimeout(function() {
                scatterContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        })
        .withFailureHandler(function(error) {
            console.error('âŒ Error obteniendo datos scatter:', error);
            document.getElementById('interpretacion-scatter').innerHTML = `
                <div style="text-align: center; padding: 30px; color: #ff6b6b;">
                    âŒ Error: ${error.message}
                </div>
            `;
        })
        .obtenerDatosScatter(filtros, varX, varY);
}

function renderizarInterpretacionCorrelacion(correlacion, nombreX, nombreY, numDatos) {
    const absCorr = Math.abs(correlacion);
    
    let color, nivel, icono, analisis, accion, ejemplo;
    
    if (absCorr >= 0.7) {
        color = '#22c55e';
        nivel = 'MUY FUERTE';
        icono = 'âœ…';
        
        if (correlacion > 0) {
            analisis = `<strong>RelaciÃ³n POSITIVA muy fuerte.</strong> Cuando ${nombreX} aumenta, ${nombreY} casi siempre aumenta tambiÃ©n.`;
            accion = `<strong>ğŸ’¡ AcciÃ³n:</strong> PRIORIZA aumentar ${nombreX}. Es un driver directo de ${nombreY}.`;
            ejemplo = `Si un agente dobla sus ${nombreX.toLowerCase().replace(/[ğŸ“ğŸ“…ğŸ ğŸ”‘ğŸ˜ï¸ğŸ¡ğŸ‘¥ğŸ’°ğŸ’¼]/g, '').trim()}, probablemente verÃ¡ un aumento significativo en ${nombreY.toLowerCase().replace(/[ğŸ“ğŸ“…ğŸ ğŸ”‘ğŸ˜ï¸ğŸ¡ğŸ‘¥ğŸ’°ğŸ’¼]/g, '').trim()}.`;
        } else {
            analisis = `<strong>RelaciÃ³n NEGATIVA muy fuerte.</strong> Cuando ${nombreX} aumenta, ${nombreY} disminuye.`;
            accion = `<strong>âš ï¸ AcciÃ³n:</strong> EvalÃºa si esta relaciÃ³n inversa es deseable. Puede indicar un problema.`;
            ejemplo = `Aumentar ${nombreX.toLowerCase().replace(/[ğŸ“ğŸ“…ğŸ ğŸ”‘ğŸ˜ï¸ğŸ¡ğŸ‘¥ğŸ’°ğŸ’¼]/g, '').trim()} podrÃ­a estar afectando negativamente a ${nombreY.toLowerCase().replace(/[ğŸ“ğŸ“…ğŸ ğŸ”‘ğŸ˜ï¸ğŸ¡ğŸ‘¥ğŸ’°ğŸ’¼]/g, '').trim()}.`;
        }
    } else if (absCorr >= 0.4) {
        color = '#ffd700';
        nivel = 'MODERADA';
        icono = 'âš ï¸';
        analisis = `<strong>RelaciÃ³n ${correlacion > 0 ? 'POSITIVA' : 'NEGATIVA'} moderada.</strong> Hay conexiÃ³n pero otros factores tambiÃ©n influyen.`;
        accion = `<strong>ğŸ’¡ AcciÃ³n:</strong> Combina ${nombreX} con otras mÃ©tricas para mejores resultados.`;
        ejemplo = `Mejorar ${nombreX.toLowerCase().replace(/[ğŸ“ğŸ“…ğŸ ğŸ”‘ğŸ˜ï¸ğŸ¡ğŸ‘¥ğŸ’°ğŸ’¼]/g, '').trim()} ayuda, pero no es suficiente por sÃ­ solo.`;
    } else {
        color = '#ff6b6b';
        nivel = 'DÃ‰BIL';
        icono = 'âŒ';
        analisis = `<strong>RelaciÃ³n muy dÃ©bil o inexistente.</strong> ${nombreX} y ${nombreY} se comportan de forma independiente.`;
        accion = `<strong>ğŸ’¡ AcciÃ³n:</strong> No esperes que mejorar una impacte en la otra. TrabÃ¡jalas por separado.`;
        ejemplo = `Un agente puede tener alto una mÃ©trica y bajo la otra, o viceversa.`;
    }
    
    document.getElementById('interpretacion-scatter').innerHTML = `
        <div style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                <div style="text-align: center; padding: 15px 20px; background: ${color}22; border-radius: 12px; border: 2px solid ${color};">
                    <div style="font-size: 2.5em; font-weight: 900; color: ${color};">${correlacion.toFixed(3)}</div>
                    <div style="font-size: 0.85em; color: ${color}; font-weight: 700;">${icono} ${nivel}</div>
                </div>
                <div style="flex: 1;">
                    <div style="font-size: 1.1em; font-weight: 700; margin-bottom: 5px;">CorrelaciÃ³n de Pearson</div>
                    <div style="font-size: 0.85em; color: #888;">Basado en ${numDatos} agentes</div>
                </div>
            </div>
        </div>
        
        <div style="margin-bottom: 15px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; border-left: 3px solid ${color};">
            <div style="font-size: 0.9em; line-height: 1.6;">${analisis}</div>
        </div>
        
        <div style="margin-bottom: 15px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; border-left: 3px solid #667eea;">
            <div style="font-size: 0.9em; line-height: 1.6;">${accion}</div>
        </div>
        
        <div style="padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; border-left: 3px solid #888;">
            <div style="font-size: 0.85em; color: #aaa; line-height: 1.6;">
                <strong>ğŸ“Œ En la prÃ¡ctica:</strong> ${ejemplo}
            </div>
        </div>
    `;
}
function renderizarAnalisisOrigenes() {
    const container = document.getElementById('vistaContenido');
    
    // Mostrar loading
    container.innerHTML = '<div style="text-align:center; padding:50px;"><div class="loading-spinner"></div><p>Cargando anÃ¡lisis de orÃ­genes...</p></div>';
    
    // Cargar datos del backend
    google.script.run
        .withSuccessHandler(function(origenes2025) {
            console.log('ğŸ“Š OrÃ­genes 2025:', origenes2025);
            
            // Obtener datos histÃ³ricos (orÃ­genes 2024)
const origenes2024 = [];

// âœ… USAR facturacionPasadaGlobal.origenes (sistema nuevo)
if (facturacionPasadaGlobal && facturacionPasadaGlobal.origenes && facturacionPasadaGlobal.origenes.length > 0) {
    facturacionPasadaGlobal.origenes.forEach(origen => {
        origenes2024.push({
            nombre: origen.fuente,
            captaciones: origen.captaciones || 0,
            gci: origen.gci || 0
        });
    });
    console.log('âœ… Usando orÃ­genes desde FacturaciÃ³n Pasada:', origenes2024);
} else {
    console.warn('âš ï¸ No hay orÃ­genes histÃ³ricos en FacturaciÃ³n Pasada');
}
            
            // Calcular totales
            const totales2025 = {
                capt: origenes2025.reduce((s, o) => s + o.captaciones, 0),
                gci: origenes2025.reduce((s, o) => s + o.gci, 0)
            };
            
            const totales2024 = {
                capt: origenes2024.reduce((s, o) => s + o.captaciones, 0),
                gci: origenes2024.reduce((s, o) => s + o.gci, 0)
            };
            
            const crecimientoCapt = totales2024.capt > 0 
                ? ((totales2025.capt - totales2024.capt) / totales2024.capt * 100).toFixed(1)
                : '-';
            
            const crecimientoGCI = totales2024.gci > 0
                ? ((totales2025.gci - totales2024.gci) / totales2024.gci * 100).toFixed(1)
                : '-';
            
            const colorCapt = crecimientoCapt >= 0 ? 'var(--color-accent-good)' : 'var(--color-accent-bad)';
            const colorGCI = crecimientoGCI >= 0 ? 'var(--color-accent-good)' : 'var(--color-accent-bad)';
            
            // Renderizar HTML
            const html = `
    <div style="background: linear-gradient(135deg, rgba(102,126,234,0.2), rgba(255,107,107,0.2)); padding: 30px; border-radius: 20px; margin-bottom: 30px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <div>
                <h2 style="font-size: 2em; margin: 0; color: var(--color-text-primary);">ğŸ¯ AnÃ¡lisis de OrÃ­genes</h2>
                <p style="color: var(--color-text-faded); margin: 5px 0 0 0;">Descubre de dÃ³nde viene tu negocio</p>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <div style="text-align: center; padding: 15px 25px; background: rgba(0,0,0,0.3); border-radius: 12px;">
                    <div style="font-size: 0.85em; color: #aaa;">AÃ‘O ACTUAL</div>
                    <div style="font-size: 1.8em; font-weight: 900; color: #22c55e;">${totales2025.gci.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</div>
                </div>
                <div style="font-size: 2em; opacity: 0.3;">vs</div>
                <div style="text-align: center; padding: 15px 25px; background: rgba(0,0,0,0.3); border-radius: 12px;">
                    <div style="font-size: 0.85em; color: #aaa;">AÃ‘O ANTERIOR</div>
                    <div style="font-size: 1.8em; font-weight: 900; color: #ff6b6b;">${totales2024.gci.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</div>
                </div>
            </div>
        </div>

        <!-- FILTROS MEJORADOS -->
        <div style="background: rgba(0,0,0,0.4); padding: 20px; border-radius: 15px; backdrop-filter: blur(10px);">
            <div style="display: grid; grid-template-columns: 3fr 1fr auto; gap: 20px; align-items: center;">
                
                <!-- SELECTOR DE AGENTES MEJORADO -->
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label style="font-weight: 600; color: var(--color-text-primary); font-size: 0.95em;">ğŸ‘¥ AGENTES</label>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="seleccionarTodosAgentes()" class="btn" style="padding: 5px 12px; font-size: 0.85em;">âœ“ Todos</button>
                            <button onclick="limpiarSeleccionAgentes()" class="btn" style="padding: 5px 12px; font-size: 0.85em;">âœ— Limpiar</button>
                        </div>
                    </div>
                    <div id="agentes-checkboxes-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px; max-height: 150px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 10px;">
                        <!-- Se llenarÃ¡ dinÃ¡micamente -->
                    </div>
                </div>

                <!-- LADO TRANSACCIÃ“N -->
                <div>
                    <label style="display: block; font-weight: 600; color: var(--color-text-primary); font-size: 0.95em; margin-bottom: 10px;">ğŸ­ LADO</label>
                    <select id="origenes-lado-filter" class="form-select" style="font-size: 1em;">
                        <option value="TODOS">Todos</option>
                        <option value="Vendedor">Vendedor</option>
                        <option value="Comprador">Comprador</option>
                        <option value="Ambos">Ambos</option>
                    </select>
                </div>

                <!-- BOTÃ“N APLICAR -->
                <div style="align-self: end;">
                    <button class="btn-primary-action" onclick="aplicarFiltrosOrigenes()" style="padding: 15px 30px; font-size: 1.1em; white-space: nowrap;">
                        ğŸ” Aplicar
                    </button>
                </div>
            </div>
            
            <!-- TAGS DE AGENTES SELECCIONADOS -->
            <div id="agentes-seleccionados-tags" style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 8px; min-height: 30px;">
                <span style="color: var(--color-text-faded); font-size: 0.9em;">Todo el equipo seleccionado</span>
            </div>
        </div>
    </div>

    <!-- MÃ‰TRICAS PRINCIPALES -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px;">
        <div style="background: linear-gradient(135deg, rgba(102,126,234,0.2), rgba(102,126,234,0.05)); padding: 20px; border-radius: 15px; border: 1px solid rgba(102,126,234,0.3);">
            <div style="font-size: 0.9em; color: #aaa; margin-bottom: 5px;">ğŸ“Š CAPTACIONES 2025</div>
            <div style="font-size: 2.5em; font-weight: 900; color: #667eea; margin: 10px 0;">${totales2025.capt}</div>
            <div style="font-size: 0.85em; color: ${colorCapt}; font-weight: 600;">${crecimientoCapt >= 0 ? 'â†—' : 'â†˜'} ${crecimientoCapt}% vs 2024</div>
        </div>
        
        <div style="background: linear-gradient(135deg, rgba(0,255,136,0.2), rgba(0,255,136,0.05)); padding: 20px; border-radius: 15px; border: 1px solid rgba(0,255,136,0.3);">
            <div style="font-size: 0.9em; color: #aaa; margin-bottom: 5px;">ğŸ’° GCI 2025</div>
            <div style="font-size: 2em; font-weight: 900; color: #22c55e; margin: 10px 0;">${totales2025.gci.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</div>
            <div style="font-size: 0.85em; color: ${colorGCI}; font-weight: 600;">${crecimientoGCI >= 0 ? 'â†—' : 'â†˜'} ${crecimientoGCI}% vs 2024</div>
        </div>
        
        <div style="background: linear-gradient(135deg, rgba(255,107,107,0.2), rgba(255,107,107,0.05)); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,107,107,0.3);">
            <div style="font-size: 0.9em; color: #aaa; margin-bottom: 5px;">ğŸ“Š CAPTACIONES 2024</div>
            <div style="font-size: 2.5em; font-weight: 900; color: #ff6b6b; margin: 10px 0;">${totales2024.capt}</div>
            <div style="font-size: 0.85em; color: #888;">AÃ±o anterior</div>
        </div>
        
        <div style="background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,215,0,0.05)); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,215,0,0.3);">
            <div style="font-size: 0.9em; color: #aaa; margin-bottom: 5px;">ğŸ’° GCI 2024</div>
            <div style="font-size: 2em; font-weight: 900; color: #ffd700; margin: 10px 0;">${totales2024.gci.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</div>
            <div style="font-size: 0.85em; color: #888;">AÃ±o anterior</div>
        </div>
    </div>

    <!-- TABLA COMPARATIVA -->
    <div class="section-card" style="margin-bottom: 30px;">
        <div class="section-title">ğŸ“‹ Tabla Comparativa por Origen</div>
        <div class="tabla-container">
            <table class="tabla">
                <thead>
                    <tr>
                        <th style="text-align: left;">Origen</th>
                        <th>Capt. 2025</th>
                        <th>GCI 2025</th>
                        <th>Capt. 2024</th>
                        <th>GCI 2024</th>
                        <th>Var. Capt.</th>
                        <th>Var. GCI</th>
                    </tr>
                </thead>
                <tbody id="tabla-origenes-body"></tbody>
                <tfoot>
                    <tr style="font-weight: bold; background: var(--color-surface);">
                        <td>TOTALES</td>
                        <td>${totales2025.capt}</td>
                        <td>${totales2025.gci.toLocaleString('es-ES')}â‚¬</td>
                        <td>${totales2024.capt}</td>
                        <td>${totales2024.gci.toLocaleString('es-ES')}â‚¬</td>
                        <td style="color: ${colorCapt};">${crecimientoCapt}%</td>
                        <td style="color: ${colorGCI};">${crecimientoGCI}%</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- GRÃFICOS COMPARATIVOS -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div class="section-card">
            <div class="section-title">ğŸ“Š Comparativa Captaciones</div>
            <canvas id="chart-origenes-captaciones"></canvas>
        </div>
        <div class="section-card">
            <div class="section-title">ğŸ’° Comparativa GCI</div>
            <canvas id="chart-origenes-gci"></canvas>
        </div>
    </div>

    <!-- PIE CHART -->
    <div class="section-card">
        <div class="section-title">ğŸ¥§ DistribuciÃ³n GCI 2025 por Origen</div>
        <canvas id="chart-origenes-pie" style="max-height: 400px;"></canvas>
    </div>
`;
            
            container.innerHTML = html;
            
            // Rellenar tabla y grÃ¡ficos
            setTimeout(() => {
                renderizarTablaOrigenes(origenes2025, origenes2024);
                renderizarGraficosOrigenes(origenes2025, origenes2024);
            }, 100);
            
            // ğŸ†• POBLAR CHECKBOXES DE AGENTES
google.script.run
    .withSuccessHandler(function(agentes) {
        const container = document.getElementById('agentes-checkboxes-container');
        if (container && agentes && agentes.length > 0) {
            container.innerHTML = agentes.map(agente => `
                <label style="display: flex; align-items: center; padding: 8px 12px; background: rgba(255,255,255,0.05); border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                    <input type="checkbox" value="${agente[0]}" onchange="actualizarTagsAgentesSeleccionados()" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
                    <span style="font-size: 0.9em;">${agente[1]}</span>
                </label>
            `).join('');
            
            // Marcar todos por defecto
            seleccionarTodosAgentes();
        }
    })
    .withFailureHandler(function(error) {
        console.error('Error al cargar agentes:', error);
    })
    .obtenerListaAgentes();
        })
        .withFailureHandler(function(error) {
            container.innerHTML = `<div style="text-align:center; padding:50px; color: var(--color-accent-bad);">âŒ Error al cargar datos: ${error}</div>`;
        })
        .calcularOrigenesDelAnoActual();
}
function seleccionarTodosAgentes() {
    const checkboxes = document.querySelectorAll('#agentes-checkboxes-container input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = true);
    actualizarTagsAgentesSeleccionados();
}

function limpiarSeleccionAgentes() {
    const checkboxes = document.querySelectorAll('#agentes-checkboxes-container input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
    actualizarTagsAgentesSeleccionados();
}

function actualizarTagsAgentesSeleccionados() {
    const checkboxes = document.querySelectorAll('#agentes-checkboxes-container input[type="checkbox"]:checked');
    const tagsContainer = document.getElementById('agentes-seleccionados-tags');
    
    if (checkboxes.length === 0 || checkboxes.length === document.querySelectorAll('#agentes-checkboxes-container input[type="checkbox"]').length) {
        tagsContainer.innerHTML = '<span style="color: var(--color-text-faded); font-size: 0.9em;">ğŸ“Š Todo el equipo seleccionado</span>';
    } else {
        tagsContainer.innerHTML = Array.from(checkboxes).map(cb => 
            `<span style="background: rgba(102,126,234,0.3); padding: 5px 12px; border-radius: 20px; font-size: 0.9em; border: 1px solid rgba(102,126,234,0.5);">
                ${cb.nextSibling.textContent}
            </span>`
        ).join('');
    }
}
function renderizarTablaOrigenes(origenes2025, origenes2024) {
    const tbody = document.getElementById('tabla-origenes-body');
    
    // Combinar datos por nombre de origen
    const combinado = origenes2025.map(o25 => {
        const o24 = origenes2024.find(o => o.nombre === o25.nombre) || { captaciones: 0, gci: 0 };
        
        const varCapt = o24.captaciones > 0 
            ? ((o25.captaciones - o24.captaciones) / o24.captaciones * 100).toFixed(1)
            : (o25.captaciones > 0 ? '+100' : '0');
        
        const varGCI = o24.gci > 0
            ? ((o25.gci - o24.gci) / o24.gci * 100).toFixed(1)
            : (o25.gci > 0 ? '+100' : '0');
        
        return {
            nombre: o25.nombre,
            capt2025: o25.captaciones,
            gci2025: o25.gci,
            capt2024: o24.captaciones,
            gci2024: o24.gci,
            varCapt: parseFloat(varCapt),
            varGCI: parseFloat(varGCI)
        };
    });
    
    // Ordenar por GCI 2025 descendente
    combinado.sort((a, b) => b.gci2025 - a.gci2025);
    
    // Renderizar filas
    tbody.innerHTML = combinado.map(o => {
        const colorCapt = o.varCapt >= 0 ? 'var(--color-accent-good)' : 'var(--color-accent-bad)';
        const colorGCI = o.varGCI >= 0 ? 'var(--color-accent-good)' : 'var(--color-accent-bad)';
        const iconoCapt = o.varCapt >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
        const iconoGCI = o.varGCI >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
        
        return `
            <tr>
                <td style="text-align: left; font-weight: 500;">${o.nombre}</td>
                <td>${o.capt2025}</td>
                <td>${o.gci2025.toLocaleString('es-ES')}â‚¬</td>
                <td style="opacity: 0.6;">${o.capt2024}</td>
                <td style="opacity: 0.6;">${o.gci2024.toLocaleString('es-ES')}â‚¬</td>
                <td style="color: ${colorCapt}; font-weight: 600;">${iconoCapt} ${o.varCapt}%</td>
                <td style="color: ${colorGCI}; font-weight: 600;">${iconoGCI} ${o.varGCI}%</td>
            </tr>
        `;
    }).join('');
}

function renderizarGraficosOrigenes(origenes2025, origenes2024) {
    // Filtrar solo orÃ­genes con datos
    const datos2025 = origenes2025.filter(o => o.captaciones > 0 || o.gci > 0);
    const datos2024Filtrados = datos2025.map(o25 => {
        const o24 = origenes2024.find(o => o.nombre === o25.nombre) || { captaciones: 0, gci: 0 };
        return o24;
    });
    
    const labels = datos2025.map(o => o.nombre.length > 30 ? o.nombre.substring(0, 27) + '...' : o.nombre);
    
    // 1. GRÃFICO COMPARATIVA CAPTACIONES
    const ctxCapt = document.getElementById('chart-origenes-captaciones');
    if (ctxCapt) {
        new Chart(ctxCapt, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '2025',
                        data: datos2025.map(o => o.captaciones),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    },
                    {
                        label: '2024',
                        data: datos2024Filtrados.map(o => o.captaciones),
                        backgroundColor: 'rgba(255, 107, 107, 0.3)',
                        borderColor: 'rgba(255, 107, 107, 1)',
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: true, position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y + ' captaciones';
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        ticks: { color: 'rgba(255,255,255,0.7)' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    x: {
                        ticks: { 
                            color: 'rgba(255,255,255,0.7)',
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: { display: false }
                    }
                }
            }
        });
    }
    
    // 2. GRÃFICO COMPARATIVA GCI
    const ctxGCI = document.getElementById('chart-origenes-gci');
    if (ctxGCI) {
        new Chart(ctxGCI, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '2025',
                        data: datos2025.map(o => o.gci),
                        backgroundColor: 'rgba(0, 255, 136, 0.8)',
                        borderColor: 'rgba(0, 255, 136, 1)',
                        borderWidth: 2
                    },
                    {
                        label: '2024',
                        data: datos2024Filtrados.map(o => o.gci),
                        backgroundColor: 'rgba(255, 107, 107, 0.3)',
                        borderColor: 'rgba(255, 107, 107, 1)',
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: true, position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toLocaleString('es-ES') + 'â‚¬';
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        ticks: { 
                            color: 'rgba(255,255,255,0.7)',
                            callback: function(value) {
                                return value.toLocaleString('es-ES') + 'â‚¬';
                            }
                        },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    x: {
                        ticks: { 
                            color: 'rgba(255,255,255,0.7)',
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: { display: false }
                    }
                }
            }
        });
    }
    
    // 3. PIE CHART DISTRIBUCIÃ“N 2025
    const ctxPie = document.getElementById('chart-origenes-pie');
    if (ctxPie) {
        // Solo mostrar top 10 + "Otros"
        const sorted = [...datos2025].sort((a, b) => b.gci - a.gci);
        const top10 = sorted.slice(0, 10);
        const otros = sorted.slice(10).reduce((sum, o) => sum + o.gci, 0);
        
        const pieLabels = top10.map(o => o.nombre);
        const pieData = top10.map(o => o.gci);
        
        if (otros > 0) {
            pieLabels.push('Otros');
            pieData.push(otros);
        }
        
        const colores = [
            '#667eea', '#22c55e', '#ff6b6b', '#ffd93d', '#6bcf7f',
            '#ff8c42', '#c44dff', '#4dffdf', '#ff4db8', '#4d94ff', '#999999'
        ];
        
        new Chart(ctxPie, {
            type: 'pie',
            data: {
                labels: pieLabels,
                datasets: [{
                    data: pieData,
                    backgroundColor: colores,
                    borderWidth: 2,
                    borderColor: 'rgba(0,0,0,0.3)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        position: 'right',
                        labels: { color: 'rgba(255,255,255,0.8)' }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const pct = ((context.parsed / total) * 100).toFixed(1);
                                return context.label + ': ' + context.parsed.toLocaleString('es-ES') + 'â‚¬ (' + pct + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
}
function aplicarFiltrosOrigenes() {
    // Obtener checkboxes seleccionados
    const checkboxes = document.querySelectorAll('#agentes-checkboxes-container input[type="checkbox"]:checked');
    const totalCheckboxes = document.querySelectorAll('#agentes-checkboxes-container input[type="checkbox"]').length;
    const selectLado = document.getElementById('origenes-lado-filter');
    
    // Si todos estÃ¡n seleccionados o ninguno, enviar array vacÃ­o (= todos)
    const agentesIds = (checkboxes.length === 0 || checkboxes.length === totalCheckboxes) 
        ? [] 
        : Array.from(checkboxes).map(cb => cb.value);
    
    const lado = selectLado.value;
    
    console.log('ğŸ” Aplicando filtros - Agentes:', agentesIds, 'Lado:', lado);
    
    // Mostrar loading en las tarjetas de stats
    const statsCards = document.querySelectorAll('[style*="grid-template-columns: repeat(4, 1fr)"] > div');
    statsCards.forEach(card => {
        const valueDiv = card.querySelector('[style*="font-size: 2"]');
        if (valueDiv) valueDiv.innerHTML = '<div class="loading-spinner" style="width:30px; height:30px;"></div>';
    });
    
    // Recargar datos con filtros
    google.script.run
        .withSuccessHandler(function(origenes2025) {
            console.log('ğŸ“Š OrÃ­genes filtrados 2025:', origenes2025);
            
            // Obtener datos histÃ³ricos (sin filtro)
const origenes2024 = [];

if (facturacionPasadaGlobal && facturacionPasadaGlobal.origenes && facturacionPasadaGlobal.origenes.length > 0) {
    facturacionPasadaGlobal.origenes.forEach(origen => {
        origenes2024.push({
            nombre: origen.fuente,
            captaciones: origen.captaciones || 0,
            gci: origen.gci || 0
        });
    });
}
            
            // Recalcular totales
            const totales2025 = {
                capt: origenes2025.reduce((s, o) => s + o.captaciones, 0),
                gci: origenes2025.reduce((s, o) => s + o.gci, 0)
            };
            
            const totales2024 = {
                capt: origenes2024.reduce((s, o) => s + o.captaciones, 0),
                gci: origenes2024.reduce((s, o) => s + o.gci, 0)
            };
            
            const crecimientoCapt = totales2024.capt > 0 
                ? ((totales2025.capt - totales2024.capt) / totales2024.capt * 100).toFixed(1)
                : '-';
            
            const crecimientoGCI = totales2024.gci > 0
                ? ((totales2025.gci - totales2024.gci) / totales2024.gci * 100).toFixed(1)
                : '-';
            
            const colorCapt = parseFloat(crecimientoCapt) >= 0 ? 'var(--color-accent-good)' : 'var(--color-accent-bad)';
            const colorGCI = parseFloat(crecimientoGCI) >= 0 ? 'var(--color-accent-good)' : 'var(--color-accent-bad)';
            
            // Actualizar tarjetas superiores (las dos primeras del gradient)
            const gradientCards = document.querySelectorAll('[style*="gradient(135deg, rgba(102,126,234,0.2)"] [style*="font-size: 1.8em"]');
            if (gradientCards[0]) gradientCards[0].textContent = totales2025.gci.toLocaleString('es-ES', {maximumFractionDigits:0}) + 'â‚¬';
            if (gradientCards[1]) gradientCards[1].textContent = totales2024.gci.toLocaleString('es-ES', {maximumFractionDigits:0}) + 'â‚¬';
            
            // Actualizar las 4 tarjetas de mÃ©tricas
            const metricsCards = document.querySelectorAll('[style*="grid-template-columns: repeat(4, 1fr)"] > div');
            
            // Tarjeta 1: Captaciones 2025
            if (metricsCards[0]) {
                metricsCards[0].querySelector('[style*="font-size: 2.5em"]').textContent = totales2025.capt;
                metricsCards[0].querySelector('[style*="font-size: 0.85em"]').innerHTML = `${parseFloat(crecimientoCapt) >= 0 ? 'â†—' : 'â†˜'} ${crecimientoCapt}% vs 2024`;
                metricsCards[0].querySelector('[style*="font-size: 0.85em"]').style.color = colorCapt;
            }
            
            // Tarjeta 2: GCI 2025
            if (metricsCards[1]) {
                metricsCards[1].querySelector('[style*="font-size: 2em"]').textContent = totales2025.gci.toLocaleString('es-ES', {maximumFractionDigits:0}) + 'â‚¬';
                metricsCards[1].querySelector('[style*="font-size: 0.85em"]').innerHTML = `${parseFloat(crecimientoGCI) >= 0 ? 'â†—' : 'â†˜'} ${crecimientoGCI}% vs 2024`;
                metricsCards[1].querySelector('[style*="font-size: 0.85em"]').style.color = colorGCI;
            }
            
            // Tarjetas 3 y 4 (2024) no cambian
            
            // Actualizar tabla
            const tbody = document.getElementById('tabla-origenes-body');
            if (tbody) {
                renderizarTablaOrigenes(origenes2025, origenes2024);
            }
            
            // Actualizar footer de tabla
            const tfoot = document.querySelector('.tabla tfoot tr');
            if (tfoot) {
                tfoot.innerHTML = `
                    <td>TOTALES</td>
                    <td>${totales2025.capt}</td>
                    <td>${totales2025.gci.toLocaleString('es-ES')}â‚¬</td>
                    <td>${totales2024.capt}</td>
                    <td>${totales2024.gci.toLocaleString('es-ES')}â‚¬</td>
                    <td style="color: ${colorCapt};">${crecimientoCapt}%</td>
                    <td style="color: ${colorGCI};">${crecimientoGCI}%</td>
                `;
            }
            
            // Actualizar grÃ¡ficos
            setTimeout(() => {
                // Destruir grÃ¡ficos anteriores
                ['chart-origenes-captaciones', 'chart-origenes-gci', 'chart-origenes-pie'].forEach(id => {
                    const canvas = document.getElementById(id);
                    if (canvas) {
                        const existingChart = Chart.getChart(canvas);
                        if (existingChart) existingChart.destroy();
                    }
                });
                
                renderizarGraficosOrigenes(origenes2025, origenes2024);
            }, 100);
            
            mostrarNotificacion('âœ… Filtros aplicados correctamente', 'success');
        })
        .withFailureHandler(function(error) {
            mostrarNotificacion('âŒ Error al aplicar filtros: ' + error, 'error');
        })
        .calcularOrigenesDelAnoActualConFiltros(agentesIds, lado);
}
// Parsear fecha desde formato dd/MM/yyyy
function parsearFecha(fechaStr) {
    const partes = fechaStr.split('/');
    return new Date(partes[2], partes[1] - 1, partes[0]);
}

// Limpiar filtros
function limpiarFiltrosTransacciones() {
    window.filtroAgenteTx = 'todos';
    window.filtroTipoTx = 'todos';
    window.filtroFechaInicioTx = '';
    window.filtroFechaFinTx = '';
    renderizarRegistroTransacciones();
}

// Abrir modal de ediciÃ³n con TODOS los datos
function editarTransaccionModal(id, gci, comision, pct) {
    console.log('ğŸ“ Editando transacciÃ³n:', id);
    
    // Buscar transacciÃ³n
    var tx = window.transaccionesGlobales ? window.transaccionesGlobales.find(function(t) { return t.id === id; }) : null;
    
    if (!tx) {
        mostrarNotificacion('TransacciÃ³n no encontrada', 'error');
        return;
    }
    
    // Cargar agentes primero, luego orÃ­genes
google.script.run
    .withSuccessHandler(function(agentes) {
        
        // Ahora cargar orÃ­genes
        google.script.run
            .withSuccessHandler(function(origenes) {
                
                var optionsHTML = '<option value="">-- Seleccionar --</option>';
                if (agentes && agentes.length > 0) {
                    agentes.forEach(function(a) {
                        var agId = Array.isArray(a) ? a[0] : a.id;
                        var agNombre = Array.isArray(a) ? a[1] : a.nombre;
                        var selected = (agNombre === tx.agente) ? 'selected' : '';
                        optionsHTML += '<option value="' + agId + '|' + agNombre + '" ' + selected + '>' + agNombre + '</option>';
                    });
                }
                
                // Opciones de orÃ­genes
                var optionsOrigenes = '<option value="">-- Sin origen --</option>';
                if (origenes && origenes.length > 0) {
                    origenes.forEach(function(origen) {
                        var selected = (origen === tx.origenLead) ? 'selected' : '';
                        optionsOrigenes += '<option value="' + origen + '" ' + selected + '>' + origen + '</option>';
                    });
                }
                
                // Calcular descuento
                var descuento = '-';
                var colorDescuento = '#888';
                if (tx.precioCaptacion > 0 && tx.volumenNegocio > 0) {
                    var pctDesc = ((tx.precioCaptacion - tx.volumenNegocio) / tx.precioCaptacion) * 100;
                    descuento = pctDesc.toFixed(1) + '%';
                    colorDescuento = pctDesc > 10 ? '#ef4444' : pctDesc > 5 ? '#ffc107' : '#22c55e';
                }
                
                // Convertir fecha
                var fechaInput = '';
                if (tx.fecha) {
                    var partes = tx.fecha.split('/');
                    if (partes.length === 3) {
                        fechaInput = partes[2] + '-' + partes[1].padStart(2, '0') + '-' + partes[0].padStart(2, '0');
                    }
                }
                
                // Limpiar descripciÃ³n
                var descripcionLimpia = (tx.descripcion || '').replace(/TRANSACCIÃ“N.*?\|/g, '').replace(/Lado:.*?\|/g, '').replace(/Comis:.*?%/g, '').trim();
                
                var modalId = 'modal-editar-tx-dynamic';
                
                var existente = document.getElementById(modalId);
                if (existente) existente.remove();
                
                var modalDiv = document.createElement('div');
                modalDiv.id = modalId;
                modalDiv.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;">
                        <div style="background: var(--color-bg-alt, #1a1a2e); padding: 30px; border-radius: 15px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; border: 1px solid var(--color-border, #333);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <div style="font-size: 1.3em; font-weight: 700;">âœï¸ Editar TransacciÃ³n</div>
                                <button onclick="document.getElementById('${modalId}').remove()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--color-text-primary, #fff);">&times;</button>
                            </div>
                            
                            <form id="form-editar-tx-dynamic" onsubmit="guardarEdicionTransaccionDynamic(event, '${modalId}')">
                                <input type="hidden" id="edit-tx-id-dyn" value="${tx.id}">
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                    <div class="form-grupo">
                                        <label class="form-label">ğŸ“… Fecha</label>
                                        <input type="date" id="edit-tx-fecha-dyn" class="form-input" value="${fechaInput}" required>
                                    </div>
                                    <div class="form-grupo">
                                        <label class="form-label">ğŸ‘¤ Agente</label>
                                        <select id="edit-tx-agente-dyn" class="form-select" required>${optionsHTML}</select>
                                    </div>
                                    <div class="form-grupo">
                                        <label class="form-label">ğŸ¯ Origen Lead</label>
                                        <select id="edit-tx-origen-dyn" class="form-select">${optionsOrigenes}</select>
                                    </div>
                                    <div class="form-grupo">
                                        <label class="form-label">Tipo</label>
                                        <select id="edit-tx-tipo-dyn" class="form-select">
                                            <option value="Venta" ${tx.tipo === 'VENTA' ? 'selected' : ''}>Venta</option>
                                            <option value="Alquiler" ${tx.tipo === 'ALQUILER' ? 'selected' : ''}>Alquiler</option>
                                            <option value="Otros" ${tx.tipo === 'OTROS' ? 'selected' : ''}>Otros</option>
                                        </select>
                                    </div>
                                    <div class="form-grupo">
                                        <label class="form-label">Lado</label>
                                        <select id="edit-tx-lado-dyn" class="form-select">
                                            <option value="Vendedor" ${tx.lado === 'Vendedor' ? 'selected' : ''}>Vendedor</option>
                                            <option value="Comprador" ${tx.lado === 'Comprador' ? 'selected' : ''}>Comprador</option>
                                            <option value="Ambos" ${tx.lado === 'Ambos' ? 'selected' : ''}>Ambos</option>
                                        </select>
                                    </div>
                                    <div class="form-grupo">
                                        <label class="form-label">ğŸ“‹ Tipo Capt.</label>
                                        <select id="edit-tx-tipocapt-dyn" class="form-select">
                                            <option value="Exclusiva" ${tx.tipoCaptacion === 'Exclusiva' ? 'selected' : ''}>Exclusiva</option>
                                            <option value="Abierto" ${tx.tipoCaptacion === 'Abierto' ? 'selected' : ''}>Abierto</option>
                                            <option value="Alquiler" ${tx.tipoCaptacion === 'Alquiler' ? 'selected' : ''}>Alquiler</option>
                                        </select>
                                    </div>
                                    <div class="form-grupo">
                                        <label class="form-label">ğŸ’° GCI (â‚¬)</label>
                                        <input type="number" id="edit-tx-gci-dyn" class="form-input" value="${tx.gci || 0}" min="0" step="0.01" required>
                                    </div>
                                    <div class="form-grupo">
                                        <label class="form-label">ğŸ·ï¸ Precio CaptaciÃ³n (â‚¬)</label>
                                        <input type="number" id="edit-tx-pcapt-dyn" class="form-input" value="${tx.precioCaptacion || 0}" min="0" step="0.01" oninput="calcularDescuentoEditarDyn()">
                                    </div>
                                    <div class="form-grupo">
                                        <label class="form-label">ğŸ’µ Precio Venta (â‚¬)</label>
                                        <input type="number" id="edit-tx-volumen-dyn" class="form-input" value="${tx.volumenNegocio || 0}" min="0" step="0.01" oninput="calcularDescuentoEditarDyn()">
                                    </div>
                                    <div class="form-grupo">
                                        <label class="form-label">ğŸ“‰ % Descuento</label>
                                        <div id="edit-tx-descuento-dyn" style="padding: 12px; background: var(--color-surface, #252540); border-radius: 8px; font-weight: 700; text-align: center; color: ${colorDescuento};">${descuento}</div>
                                    </div>
                                    <div class="form-grupo">
                                        <label class="form-label">% ComisiÃ³n</label>
                                        <input type="number" id="edit-tx-pct-dyn" class="form-input" value="${tx.pctComision || 0}" min="0" max="100" step="0.1">
                                    </div>
                                    <div class="form-grupo">
                                        <label class="form-label">ComisiÃ³n (â‚¬)</label>
                                        <input type="number" id="edit-tx-comision-dyn" class="form-input" value="${tx.comision || 0}" min="0" step="0.01">
                                    </div>
                                    <div class="form-grupo" style="grid-column: span 2;">
                                        <label class="form-label">ğŸ“ DescripciÃ³n</label>
                                        <input type="text" id="edit-tx-descripcion-dyn" class="form-input" value="${descripcionLimpia}">
                                    </div>
                                </div>
                                
                                <div style="margin-top: 20px;">
                                    <button type="submit" class="btn btn-primary-action" style="width: 100%; padding: 12px;">ğŸ’¾ Guardar Cambios</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modalDiv);
                
            })
            .withFailureHandler(function() {
                mostrarNotificacion('Error cargando orÃ­genes', 'error');
            })
            .obtenerOrigenesNegocio();
        
    })
    .withFailureHandler(function(error) {
        console.error('Error:', error);
        mostrarNotificacion('Error cargando agentes', 'error');
    })
    .obtenerListaAgentes();

function calcularDescuentoEditarDyn() {
    var precioCaptacion = parseFloat(document.getElementById('edit-tx-pcapt-dyn').value) || 0;
    var precioVenta = parseFloat(document.getElementById('edit-tx-volumen-dyn').value) || 0;
    var div = document.getElementById('edit-tx-descuento-dyn');
    
    if (precioCaptacion > 0 && precioVenta > 0) {
        var descuento = ((precioCaptacion - precioVenta) / precioCaptacion) * 100;
        div.innerHTML = descuento.toFixed(1) + '%';
        div.style.color = descuento > 10 ? '#ef4444' : descuento > 5 ? '#ffc107' : '#22c55e';
    } else {
        div.innerHTML = '-';
        div.style.color = '#888';
    }
}

function guardarEdicionTransaccionDynamic(event, modalId) {
    event.preventDefault();
    
    var agenteVal = document.getElementById('edit-tx-agente-dyn').value;
    var agenteParts = agenteVal.split('|');
    
    var datos = {
    id: document.getElementById('edit-tx-id-dyn').value,
    fecha: document.getElementById('edit-tx-fecha-dyn').value,
    idAgente: agenteParts[0] || '',
    nombreAgente: agenteParts[1] || '',
    tipo: document.getElementById('edit-tx-tipo-dyn').value,
    lado: document.getElementById('edit-tx-lado-dyn').value,
    tipoCaptacion: document.getElementById('edit-tx-tipocapt-dyn').value,
    origenLead: document.getElementById('edit-tx-origen-dyn').value,
    gci: parseFloat(document.getElementById('edit-tx-gci-dyn').value) || 0,
    precioCaptacion: parseFloat(document.getElementById('edit-tx-pcapt-dyn').value) || 0,
    volumenNegocio: parseFloat(document.getElementById('edit-tx-volumen-dyn').value) || 0,
    pctComision: parseFloat(document.getElementById('edit-tx-pct-dyn').value) || 0,
    comision: parseFloat(document.getElementById('edit-tx-comision-dyn').value) || 0,
    descripcion: document.getElementById('edit-tx-descripcion-dyn').value
};
    
    mostrarNotificacion('â³ Guardando...', 'info');
    
    google.script.run
        .withSuccessHandler(function(res) {
            if (res.success) {
                mostrarNotificacion('âœ… TransacciÃ³n actualizada', 'success');
                document.getElementById(modalId).remove();
                renderizarRegistroTransacciones();
            } else {
                mostrarNotificacion('âŒ ' + res.error, 'error');
            }
        })
        .withFailureHandler(function(error) {
            mostrarNotificacion('âŒ ' + error.message, 'error');
        })
        .actualizarTransaccionCompleta(datos);
}

function anularDesdeModalDyn(id, modalId) {
    if (confirm('Â¿Seguro que quieres ANULAR esta transacciÃ³n?')) {
        google.script.run
            .withSuccessHandler(function(res) {
                if (res.success) {
                    mostrarNotificacion('âœ… Anulada', 'success');
                    document.getElementById(modalId).remove();
                    renderizarRegistroTransacciones();
                } else {
                    mostrarNotificacion('âŒ ' + res.error, 'error');
                }
            })
            .anularTransaccion(id);
    }
}

function calcularDescuentoEditar() {
    var precioCaptacion = parseFloat(document.getElementById('edit-tx-precio-captacion').value) || 0;
    var precioVenta = parseFloat(document.getElementById('edit-tx-volumen').value) || 0;
    var divDescuento = document.getElementById('edit-tx-descuento');
    
    if (precioCaptacion > 0 && precioVenta > 0) {
        var descuento = ((precioCaptacion - precioVenta) / precioCaptacion) * 100;
        divDescuento.innerHTML = descuento.toFixed(1) + '%';
        divDescuento.style.color = descuento > 10 ? '#ef4444' : descuento > 5 ? '#ffc107' : '#22c55e';
    } else {
        divDescuento.innerHTML = '-';
        divDescuento.style.color = '#888';
    }
}
function anularTransaccionDesdeModal() {
    var id = document.getElementById('edit-tx-id').value;
    if (confirm('Â¿Anular esta transacciÃ³n?')) {
        google.script.run
            .withSuccessHandler(function(res) {
                if (res.success) {
                    mostrarNotificacion('âœ… Anulada', 'success');
                    cerrarModalSuperior('modal-editar-tx');
                    renderizarRegistroTransacciones();
                } else {
                    mostrarNotificacion('âŒ ' + res.error, 'error');
                }
            })
            .anularTransaccion(id);
    }
}
function guardarEdicionTransaccion(event) {
    event.preventDefault();
    
    var id = document.getElementById('edit-tx-id').value;
    var agenteVal = document.getElementById('edit-tx-agente').value;
    var agenteParts = agenteVal.split('|');
    
    var datos = {
        id: id,
        fecha: document.getElementById('edit-tx-fecha').value,
        idAgente: agenteParts[0] || '',
        nombreAgente: agenteParts[1] || '',
        tipo: document.getElementById('edit-tx-tipo').value,
        lado: document.getElementById('edit-tx-lado').value,
        gci: parseFloat(document.getElementById('edit-tx-gci').value) || 0,
        precioCaptacion: parseFloat(document.getElementById('edit-tx-precio-captacion').value) || 0,
        volumenNegocio: parseFloat(document.getElementById('edit-tx-volumen').value) || 0,
        pctComision: parseFloat(document.getElementById('edit-tx-pct').value) || 0,
        comision: parseFloat(document.getElementById('edit-tx-comision').value) || 0,
        descripcion: document.getElementById('edit-tx-descripcion').value
    };
    
    mostrarNotificacion('â³ Guardando cambios...', 'info');
    
    google.script.run
        .withSuccessHandler(function(res) {
            if (res.success) {
                mostrarNotificacion('âœ… TransacciÃ³n actualizada', 'success');
                cerrarModalSuperior('modal-editar-tx');
                cargarDatosGerente(periodoActual);
            } else {
                mostrarNotificacion('âŒ ' + res.error, 'error');
            }
        })
        .withFailureHandler(function(error) {
            mostrarNotificacion('âŒ Error: ' + error.message, 'error');
        })
        .actualizarTransaccionCompleta(datos);
}

function anularTransaccionConfirmar() {
    var id = document.getElementById('edit-tx-id').value;
    if (confirm('Â¿Seguro que quieres ANULAR esta transacciÃ³n?\n\nEsto pondrÃ¡ el GCI y comisiones a 0.')) {
        google.script.run
            .withSuccessHandler(function(res) {
                if (res.success) {
                    mostrarNotificacion('âœ… TransacciÃ³n anulada', 'success');
                    cerrarModalSuperior('modal-editar-tx');
                    cargarDatosGerente(periodoActual);
                } else {
                    mostrarNotificacion('âŒ ' + res.error, 'error');
                }
            })
            .withFailureHandler(function(error) {
                mostrarNotificacion('âŒ ' + error.message, 'error');
            })
            .anularTransaccion(id);
    }
}

// Convertir fecha de dd/MM/yyyy a yyyy-MM-dd
function convertirFechaParaInput(fechaStr) {
    const partes = fechaStr.split('/');
    return `${partes[2]}-${partes[1].padStart(2, '0')}-${partes[0].padStart(2, '0')}`;
}

// Calcular comisiÃ³n automÃ¡ticamente
function calcularComisionEdicion() {
    const gci = parseFloat(document.getElementById('edit-tx-gci').value) || 0;
    const pct = parseFloat(document.getElementById('edit-tx-pct').value) || 0;
    
    // âœ… CORRECCIÃ“N CRÃTICA: ComisiÃ³n = (GCI Ã— %) / 100
    const comision = (gci * pct / 100).toFixed(2);
    
    document.getElementById('edit-tx-comision').value = comision;
}

// Guardar ediciÃ³n COMPLETA
function guardarEdicionTransaccionCompleta(event) {
    event.preventDefault();
    
    const agenteSeleccionado = document.getElementById('edit-tx-agente').value.split('|');
    
    const datosActualizados = {
        id: document.getElementById('edit-tx-id').value,
        fecha: document.getElementById('edit-tx-fecha').value,
        idAgente: agenteSeleccionado[0],
        nombreAgente: agenteSeleccionado[1],
        tipo: document.getElementById('edit-tx-tipo').value,
        lado: document.getElementById('edit-tx-lado').value,
        gci: parseFloat(document.getElementById('edit-tx-gci').value),
        volumenNegocio: parseFloat(document.getElementById('edit-tx-volumen').value) || 0,
        pctComision: parseFloat(document.getElementById('edit-tx-pct').value),
        comision: parseFloat(document.getElementById('edit-tx-comision').value),
        descripcion: document.getElementById('edit-tx-descripcion').value
    };
    
    google.script.run
        .withSuccessHandler(function(respuesta) {
            if (respuesta.success) {
                mostrarNotificacion('âœ… TransacciÃ³n actualizada completamente', 'success');
                document.getElementById('modal-editar-tx').classList.remove('active');
                document.body.classList.remove('modal-open');
                renderizarRegistroTransacciones();
            } else {
                mostrarNotificacion('âŒ Error: ' + respuesta.error, 'error');
            }
        })
        .withFailureHandler(function(error) {
            mostrarNotificacion('âŒ Error: ' + error.message, 'error');
        })
        .editarTransaccionCompleta(datosActualizados);
}

// Anular transacciÃ³n
function anularTransaccionConfirm(id) {
    // Crear modal de confirmaciÃ³n custom
    const modalId = 'modal-confirm-anular-' + Date.now();
    const modalConfirm = document.createElement('div');
    modalConfirm.id = modalId;
    modalConfirm.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center;">
            <div style="background: var(--color-bg-alt); padding: 30px; border-radius: 15px; max-width: 500px; text-align: center; border: 2px solid #ff4444; box-shadow: 0 20px 60px rgba(255,68,68,0.5);">
                <div style="font-size: 3em; margin-bottom: 10px;">âš ï¸</div>
                <div style="font-size: 1.3em; font-weight: 700; margin-bottom: 15px; color: #ff4444;">Anular TransacciÃ³n</div>
                <div style="margin-bottom: 20px; line-height: 1.5; color: var(--color-text-primary);">
                    Â¿EstÃ¡s seguro de que quieres anular esta transacciÃ³n?<br>
                    <strong style="color: #ff4444;">Esto pondrÃ¡ el GCI y comisiones en 0.</strong>
                </div>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button onclick="eliminarModalConfirmacion('${modalId}')" class="btn" style="background: #555; color: #fff;">âŒ Cancelar</button>
                    <button onclick="ejecutarAnulacionTransaccion('${id}'); eliminarModalConfirmacion('${modalId}');" class="btn" style="background: #ff4444; color: #fff;">âœ… SÃ­, Anular</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modalConfirm);
}

function eliminarModalConfirmacion(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.remove();
    }
}

function ejecutarAnulacionTransaccion(id) {
    google.script.run
        .withSuccessHandler(function(respuesta) {
            if (respuesta.success) {
                mostrarNotificacion('âœ… TransacciÃ³n anulada', 'success');
                
                // âœ… CERRAR TODOS LOS MODALES
                document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
                document.body.classList.remove('modal-open');
                
                // âœ… RECARGAR VISTA
                setTimeout(() => {
                    if (vistaActualGerente === 'transacciones') {
                        cambiarVistaGerente('transacciones');
                    } else {
                        cargarDashboardGerente();
                    }
                }, 300);
            } else {
                mostrarNotificacion('âŒ Error: ' + respuesta.error, 'error');
            }
        })
        .withFailureHandler(function(error) {
            mostrarNotificacion('âŒ Error: ' + error.message, 'error');
        })
        .anularTransaccion(id);
}

// Exportar CSV
function exportarTransaccionesCSV() {
    const transacciones = window.transaccionesGlobales || [];
    
    if (transacciones.length === 0) {
        mostrarNotificacion('No hay transacciones para exportar', 'error');
        return;
    }
    
    // Aplicar filtros actuales
    let datos = transacciones;
    
    if (window.filtroAgenteTx && window.filtroAgenteTx !== 'todos') {
        datos = datos.filter(t => t.agente === window.filtroAgenteTx);
    }
    
    if (window.filtroTipoTx && window.filtroTipoTx !== 'todos') {
        datos = datos.filter(t => t.tipo === window.filtroTipoTx);
    }
    
    if (window.filtroFechaInicioTx) {
        const fechaInicio = new Date(window.filtroFechaInicioTx);
        datos = datos.filter(t => parsearFecha(t.fecha) >= fechaInicio);
    }
    
    if (window.filtroFechaFinTx) {
        const fechaFin = new Date(window.filtroFechaFinTx);
        datos = datos.filter(t => parsearFecha(t.fecha) <= fechaFin);
    }
    
    // Construir CSV
    let csv = 'ID;Fecha;Agente;Tipo;Lado;GCI;Volumen_Negocio;Comision;Pct_Comision;Descripcion\n';
    
    datos.forEach(t => {
        csv += `${t.id};${t.fecha};${t.agente};${t.tipo};${t.lado};${t.gci};${t.volumenNegocio};${t.comision};${t.pctComision};${t.descripcion.replace(/;/g, ',')}\n`;
    });
    
    // Descargar archivo
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `Transacciones_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    mostrarNotificacion(`âœ… Exportadas ${datos.length} transacciones`, 'success');
}
// Cargar datos de Beneficio Neto
function cargarDatosBeneficio() {
    const filtros = calcularFiltrosPeriodo(periodoActual, 'gerente');
    
    google.script.run
        .withSuccessHandler(function(resultado) {
            if (resultado.success) {
                window.datosBeneficioGlobal = resultado;
                
                const beneficio = resultado.beneficioNeto;
                const pct = resultado.porcentajeBeneficio;
                const color = pct >= 50 ? '#22c55e' : pct >= 30 ? '#ffd700' : '#ff6b6b';
                
                document.getElementById('kpi-beneficio').textContent = beneficio.toLocaleString('es-ES', {maximumFractionDigits: 0}) + 'â‚¬';
                document.getElementById('kpi-beneficio').style.color = color;
                
                document.getElementById('kpi-beneficio-pct').innerHTML = `Margen: ${pct.toFixed(1)}%`;
                document.getElementById('kpi-beneficio-pct').style.color = color;
            }
        })
        .obtenerBeneficioNeto(filtros);
}

// Cargar datos de Transacciones
function cargarDatosTransacciones() {
    const filtros = calcularFiltrosPeriodo(periodoActual, 'gerente');
    
    google.script.run
        .withSuccessHandler(function(resultado) {
            if (resultado.success) {
                window.datosTransaccionesGlobal = resultado;
                
                const stats = resultado.stats;
                
                document.getElementById('kpi-transacciones-total').textContent = stats.total;
                
                const detalle = `
                    ğŸ  ${stats.vendedor} Vendedor | 
                    ğŸ”‘ ${stats.comprador} Comprador | 
                    ğŸ¤ ${stats.ambos} Ambos
                `;
                document.getElementById('kpi-transacciones-detalle').innerHTML = detalle;
            }
        })
        .obtenerEstadisticasTransacciones(filtros);
}

// Llamar estas funciones al cargar el dashboard
// AÃ±ade estas lÃ­neas donde cargas los demÃ¡s datos del dashboard
cargarDatosBeneficio();
cargarDatosTransacciones();
function mostrarGraficoBeneficio() {
    if (!window.datosBeneficioGlobal) {
        mostrarNotificacion('âš ï¸ Cargando datos de beneficio...', 'error');
        return;
    }
    
    const resultado = window.datosBeneficioGlobal;
    
    // Crear modal
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 1200px; height: auto; max-height: 90vh; overflow-y: auto;">
            <span class="modal-close" onclick="this.closest('.modal').remove(); document.body.classList.remove('modal-open');">Ã—</span>
            <div class="modal-body">
                <div class="section-title">ğŸ’° EvoluciÃ³n de Beneficio Neto</div>
                
                <!-- RESUMEN GLOBAL -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: var(--color-surface); padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 0.85em; color: #aaa;">ğŸ’° GCI Total</div>
                        <div style="font-size: 1.8em; font-weight: 700; color: #22c55e;">${resultado.gciTotal.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</div>
                    </div>
                    <div style="background: var(--color-surface); padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 0.85em; color: #aaa;">ğŸ’¸ Comisiones Pagadas</div>
                        <div style="font-size: 1.8em; font-weight: 700; color: #ff6b6b;">${resultado.comisionesTotal.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</div>
                        <div style="font-size: 0.75em; color: #aaa; margin-top: 3px;">
                            ${resultado.gciTotal > 0 ? ((resultado.comisionesTotal / resultado.gciTotal) * 100).toFixed(1) : 0}% del GCI
                        </div>
                    </div>
                    <div style="background: var(--color-surface); padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 0.85em; color: #aaa;">ğŸ¢ Gastos Operativos</div>
                        <div style="font-size: 1.8em; font-weight: 700; color: #ffd700;">${resultado.gastosOperativos.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</div>
                        <div style="font-size: 0.75em; color: #aaa; margin-top: 3px;">
                            ${resultado.gciTotal > 0 ? ((resultado.gastosOperativos / resultado.gciTotal) * 100).toFixed(1) : 0}% del GCI
                        </div>
                    </div>
                    <div style="background: var(--color-surface); padding: 15px; border-radius: 10px; text-align: center; border: 2px solid ${resultado.porcentajeBeneficio >= 40 ? '#22c55e' : resultado.porcentajeBeneficio >= 25 ? '#ffd700' : '#ff6b6b'};">
                        <div style="font-size: 0.85em; color: ${resultado.porcentajeBeneficio >= 40 ? '#22c55e' : resultado.porcentajeBeneficio >= 25 ? '#ffd700' : '#ff6b6b'};">âœ… Beneficio Neto</div>
                        <div style="font-size: 1.8em; font-weight: 700; color: ${resultado.porcentajeBeneficio >= 40 ? '#22c55e' : resultado.porcentajeBeneficio >= 25 ? '#ffd700' : '#ff6b6b'};">
                            ${resultado.beneficioNeto.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬
                        </div>
                        <div style="font-size: 0.9em; margin-top: 3px; font-weight: 700; color: ${resultado.porcentajeBeneficio >= 40 ? '#22c55e' : resultado.porcentajeBeneficio >= 25 ? '#ffd700' : '#ff6b6b'};">
                            Margen: ${resultado.porcentajeBeneficio.toFixed(1)}%
                        </div>
                    </div>
                </div>
                
                <!-- GRÃFICO LÃNEAS -->
                <div class="chart-container" style="height: 400px; margin-bottom: 25px;">
                    <canvas id="chart-beneficio-lineas"></canvas>
                </div>
                
                <!-- GRÃFICO BARRAS - BENEFICIO POR MES -->
                <div class="chart-container" style="height: 350px; margin-bottom: 25px;">
                    <canvas id="chart-beneficio-barras"></canvas>
                </div>
                
                <!-- LEYENDA -->
                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px;">
                    <div style="font-weight: 700; margin-bottom: 10px; color: #fff;">ğŸ“Š Leyenda de Margen de Beneficio</div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.9em;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 20px; height: 20px; background: #22c55e; border-radius: 3px;"></div>
                            <span><strong>Excelente:</strong> â‰¥ 40%</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 20px; height: 20px; background: #ffd700; border-radius: 3px;"></div>
                            <span><strong>Regular:</strong> 25% - 40%</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 20px; height: 20px; background: #ff6b6b; border-radius: 3px;"></div>
                            <span><strong>Bajo:</strong> < 25%</span>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: rgba(102,126,234,0.1); border-radius: 5px; border-left: 3px solid #667eea;">
                        <strong>ğŸ¯ Objetivo:</strong> Mantener un margen de beneficio neto > 40% del GCI total para asegurar la salud financiera del negocio.
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    document.body.classList.add('modal-open');
    
    // Preparar datos mensuales
    const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    const datosGCI = [];
    const datosComisiones = [];
    const datosGastos = [];
    const datosBeneficio = [];
    const datosPorcentaje = [];
    
    for (let mes = 1; mes <= 12; mes++) {
        const d = resultado.datosMensuales[mes];
        datosGCI.push(d.gci);
        datosComisiones.push(d.comisiones);
        datosGastos.push(d.gastos);
        datosBeneficio.push(d.beneficio);
        
        // Calcular porcentaje del mes
        const pct = d.gci > 0 ? ((d.beneficio / d.gci) * 100) : 0;
        datosPorcentaje.push(pct);
    }
    
    // Crear grÃ¡ficos
    setTimeout(() => {
        // GrÃ¡fico 1: LÃ­neas - EvoluciÃ³n
        new Chart(document.getElementById('chart-beneficio-lineas'), {
            type: 'line',
            data: {
                labels: meses,
                datasets: [
                    {
                        label: 'GCI',
                        data: datosGCI,
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(0,255,136,0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Comisiones',
                        data: datosComisiones,
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255,107,107,0.1)',
                        borderWidth: 2,
                        tension: 0.4
                    },
                    {
                        label: 'Gastos',
                        data: datosGastos,
                        borderColor: '#ffd700',
                        backgroundColor: 'rgba(255,215,0,0.1)',
                        borderWidth: 2,
                        tension: 0.4
                    },
                    {
                        label: 'Beneficio Neto',
                        data: datosBeneficio,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102,126,234,0.2)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: { color: '#fff', font: { size: 12 } }
                    },
                    title: {
                        display: true,
                        text: 'EvoluciÃ³n Mensual - GCI vs Costes',
                        color: '#fff',
                        font: { size: 16, weight: 'bold' }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#fff' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    y: {
                        ticks: { 
                            color: '#fff',
                            callback: function(value) {
                                return value.toLocaleString('es-ES') + 'â‚¬';
                            }
                        },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    }
                }
            }
        });
        
        // GrÃ¡fico 2: Barras - Beneficio y % por mes
        new Chart(document.getElementById('chart-beneficio-barras'), {
            type: 'bar',
            data: {
                labels: meses,
                datasets: [
                    {
                        label: 'Beneficio (â‚¬)',
                        data: datosBeneficio,
                        backgroundColor: datosPorcentaje.map(pct => {
                            if (pct >= 40) return 'rgba(0,255,136,0.8)';
                            if (pct >= 25) return 'rgba(255,215,0,0.8)';
                            return 'rgba(255,107,107,0.8)';
                        }),
                        borderColor: '#fff',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Margen %',
                        data: datosPorcentaje,
                        type: 'line',
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102,126,234,0.2)',
                        borderWidth: 3,
                        tension: 0.4,
                        yAxisID: 'y1',
                        pointRadius: 5,
                        pointBackgroundColor: '#667eea'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        labels: { color: '#fff', font: { size: 12 } }
                    },
                    title: {
                        display: true,
                        text: 'Beneficio (â‚¬) y Margen (%) por Mes',
                        color: '#fff',
                        font: { size: 16, weight: 'bold' }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.datasetIndex === 0) {
                                    label += context.parsed.y.toLocaleString('es-ES') + 'â‚¬';
                                } else {
                                    label += context.parsed.y.toFixed(1) + '%';
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#fff' },
                        grid: { display: false }
                    },
                    y: {
                        type: 'linear',
                        position: 'left',
                        ticks: { 
                            color: '#fff',
                            callback: function(value) {
                                return value.toLocaleString('es-ES') + 'â‚¬';
                            }
                        },
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        title: {
                            display: true,
                            text: 'Beneficio (â‚¬)',
                            color: '#fff'
                        }
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        ticks: { 
                            color: '#667eea',
                            callback: function(value) {
                                return value.toFixed(0) + '%';
                            }
                        },
                        grid: { display: false },
                        title: {
                            display: true,
                            text: 'Margen %',
                            color: '#667eea'
                        },
                        min: 0,
                        max: 100
                    }
                }
            }
        });
    }, 100);
}
function mostrarGraficoTransacciones() {
    if (!window.datosTransaccionesGlobal) {
        mostrarNotificacion('âš ï¸ Cargando datos de transacciones...', 'error');
        return;
    }
    
    const resultado = window.datosTransaccionesGlobal;
    const stats = resultado.stats;
    
    // Crear modal
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 1200px; height: auto; max-height: 90vh; overflow-y: auto;">
            <span class="modal-close" onclick="this.closest('.modal').remove(); document.body.classList.remove('modal-open');">Ã—</span>
            <div class="modal-body">
                <div class="section-title">ğŸ“Š AnÃ¡lisis Completo de Transacciones</div>
                
                <!-- RESUMEN POR LADO -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: var(--color-surface); padding: 20px; border-radius: 10px; border-left: 4px solid #667eea;">
                        <div style="font-size: 0.9em; color: #667eea; margin-bottom: 5px;">ğŸ  VENDEDOR</div>
                        <div style="font-size: 2em; font-weight: 700; margin: 10px 0;">${stats.vendedor}</div>
                        <div style="font-size: 0.85em; color: #aaa;">GCI: ${stats.gciVendedor.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</div>
                        <div style="font-size: 0.85em; color: #aaa;">Volumen: ${stats.volumenVendedor.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</div>
                        <div style="font-size: 0.85em; color: #aaa;">Ticket: ${stats.vendedor > 0 ? (stats.volumenVendedor / stats.vendedor).toFixed(0) : 0}â‚¬</div>
                    </div>
                    
                    <div style="background: var(--color-surface); padding: 20px; border-radius: 10px; border-left: 4px solid #ffd700;">
                        <div style="font-size: 0.9em; color: #ffd700; margin-bottom: 5px;">ğŸ”‘ COMPRADOR</div>
                        <div style="font-size: 2em; font-weight: 700; margin: 10px 0;">${stats.comprador}</div>
                        <div style="font-size: 0.85em; color: #aaa;">GCI: ${stats.gciComprador.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</div>
                        <div style="font-size: 0.85em; color: #aaa;">Volumen: ${stats.volumenComprador.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</div>
                        <div style="font-size: 0.85em; color: #aaa;">Ticket: ${stats.comprador > 0 ? (stats.volumenComprador / stats.comprador).toFixed(0) : 0}â‚¬</div>
                    </div>
                    
                    <div style="background: var(--color-surface); padding: 20px; border-radius: 10px; border-left: 4px solid #22c55e;">
                        <div style="font-size: 0.9em; color: #22c55e; margin-bottom: 5px;">ğŸ¤ AMBOS LADOS</div>
                        <div style="font-size: 2em; font-weight: 700; margin: 10px 0;">${stats.ambos}</div>
                        <div style="font-size: 0.85em; color: #aaa;">GCI: ${stats.gciAmbos.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</div>
                        <div style="font-size: 0.85em; color: #aaa;">Volumen: ${stats.volumenAmbos.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</div>
                        <div style="font-size: 0.85em; color: #aaa;">Ticket: ${stats.ambos > 0 ? (stats.volumenAmbos / stats.ambos).toFixed(0) : 0}â‚¬</div>
                    </div>
                    
                    <div style="background: var(--color-surface); padding: 20px; border-radius: 10px; border: 2px solid #fff;">
                        <div style="font-size: 0.9em; color: #fff; margin-bottom: 5px;">ğŸ“ˆ TOTAL</div>
                        <div style="font-size: 2em; font-weight: 700; margin: 10px 0;">${stats.total}</div>
                        <div style="font-size: 0.85em; color: #aaa;">GCI: ${stats.gciTotal.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</div>
                        <div style="font-size: 0.85em; color: #aaa;">Volumen: ${stats.volumenTotal.toLocaleString('es-ES', {maximumFractionDigits:0})}â‚¬</div>
                        <div style="font-size: 0.85em; color: #aaa;">Ticket: ${stats.total > 0 ? (stats.volumenTotal / stats.total).toFixed(0) : 0}â‚¬</div>
                    </div>
                </div>
                
                <!-- GRÃFICOS -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div class="chart-container" style="height: 350px;">
                        <div style="font-weight: 700; margin-bottom: 10px; text-align: center;">ğŸ“Š Transacciones por Mes</div>
                        <canvas id="chart-tx-mensuales"></canvas>
                    </div>
                    <div class="chart-container" style="height: 350px;">
                        <div style="font-weight: 700; margin-bottom: 10px; text-align: center;">ğŸ’° GCI por Lado</div>
                        <canvas id="chart-tx-gci"></canvas>
                    </div>
                </div>
                
                <!-- LEYENDA -->
                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px;">
                    <div style="font-weight: 700; margin-bottom: 10px; color: #fff;">ğŸ“Š Leyenda de Transacciones</div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.9em;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 20px; height: 20px; background: #22c55e; border-radius: 3px;"></div>
                            <span><strong>Excelente:</strong> â‰¥ 15 tx</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 20px; height: 20px; background: #ffd700; border-radius: 3px;"></div>
                            <span><strong>Regular:</strong> 8 - 15 tx</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 20px; height: 20px; background: #ff6b6b; border-radius: 3px;"></div>
                            <span><strong>Bajo:</strong> < 8 tx</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    document.body.classList.add('modal-open');
    
    // Preparar datos
    const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    const datosVendedor = [];
    const datosComprador = [];
    const datosAmbos = [];
    
    for (let mes = 1; mes <= 12; mes++) {
        const d = resultado.mensuales[mes];
        datosVendedor.push(d.vendedor);
        datosComprador.push(d.comprador);
        datosAmbos.push(d.ambos);
    }
    
    setTimeout(() => {
        // GrÃ¡fico 1: Transacciones por mes (barras apiladas)
        new Chart(document.getElementById('chart-tx-mensuales'), {
            type: 'bar',
            data: {
                labels: meses,
                datasets: [
                    {
                        label: 'Vendedor',
                        data: datosVendedor,
                        backgroundColor: 'rgba(102,126,234,0.8)',
                        borderColor: '#667eea',
                        borderWidth: 1
                    },
                    {
                        label: 'Comprador',
                        data: datosComprador,
                        backgroundColor: 'rgba(255,215,0,0.8)',
                        borderColor: '#ffd700',
                        borderWidth: 1
                    },
                    {
                        label: 'Ambos',
                        data: datosAmbos,
                        backgroundColor: 'rgba(0,255,136,0.8)',
                        borderColor: '#22c55e',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        labels: { color: '#fff', font: { size: 11 } }
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        ticks: { color: '#fff', font: { size: 10 } },
                        grid: { display: false }
                    },
                    y: {
                        stacked: true,
                        ticks: { color: '#fff' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    }
                }
            }
        });
        
        // GrÃ¡fico 2: GCI por lado (doughnut)
        new Chart(document.getElementById('chart-tx-gci'), {
            type: 'doughnut',
            data: {
                labels: ['Vendedor', 'Comprador', 'Ambos'],
                datasets: [{
                    data: [stats.gciVendedor, stats.gciComprador, stats.gciAmbos],
                    backgroundColor: [
                        'rgba(102,126,234,0.8)',
                        'rgba(255,215,0,0.8)',
                        'rgba(0,255,136,0.8)'
                    ],
                    borderColor: ['#667eea', '#ffd700', '#22c55e'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#fff', font: { size: 12 } }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed;
                                const total = stats.gciTotal;
                                const pct = ((value / total) * 100).toFixed(1);
                                return `${context.label}: ${value.toLocaleString('es-ES')}â‚¬ (${pct}%)`;
                            }
                        }
                    }
                }
            }
        });
    }, 100);
}
function crearGraficoDetalleComparativo(canvasId, labels, dataRealizado, dataObjetivo, dataHistorico, titulo) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    
    // Destruir grÃ¡fico previo si existe para evitar superposiciones y errores de "canvas in use"
    if (chartInstances[canvasId]) {
        chartInstances[canvasId].destroy();
    }

    // ConfiguraciÃ³n de colores
    const colorReal = '#22c55e'; // Verde neÃ³n
    const colorObj = '#ffd700';  // Amarillo
    const colorHist = 'rgba(255, 255, 255, 0.1)'; // Blanco transparente

    chartInstances[canvasId] = new Chart(ctx, {
        type: 'bar', // El tipo base es barra para permitir la mezcla
        data: {
            labels: labels,
            datasets: [
                {
                    type: 'line',
                    label: 'Realizado 2025 (App + HistÃ³rico)',
                    data: dataRealizado,
                    borderColor: colorReal,
                    backgroundColor: 'rgba(0, 255, 136, 0.1)', // Relleno suave bajo la lÃ­nea
                    borderWidth: 3,
                    pointBackgroundColor: colorReal,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    fill: true,
                    tension: 0.3, // Curva suave
                    order: 0 // Capa superior (frente)
                },
                {
                    type: 'line',
                    label: 'Objetivo',
                    data: dataObjetivo,
                    borderColor: colorObj,
                    borderWidth: 2,
                    borderDash: [5, 5], // LÃ­nea punteada
                    pointRadius: 0,
                    fill: false,
                    tension: 0.3,
                    order: 1 // Capa media
                },
                {
                    type: 'bar',
                    label: 'Referencia AÃ±o Anterior',
                    data: dataHistorico,
                    backgroundColor: colorHist,
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                    borderWidth: 1,
                    barPercentage: 0.6,
                    order: 2 // Capa fondo
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: { color: '#ccc', font: { size: 12 } }
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.9)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: '#333',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            if (context.parsed.y !== null) {
                                // Formatear si es dinero
                                if (titulo.toLowerCase().includes('gci') || titulo.toLowerCase().includes('ticket')) {
                                    label += context.parsed.y.toLocaleString('es-ES', {maximumFractionDigits: 0}) + ' â‚¬';
                                } else {
                                    label += Math.round(context.parsed.y);
                                }
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { color: '#aaa' }
                },
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(255,255,255,0.05)' },
                    ticks: { color: '#aaa' }
                }
            }
        }
    });
    
    console.log('âœ… GrÃ¡fico detallado generado correctamente en', canvasId);
}
// =========================================================
// ğŸ IMPORTADOR V62: PARSER ESPAÃ‘OL + SIN FILTROS
// =========================================================

let estadoImportacion = []; 
let lineasCargadas = [];

function mostrarModalImportador() {
    document.querySelectorAll('.modal').forEach(el => el.remove());
    document.body.classList.remove('modal-open');

    const anioActual = new Date().getFullYear();
    
    const modalHTML = `
        <div id="modal-pegado" class="modal active" style="z-index:5000; display:block; background:rgba(0,0,0,0.95);">
            <div class="modal-content" style="width:95%; max-width:1400px; height:95vh; display:flex; flex-direction:column; background:#1a1a1a; color:#fff; border:1px solid #555;">
                
                <div style="display:flex; justify-content:space-between; align-items:center; padding:15px; border-bottom:1px solid #333; background:#222;">
                    <h3 style="margin:0; color:#22c55e;">ğŸ Importador V62 (Fuerza Bruta)</h3>
                    <button onclick="cerrarModalTotal()" style="background:#ff4444; color:white; border:none; font-size:18px; padding:5px 15px; cursor:pointer; border-radius:5px;">CERRAR X</button>
                </div>
                
                <div class="modal-body" style="flex-grow:1; display:flex; flex-direction:column; overflow-y:auto; padding:20px;">
                    
                    <div id="paso-1">
                        <p style="color:#aaa; margin-bottom:5px;">1. Pega aquÃ­ las filas del Excel (incluyendo a Lidia):</p>
                        <textarea id="input-paste" oninput="previsualizarV62()" style="width:100%; height:150px; background:#000; color:#0f0; border:1px solid #555; padding:10px; font-family:monospace; font-size:0.8em; white-space:pre;" placeholder="Pegar datos..."></textarea>
                        
                        <div id="panel-calibracion" style="display:none; margin-top:15px; background:#333; padding:15px; border:2px solid #ffd700; border-radius:10px;">
                            <h4 style="margin:0 0 10px 0; color:#ffd700;">ğŸ“ 2. CalibraciÃ³n (Mira la regla abajo)</h4>
                            
                            <div style="overflow-x:auto; background:#000; padding:10px; border:1px solid #555; margin-bottom:15px;">
                                <div id="regla-datos" style="display:flex; gap:2px; white-space:nowrap;"></div>
                            </div>

                            <div style="display:flex; gap:20px; align-items:end; flex-wrap:wrap;">
                                <div>
                                    <label style="display:block; font-size:0.8em; color:#aaa;">NÂº Columna NOMBRE:</label>
                                    <input type="number" id="idx-nombre" value="2" style="width:60px; padding:5px; text-align:center; font-weight:bold;">
                                </div>
                                <div>
                                    <label style="display:block; font-size:0.8em; color:#aaa;">NÂº Columna Inicio ENERO:</label>
                                    <input type="number" id="idx-enero" value="42" style="width:60px; padding:5px; text-align:center; font-weight:bold;">
                                </div>
                                <div style="flex-grow:1;">
                                    <label style="display:block; font-size:0.8em; color:#aaa;">AÃ±o:</label>
                                    <select id="input-year" style="padding:5px; width:100px;">
                                        <option value="${anioActual}">${anioActual}</option>
                                        <option value="${anioActual - 1}" selected>${anioActual - 1}</option>
                                    </select>
                                </div>
                                <button onclick="procesarV62()" style="padding:10px 25px; background:#22c55e; color:black; font-weight:bold; border:none; cursor:pointer; border-radius:5px; font-size:1.1em;">
                                    ğŸš€ 3. PROCESAR
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="resultado-importacion" style="margin-top:20px; flex-grow:1; overflow:hidden; display:none; flex-direction:column;"></div>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function cerrarModalTotal() {
    document.querySelectorAll('.modal').forEach(el => el.remove());
    document.body.classList.remove('modal-open');
}

function previsualizarV62() {
    const text = document.getElementById('input-paste').value;
    if (!text.trim()) return;

    lineasCargadas = text.split(/\r\n|\n/).filter(l => l.trim().length > 0);
    if (lineasCargadas.length === 0) return;

    // Intentamos encontrar la fila de Lidia para mostrarla de ejemplo
    let filaEjemplo = lineasCargadas[0];
    for(let l of lineasCargadas) {
        if(l.includes("Lidia")) { filaEjemplo = l; break; }
    }

    const cols = filaEjemplo.split('\t');
    let html = '';

    cols.forEach((val, idx) => {
        let bg = '#222';
        let color = '#aaa';
        if (val.includes("Lidia")) { bg = '#004400'; color = '#22c55e'; } 
        // Detectar nÃºmeros posibles (como el 7 de enero)
        if (val.trim().match(/^[0-9]+$/)) { bg = '#444400'; color = '#ffd700'; } 

        html += `
            <div style="min-width:60px; max-width:100px; background:${bg}; border:1px solid #444; margin-right:2px; text-align:center;">
                <div style="background:#444; color:#fff; font-size:10px; padding:2px;">${idx}</div>
                <div style="padding:5px; color:${color}; font-size:11px; overflow:hidden; text-overflow:ellipsis;">${val || '-'}</div>
            </div>
        `;
    });

    document.getElementById('regla-datos').innerHTML = html;
    document.getElementById('panel-calibracion').style.display = 'block';
}

function procesarV62() {
    const anio = parseInt(document.getElementById('input-year').value);
    const colNombre = parseInt(document.getElementById('idx-nombre').value);
    const colEnero = parseInt(document.getElementById('idx-enero').value);
    const ANCHO_MES = 20;

    const OFF = {
        citas: 0, excl: 1, abierto: 2, citasComp: 3, visitas: 4,
        captAlq: 5, tresBs: 6, bajadas: 7, propuestas: 8, arras: 9,
        vtaExcl: 10, gciExcl: 11, vtaAbierto: 12, gciAbierto: 13,
        vtaComp: 14, gciComp: 15, vtaAlq: 16, gciAlq: 17,
        gciTotal: 18 
    };

    const agentesTemp = [];

    lineasCargadas.forEach((linea, i) => {
        const cols = linea.split('\t');
        
        // Si la lÃ­nea no llega ni a la columna de Enero, la saltamos
        if (cols.length < colEnero) return;

        let nombre = cols[colNombre] ? cols[colNombre].trim() : '';
        
        // Filtro mÃ­nimo: Si no tiene nombre o es una cabecera obvia
        if (!nombre || nombre.length < 2 || nombre.includes("NOMBRE AGENTE") || nombre === "0") return;

        const datosMensuales = [];

        for (let m = 0; m < 12; m++) {
            const base = colEnero + (m * ANCHO_MES);
            
            const getVal = (off) => {
                if ((base + off) >= cols.length) return 0;
                let val = cols[base + off];
                if (!val) return 0;
                
                // LIMPIEZA AGRESIVA: Solo dejamos nÃºmeros, comas, puntos y guiones
                val = val.replace(/[^0-9,\.\-]/g, '');
                if (val === '' || val === '-') return 0;

                // PARSER ESPAÃ‘OL (Punto miles, Coma decimal) -> JS (Nada miles, Punto decimal)
                // Ejemplo: "1.200,50" -> "1200.50"
                // Ejemplo: "100" -> "100"
                // Ejemplo: "50,5" -> "50.5"
                
                if (val.includes('.') && val.includes(',')) {
                    // Tiene ambos: quitamos punto, cambiamos coma
                    val = val.replace(/\./g, '').replace(',', '.');
                } else if (val.includes(',')) {
                    // Solo tiene coma: es decimal
                    val = val.replace(',', '.');
                } else if (val.includes('.')) {
                    // Solo tiene punto: en EspaÃ±a suele ser miles (1.200), lo quitamos
                    // CUIDADO: Si fuera 1.5 (uno y medio) esto lo convierte en 15. 
                    // Asumimos formato ES estricto donde punto es miles.
                    val = val.replace(/\./g, '');
                }
                
                return parseFloat(val) || 0;
            };

            const mesData = {};
            for (const key in OFF) mesData[key] = getVal(OFF[key]);
            
            // Recalcular ventas
            mesData.ventas = mesData.vtaExcl + mesData.vtaAbierto + mesData.vtaComp + mesData.vtaAlq;
            datosMensuales.push(mesData);
        }

        const totalGCI = datosMensuales.reduce((s, m) => s + m.gciTotal, 0);
        const totalCitas = datosMensuales.reduce((s, m) => s + m.citas, 0);
        const totalVentas = datosMensuales.reduce((s, m) => s + m.ventas, 0);
        const totalExclusivas = datosMensuales.reduce((s, m) => s + m.excl, 0);

        // AÃ‘ADIR SIEMPRE (Sin filtrar por 0), para ver si lee mal o si son ceros reales
        agentesTemp.push({
            id: i,
            nombre: nombre,
            anio: anio,
            mensual: datosMensuales,
            totalCitas, totalExclusivas, totalVentas, totalGCI
        });
    });

    estadoImportacion = agentesTemp;
    renderizarV62();
}

function renderizarV62() {
    const div = document.getElementById('resultado-importacion');
    const agentes = estadoImportacion;

    if (agentes.length === 0) {
        alert("âŒ Error: 0 agentes procesados. Revisa el nÃºmero de columna del Nombre.");
        return;
    }

    document.getElementById('paso-1').style.display = 'none';
    div.style.display = 'flex';

    const totalOfi = agentes.reduce((s, a) => s + a.totalGCI, 0);

    const headers = ["Citas", "Excl", "Abierto", "Visitas", "Alq", "3Bs", "Bajadas", "Prop", "Arras", "Ventas", "GCI Tot"];
    const keys = ["citas", "excl", "abierto", "visitas", "captAlq", "tresBs", "bajadas", "propuestas", "arras", "ventas", "gciTotal"];
    const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];

    let html = `
        <div style="margin-bottom:10px; background:#333; padding:10px; border-radius:5px; display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h3 style="margin:0; color:#fff;">TOTAL: <span style="color:#22c55e;">${totalOfi.toLocaleString('de-DE')}â‚¬</span></h3>
                <small style="color:#aaa;">${agentes.length} Agentes</small>
            </div>
            <button onclick="mostrarModalImportador()" style="background:#555; color:white; padding:5px 15px; border:none; border-radius:5px; cursor:pointer;">â†©ï¸ Recalibrar</button>
        </div>
        
        <div id="lista-agentes" style="flex-grow:1; overflow-y:auto; padding-right:5px;">
    `;

    agentes.forEach((a, idx) => {
        html += `
            <div style="background:#2a2a2a; margin-bottom:10px; border-radius:5px; overflow:hidden; border:1px solid #444;">
                <div onclick="toggleDetalle('det-${idx}')" style="padding:10px 15px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; background:linear-gradient(90deg, #333, #2a2a2a);">
                    <div><strong style="color:#fff;">ğŸ‘¤ ${a.nombre}</strong></div>
                    <div>
                        <span style="color:#22c55e; font-weight:bold; margin-right:10px;">${a.totalGCI.toLocaleString('de-DE')}â‚¬</span>
                        <span style="color:#aaa; font-size:0.8em;">â–¼</span>
                    </div>
                </div>
                <div id="det-${idx}" style="display:none; padding:5px; background:#1e1e1e;">
                    <div style="overflow-x:auto;">
                        <table class="tabla" style="width:100%; font-size:0.7em; color:#ccc;">
                            <thead>
                                <tr style="background:#333;">
                                    <th style="position:sticky; left:0; background:#333; padding:5px;">Mes</th>
                                    ${headers.map(h => `<th style="text-align:center;">${h}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
        `;
        
        a.mensual.forEach((m, i) => {
            let tds = keys.map(k => {
                // Formato espaÃ±ol visual
                let valStr = m[k] === 0 ? '-' : m[k].toLocaleString('de-DE');
                let color = k==='gciTotal' ? '#22c55e' : '#fff';
                return `<td style="text-align:center; color:${color};">${valStr}</td>`;
            }).join('');
            html += `<tr><td>${meses[i]}</td>${tds}</tr>`;
        });
        
        html += `</tbody></table></div></div></div>`;
    });

    html += `
        </div>
        <div style="margin-top:15px;">
            <button class="btn-primary-action" onclick="guardarV62()" style="width:100%; padding:15px; font-size:1.2em;">ğŸ’¾ GUARDAR DATOS</button>
        </div>
    `;
    div.innerHTML = html;
}

function toggleDetalle(id) {
    const el = document.getElementById(id);
    el.style.display = (el.style.display === 'none') ? 'block' : 'none';
}

function guardarV62() {
    const btn = document.querySelector('#resultado-importacion .btn-primary-action');
    btn.innerHTML = "â³ Guardando...";
    btn.disabled = true;

    google.script.run
        .withSuccessHandler(res => {
            alert("âœ… " + res.message);
            cerrarModalTotal();
            if(typeof cargarDatosGerente === 'function') cargarDatosGerente('ano');
        })
        .withFailureHandler(err => {
            alert("âŒ Error: " + err.message);
            btn.disabled = false;
        })
        .guardarImportacionMasivaV27(estadoImportacion);
}


// ============================================
// MEJORA 1: RECÃLCULO COMISIÃ“N EN TRANSACCIONES
// ============================================

function recalcularComisionTransaccion(campo) {
    window.ultimoCampoComisionTx = campo;
    
    const gciInput = document.getElementById('tx-gci-parcial');
    const pctInput = document.getElementById('tx-comision-pct');
    const importeInput = document.getElementById('tx-comision-importe');
    
    const gci = parseFloat(gciInput.value) || 0;
    
    if (campo === 'pct') {
        const pct = parseFloat(pctInput.value) || 40;
        importeInput.value = (gci * pct / 100).toFixed(2);
    } else if (campo === 'importe') {
        const importe = parseFloat(importeInput.value) || 0;
        if (gci > 0) {
            pctInput.value = ((importe / gci) * 100).toFixed(1);
        }
    }
}
// ============================================
// MEJORA 2: CARGAR 18 ORÃGENES DE NEGOCIO
// ============================================

function cargarOrigenesNegocio() {
    google.script.run
        .withSuccessHandler(function(origenes) {
            const tbody = document.getElementById('tabla-origenes-negocio');
            let html = '';
            
            origenes.forEach((origen, idx) => {
                html += `
                    <tr>
                        <td style="text-align:left;">${origen}</td>
                        <td><input type="number" id="fp-origen-${idx}-capt" class="form-input" value="0" min="0"></td>
                        <td><input type="number" id="fp-origen-${idx}-gci" class="form-input" value="0" min="0" step="0.01" oninput="calcularPorcentajesFuentes()"></td>
                        <td id="fp-origen-${idx}-pct" style="font-weight:700;">0%</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        })
        .withFailureHandler(function(error) {
            console.error('Error al cargar orÃ­genes:', error);
            mostrarNotificacion('Error al cargar orÃ­genes de negocio', 'error');
        })
        .obtenerOrigenesNegocio();
}
// ============================================
// MEJORA 4: VISTA MÃšLTIPLE AGENTES (GERENTE)
// ============================================

let mostrandoTodosLosAgentesGerente = false;

function toggleMostrarTodosGerente() {
    mostrandoTodosLosAgentesGerente = !mostrandoTodosLosAgentesGerente;
    const btn = document.getElementById('btn-mostrar-todos-gerente');
    
    if (mostrandoTodosLosAgentesGerente) {
        btn.textContent = 'ğŸ‘¤ Vista Individual';
        btn.classList.add('active');
        renderizarFormulariosMultiplesGerente();
    } else {
        btn.textContent = 'ğŸ‘¥ Mostrar Todos los Agentes';
        btn.classList.remove('active');
        restaurarVistaIndividualGerente();
    }
}

function restaurarVistaIndividualGerente() {
    const container = document.getElementById('formularios-container-gerente');
    
    container.innerHTML = `
        <form id="form-actividad-gerente" onsubmit="guardarActividadGerente(event)" class="form-grid">
            
            <div class="form-grupo" style="grid-column: 1 / -1;">
                <label class="form-label">ğŸ‘¤ Seleccionar Agente</label>
                <select id="actividad-agente-select" class="form-select" required onchange="verificarActividadExistenteGerente()">
                    <option value="">-- Elige un agente --</option>
                </select>
            </div>

            <div id="aviso-actividad-existente-gerente" style="display: none; grid-column: 1 / -1; background: rgba(255,215,0,0.1); border: 1px solid #ffd700; border-radius: 8px; padding: 15px; margin: 10px 0;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.5em;">âš ï¸</span>
                    <div>
                        <strong>Ya existe actividad para esta fecha</strong>
                        <div style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;" id="resumen-actividad-existente-gerente"></div>
                    </div>
                </div>
            </div>

            <div class="form-grupo">
                <label class="form-label">ğŸ“… Fecha</label>
                <input type="date" id="gerente-form-fecha" class="form-input" required onchange="verificarActividadExistenteGerente()">
            </div>
            <div class="form-grupo">
                <label class="form-label">ğŸ“ Citas CaptaciÃ³n</label>
                <input type="number" id="gerente-form-citas-captacion" class="form-input" min="0" value="0">
            </div>
            <div class="form-grupo">
                <label class="form-label">ğŸ  Exclusivas Venta</label>
                <input type="number" id="gerente-form-exclusivas-venta" class="form-input" min="0" value="0">
            </div>
            <div class="form-grupo">
                <label class="form-label">ğŸ”‘ Exclusivas Comprador</label>
                <input type="number" id="gerente-form-exclusivas-comprador" class="form-input" min="0" value="0">
            </div>
            <div class="form-grupo">
                <label class="form-label">ğŸ˜ï¸ Captaciones Abierto</label>
                <input type="number" id="gerente-form-captaciones-abierto" class="form-input" min="0" value="0">
            </div>
            <div class="form-grupo">
                <label class="form-label">ğŸ‘¥ Citas Compradores</label>
                <input type="number" id="gerente-form-citas-compradores" class="form-input" min="0" value="0">
            </div>
            <div class="form-grupo">
                <label class="form-label">ğŸ¡ Casas EnseÃ±adas</label>
                <input type="number" id="gerente-form-casas-ensenadas" class="form-input" min="0" value="0">
            </div>
            <div class="form-grupo">
                <label class="form-label">ğŸ“§ Leads Compradores</label>
                <input type="number" id="gerente-form-leads-compradores" class="form-input" min="0" value="0">
            </div>
            <div class="form-grupo">
    <label class="form-label">ğŸ“ Llamadas</label>
    <input type="number" id="gerente-form-llamadas" class="form-input" min="0" value="0">
</div>

<!-- ğŸ†• NUEVOS CAMPOS CAPTACIÃ“N -->
<div class="form-grupo">
    <label class="form-label">ğŸ¢ Captaciones Alquiler</label>
    <input type="number" id="gerente-form-captaciones-alquiler" class="form-input" min="0" value="0">
</div>
<div class="form-grupo">
    <label class="form-label">ğŸ“± Lead Vendedor</label>
    <input type="number" id="gerente-form-lead-vendedor" class="form-input" min="0" value="0">
</div>
<div class="form-grupo">
    <label class="form-label">âš¡ 3Bs Activadas</label>
    <input type="number" id="gerente-form-3bs" class="form-input" min="0" value="0">
</div>
<div class="form-grupo">
    <label class="form-label">ğŸ’¹ Bajadas Precio</label>
    <input type="number" id="gerente-form-bajadas-precio" class="form-input" min="0" value="0">
</div>

<!-- ğŸ†• NUEVOS CAMPOS COMPRADOR -->
<div class="form-grupo">
    <label class="form-label">ğŸ  Lead Comprador</label>
    <input type="number" id="gerente-form-lead-comprador" class="form-input" min="0" value="0">
</div>
<div class="form-grupo">
    <label class="form-label">ğŸ“„ Propuestas Compra</label>
    <input type="number" id="gerente-form-propuestas-compra" class="form-input" min="0" value="0">
</div>
<div class="form-grupo">
    <label class="form-label">ğŸ¯ Lead Seguimiento</label>
    <input type="number" id="gerente-form-lead-seguimiento" class="form-input" min="0" value="0">
</div>

<!-- ğŸ†• CAMPO TRANSACCIONES -->
<div class="form-grupo">
    <label class="form-label">âœï¸ Arras Firmadas</label>
    <input type="number" id="gerente-form-arras" class="form-input" min="0" value="0">
</div>

<div class="form-grupo">
    <label class="form-label">ğŸ’° GCI (â‚¬)</label>
    <input type="number" id="gerente-form-gci" class="form-input" min="0" step="0.01" value="0">
</div>
            <button type="submit" id="btn-submit-actividad-gerente" class="form-submit">ğŸ’¾ Guardar Actividad</button>
        </form>
    `;
    
     // Recargar lista de agentes en el select
    setTimeout(() => {
        poblarSelectAgentes('actividad-agente-select');
    }, 100);
    
    // Establecer fecha actual
    document.getElementById('gerente-form-fecha').value = new Date().toISOString().split('T')[0];
    
    // Resetear modo ediciÃ³n
    modoEdicionActividadGerente = false;
}

function renderizarFormulariosMultiplesGerente() {
    const container = document.getElementById('formularios-container-gerente');
    if (!container) return;
    
    google.script.run
        .withSuccessHandler(function(agentes) {
            if (!agentes || agentes.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--color-accent-bad);">âŒ No se encontraron agentes</div>';
                return;
            }
            
            let html = `
                <div class="form-grupo" style="margin-bottom: 30px; padding: 20px; background: var(--color-surface); border-radius: 15px;">
                    <label class="form-label" style="font-size: 1.2em;">ğŸ“… Fecha para TODOS los agentes</label>
                    <input type="date" id="fecha-multiple-gerente" class="form-input" 
                           value="${new Date().toISOString().split('T')[0]}"
                           onchange="verificarActividadTodosGerente()"
                           required
                           style="font-size: 1.1em;">
                </div>
            `;
            
            agentes.forEach((agente, idx) => {
                // âœ… CORRECCIÃ“N: agente es [id, nombre]
                const agenteId = agente[0];
                const agenteNombre = agente[1];
                
                html += `
                    <div class="section agent-form-multi" data-agent-id="${agenteId}" data-agent-name="${agenteNombre}" style="margin-bottom: 20px; animation: fadeInUp 0.3s ${idx * 50}ms both;">
                        <h3 style="color: var(--color-secondary); margin-bottom: 10px;">${agenteNombre}</h3>
                        
                        <div id="aviso-gerente-${agenteId}" style="display:none; background: rgba(255,215,0,0.1); border: 1px solid #ffd700; border-radius: 8px; padding: 10px; margin-bottom: 10px; font-size: 0.9em;">
                            âš ï¸ Ya hay actividad este dÃ­a
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-grupo">
                                <label class="form-label">ğŸ“ Citas Capt.</label>
                                <input type="number" class="form-input multi-citasCaptacion" min="0" value="0">
                            </div>
                            <div class="form-grupo">
                                <label class="form-label">ğŸ  Excl. Venta</label>
                                <input type="number" class="form-input multi-exclusivasVenta" min="0" value="0">
                            </div>
                            <div class="form-grupo">
                                <label class="form-label">ğŸ”‘ Excl. Compr.</label>
                                <input type="number" class="form-input multi-exclusivasComprador" min="0" value="0">
                            </div>
                            <div class="form-grupo">
                                <label class="form-label">ğŸ˜ï¸ Capt. Abierto</label>
                                <input type="number" class="form-input multi-captacionesAbierto" min="0" value="0">
                            </div>
                            <div class="form-grupo">
                                <label class="form-label">ğŸ‘¥ Citas Compr.</label>
                                <input type="number" class="form-input multi-citasCompradores" min="0" value="0">
                            </div>
                            <div class="form-grupo">
                                <label class="form-label">ğŸ¡ Casas EnseÃ±.</label>
                                <input type="number" class="form-input multi-casasEnsenadas" min="0" value="0">
                            </div>
                            <div class="form-grupo">
                                <label class="form-label">ğŸ“§ Leads</label>
                                <input type="number" class="form-input multi-leadsCompradores" min="0" value="0">
                            </div>
                            <div class="form-grupo">
                                <label class="form-label">ğŸ“ Llamadas</label>
                                <input type="number" class="form-input multi-llamadas" min="0" value="0">
                            </div>
                            <div class="form-grupo">
                                <label class="form-label">ğŸ¢ Capt. Alquiler</label>
                                <input type="number" class="form-input multi-captacionesAlquiler" min="0" value="0">
                            </div>
                            <div class="form-grupo">
                                <label class="form-label">ğŸ“± Lead Vendedor</label>
                                <input type="number" class="form-input multi-leadVendedor" min="0" value="0">
                            </div>
                            <div class="form-grupo">
                                <label class="form-label">âš¡ 3Bs</label>
                                <input type="number" class="form-input multi-tresBs" min="0" value="0">
                            </div>
                            <div class="form-grupo">
                                <label class="form-label">ğŸ’¹ Bajadas</label>
                                <input type="number" class="form-input multi-bajadasPrecio" min="0" value="0">
                            </div>
                            <div class="form-grupo">
                                <label class="form-label">ğŸ  Lead Comprador</label>
                                <input type="number" class="form-input multi-leadComprador" min="0" value="0">
                            </div>
                            <div class="form-grupo">
                                <label class="form-label">ğŸ“„ Propuestas</label>
                                <input type="number" class="form-input multi-propuestasCompra" min="0" value="0">
                            </div>
                            <div class="form-grupo">
                                <label class="form-label">ğŸ¯ Lead Seguim.</label>
                                <input type="number" class="form-input multi-leadSeguimiento" min="0" value="0">
                            </div>
                            <div class="form-grupo">
                                <label class="form-label">âœï¸ Arras</label>
                                <input type="number" class="form-input multi-arras" min="0" value="0">
                            </div>
                            <div class="form-grupo">
                                <label class="form-label">ğŸ’° GCI (â‚¬)</label>
                                <input type="number" class="form-input multi-gci" min="0" step="0.01" value="0">
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                <button type="button" class="btn btn-primary-action" 
                        onclick="guardarActividadMultipleGerente()"
                        style="width: 100%; padding: 20px; font-size: 1.2em; margin-top: 20px;">
                    ğŸ’¾ GUARDAR ACTIVIDAD DE TODOS
                </button>
            `;
            
            container.innerHTML = html;
        })
        .withFailureHandler(function(error) {
            console.error('Error cargando agentes:', error);
            mostrarNotificacion('Error al cargar agentes', 'error');
        })
        .obtenerListaAgentes();
}

function verificarActividadTodosGerente() {
    const fecha = document.getElementById('fecha-multiple-gerente').value;
    if (!fecha) return;
    
    document.querySelectorAll('.agent-form-multi').forEach(section => {
        const agenteId = section.dataset.agentId;
        const avisoDiv = document.getElementById(`aviso-gerente-${agenteId}`);
        
        google.script.run
            .withSuccessHandler(function(actividades) {
                if (actividades && actividades.length > 0) {
                    const act = actividades[0];
                    avisoDiv.innerHTML = `âš ï¸ Actividad previa: GCI ${act.gci}â‚¬ | Citas ${act.citasCaptacion} | Excl. ${act.exclusivasVenta}`;
                    avisoDiv.style.display = 'block';
                } else {
                    avisoDiv.style.display = 'none';
                }
            })
            .withFailureHandler(function(error) {
                console.error('Error al verificar actividad:', error);
            })
            .obtenerActividadDia(agenteId, fecha);
    });
}

function guardarActividadMultipleGerente() {
    const fecha = document.getElementById('fecha-multiple-gerente').value;
    
    if (!fecha) {
        mostrarNotificacion('âš ï¸ Selecciona una fecha', 'error');
        return;
    }
    
    let contador = 0;
    let total = 0;
    
    document.querySelectorAll('.agent-form-multi').forEach(section => {
        const datos = {
            fecha: fecha,
            idAgente: section.dataset.agentId,
            nombreAgente: section.dataset.agentName,
            citasCaptacion: section.querySelector('.multi-citasCaptacion').value,
            exclusivasVenta: section.querySelector('.multi-exclusivasVenta').value,
            exclusivasComprador: section.querySelector('.multi-exclusivasComprador').value,
            captacionesAbierto: section.querySelector('.multi-captacionesAbierto').value,
            citasCompradores: section.querySelector('.multi-citasCompradores').value,
            casasEnsenadas: section.querySelector('.multi-casasEnsenadas').value,
            leadsCompradores: section.querySelector('.multi-leadsCompradores').value,
llamadas: section.querySelector('.multi-llamadas').value,
captacionesAlquiler: section.querySelector('.multi-captacionesAlquiler').value,
leadVendedor: section.querySelector('.multi-leadVendedor').value,
tresBs: section.querySelector('.multi-tresBs').value,
bajadasPrecio: section.querySelector('.multi-bajadasPrecio').value,
leadComprador: section.querySelector('.multi-leadComprador').value,
propuestasCompra: section.querySelector('.multi-propuestasCompra').value,
leadSeguimiento: section.querySelector('.multi-leadSeguimiento').value,
arras: section.querySelector('.multi-arras').value,
gci: section.querySelector('.multi-gci').value,
            notas: ''
        };
        
        const hayActividad = Object.values(datos).slice(2).some(v => parseFloat(v) > 0);
        
        if (hayActividad) {
            total++;
            google.script.run
                .withSuccessHandler(function() {
                    contador++;
                    if (contador === total) {
                        mostrarNotificacion(`âœ… ${contador} actividades guardadas correctamente`, 'success');
                        
                        setTimeout(() => {
                            document.querySelectorAll('.agent-form-multi input[type="number"]').forEach(input => {
                                input.value = '0';
                            });
                        }, 1000);
                    }
                })
                .withFailureHandler(function(error) {
                    mostrarNotificacion('Error al guardar actividad', 'error');
                })
                .guardarActividad(datos);
        }
    });
    
    if (total === 0) {
        mostrarNotificacion('âš ï¸ No hay actividad para guardar (todos los campos estÃ¡n en 0)', 'error');
    }
}
// ============================================
// MEJORA EXTRA: CARGAR Y EDITAR ACTIVIDAD EXISTENTE
// ============================================

let modoEdicionActividad = false;

function verificarActividadExistente() {
    const fecha = document.getElementById('form-fecha').value;
    const idAgente = document.getElementById('form-agent-id').value;
    
    if (!fecha || !idAgente) return;
    
    google.script.run
        .withSuccessHandler(function(actividad) {
            if (actividad && actividad.citasCaptacion !== undefined) {
                // HAY ACTIVIDAD - Cargar datos
                modoEdicionActividad = true;
                cargarDatosEnFormulario(actividad);
                mostrarAvisoActividadExistente(actividad);
                cambiarBotonAActualizar();
            } else {
                // NO HAY ACTIVIDAD - Limpiar formulario
                modoEdicionActividad = false;
                limpiarFormularioActividad();
                ocultarAvisoActividadExistente();
                cambiarBotonAGuardar();
            }
        })
        .withFailureHandler(function(error) {
            console.error('Error al verificar actividad:', error);
        })
        .obtenerActividadCompletaDia(idAgente, fecha);
}

function cargarDatosEnFormulario(actividad) {
    document.getElementById('form-citas-captacion').value = actividad.citasCaptacion || 0;
    document.getElementById('form-exclusivas-venta').value = actividad.exclusivasVenta || 0;
    document.getElementById('form-exclusivas-comprador').value = actividad.exclusivasComprador || 0;
    document.getElementById('form-captaciones-abierto').value = actividad.captacionesAbierto || 0;
    document.getElementById('form-citas-compradores').value = actividad.citasCompradores || 0;
    document.getElementById('form-casas-ensenadas').value = actividad.casasEnsenadas || 0;
    document.getElementById('form-leads-compradores').value = actividad.leadsCompradores || 0;
    document.getElementById('form-llamadas').value = actividad.llamadas || 0;
    // ğŸ†• NUEVOS CAMPOS
    document.getElementById('form-captaciones-alquiler').value = actividad.captacionesAlquiler || 0;
    document.getElementById('form-lead-vendedor').value = actividad.leadVendedor || 0;
    document.getElementById('form-3bs').value = actividad.tresBs || 0;
    document.getElementById('form-bajadas-precio').value = actividad.bajadasPrecio || 0;
    document.getElementById('form-lead-comprador').value = actividad.leadComprador || 0;
    document.getElementById('form-propuestas-compra').value = actividad.propuestasCompra || 0;
    document.getElementById('form-lead-seguimiento').value = actividad.leadSeguimiento || 0;
    document.getElementById('form-arras').value = actividad.arras || 0;
    document.getElementById('form-gci').value = actividad.gci || 0;
}

function limpiarFormularioActividad() {
    document.getElementById('form-citas-captacion').value = 0;
    document.getElementById('form-exclusivas-venta').value = 0;
    document.getElementById('form-exclusivas-comprador').value = 0;
    document.getElementById('form-captaciones-abierto').value = 0;
    document.getElementById('form-citas-compradores').value = 0;
    document.getElementById('form-casas-ensenadas').value = 0;
    document.getElementById('form-leads-compradores').value = 0;
    document.getElementById('form-llamadas').value = 0;
    // ğŸ†• NUEVOS CAMPOS
    document.getElementById('form-captaciones-alquiler').value = 0;
    document.getElementById('form-lead-vendedor').value = 0;
    document.getElementById('form-3bs').value = 0;
    document.getElementById('form-bajadas-precio').value = 0;
    document.getElementById('form-lead-comprador').value = 0;
    document.getElementById('form-propuestas-compra').value = 0;
    document.getElementById('form-lead-seguimiento').value = 0;
    document.getElementById('form-arras').value = 0;
    document.getElementById('form-gci').value = 0;
}

function mostrarAvisoActividadExistente(actividad) {
    const aviso = document.getElementById('aviso-actividad-existente');
    const resumen = document.getElementById('resumen-actividad-existente');
    
    resumen.innerHTML = `GCI: ${actividad.gci}â‚¬ | Citas: ${actividad.citasCaptacion} | Exclusivas: ${actividad.exclusivasVenta} | Llamadas: ${actividad.llamadas}`;
    aviso.style.display = 'block';
}

function ocultarAvisoActividadExistente() {
    document.getElementById('aviso-actividad-existente').style.display = 'none';
}

function cambiarBotonAActualizar() {
    const btn = document.getElementById('btn-submit-actividad');
    btn.textContent = 'ğŸ”„ ACTUALIZAR ACTIVIDAD';
    btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
}

function cambiarBotonAGuardar() {
    const btn = document.getElementById('btn-submit-actividad');
    btn.textContent = 'ğŸ’¾ GUARDAR ACTIVIDAD';
    btn.style.background = '';
}
// ============================================
// MEJORA EXTRA: EDITAR ACTIVIDAD EN VISTA GERENTE
// ============================================

let modoEdicionActividadGerente = false;

function verificarActividadExistenteGerente() {
    const fecha = document.getElementById('gerente-form-fecha').value;
    const idAgente = document.getElementById('actividad-agente-select').value;
    
    if (!fecha || !idAgente) return;
    
    google.script.run
        .withSuccessHandler(function(actividad) {
            if (actividad && actividad.citasCaptacion !== undefined) {
                modoEdicionActividadGerente = true;
                cargarDatosEnFormularioGerente(actividad);
                mostrarAvisoActividadExistenteGerente(actividad);
                cambiarBotonAActualizarGerente();
            } else {
                modoEdicionActividadGerente = false;
                limpiarFormularioActividadGerente();
                ocultarAvisoActividadExistenteGerente();
                cambiarBotonAGuardarGerente();
            }
        })
        .withFailureHandler(function(error) {
            console.error('Error al verificar actividad:', error);
        })
        .obtenerActividadCompletaDia(idAgente, fecha);
}

function cargarDatosEnFormularioGerente(actividad) {
    document.getElementById('gerente-form-citas-captacion').value = actividad.citasCaptacion || 0;
    document.getElementById('gerente-form-exclusivas-venta').value = actividad.exclusivasVenta || 0;
    document.getElementById('gerente-form-exclusivas-comprador').value = actividad.exclusivasComprador || 0;
    document.getElementById('gerente-form-captaciones-abierto').value = actividad.captacionesAbierto || 0;
    document.getElementById('gerente-form-citas-compradores').value = actividad.citasCompradores || 0;
    document.getElementById('gerente-form-casas-ensenadas').value = actividad.casasEnsenadas || 0;
    document.getElementById('gerente-form-leads-compradores').value = actividad.leadsCompradores || 0;
    document.getElementById('gerente-form-llamadas').value = actividad.llamadas || 0;
    // ğŸ†• NUEVOS CAMPOS
    document.getElementById('gerente-form-captaciones-alquiler').value = actividad.captacionesAlquiler || 0;
    document.getElementById('gerente-form-lead-vendedor').value = actividad.leadVendedor || 0;
    document.getElementById('gerente-form-3bs').value = actividad.tresBs || 0;
    document.getElementById('gerente-form-bajadas-precio').value = actividad.bajadasPrecio || 0;
    document.getElementById('gerente-form-lead-comprador').value = actividad.leadComprador || 0;
    document.getElementById('gerente-form-propuestas-compra').value = actividad.propuestasCompra || 0;
    document.getElementById('gerente-form-lead-seguimiento').value = actividad.leadSeguimiento || 0;
    document.getElementById('gerente-form-arras').value = actividad.arras || 0;
    document.getElementById('gerente-form-gci').value = actividad.gci || 0;
}

function limpiarFormularioActividadGerente() {
    document.getElementById('gerente-form-citas-captacion').value = 0;
    document.getElementById('gerente-form-exclusivas-venta').value = 0;
    document.getElementById('gerente-form-exclusivas-comprador').value = 0;
    document.getElementById('gerente-form-captaciones-abierto').value = 0;
    document.getElementById('gerente-form-citas-compradores').value = 0;
    document.getElementById('gerente-form-casas-ensenadas').value = 0;
    document.getElementById('gerente-form-leads-compradores').value = 0;
    document.getElementById('gerente-form-llamadas').value = 0;
    // ğŸ†• NUEVOS CAMPOS
    document.getElementById('gerente-form-captaciones-alquiler').value = 0;
    document.getElementById('gerente-form-lead-vendedor').value = 0;
    document.getElementById('gerente-form-3bs').value = 0;
    document.getElementById('gerente-form-bajadas-precio').value = 0;
    document.getElementById('gerente-form-lead-comprador').value = 0;
    document.getElementById('gerente-form-propuestas-compra').value = 0;
    document.getElementById('gerente-form-lead-seguimiento').value = 0;
    document.getElementById('gerente-form-arras').value = 0;
    document.getElementById('gerente-form-gci').value = 0;
}

function mostrarAvisoActividadExistenteGerente(actividad) {
    const aviso = document.getElementById('aviso-actividad-existente-gerente');
    const resumen = document.getElementById('resumen-actividad-existente-gerente');
    
    resumen.innerHTML = `GCI: ${actividad.gci}â‚¬ | Citas: ${actividad.citasCaptacion} | Exclusivas: ${actividad.exclusivasVenta} | Llamadas: ${actividad.llamadas}`;
    aviso.style.display = 'block';
}

function ocultarAvisoActividadExistenteGerente() {
    const avisoEl = document.getElementById('aviso-actividad-existente-gerente');
    if (avisoEl) avisoEl.style.display = 'none';
}

function cambiarBotonAActualizarGerente() {
    const btn = document.getElementById('btn-submit-actividad-gerente');
    if (btn) {
        btn.textContent = 'ğŸ”„ ACTUALIZAR ACTIVIDAD';
        btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    }
}

function cambiarBotonAGuardarGerente() {
    const btn = document.getElementById('btn-submit-actividad-gerente');
    if (btn) {
        btn.textContent = 'ğŸ’¾ GUARDAR ACTIVIDAD';
        btn.style.background = '';
    }
}
/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * FUNCIÃ“N 2: renderizarAnalisisPresupuestario (NUEVA)
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 */
function renderizarAnalisisPresupuestario(datos) {
    const analisis = datos.analisisAnual;
    const container = document.getElementById('presup-cards-anual');
    
    // Card 1: GCI Total
    const card1 = `
        <div style="background: rgba(76,175,80,0.1); border: 2px solid #4caf50; padding: 20px; border-radius: 15px; text-align: center;">
            <div style="font-size: 0.85em; opacity: 0.8; margin-bottom: 10px;">ğŸ’° GCI Total Anual</div>
            <div style="font-size: 2em; font-weight: 900; color: #4caf50;">${analisis.totalGCI.toLocaleString('es-ES', {minimumFractionDigits: 2})} â‚¬</div>
        </div>
    `;
    
    // Card 2: Beneficio Neto
    const indicadorBenef = analisis.cumple && analisis.pctBeneficio >= 35 && analisis.pctBeneficio <= 45 ? 'âœ…' : 'âš ï¸';
    const colorBenef = analisis.pctBeneficio >= 35 && analisis.pctBeneficio <= 45 ? '#4caf50' : '#ff9800';
    const card2 = `
        <div style="background: rgba(76,175,80,0.1); border: 2px solid ${colorBenef}; padding: 20px; border-radius: 15px; text-align: center;">
            <div style="font-size: 0.85em; opacity: 0.8; margin-bottom: 10px;">ğŸ’ Beneficio Neto</div>
            <div style="font-size: 2em; font-weight: 900; color: ${colorBenef};">${analisis.totalBeneficio.toLocaleString('es-ES', {minimumFractionDigits: 2})} â‚¬</div>
            <div style="font-size: 0.9em; margin-top: 8px; color: ${colorBenef};">${analisis.pctBeneficio.toFixed(1)}% ${indicadorBenef}</div>
        </div>
    `;
    
    // Card 3: Gastos Ventas
    const indicadorVentas = analisis.pctVentas >= 25 && analisis.pctVentas <= 35 ? 'âœ…' : 'âš ï¸';
    const colorVentas = analisis.pctVentas >= 25 && analisis.pctVentas <= 35 ? '#ff9800' : '#f44336';
    const card3 = `
        <div style="background: rgba(255,152,0,0.1); border: 2px solid ${colorVentas}; padding: 20px; border-radius: 15px; text-align: center;">
            <div style="font-size: 0.85em; opacity: 0.8; margin-bottom: 10px;">ğŸ’¼ Gastos Ventas</div>
            <div style="font-size: 2em; font-weight: 900; color: ${colorVentas};">${analisis.totalGastosVentas.toLocaleString('es-ES', {minimumFractionDigits: 2})} â‚¬</div>
            <div style="font-size: 0.9em; margin-top: 8px; color: ${colorVentas};">${analisis.pctVentas.toFixed(1)}% ${indicadorVentas}</div>
        </div>
    `;
    
    // Card 4: Gastos Operativos
    const indicadorOper = analisis.pctOperativos >= 25 && analisis.pctOperativos <= 35 ? 'âœ…' : 'âš ï¸';
    const colorOper = analisis.pctOperativos >= 25 && analisis.pctOperativos <= 35 ? '#f44336' : '#d32f2f';
    const card4 = `
        <div style="background: rgba(244,67,54,0.1); border: 2px solid ${colorOper}; padding: 20px; border-radius: 15px; text-align: center;">
            <div style="font-size: 0.85em; opacity: 0.8; margin-bottom: 10px;">ğŸ¢ Gastos Operativos</div>
            <div style="font-size: 2em; font-weight: 900; color: ${colorOper};">${analisis.totalGastosOperativos.toLocaleString('es-ES', {minimumFractionDigits: 2})} â‚¬</div>
            <div style="font-size: 0.9em; margin-top: 8px; color: ${colorOper};">${analisis.pctOperativos.toFixed(1)}% ${indicadorOper}</div>
        </div>
    `;
    
    container.innerHTML = card1 + card2 + card3 + card4;
    
    // Mensaje cumplimiento anual
    const mensajeDiv = document.getElementById('presup-mensaje-cumplimiento');
    if (analisis.cumple) {
        mensajeDiv.innerHTML = 'âœ… Â¡Felicidades! El modelo 40-30-30 se cumple a nivel anual.';
        mensajeDiv.style.background = 'rgba(76,175,80,0.2)';
        mensajeDiv.style.color = '#4caf50';
        mensajeDiv.style.border = '2px solid #4caf50';
    } else {
        mensajeDiv.innerHTML = 'âš ï¸ Advertencia: El modelo 40-30-30 NO se cumple a nivel anual. Revisa los meses con desviaciones.';
        mensajeDiv.style.background = 'rgba(255,152,0,0.2)';
        mensajeDiv.style.color = '#ff9800';
        mensajeDiv.style.border = '2px solid #ff9800';
    }
}

/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * FUNCIÃ“N 3: renderizarGraficosPresupuesto (NUEVA)
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 */
function renderizarGraficosPresupuesto(datos) {
    // Destruir grÃ¡ficos anteriores si existen
    if (window.chartPresupBarras) window.chartPresupBarras.destroy();
    if (window.chartPresupLineas) window.chartPresupLineas.destroy();
    
    // GRÃFICO 1: BARRAS (GCI vs Gastos)
    const ctxBarras = document.getElementById('chart-presup-barras').getContext('2d');
    window.chartPresupBarras = new Chart(ctxBarras, {
        type: 'bar',
        data: {
            labels: datos.meses,
            datasets: [
                {
                    label: 'GCI',
                    data: datos.gciMensual,
                    backgroundColor: 'rgba(76, 175, 80, 0.7)',
                    borderColor: '#4caf50',
                    borderWidth: 2
                },
                {
                    label: 'Gastos Ventas',
                    data: datos.gastosVentas,
                    backgroundColor: 'rgba(255, 152, 0, 0.7)',
                    borderColor: '#ff9800',
                    borderWidth: 2
                },
                {
                    label: 'Gastos Operativos',
                    data: datos.gastosOperativos,
                    backgroundColor: 'rgba(244, 67, 54, 0.7)',
                    borderColor: '#f44336',
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('es-ES') + ' â‚¬';
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toLocaleString('es-ES', {minimumFractionDigits: 2}) + ' â‚¬';
                        }
                    }
                }
            }
        }
    });
    
    // GRÃFICO 2: LÃNEAS (% DistribuciÃ³n)
    const pctBeneficio = datos.analisisMensual.map(m => m.pctBeneficio);
    const pctVentas = datos.analisisMensual.map(m => m.pctVentas);
    const pctOperativos = datos.analisisMensual.map(m => m.pctOperativos);
    
    const ctxLineas = document.getElementById('chart-presup-lineas').getContext('2d');
    window.chartPresupLineas = new Chart(ctxLineas, {
        type: 'line',
        data: {
            labels: datos.meses,
            datasets: [
                {
                    label: '% Beneficio (Meta: 40%)',
                    data: pctBeneficio,
                    borderColor: '#4caf50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    tension: 0.4,
                    borderWidth: 3
                },
                {
                    label: '% Ventas (Meta: 30%)',
                    data: pctVentas,
                    borderColor: '#ff9800',
                    backgroundColor: 'rgba(255, 152, 0, 0.1)',
                    tension: 0.4,
                    borderWidth: 3
                },
                {
                    label: '% Operativos (Meta: 30%)',
                    data: pctOperativos,
                    borderColor: '#f44336',
                    backgroundColor: 'rgba(244, 67, 54, 0.1)',
                    tension: 0.4,
                    borderWidth: 3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                        }
                    }
                },
                annotation: {
                    annotations: {
                        line40: {
                            type: 'line',
                            yMin: 40,
                            yMax: 40,
                            borderColor: 'rgba(76, 175, 80, 0.5)',
                            borderWidth: 2,
                            borderDash: [5, 5]
                        },
                        line30a: {
                            type: 'line',
                            yMin: 30,
                            yMax: 30,
                            borderColor: 'rgba(255, 152, 0, 0.5)',
                            borderWidth: 2,
                            borderDash: [5, 5]
                        },
                        line30b: {
                            type: 'line',
                            yMin: 30,
                            yMax: 30,
                            borderColor: 'rgba(244, 67, 54, 0.5)',
                            borderWidth: 2,
                            borderDash: [5, 5]
                        }
                    }
                }
            }
        }
    });
}

/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * FUNCIÃ“N 4: renderizarTablaPresupuesto (NUEVA)
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 */
function renderizarTablaPresupuesto(datos) {
    const tbody = document.getElementById('presup-tabla-body');
    let html = '';
    
    datos.analisisMensual.forEach((mes, idx) => {
        const bgColor = mes.cumple ? 'rgba(76,175,80,0.1)' : 'rgba(244,67,54,0.1)';
        const cumpleIcon = mes.cumple ? 'âœ…' : 'âŒ';
        
        html += `
            <tr style="background: ${bgColor};">
                <td style="font-weight: 700;">${datos.meses[idx]}</td>
                <td>${mes.gci.toLocaleString('es-ES', {minimumFractionDigits: 2})}</td>
                <td>${mes.gastosVentas.toLocaleString('es-ES', {minimumFractionDigits: 2})}</td>
                <td>${mes.gastosOperativos.toLocaleString('es-ES', {minimumFractionDigits: 2})}</td>
                <td style="font-weight: 700; color: ${mes.beneficio >= 0 ? '#4caf50' : '#f44336'};">
                    ${mes.beneficio.toLocaleString('es-ES', {minimumFractionDigits: 2})}
                </td>
                <td>${mes.pctBeneficio.toFixed(1)}%</td>
                <td>${mes.pctVentas.toFixed(1)}%</td>
                <td>${mes.pctOperativos.toFixed(1)}%</td>
                <td style="text-align: center; font-size: 1.3em;">${cumpleIcon}</td>
                <td style="text-align: center;">
                    ${mes.gci > 0 ? 
                        `<button class="btn" style="padding: 5px 10px; font-size: 0.8em;" onclick="mostrarDetalleGastosMes(${idx}, '${datos.meses[idx]}')">Ver Detalle</button>` 
                        : '-'}
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * FUNCIÃ“N 5: mostrarDetalleGastosMes (NUEVA)
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 */
function mostrarDetalleGastosMes(mesIndex, nombreMes) {
    // Abrir modal secundario
    document.getElementById('modal-detalle-gasto-mes').classList.add('active');
    document.getElementById('detalle-mes-titulo').textContent = `Detalle de Gastos - ${nombreMes}`;
    
    // Obtener datos del mes (ya estÃ¡n cargados globalmente)
    const year = new Date().getFullYear();
    
    google.script.run
        .withSuccessHandler(datos => {
            const mesData = datos.analisisMensual[mesIndex];
            
            // Renderizar Gastos de Ventas
            let htmlVentas = '';
            let subtotalVentas = 0;
            mesData.detallesVentas.forEach(d => {
                htmlVentas += `
                    <tr>
                        <td>${d.fecha}</td>
                        <td>${d.concepto}</td>
                        <td>${d.desc}</td>
                        <td style="text-align: right; font-weight: 700;">${d.importe.toLocaleString('es-ES', {minimumFractionDigits: 2})} â‚¬</td>
                    </tr>
                `;
                subtotalVentas += d.importe;
            });
            document.getElementById('detalle-ventas-body').innerHTML = htmlVentas || '<tr><td colspan="4" style="text-align: center; opacity: 0.5;">Sin datos</td></tr>';
            document.getElementById('detalle-ventas-subtotal').textContent = subtotalVentas.toLocaleString('es-ES', {minimumFractionDigits: 2}) + ' â‚¬';
            
            // Renderizar Gastos Operativos
            let htmlOper = '';
            let subtotalOper = 0;
            mesData.detallesOperativos.forEach(d => {
                htmlOper += `
                    <tr>
                        <td>${d.fecha}</td>
                        <td>${d.concepto}</td>
                        <td>${d.desc}</td>
                        <td style="text-align: right; font-weight: 700;">${d.importe.toLocaleString('es-ES', {minimumFractionDigits: 2})} â‚¬</td>
                    </tr>
                `;
                subtotalOper += d.importe;
            });
            document.getElementById('detalle-operativos-body').innerHTML = htmlOper || '<tr><td colspan="4" style="text-align: center; opacity: 0.5;">Sin datos</td></tr>';
            document.getElementById('detalle-operativos-subtotal').textContent = subtotalOper.toLocaleString('es-ES', {minimumFractionDigits: 2}) + ' â‚¬';
            
            // Total General
            const totalGeneral = subtotalVentas + subtotalOper;
            document.getElementById('detalle-total-general').textContent = totalGeneral.toLocaleString('es-ES', {minimumFractionDigits: 2}) + ' â‚¬';
        })
        .withFailureHandler(err => {
            mostrarNotificacion('Error al cargar detalles: ' + err.message, 'error');
        })
        .obtenerDatosPresupuestarios(year);
}

function mostrarModalGestionAgentes() {
    document.getElementById('modal-gestion-agentes').classList.add('active');
    document.body.classList.add('modal-open');
    
    // Cargar dashboard por defecto
    cambiarTabAgentes('dashboard');
}

/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * FUNCIÃ“N 2: cambiarTabAgentes
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Cambia entre los 3 tabs: dashboard, crear, listado
 */
  function cambiarTabAgentes(tab) {
    // Ocultar todos los contenidos
    document.getElementById('tab-content-dashboard').style.display = 'none';
    document.getElementById('tab-content-crear').style.display = 'none';
    document.getElementById('tab-content-listado').style.display = 'none';
    
    // Desactivar todos los botones
    document.getElementById('tab-btn-dashboard').classList.remove('active');
    document.getElementById('tab-btn-crear').classList.remove('active');
    document.getElementById('tab-btn-listado').classList.remove('active');
    
    // Activar el tab seleccionado
    switch(tab) {
        case 'dashboard':
            document.getElementById('tab-content-dashboard').style.display = 'block';
            document.getElementById('tab-btn-dashboard').classList.add('active');
            cargarDashboardAgentes();
            break;
        case 'crear':
            document.getElementById('tab-content-crear').style.display = 'block';
            document.getElementById('tab-btn-crear').classList.add('active');
            // Pre-llenar fecha de hoy
            document.getElementById('crear-fecha-ingreso').valueAsDate = new Date();
            break;
        case 'listado':
            document.getElementById('tab-content-listado').style.display = 'block';
            document.getElementById('tab-btn-listado').classList.add('active');
            cargarListadoAgentes();
            break;
    }
}

/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * FUNCIÃ“N 3: cargarDashboardAgentes
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Carga los datos del dashboard (KPIs + grÃ¡fico + tabla)
 */
function cargarDashboardAgentes() {
    mostrarNotificacion('Cargando dashboard de agentes...', 'success');
    
    google.script.run
        .withSuccessHandler(datos => {
            if (!datos) {
                mostrarNotificacion('No hay datos disponibles', 'error');
                return;
            }
            
            // Renderizar resumen (4 KPIs)
            document.getElementById('dashboard-total-agentes').textContent = datos.resumen.totalAgentes;
            document.getElementById('dashboard-gci-total').textContent = datos.resumen.totalGCI.toLocaleString('es-ES', {minimumFractionDigits: 2}) + ' â‚¬';
            document.getElementById('dashboard-transacciones-total').textContent = datos.resumen.totalTransacciones;
            document.getElementById('dashboard-ticket-promedio').textContent = datos.resumen.ticketPromedio.toLocaleString('es-ES', {minimumFractionDigits: 2}) + ' â‚¬';
            
            // Renderizar grÃ¡fico de altas
            renderizarGraficoAltasAgentes(datos.graficoAltas);
            
            // Renderizar tabla de rendimiento
            renderizarTablaRendimientoAgentes(datos.agentes);
            
            mostrarNotificacion('Dashboard cargado correctamente', 'success');
        })
        .withFailureHandler(err => {
            mostrarNotificacion('Error al cargar dashboard: ' + err.message, 'error');
        })
        .obtenerDashboardGestionAgentes();
}

/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * FUNCIÃ“N 4: renderizarGraficoAltasAgentes
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Crea el grÃ¡fico de barras de altas por mes
 */
function renderizarGraficoAltasAgentes(graficoData) {
    // Destruir grÃ¡fico anterior si existe
    if (window.chartAltasAgentes) {
        window.chartAltasAgentes.destroy();
    }
    
    const ctx = document.getElementById('chart-altas-agentes').getContext('2d');
    
    window.chartAltasAgentes = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: graficoData.labels,
            datasets: [{
                label: 'NÃºmero de Altas',
                data: graficoData.datos,
                backgroundColor: 'rgba(66, 133, 244, 0.7)',
                borderColor: '#4285f4',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        callback: function(value) {
                            return Math.floor(value);
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Altas: ' + context.parsed.y;
                        }
                    }
                }
            }
        }
    });
}

/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * FUNCIÃ“N 5: renderizarTablaRendimientoAgentes
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Renderiza la tabla de rendimiento con 9 columnas
 */
function renderizarTablaRendimientoAgentes(agentes) {
    const tbody = document.getElementById('dashboard-tabla-agentes');
    let html = '';
    
    agentes.forEach(agente => {
        const colorRent = agente.rentabilidad >= 0 ? '#4caf50' : '#f44336';
        
        html += `
            <tr>
                <td style="text-align: left;">
                    <div style="font-weight: 700;">${agente.nombre}</div>
                    <div style="font-size: 0.85em; opacity: 0.7;">${agente.email}</div>
                </td>
                <td>${agente.antiguedad}</td>
                <td>${agente.sueldoFijo.toLocaleString('es-ES', {minimumFractionDigits: 2})} â‚¬</td>
                <td style="font-weight: 700; color: #4caf50;">${agente.gci.toLocaleString('es-ES', {minimumFractionDigits: 2})} â‚¬</td>
                <td>${agente.transacciones}</td>
                <td>${agente.ticketPromedio.toLocaleString('es-ES', {minimumFractionDigits: 2})} â‚¬</td>
                <td>${agente.comisiones.toLocaleString('es-ES', {minimumFractionDigits: 2})} â‚¬</td>
                <td style="font-weight: 700; color: ${colorRent};">
                    ${agente.rentabilidad.toLocaleString('es-ES', {minimumFractionDigits: 2})} â‚¬
                </td>
                <td style="font-weight: 700; color: ${colorRent};">
                    ${agente.pctRentabilidad.toFixed(1)}%
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html || '<tr><td colspan="9" style="text-align: center; opacity: 0.5;">No hay datos disponibles</td></tr>';
}

/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * FUNCIÃ“N 6: cargarListadoAgentes
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Carga TODOS los agentes (activos e inactivos)
 */
function cargarListadoAgentes() {
    mostrarNotificacion('Cargando listado completo...', 'success');
    
    google.script.run
        .withSuccessHandler(agentes => {
            renderizarListadoAgentes(agentes);
        })
        .withFailureHandler(err => {
            mostrarNotificacion('Error al cargar listado: ' + err.message, 'error');
        })
        .obtenerTodosAgentes();
}
function calcularDescuento() {
    var precioCaptacion = parseFloat(document.getElementById('transaccion-precio-captacion').value) || 0;
    var precioVenta = parseFloat(document.getElementById('transaccion-precio-venta').value) || 0;
    var divDescuento = document.getElementById('transaccion-descuento');
    
    if (precioCaptacion > 0 && precioVenta > 0) {
        var descuento = ((precioCaptacion - precioVenta) / precioCaptacion) * 100;
        
        var color = descuento <= 5 ? '#22c55e' : (descuento <= 10 ? '#ffc107' : '#ef4444');
        
        if (descuento < 0) {
            divDescuento.innerHTML = '+' + Math.abs(descuento).toFixed(1) + '% ğŸ“ˆ';
            divDescuento.style.color = '#22c55e';
        } else {
            divDescuento.innerHTML = descuento.toFixed(1) + '%';
            divDescuento.style.color = color;
        }
    } else {
        divDescuento.innerHTML = '-';
        divDescuento.style.color = '#888';
    }
}

/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * FUNCIÃ“N 7: renderizarListadoAgentes
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Renderiza tabla con badges de estado
 */
function renderizarListadoAgentes(agentes) {
    const tbody = document.getElementById('listado-tabla-body');
    let html = '';
    
    agentes.forEach(agente => {
        const badgeColor = agente.estado === 'Activo' ? 
            'background: #e8f5e9; color: #2e7d32; border: 1px solid #4caf50;' : 
            'background: #ffebee; color: #c62828; border: 1px solid #f44336;';
        
        html += `
            <tr>
                <td>${agente.id}</td>
                <td style="font-weight: 700;">${agente.nombre}</td>
                <td>${agente.email}</td>
                <td>${agente.telefono}</td>
                <td>${agente.fechaIngreso}</td>
                <td>${agente.sueldoFijo.toLocaleString('es-ES', {minimumFractionDigits: 2})} â‚¬</td>
                <td>
                    <span style="padding: 4px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 700; ${badgeColor}">
                        ${agente.estado}
                    </span>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html || '<tr><td colspan="7" style="text-align: center; opacity: 0.5;">No hay agentes registrados</td></tr>';
}

/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * FUNCIÃ“N 8: crearNuevoAgente
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Procesa el formulario de creaciÃ³n y vuelve al dashboard
 */
function crearNuevoAgente(event) {
    event.preventDefault();
    
    const datos = {
        nombre: document.getElementById('crear-nombre').value,
        email: document.getElementById('crear-email').value,
        telefono: document.getElementById('crear-telefono').value,
        fechaIngreso: document.getElementById('crear-fecha-ingreso').value,
        sueldoFijo: document.getElementById('crear-sueldo').value,
        objetivosAcumulados: document.getElementById('crear-objetivos').value
    };
    
    mostrarNotificacion('Creando agente...', 'success');
    
    google.script.run
        .withSuccessHandler(respuesta => {
            if (respuesta.success) {
                mostrarNotificacion('âœ… Agente creado: ' + respuesta.agente.nombre, 'success');
                
                // Limpiar formulario
                document.getElementById('form-crear-agente-modal').reset();
                
                // Volver al dashboard
                cambiarTabAgentes('dashboard');
            } else {
                mostrarNotificacion('Error al crear agente', 'error');
            }
        })
        .withFailureHandler(err => {
            mostrarNotificacion('Error: ' + err.message, 'error');
        })
        .crearAgenteCompleto(datos);
}
// =========================================================
// ğŸ“ˆ FIX GRÃFICOS INDIVIDUALES (V10)
// =========================================================

function mostrarGraficoAgente(idAgente, kpiKey) {
    console.log('ğŸ“Š Mostrando grÃ¡fico:', idAgente, kpiKey);
    
    const modalBody = document.getElementById('modal-grafico-body');
    if (!modalBody) {
        console.error('âŒ modal-grafico-body no existe');
        return;
    }
    
    // Mostrar loading
    modalBody.innerHTML = `
        <div class="loading">
            <div class="loader"></div>
            <div>Cargando datos de ${idAgente}...</div>
        </div>
    `;
    
    abrirModalEncima('modal-grafico-secundario');
    
    // Obtener aÃ±o contable
    google.script.run
        .withSuccessHandler(function(aÃ±oContable) {
            // Cargar datos del agente
            google.script.run
                .withSuccessHandler(function(datos) {
                    console.log('âœ… Datos recibidos:', datos);
                    renderizarGraficoModalAgente(datos, kpiKey);
                })
                .withFailureHandler(function(error) {
                    console.error('âŒ Error al cargar datos:', error);
                    modalBody.innerHTML = `<div style="text-align:center; padding:50px; color:red;">Error: ${error.message}</div>`;
                })
                .obtenerDatosAgenteCompleto(idAgente, {
                    fechaInicio: aÃ±oContable + '-01-01',
                    fechaFin: aÃ±oContable + '-12-31'
                });
        })
        .withFailureHandler(function(error) {
            console.error('âŒ Error obteniendo aÃ±o contable:', error);
            // Fallback: usar aÃ±o del sistema
            const aÃ±oSistema = new Date().getFullYear();
            google.script.run
                .withSuccessHandler(function(datos) {
                    renderizarGraficoModalAgente(datos, kpiKey);
                })
                .withFailureHandler(function(error) {
                    modalBody.innerHTML = `<div style="text-align:center; padding:50px; color:red;">Error: ${error.message}</div>`;
                })
                .obtenerDatosAgenteCompleto(idAgente, {
                    fechaInicio: aÃ±oSistema + '-01-01',
                    fechaFin: aÃ±oSistema + '-12-31'
                });
        })
        .obtenerAÃ±oContable();
}

// AsegÃºrate de tener tambiÃ©n esta funciÃ³n actualizada para pintar el grÃ¡fico
function renderizarGraficoModalAgente(datos, kpiKey) {
    const modalBody = document.getElementById('modal-grafico-body');
    
    if (!datos || !datos.evolucionMensual) {
        modalBody.innerHTML = '<div style="text-align:center; padding:50px;">âŒ No hay datos disponibles</div>';
        return;
    }

    const nombreAgente = datos.agente || "Agente";
    const kpiLabel = kpiNames[kpiKey] || kpiKey;
    const labels = datos.evolucionMensual.labels || ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
    const dataReal = datos.evolucionMensual[kpiKey]?.realizado || [];
    const dataObj = datos.evolucionMensual[kpiKey]?.objetivo || [];

    // âœ… HISTÃ“RICO DEL AÃ‘O ANTERIOR (mensual real si estÃ¡ disponible)
    let dataHistorico = new Array(12).fill(0);
    let tieneHistorico = false;
    
    // PRIORIDAD 1: Buscar histÃ³rico mensual real del aÃ±o anterior
    if (window.datosHistoricos2024 && window.datosHistoricos2024[kpiKey]) {
        dataHistorico = window.datosHistoricos2024[kpiKey].realizado || new Array(12).fill(0);
        const suma = dataHistorico.reduce((a, b) => a + b, 0);
        if (suma > 0) {
            tieneHistorico = true;
            console.log('ğŸ“Š Usando histÃ³rico mensual 2024 del equipo');
        }
    }
    
    // FALLBACK: HistÃ³rico individual del agente
    if (!tieneHistorico && historialAgentesCache && historialAgentesCache[datos.id]) {
        const hist = historialAgentesCache[datos.id];
        
        const mapKeys = {
    'gci': 'gci',
    'citasCaptacion': 'citasCapt',
    'exclusivasVenta': 'exclVenta',
    'exclusivasComprador': 'exclComp',
    'captacionesAbierto': 'captAbierto',
    'captacionesAlquiler': 'captAlquiler',
    'citasCompradores': 'citasComp',
    'casasEnsenadas': 'visitas',
    'llamadas': 'llamadas',
    'leadVendedor': 'leadVendedor',
    'leadComprador': 'leadComprador',
    'leadsCompradores': 'leadsCompradores',
    'tresBs': 'tresBs',
    'bajadasPrecio': 'bajadasPrecio',
    'propuestasCompra': 'propuestas',
    'leadSeguimiento': 'leadSeguimiento',
    'arras': 'arras',
    'ventas': 'ventas',
    'totalTransacciones': 'ventas',
    'volumenNegocio': 'volumenNegocio'
};
        
        const histKey = mapKeys[kpiKey];
        
        if (histKey && hist[histKey] !== undefined && hist[histKey] > 0) {
            const valorMensual = hist[histKey] / 12;
            dataHistorico = new Array(12).fill(valorMensual);
            tieneHistorico = true;
            console.log('ğŸ“Š Usando histÃ³rico anual ' + nombreAgente + ': ' + hist[histKey]);
        }
    }

    const totalReal = dataReal.reduce((a, b) => a + b, 0);
    const totalObj = dataObj.reduce((a, b) => a + b, 0);
    const totalHist = dataHistorico.reduce((a, b) => a + b, 0);
    
    // Calcular % cumplimiento
    const pctCumplimiento = totalObj > 0 ? ((totalReal / totalObj) * 100).toFixed(1) : 0;
    const colorCumplimiento = pctCumplimiento >= 90 ? '#22c55e' : pctCumplimiento >= 70 ? '#ffd700' : '#ff6b6b';
    
    // Calcular crecimiento vs aÃ±o anterior
    let htmlCrecimiento = '';
    if (tieneHistorico && totalHist > 0) {
        const diff = totalReal - totalHist;
        const pctCrecimiento = ((diff / totalHist) * 100).toFixed(1);
        const colorCrecimiento = diff >= 0 ? '#22c55e' : '#ff6b6b';
        const icono = diff >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
        
        htmlCrecimiento = `
            <div style="text-align:center; margin-top:10px;">
                <div style="font-size:1.2em; color:${colorCrecimiento}; font-weight:bold;">
                    ${icono} ${pctCrecimiento}% vs AÃ±o Anterior
                </div>
                <div style="font-size:0.9em; color:#888;">
                    (${totalHist.toLocaleString('es-ES', {maximumFractionDigits:0})} aÃ±o anterior)
                </div>
            </div>
        `;
    }
    
    modalBody.innerHTML = `
        <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(255,107,107,0.1)); padding: 25px; border-radius: 15px; margin-bottom: 20px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h2 style="margin:0; color:var(--color-primary); font-size:2em;">${kpiLabel}</h2>
                    <div style="color:#aaa; font-weight:600; font-size:1.2em; margin-top:5px;">ğŸ‘¤ ${nombreAgente}</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:3em; font-weight:900; color:var(--color-accent-good);">
                        ${totalReal.toLocaleString('es-ES', {maximumFractionDigits: 0})}
                    </div>
                    <div style="font-size:1em; color:${colorCumplimiento}; font-weight:bold; margin-top:5px;">
                        ${pctCumplimiento}% del objetivo (${totalObj.toLocaleString('es-ES', {maximumFractionDigits:0})})
                    </div>
                    ${htmlCrecimiento}
                </div>
            </div>
        </div>

        <div class="chart-container" style="height: 500px; width: 100%; background: var(--color-surface); padding: 20px; border-radius: 12px;">
            <canvas id="modal-chart-detalle"></canvas>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px;">
            <div style="background: rgba(0,255,136,0.1); padding: 15px; border-radius: 10px; border-left: 4px solid #22c55e;">
                <div style="font-size: 0.9em; color: #aaa;">REALIZADO 2025</div>
                <div style="font-size: 1.8em; font-weight: 900; color: #22c55e;">${totalReal.toLocaleString('es-ES', {maximumFractionDigits:0})}</div>
            </div>
            <div style="background: rgba(255,215,0,0.1); padding: 15px; border-radius: 10px; border-left: 4px solid #ffd700;">
                <div style="font-size: 0.9em; color: #aaa;">OBJETIVO 2025</div>
                <div style="font-size: 1.8em; font-weight: 900; color: #ffd700;">${totalObj.toLocaleString('es-ES', {maximumFractionDigits:0})}</div>
            </div>
            <div style="background: rgba(102,126,234,0.1); padding: 15px; border-radius: 10px; border-left: 4px solid #667eea;">
                <div style="font-size: 0.9em; color: #aaa;">AÃ‘O ANTERIOR</div>
                <div style="font-size: 1.8em; font-weight: 900; color: #667eea;">${totalHist.toLocaleString('es-ES', {maximumFractionDigits:0})}</div>
            </div>
        </div>
    `;

    setTimeout(() => {
        const ctx = document.getElementById('modal-chart-detalle');
        if (!ctx) return;
        
        if (chartInstances['modal-chart-detalle']) {
            chartInstances['modal-chart-detalle'].destroy();
        }

        const datasets = [
            {
                label: 'âœ… Realizado 2025',
                data: dataReal,
                backgroundColor: 'rgba(0, 255, 136, 0.8)',
                borderColor: '#22c55e',
                borderWidth: 2,
                order: 3,
                barThickness: 'flex',
                maxBarThickness: 40
            }
        ];
        
        // AÃ±adir aÃ±o anterior si hay datos
        if (tieneHistorico) {
            datasets.push({
                label: 'ğŸ“Š AÃ±o Anterior',
                data: dataHistorico,
                backgroundColor: 'rgba(102, 126, 234, 0.6)',
                borderColor: '#667eea',
                borderWidth: 2,
                order: 2,
                barThickness: 'flex',
                maxBarThickness: 40
            });
        }
        
        // AÃ±adir objetivo como lÃ­nea
        datasets.push({
            label: 'ğŸ¯ Objetivo 2025',
            data: dataObj,
            type: 'line',
            borderColor: '#ffd700',
            borderWidth: 3,
            pointRadius: 5,
            pointBackgroundColor: '#ffd700',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            order: 1,
            tension: 0.3
        });

        chartInstances['modal-chart-detalle'] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        grid: { 
                            color: 'rgba(255,255,255,0.05)',
                            lineWidth: 1
                        },
                        ticks: {
                            color: 'var(--color-text-secondary)',
                            font: {
                                size: 12,
                                weight: '600'
                            },
                            callback: function(value) {
                                return value.toLocaleString('es-ES', {maximumFractionDigits:0});
                            }
                        }
                    },
                    x: { 
                        grid: { 
                            display: false 
                        },
                        ticks: {
                            color: 'var(--color-text-primary)',
                            font: {
                                size: 13,
                                weight: 'bold'
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: 'var(--color-text-primary)',
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            padding: 20,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.9)',
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13
                        },
                        padding: 12,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += context.parsed.y.toLocaleString('es-ES', {maximumFractionDigits:0});
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }, 100);
}

function renderizarGraficoModalCompleto(datosCompletos, kpiKey) {
    const modalBody = document.getElementById('modal-analisis-body');
    
    const evolucion = datosCompletos.evolucionMensual[kpiKey];
    
    if (!evolucion) {
        modalBody.innerHTML = '<div class="section">âš ï¸ KPI no disponible</div>';
        return;
    }
    
    const meta = getKpiMetadata(kpiKey, 0);
    const realizado = evolucion.realizado || [];
    const objetivo = evolucion.objetivo || [];
    
    const totalRealizado = realizado.reduce((a, b) => a + b, 0);
    const totalObjetivo = objetivo.reduce((a, b) => a + b, 0);
    const cumplimiento = totalObjetivo > 0 ? ((totalRealizado / totalObjetivo) * 100).toFixed(1) : 0;
    
    // HTML del modal
    modalBody.innerHTML = `
        <div class="section-title">${meta.icon} ${meta.label}</div>
        <div style="text-align:center; font-size:1.2em; opacity:0.8; margin:-10px 0 20px 0;">
            ${datosCompletos.agente.nombre} - ${datosCompletos.year}
        </div>
        
        <div class="chart-container" style="height:450px; background:var(--color-surface); border-radius:15px; padding:20px; margin-bottom:20px;">
            <canvas id="chart-modal-kpi-agente"></canvas>
        </div>
        
        <div style="padding:20px; background:var(--color-surface); border-radius:15px;">
            <h3 style="color:var(--color-secondary); margin-bottom:15px; text-align:center;">ğŸ“Š Resumen Anual</h3>
            <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:20px;">
                <div style="text-align:center; padding:15px; background:rgba(0,255,136,0.1); border-radius:10px;">
                    <div style="font-size:2.5em; color:var(--color-accent-good); font-weight:900;">
                        ${formatearValor(totalRealizado, meta.unidad)}
                    </div>
                    <div style="font-size:1em; opacity:0.8; margin-top:5px;">Realizado</div>
                </div>
                <div style="text-align:center; padding:15px; background:rgba(255,215,0,0.1); border-radius:10px;">
                    <div style="font-size:2.5em; color:var(--color-accent-warn); font-weight:900;">
                        ${formatearValor(totalObjetivo, meta.unidad)}
                    </div>
                    <div style="font-size:1em; opacity:0.8; margin-top:5px;">Objetivo</div>
                </div>
                <div style="text-align:center; padding:15px; background:rgba(183,0,0,0.1); border-radius:10px;">
                    <div style="font-size:2.5em; color:${cumplimiento >= 90 ? 'var(--color-accent-good)' : 'var(--color-primary)'}; font-weight:900;">
                        ${cumplimiento}%
                    </div>
                    <div style="font-size:1em; opacity:0.8; margin-top:5px;">Cumplimiento</div>
                </div>
            </div>
        </div>
    `;
    
    // Crear grÃ¡fico
    setTimeout(() => {
        crearGraficoBarrasModal('chart-modal-kpi-agente', realizado, objetivo, meta);
    }, 100);
}

/**
 * Crea grÃ¡fico de barras con Chart.js
 */
function crearGraficoBarrasModal(canvasId, realizado, objetivo, meta) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    
    // Destruir grÃ¡fico previo
    if (chartInstances[canvasId]) {
        chartInstances[canvasId].destroy();
    }
    
    const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    
    chartInstances[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: meses,
            datasets: [
                {
                    label: 'Realizado',
                    data: realizado,
                    backgroundColor: 'rgba(0,255,136,0.7)',
                    borderColor: 'rgba(0,255,136,1)',
                    borderWidth: 2
                },
                {
                    label: 'Objetivo',
                    data: objetivo,
                    type: 'line',
                    borderColor: 'rgba(255,215,0,1)',
                    backgroundColor: 'rgba(255,215,0,0.2)',
                    borderWidth: 3,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    labels: { 
                        color: 'var(--color-text-primary)',
                        font: { size: 14, weight: 'bold' }
                    }
                },
                title: {
                    display: true,
                    text: meta.label + ' - EvoluciÃ³n Mensual',
                    color: 'var(--color-text-primary)',
                    font: { size: 18, weight: 'bold' }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: 'var(--color-text-secondary)',
                        callback: function(value) {
                            return formatearValor(value, meta.unidad);
                        }
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: {
                    ticks: { color: 'var(--color-text-secondary)', font: { size: 12 } },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
    
    console.log('âœ… GrÃ¡fico creado correctamente');
}
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODELO ECONÃ“MICO AGENTE (MEA) - Panel de ayuda para objetivos
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

var meaData = { 
    gciAnterior: 0, 
    aÃ±oAnterior: new Date().getFullYear() - 1,
    historico: null,
    resultados: null
};

function togglePanelMEA() {
    var contenido = document.getElementById('mea-contenido');
    var icon = document.getElementById('mea-toggle-icon');
    if (contenido.style.display === 'none') {
        contenido.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
    } else {
        contenido.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
    }
}

function toggleEditarHistorico() {
    var inputManual = document.getElementById('mea-input-manual');
    var btnEditar = document.getElementById('mea-btn-editar');
    
    if (inputManual.style.display === 'none') {
        inputManual.style.display = 'block';
        btnEditar.textContent = 'âœ“ Cerrar ediciÃ³n';
        btnEditar.style.background = 'rgba(34,197,94,0.2)';
    } else {
        inputManual.style.display = 'none';
        btnEditar.textContent = 'âœï¸ Editar datos';
        btnEditar.style.background = '';
    }
}

function cargarMEAgente(idAgente) {
    var panel = document.getElementById('panel-mea');
    if (!idAgente) {
        panel.style.display = 'none';
        return;
    }
    
    panel.style.display = 'block';
    document.getElementById('mea-aÃ±o').textContent = meaData.aÃ±oAnterior;
    
    // Ocultar inputs manuales por defecto
    var inputManual = document.getElementById('mea-input-manual');
    if (inputManual) inputManual.style.display = 'none';
    
    var btnEditar = document.getElementById('mea-btn-editar');
    if (btnEditar) {
        btnEditar.textContent = 'âœï¸ Editar datos';
        btnEditar.style.background = '';
    }
    
    google.script.run
        .withSuccessHandler(function(datos) {
            console.log('ğŸ“Š HistÃ³rico agente recibido:', datos);
            
            if (datos && datos.success && datos.totales && datos.totales.gciTotal > 0) {
                document.getElementById('mea-sin-datos').style.display = 'none';
                
                meaData.historico = datos;
                meaData.gciAnterior = datos.totales.gciTotal || 0;
                
                var ventas = datos.ventas || 0;
                var citas = datos.totales.citas || 0;
                var captaciones = datos.captaciones || 0;
                var citasCompradores = datos.totales.citasCompradores || 0;
                var casasEnsenadas = datos.totales.casasEnsenadas || 0;
                
                // Mostrar datos histÃ³ricos
                document.getElementById('mea-h-gci').textContent = fmtMonedaCortaMEA(meaData.gciAnterior);
                document.getElementById('mea-h-ventas').textContent = ventas;
                document.getElementById('mea-h-citas').textContent = citas;
                document.getElementById('mea-h-capt').textContent = captaciones;
                document.getElementById('mea-h-comision').textContent = fmtMonedaCortaMEA(datos.ratios?.comisionMedia || 0);
                document.getElementById('mea-gci-anterior').textContent = fmtMonedaCortaMEA(meaData.gciAnterior);
                
                // Pre-cargar inputs manuales con datos actuales (para ediciÃ³n)
                document.getElementById('mea-manual-gci').value = meaData.gciAnterior;
                document.getElementById('mea-manual-ventas').value = ventas;
                document.getElementById('mea-manual-citas').value = citas;
                document.getElementById('mea-manual-capt').value = captaciones;
                document.getElementById('mea-manual-citas-comp').value = citasCompradores;
                document.getElementById('mea-manual-casas').value = casasEnsenadas;
                
                // Cargar ratios reales del agente
                var comisionMedia = datos.ratios?.comisionMedia || 12000;
                var citaACapt = datos.ratios?.citaACaptacion || 50;
                var captAVenta = datos.ratios?.captacionAVenta || 60;
                
                // Calcular compradores por venta y casas por comprador del histÃ³rico
                var compradoresPorVenta = ventas > 0 ? (citasCompradores / ventas).toFixed(1) : 3;
                var casasPorComprador = citasCompradores > 0 ? (casasEnsenadas / citasCompradores).toFixed(1) : 8;
                
                document.getElementById('mea-comision').value = Math.round(comisionMedia);
                document.getElementById('mea-cita-capt').value = Math.round(citaACapt);
                document.getElementById('mea-capt-venta').value = Math.round(captAVenta);
                document.getElementById('mea-comp-venta').value = compradoresPorVenta;
                document.getElementById('mea-casas-comp').value = casasPorComprador;
                
                // Calcular % vendedor vs comprador del histÃ³rico
                if (datos.totales.gciTotal > 0) {
                    var gciVendedor = (datos.totales.gciExcl || 0) + (datos.totales.gciAbierto || 0);
                    var pctVend = Math.round((gciVendedor / datos.totales.gciTotal) * 100);
                    pctVend = Math.max(0, Math.min(100, pctVend || 60));
                    document.getElementById('mea-pct-vendedor').value = pctVend;
                    document.getElementById('mea-pct-vendedor-val').value = pctVend;
                    document.getElementById('mea-pct-vendedor-label').textContent = pctVend + '% Vendedor / ' + (100 - pctVend) + '% Comprador';
                }
                
                // Sugerir objetivo +20%
                var objetivoSugerido = Math.round(meaData.gciAnterior * 1.2);
                document.getElementById('mea-objetivo-gci').value = objetivoSugerido;
                document.getElementById('mea-slider-incremento').value = 20;
                document.getElementById('mea-incremento-custom').value = 20;
                document.getElementById('mea-incremento-pct').textContent = '+20%';
                
                meaRecalcular();
                
            } else {
                meaSinDatos();
            }
        })
        .withFailureHandler(function(error) {
            console.warn('Error cargando histÃ³rico agente:', error);
            meaSinDatos();
        })
        .obtenerHistoricoAgente(idAgente, meaData.aÃ±oAnterior);
}

function meaSinDatos() {
    meaData.gciAnterior = 0;
    meaData.historico = null;
    
    document.getElementById('mea-h-gci').textContent = '-';
    document.getElementById('mea-h-ventas').textContent = '-';
    document.getElementById('mea-h-citas').textContent = '-';
    document.getElementById('mea-h-capt').textContent = '-';
    document.getElementById('mea-h-comision').textContent = '-';
    document.getElementById('mea-gci-anterior').textContent = '0â‚¬';
    document.getElementById('mea-sin-datos').style.display = 'inline';
    
    // Mostrar inputs manuales automÃ¡ticamente
    var inputManual = document.getElementById('mea-input-manual');
    if (inputManual) inputManual.style.display = 'block';
    
    // Limpiar inputs manuales
    document.getElementById('mea-manual-gci').value = 0;
    document.getElementById('mea-manual-ventas').value = 0;
    document.getElementById('mea-manual-citas').value = 0;
    document.getElementById('mea-manual-capt').value = 0;
    document.getElementById('mea-manual-citas-comp').value = 0;
    document.getElementById('mea-manual-casas').value = 0;
    
    // Valores por defecto
    document.getElementById('mea-comision').value = 12000;
    document.getElementById('mea-cita-capt').value = 50;
    document.getElementById('mea-capt-venta').value = 60;
    document.getElementById('mea-comp-venta').value = 3;
    document.getElementById('mea-casas-comp').value = 8;
    document.getElementById('mea-pct-vendedor').value = 60;
    document.getElementById('mea-pct-vendedor-val').value = 60;
    document.getElementById('mea-pct-vendedor-label').textContent = '60% Vendedor / 40% Comprador';
    document.getElementById('mea-objetivo-gci').value = 0;
    document.getElementById('mea-resultados').style.display = 'none';
}

function meaActualizarDesdeManual() {
    var gciManual = parseFloat(document.getElementById('mea-manual-gci').value) || 0;
    var ventasManual = parseFloat(document.getElementById('mea-manual-ventas').value) || 0;
    var citasManual = parseFloat(document.getElementById('mea-manual-citas').value) || 0;
    var captManual = parseFloat(document.getElementById('mea-manual-capt').value) || 0;
    var citasCompManual = parseFloat(document.getElementById('mea-manual-citas-comp').value) || 0;
    var casasManual = parseFloat(document.getElementById('mea-manual-casas').value) || 0;
    
    meaData.gciAnterior = gciManual;
    
    // Actualizar display
    document.getElementById('mea-h-gci').textContent = fmtMonedaCortaMEA(gciManual);
    document.getElementById('mea-h-ventas').textContent = ventasManual;
    document.getElementById('mea-h-citas').textContent = citasManual;
    document.getElementById('mea-h-capt').textContent = captManual;
    document.getElementById('mea-gci-anterior').textContent = fmtMonedaCortaMEA(gciManual);
    
    // Calcular comisiÃ³n media
    if (ventasManual > 0 && gciManual > 0) {
        var comisionMedia = Math.round(gciManual / ventasManual);
        document.getElementById('mea-h-comision').textContent = fmtMonedaCortaMEA(comisionMedia);
        document.getElementById('mea-comision').value = comisionMedia;
    }
    
    // Calcular ratio cita â†’ captaciÃ³n
    if (citasManual > 0 && captManual > 0) {
        var ratioCitaCapt = Math.round((captManual / citasManual) * 100);
        document.getElementById('mea-cita-capt').value = Math.min(ratioCitaCapt, 100);
    }
    
    // Calcular ratio captaciÃ³n â†’ venta
    if (captManual > 0 && ventasManual > 0) {
        var ratioCaptVenta = Math.round((ventasManual / captManual) * 100);
        document.getElementById('mea-capt-venta').value = Math.min(ratioCaptVenta, 100);
    }
    
    // Calcular compradores por venta
    if (ventasManual > 0 && citasCompManual > 0) {
        var compPorVenta = (citasCompManual / ventasManual).toFixed(1);
        document.getElementById('mea-comp-venta').value = compPorVenta;
    }
    
    // Calcular casas por comprador
    if (citasCompManual > 0 && casasManual > 0) {
        var casasPorComp = (casasManual / citasCompManual).toFixed(1);
        document.getElementById('mea-casas-comp').value = casasPorComp;
    }
    
    // Sugerir objetivo +20%
    if (gciManual > 0) {
        var objetivoSugerido = Math.round(gciManual * 1.2);
        document.getElementById('mea-objetivo-gci').value = objetivoSugerido;
        document.getElementById('mea-slider-incremento').value = 20;
        document.getElementById('mea-incremento-custom').value = 20;
        document.getElementById('mea-incremento-pct').textContent = '+20%';
        
        meaRecalcular();
    }
}

function meaEscenario(pct) {
    document.querySelectorAll('.mea-btn').forEach(function(b) { b.classList.remove('active'); });
    if (event && event.target) event.target.classList.add('active');
    
    document.getElementById('mea-slider-incremento').value = pct;
    document.getElementById('mea-incremento-custom').value = pct;
    document.getElementById('mea-incremento-pct').textContent = (pct >= 0 ? '+' : '') + pct + '%';
    
    if (meaData.gciAnterior > 0) {
        document.getElementById('mea-objetivo-gci').value = Math.round(meaData.gciAnterior * (1 + pct / 100));
    }
    meaRecalcular();
}

function meaAplicarIncrementoCustom() {
    var pct = parseInt(document.getElementById('mea-incremento-custom').value) || 0;
    document.querySelectorAll('.mea-btn').forEach(function(b) { b.classList.remove('active'); });
    
    var sliderVal = Math.max(-30, Math.min(50, pct));
    document.getElementById('mea-slider-incremento').value = sliderVal;
    document.getElementById('mea-incremento-pct').textContent = (pct >= 0 ? '+' : '') + pct + '%';
    
    if (meaData.gciAnterior > 0) {
        document.getElementById('mea-objetivo-gci').value = Math.round(meaData.gciAnterior * (1 + pct / 100));
    }
    meaRecalcular();
}

function meaActualizarDesdeSlider() {
    var pct = parseInt(document.getElementById('mea-slider-incremento').value) || 0;
    document.querySelectorAll('.mea-btn').forEach(function(b) { b.classList.remove('active'); });
    
    document.getElementById('mea-incremento-custom').value = pct;
    document.getElementById('mea-incremento-pct').textContent = (pct >= 0 ? '+' : '') + pct + '%';
    
    if (meaData.gciAnterior > 0) {
        document.getElementById('mea-objetivo-gci').value = Math.round(meaData.gciAnterior * (1 + pct / 100));
    }
    meaRecalcular();
}

// âœ… SLIDER PORCENTAJE VENDEDOR/COMPRADOR - CORREGIDO
// âœ… SLIDER PORCENTAJE VENDEDOR/COMPRADOR - CORREGIDO
function meaActualizarPctVendedor(fuente) {
    var pct;
    
    if (fuente === 'slider') {
        pct = parseInt(document.getElementById('mea-pct-vendedor').value);
    } else {
        pct = parseInt(document.getElementById('mea-pct-vendedor-val').value);
    }
    
    // Asegurar que estÃ¡ en rango vÃ¡lido
    if (isNaN(pct)) pct = 60;
    pct = Math.max(0, Math.min(100, pct));
    
    // Sincronizar ambos controles
    document.getElementById('mea-pct-vendedor').value = pct;
    document.getElementById('mea-pct-vendedor-val').value = pct;
    
    // Actualizar etiqueta
    var pctComprador = 100 - pct;
    document.getElementById('mea-pct-vendedor-label').textContent = pct + '% Vendedor / ' + pctComprador + '% Comprador';
    
    meaRecalcular();
}

function meaRecalcular() {
    var gci = parseFloat(document.getElementById('mea-objetivo-gci').value) || 0;
    var comision = parseFloat(document.getElementById('mea-comision').value) || 12000;
    var citaCapt = parseFloat(document.getElementById('mea-cita-capt').value) || 50;
    var captVenta = parseFloat(document.getElementById('mea-capt-venta').value) || 60;
    var compVenta = parseFloat(document.getElementById('mea-comp-venta').value) || 3;
    var casasComp = parseFloat(document.getElementById('mea-casas-comp').value) || 8;
    var pctVendedor = parseFloat(document.getElementById('mea-pct-vendedor').value) || 60;
    
    if (gci <= 0 || comision <= 0) {
        document.getElementById('mea-resultados').style.display = 'none';
        return;
    }
    
    // CÃ¡lculos
    var ventas = Math.ceil(gci / comision);
    var ventasVend = Math.ceil(ventas * (pctVendedor / 100));
    var ventasComp = ventas - ventasVend;
    var captaciones = captVenta > 0 ? Math.ceil(ventasVend / (captVenta / 100)) : ventasVend;
    var citas = citaCapt > 0 ? Math.ceil(captaciones / (citaCapt / 100)) : captaciones;
    var compradores = Math.ceil(ventasComp * compVenta);
    var casas = Math.ceil(compradores * casasComp);
    
    // Desglose captaciones
    var exclusivasVenta = Math.ceil(captaciones * 0.7);
    var captacionesAbierto = captaciones - exclusivasVenta;
    
    // Mostrar resultados
    document.getElementById('mea-r-ventas').textContent = ventas;
    document.getElementById('mea-r-capt').textContent = captaciones;
    document.getElementById('mea-r-citas').textContent = citas;
    document.getElementById('mea-r-compradores').textContent = compradores;
    document.getElementById('mea-r-casas').textContent = casas;
    
    // Guardar para aplicar
    meaData.resultados = {
        gci: gci,
        ventas: ventas,
        citas: citas,
        captaciones: captaciones,
        exclusivasVenta: exclusivasVenta,
        captacionesAbierto: captacionesAbierto,
        compradores: compradores,
        casas: casas
    };
    
    document.getElementById('mea-resultados').style.display = 'block';
}

function meaAplicar() {
    var r = meaData.resultados;
    if (!r) {
        mostrarNotificacion('Primero calcula el modelo', 'error');
        return;
    }
    
    // Solo KPIs principales con lÃ³gica matemÃ¡tica
    var campos = {
        'obj-gci': r.gci,
        'obj-citasCaptacion': r.citas,
        'obj-exclusivasVenta': r.exclusivasVenta,
        'obj-captacionesAbierto': r.captacionesAbierto,
        'obj-citasCompradores': r.compradores,
        'obj-casasEnsenadas': r.casas
    };
    
    var aplicados = 0;
    for (var id in campos) {
        var input = document.getElementById(id);
        if (input) {
            input.value = Math.round(campos[id]);
            input.style.background = 'rgba(34,197,94,0.2)';
            input.style.transition = 'background 0.3s';
            (function(el) {
                setTimeout(function() { el.style.background = ''; }, 1500);
            })(input);
            aplicados++;
        }
    }
    
    if (aplicados > 0) {
        mostrarNotificacion('âœ¨ ' + aplicados + ' KPIs principales aplicados. Rellena el resto manualmente.', 'success');
        
        // Colapsar el panel
        document.getElementById('mea-contenido').style.display = 'none';
        document.getElementById('mea-toggle-icon').style.transform = 'rotate(0deg)';
    }
}

function fmtMonedaCortaMEA(v) {
    if (v >= 1000000) return (v / 1000000).toFixed(1) + 'Mâ‚¬';
    if (v >= 1000) return Math.round(v / 1000) + 'Kâ‚¬';
    return Math.round(v) + 'â‚¬';
}

/**
 * Formatea valores segÃºn unidad
 */
function formatearValor(valor, unidad) {
    const num = parseFloat(valor);
    if (isNaN(num)) return '0';
    
    if (unidad === 'â‚¬') {
        return Math.round(num).toLocaleString('es-ES') + 'â‚¬';
    } else if (unidad === '%') {
        return num.toFixed(1) + '%';
    } else {
        return Math.round(num).toLocaleString('es-ES');
    }
}
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CUADRE DE OBJETIVOS - Oficina vs Agentes
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function cargarCuadreObjetivos() {
    // Obtener objetivos de oficina del formulario actual
    const getVal = (id) => parseFloat(document.getElementById(id)?.value) || 0;
    
    const objetivosOficina = {
        gci: getVal('me-obj-gci'),
        citasCaptacion: getVal('me-obj-citas-capt'),
        exclusivasVenta: getVal('me-obj-excl-venta'),
        captacionesAbierto: getVal('me-obj-capt-abierto'),
        citasCompradores: getVal('me-obj-citas-comp'),
        casasEnsenadas: getVal('me-obj-casas'),
        exclusivasComprador: getVal('me-obj-excl-comp'),
        llamadas: getVal('me-obj-llamadas'),
        volumenNegocio: getVal('me-obj-volumen'),
        captacionesAlquiler: getVal('me-obj-capt-alq'),
        leadVendedor: getVal('me-obj-lead-vend'),
        tresBs: getVal('me-obj-3bs'),
        bajadasPrecio: getVal('me-obj-bajadas'),
        leadComprador: getVal('me-obj-lead-comp'),
        propuestasCompra: getVal('me-obj-propuestas'),
        leadSeguimiento: getVal('me-obj-lead-seg'),
        arras: getVal('me-obj-arras'),
        ventas: getVal('me-obj-ventas')
    };
    
    // Cargar suma de agentes desde el servidor
    google.script.run
        .withSuccessHandler(function(sumaAgentes) {
            renderizarTablaCuadre(objetivosOficina, sumaAgentes);
        })
        .withFailureHandler(function(error) {
            console.error('Error cargando suma agentes:', error);
            mostrarNotificacion('Error cargando datos de agentes', 'error');
        })
        .obtenerSumaObjetivosAgentes();
}

function renderizarTablaCuadre(oficina, agentes) {
    const tbody = document.getElementById('me-cuadre-tbody');
    
    const kpis = [
        { key: 'gci', label: 'ğŸ’° GCI', format: 'moneda' },
        { key: 'citasCaptacion', label: 'ğŸ“ Citas CaptaciÃ³n', format: 'numero' },
        { key: 'exclusivasVenta', label: 'ğŸ  Exclusivas Venta', format: 'numero' },
        { key: 'captacionesAbierto', label: 'ğŸ˜ï¸ Capt. Abierto', format: 'numero' },
        { key: 'citasCompradores', label: 'ğŸ‘¥ Citas Compradores', format: 'numero' },
        { key: 'casasEnsenadas', label: 'ğŸ¡ Casas EnseÃ±adas', format: 'numero' },
        { key: 'exclusivasComprador', label: 'ğŸ”‘ Excl. Comprador', format: 'numero' },
        { key: 'llamadas', label: 'ğŸ“ Llamadas', format: 'numero' },
        { key: 'volumenNegocio', label: 'ğŸ’¼ Volumen Negocio', format: 'moneda' },
        { key: 'ventas', label: 'ğŸ¤ Ventas', format: 'numero' }
    ];
    
    let html = '';
    let totalOficina = 0;
    let totalAgentes = 0;
    
    kpis.forEach(kpi => {
        const valOficina = oficina[kpi.key] || 0;
        const valAgentes = agentes[kpi.key] || 0;
        const diff = valOficina - valAgentes;
        
        if (kpi.key === 'gci') {
            totalOficina = valOficina;
            totalAgentes = valAgentes;
        }
        
        const formatVal = (v) => {
            if (kpi.format === 'moneda') return Math.round(v).toLocaleString('es-ES') + 'â‚¬';
            return Math.round(v).toLocaleString('es-ES');
        };
        
        let estado = '';
        let colorDiff = '#888';
        
        if (valOficina === 0 && valAgentes === 0) {
            estado = '<span style="color:#888;">â€”</span>';
        } else if (Math.abs(diff) < 1) {
            estado = '<span style="color:#22c55e;">âœ… Cuadrado</span>';
            colorDiff = '#22c55e';
        } else if (diff > 0) {
            estado = '<span style="color:#f59e0b;">âš ï¸ Agentes bajo</span>';
            colorDiff = '#f59e0b';
        } else {
            estado = '<span style="color:#3b82f6;">â„¹ï¸ Agentes sobre</span>';
            colorDiff = '#3b82f6';
        }
        
        html += `
            <tr>
                <td style="padding: 8px; border-bottom: 1px solid var(--color-border);">${kpi.label}</td>
                <td style="padding: 8px; text-align: right; border-bottom: 1px solid var(--color-border);">${formatVal(valOficina)}</td>
                <td style="padding: 8px; text-align: right; border-bottom: 1px solid var(--color-border);">${formatVal(valAgentes)}</td>
                <td style="padding: 8px; text-align: right; border-bottom: 1px solid var(--color-border); color: ${colorDiff}; font-weight: 600;">
                    ${diff >= 0 ? '+' : ''}${formatVal(diff)}
                </td>
                <td style="padding: 8px; text-align: center; border-bottom: 1px solid var(--color-border);">${estado}</td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
    
    // Actualizar resumen
    const diffTotal = totalOficina - totalAgentes;
    document.getElementById('cuadre-gci-oficina').textContent = Math.round(totalOficina).toLocaleString('es-ES') + 'â‚¬';
    document.getElementById('cuadre-gci-agentes').textContent = Math.round(totalAgentes).toLocaleString('es-ES') + 'â‚¬';
    document.getElementById('cuadre-gci-diff').textContent = (diffTotal >= 0 ? '+' : '') + Math.round(diffTotal).toLocaleString('es-ES') + 'â‚¬';
    document.getElementById('cuadre-gci-diff').style.color = Math.abs(diffTotal) < 1 ? '#22c55e' : (diffTotal > 0 ? '#f59e0b' : '#3b82f6');
}

function igualarAgentesAOficina() {
    mostrarNotificacion('Esta funciÃ³n distribuirÃ¡ los objetivos de oficina entre los agentes. Â¿Implementar?', 'info');
    // TODO: Implementar distribuciÃ³n proporcional
}

function igualarOficinaAAgentes() {
    // Copiar suma de agentes a los campos de oficina
    google.script.run
        .withSuccessHandler(function(suma) {
            if (suma.gci) document.getElementById('me-obj-gci').value = suma.gci;
            if (suma.citasCaptacion) document.getElementById('me-obj-citas-capt').value = suma.citasCaptacion;
            if (suma.exclusivasVenta) document.getElementById('me-obj-excl-venta').value = suma.exclusivasVenta;
            if (suma.captacionesAbierto) document.getElementById('me-obj-capt-abierto').value = suma.captacionesAbierto;
            if (suma.citasCompradores) document.getElementById('me-obj-citas-comp').value = suma.citasCompradores;
            if (suma.casasEnsenadas) document.getElementById('me-obj-casas').value = suma.casasEnsenadas;
            if (suma.exclusivasComprador) document.getElementById('me-obj-excl-comp').value = suma.exclusivasComprador;
            if (suma.llamadas) document.getElementById('me-obj-llamadas').value = suma.llamadas;
            if (suma.volumenNegocio) document.getElementById('me-obj-volumen').value = suma.volumenNegocio;
            if (suma.ventas) document.getElementById('me-obj-ventas').value = suma.ventas;
            
            mostrarNotificacion('âœ… Objetivos de oficina igualados a suma de agentes', 'success');
            cargarCuadreObjetivos();
        })
        .obtenerSumaObjetivosAgentes();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¯ FUNCIÃ“N 2: MODAL DE HISTÃ“RICO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * Abre el modal de carga de histÃ³rico
 */
function mostrarModalCargaHistorico() {
    console.log('ğŸ“œ Abriendo modal de histÃ³rico');
    
    // Cerrar Centro de Acciones
    cerrarModalSuperior('modal-acciones');
    
    // Abrir modal histÃ³rico
    const modal = document.getElementById('modal-carga-historico');
    if (!modal) {
        console.error('âŒ Modal no encontrado: modal-carga-historico');
        alert('âŒ Error: Modal de histÃ³rico no encontrado en el HTML');
        return;
    }
    
    modal.classList.add('active');
    document.body.classList.add('modal-open');
    
    // Cargar agentes
    cargarSelectAgentesHistorico();
    
    // Modo ANUAL por defecto
    setModoHistorico('ANUAL');
}

/**
 * Carga lista de agentes en el selector
 */
function cargarSelectAgentesHistorico() {
    const select = document.getElementById('hist-agente-select');  // âœ… ID CORRECTO
    if (!select) {
        console.error('âŒ Select hist-agente-select no encontrado');
        return;
    }
    
    select.innerHTML = '<option value="">Cargando agentes...</option>';
    select.disabled = true;
    
    google.script.run
        .withSuccessHandler(function(agentes) {
            select.disabled = false;
            
            if (!agentes || agentes.length === 0) {
                select.innerHTML = '<option value="">âŒ No hay agentes</option>';
                return;
            }
            
            select.innerHTML = '<option value="">-- Selecciona un agente --</option>';
            
            agentes.forEach(agente => {
                const option = document.createElement('option');
                option.value = agente[0]; // âœ… ID es Ã­ndice 0
                option.textContent = agente[1]; // âœ… Nombre es Ã­ndice 1
                select.appendChild(option);
            });
            
            console.log(`âœ… ${agentes.length} agentes cargados en histÃ³rico`);
        })
        .withFailureHandler(function(error) {
            select.disabled = false;
            select.innerHTML = '<option value="">âŒ Error al cargar</option>';
            console.error('Error cargando agentes en histÃ³rico:', error);
        })
        .obtenerListaAgentes();
}

/**
 * Cambia entre modo ANUAL y MENSUAL
 */
function setModoHistorico(modo) {
    console.log('ğŸ”„ Modo:', modo);
    
    const panelAnual = document.getElementById('hist-panel-anual');
    const panelMensual = document.getElementById('hist-panel-mensual');
    const btnAnual = document.getElementById('btn-hist-anual');
    const btnMensual = document.getElementById('btn-hist-mensual');
    
    if (!panelAnual || !panelMensual) {
        console.error('âŒ Paneles no encontrados');
        return;
    }
    
    if (modo === 'ANUAL') {
        panelAnual.style.display = 'block';
        panelMensual.style.display = 'none';
        
        btnAnual.style.background = 'var(--color-primary)';
        btnAnual.style.opacity = '1';
        btnMensual.style.background = 'transparent';
        btnMensual.style.opacity = '0.6';
    } else {
        panelAnual.style.display = 'none';
        panelMensual.style.display = 'block';
        
        btnMensual.style.background = 'var(--color-primary)';
        btnMensual.style.opacity = '1';
        btnAnual.style.background = 'transparent';
        btnAnual.style.opacity = '0.6';
        
        generarTablaMensual();
    }
}

/**
 * Genera tabla de 12 meses
 */
function generarTablaMensual() {
    const tbody = document.getElementById('hist-tabla-body');
    if (!tbody) return;
    
    // Solo generar si estÃ¡ vacÃ­a
    if (tbody.children.length > 0) return;
    
    const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                   'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    
    let html = '';
    meses.forEach((mes, idx) => {
        const m = idx + 1;
        html += `
        <tr>
            <td style="font-weight:bold; text-align:left;">${mes}</td>
            <td><input type="number" id="hm-gci-${m}" class="form-input" style="width:100px; padding:8px;" value="0"></td>
            <td><input type="number" id="hm-ventas-${m}" class="form-input" style="width:70px; padding:8px;" value="0"></td>
            <td><input type="number" id="hm-citasCapt-${m}" class="form-input" style="width:70px; padding:8px;" value="0"></td>
            <td><input type="number" id="hm-exclVenta-${m}" class="form-input" style="width:70px; padding:8px;" value="0"></td>
            <td><input type="number" id="hm-captAbierto-${m}" class="form-input" style="width:70px; padding:8px;" value="0"></td>
            <td><input type="number" id="hm-citasComp-${m}" class="form-input" style="width:70px; padding:8px;" value="0"></td>
            <td><input type="number" id="hm-exclComp-${m}" class="form-input" style="width:70px; padding:8px;" value="0"></td>
            <td><input type="number" id="hm-visitas-${m}" class="form-input" style="width:70px; padding:8px;" value="0"></td>
        </tr>
        `;
    });
    
    tbody.innerHTML = html;
    console.log('âœ… Tabla mensual generada');
}


function guardarHistoricoAgenteHTML() {
    console.log('ğŸ’¾ Iniciando guardado...');
    
    const selectAgente = document.getElementById('hist-agente-select');
    const selectAnio = document.getElementById('hist-anio');
    
    if (!selectAgente || !selectAnio) {
        mostrarNotificacion('âŒ Formulario incompleto', 'error');
        return;
    }
    
    const idAgente = selectAgente.value;
    const anio = parseInt(selectAnio.value);
    
    if (!idAgente) {
        mostrarNotificacion('âš ï¸ Selecciona un agente', 'error');
        return;
    }
    
    const panelAnual = document.getElementById('hist-panel-anual');
    const modo = panelAnual.style.display !== 'none' ? 'ANUAL' : 'MENSUAL';
    
    let datosGuardar = {
        idAgente: idAgente,
        anio: anio,
        modo: modo
    };
    
    if (modo === 'ANUAL') {
        datosGuardar.totales = {
            // PRINCIPALES
            gci: parseFloat(document.getElementById('ha-gci')?.value) || 0,
            ventas: parseInt(document.getElementById('ha-ventas')?.value) || 0,
            volumenNegocio: parseFloat(document.getElementById('ha-volumen')?.value) || 0,
            
            // CAPTACIÃ“N
            citasCapt: parseInt(document.getElementById('ha-citasCapt')?.value) || 0,
            exclVenta: parseInt(document.getElementById('ha-exclVenta')?.value) || 0,
            captAbierto: parseInt(document.getElementById('ha-captAbierto')?.value) || 0,
            captAlquiler: parseInt(document.getElementById('ha-captAlq')?.value) || 0,
            leadVendedor: parseInt(document.getElementById('ha-leadVendedor')?.value) || 0,
            tresBs: parseInt(document.getElementById('ha-3bs')?.value) || 0,
            bajadasPrecio: parseInt(document.getElementById('ha-bajadas')?.value) || 0,
            llamadas: parseInt(document.getElementById('ha-llamadas')?.value) || 0,
            
            // COMPRADOR
            citasComp: parseInt(document.getElementById('ha-citasComp')?.value) || 0,
            exclComp: parseInt(document.getElementById('ha-exclComp')?.value) || 0,
            visitas: parseInt(document.getElementById('ha-visitas')?.value) || 0,
            leadComprador: parseInt(document.getElementById('ha-leadComprador')?.value) || 0,
            leadsCompradores: parseInt(document.getElementById('ha-leadsCompradores')?.value) || 0,
            propuestas: parseInt(document.getElementById('ha-propuestas')?.value) || 0,
            leadSeguimiento: parseInt(document.getElementById('ha-leadSeguimiento')?.value) || 0,
            
            // CIERRE
            arras: parseInt(document.getElementById('ha-arras')?.value) || 0
        };
    } else {
        // ... modo mensual (tambiÃ©n necesitarÃ­a actualizarse)
        datosGuardar.mensual = [];
        for (let mes = 1; mes <= 12; mes++) {
            datosGuardar.mensual.push({
                mes: mes,
                gci: parseFloat(document.getElementById(`hm-gci-${mes}`)?.value) || 0,
                ventas: parseInt(document.getElementById(`hm-ventas-${mes}`)?.value) || 0,
                citasCapt: parseInt(document.getElementById(`hm-citasCapt-${mes}`)?.value) || 0,
                exclVenta: parseInt(document.getElementById(`hm-exclVenta-${mes}`)?.value) || 0,
                captAbierto: parseInt(document.getElementById(`hm-captAbierto-${mes}`)?.value) || 0,
                captAlquiler: parseInt(document.getElementById(`hm-captAlq-${mes}`)?.value) || 0,
                leadVendedor: parseInt(document.getElementById(`hm-leadVendedor-${mes}`)?.value) || 0,
                tresBs: parseInt(document.getElementById(`hm-3bs-${mes}`)?.value) || 0,
                bajadasPrecio: parseInt(document.getElementById(`hm-bajadas-${mes}`)?.value) || 0,
                llamadas: parseInt(document.getElementById(`hm-llamadas-${mes}`)?.value) || 0,
                citasComp: parseInt(document.getElementById(`hm-citasComp-${mes}`)?.value) || 0,
                exclComp: parseInt(document.getElementById(`hm-exclComp-${mes}`)?.value) || 0,
                visitas: parseInt(document.getElementById(`hm-visitas-${mes}`)?.value) || 0,
                leadComprador: parseInt(document.getElementById(`hm-leadComprador-${mes}`)?.value) || 0,
                leadsCompradores: parseInt(document.getElementById(`hm-leadsCompradores-${mes}`)?.value) || 0,
                propuestas: parseInt(document.getElementById(`hm-propuestas-${mes}`)?.value) || 0,
                leadSeguimiento: parseInt(document.getElementById(`hm-leadSeguimiento-${mes}`)?.value) || 0,
                arras: parseInt(document.getElementById(`hm-arras-${mes}`)?.value) || 0
            });
        }
    }
    
    console.log('ğŸ“¦ Enviando:', datosGuardar);
    
    google.script.run
        .withSuccessHandler(function(resultado) {
            if (resultado.success) {
                mostrarNotificacion('âœ… ' + resultado.message, 'success');
                cerrarModalSuperior('modal-carga-historico');
                if (!historialAgentesCache) historialAgentesCache = {};
                historialAgentesCache[idAgente] = datosGuardar.totales || {};
            } else {
                mostrarNotificacion('âŒ ' + resultado.message, 'error');
            }
        })
        .withFailureHandler(function(error) {
            console.error('âŒ Error:', error);
            mostrarNotificacion('âŒ Error: ' + error.message, 'error');
        })
        .guardarHistoricoAgenteHTML(datosGuardar);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¯ FUNCIÃ“N 3: NOTIFICACIONES (Toast)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * Muestra notificaciÃ³n tipo toast
 */
function mostrarNotificacion(mensaje, tipo = 'info') {
    let notif = document.getElementById('app-notification');
    
    if (!notif) {
        // Crear elemento si no existe
        notif = document.createElement('div');
        notif.id = 'app-notification';
        document.body.appendChild(notif);
    }
    
    notif.textContent = mensaje;
    notif.className = tipo; // 'success', 'error', 'info'
    
    notif.classList.add('show');
    
    setTimeout(() => {
        notif.classList.remove('show');
    }, 3000);
}
function crearGraficoProductividad() {
    const canvasId = 'chart-productividad';
    const canvas = document.getElementById(canvasId);
    
    if (!canvas) return;
    if (!datosGlobales || datosGlobales.length === 0) {
        canvas.parentElement.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">Esperando datos...</div>';
        return;
    }

    if (window.chartProductividadInstance instanceof Chart) {
        window.chartProductividadInstance.destroy();
    }

    // Ordenar y filtrar Top 10
    const top10 = [...datosGlobales]
        .filter(a => a.realizado && a.realizado.gci > 0)
        .sort((a, b) => b.realizado.gci - a.realizado.gci)
        .slice(0, 10);

    if (top10.length === 0) {
        canvas.parentElement.innerHTML = '<div style="text-align:center; padding:40px; color:#888;">Sin producciÃ³n registrada</div>';
        return;
    }

    // CREAR GRADIENTE HORIZONTAL (De izquierda a derecha)
    const ctx = canvas.getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 400, 0); 
    gradient.addColorStop(0, 'rgba(0, 200, 81, 0.8)');  // Verde intenso (inicio)
    gradient.addColorStop(1, 'rgba(0, 200, 81, 0.2)');  // Verde suave (final)

    window.chartProductividadInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: top10.map(a => a.agente), // Nombres de agentes
            datasets: [{
                label: 'GCI Generado',
                data: top10.map(a => a.realizado.gci),
                backgroundColor: gradient,
                borderColor: '#00C851',
                borderWidth: 1,
                borderRadius: 4,
                barPercentage: 0.6 // Barras un poco mÃ¡s finas y elegantes
            }]
        },
        options: {
            indexAxis: 'y', // Horizontal
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(20, 20, 20, 0.95)',
                    titleColor: '#fff',
                    bodyColor: '#ddd',
                    callbacks: {
                        label: function(context) {
                            return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(context.raw);
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { color: 'rgba(255,255,255,0.05)' },
                    ticks: { 
                        color: '#aaa',
                        callback: function(value) {
                            // Abreviar (100k)
                            return (value / 1000) + 'kâ‚¬'; 
                        }
                    }
                },
                y: {
                    grid: { display: false },
                    ticks: { 
                        color: '#fff', // Nombres en BLANCO para que se lean bien sobre fondo oscuro
                        font: { size: 12, weight: 'bold' } 
                    }
                }
            }
        }
    });
}

function crearGraficoEvolucionCitas() {
    const ctx = document.getElementById('chart-evolucion-citas');
    if (!ctx) return;
    
    if (chartInstances['chart-evolucion-citas']) {
        chartInstances['chart-evolucion-citas'].destroy();
    }
    
    const labels = datosAgregadosEquipo.labels || ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
    const dataReal = datosAgregadosEquipo.citasCaptacion?.realizado || [];
    const dataObj = datosAgregadosEquipo.citasCaptacion?.objetivo || [];
    
    // HistÃ³rico
    let dataHist = [];
    if (window.datosHistoricos2024 && window.datosHistoricos2024.citasCaptacion) {
        dataHist = window.datosHistoricos2024.citasCaptacion.realizado || [];
    }
    
    const datasets = [
        {
            label: 'âœ… Realizado 2025',
            data: dataReal,
            backgroundColor: 'rgba(0, 255, 136, 0.8)',
            borderColor: '#22c55e',
            borderWidth: 2
        }
    ];
    
    if (dataHist.length > 0 && dataHist.reduce((a,b)=>a+b,0) > 0) {
        datasets.push({
            label: 'ğŸ“Š AÃ±o Anterior',
            data: dataHist,
            backgroundColor: 'rgba(102, 126, 234, 0.6)',
            borderColor: '#667eea',
            borderWidth: 2
        });
    }
    
    datasets.push({
        label: 'ğŸ¯ Objetivo',
        data: dataObj,
        type: 'line',
        borderColor: '#ffd700',
        borderWidth: 3,
        pointRadius: 4,
        tension: 0.3
    });
    
    chartInstances['chart-evolucion-citas'] = new Chart(ctx, {
        type: 'bar',
        data: { labels: labels, datasets: datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                x: { grid: { display: false } }
            },
            plugins: {
                legend: { display: true, position: 'top' }
            }
        }
    });
}

function crearGraficoEvolucionVisitas() {
    const ctx = document.getElementById('chart-evolucion-visitas');
    if (!ctx) return;
    
    if (chartInstances['chart-evolucion-visitas']) {
        chartInstances['chart-evolucion-visitas'].destroy();
    }
    
    const labels = datosAgregadosEquipo.labels || ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
    const dataReal = datosAgregadosEquipo.casasEnsenadas?.realizado || [];
    const dataObj = datosAgregadosEquipo.casasEnsenadas?.objetivo || [];
    
    // HistÃ³rico
    let dataHist = [];
    if (window.datosHistoricos2024 && window.datosHistoricos2024.casasEnsenadas) {
        dataHist = window.datosHistoricos2024.casasEnsenadas.realizado || [];
    }
    
    const datasets = [
        {
            label: 'âœ… Realizado 2025',
            data: dataReal,
            backgroundColor: 'rgba(0, 255, 136, 0.8)',
            borderColor: '#22c55e',
            borderWidth: 2
        }
    ];
    
    if (dataHist.length > 0 && dataHist.reduce((a,b)=>a+b,0) > 0) {
        datasets.push({
            label: 'ğŸ“Š AÃ±o Anterior',
            data: dataHist,
            backgroundColor: 'rgba(102, 126, 234, 0.6)',
            borderColor: '#667eea',
            borderWidth: 2
        });
    }
    
    datasets.push({
        label: 'ğŸ¯ Objetivo',
        data: dataObj,
        type: 'line',
        borderColor: '#ffd700',
        borderWidth: 3,
        pointRadius: 4,
        tension: 0.3
    });
    
    chartInstances['chart-evolucion-visitas'] = new Chart(ctx, {
        type: 'bar',
        data: { labels: labels, datasets: datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                x: { grid: { display: false } }
            },
            plugins: {
                legend: { display: true, position: 'top' }
            }
        }
    });
}
function crearGraficoVelocidadCaptacion() {
    const ctx = document.getElementById('chart-velocidad-captacion');
    if (!ctx || !datosGlobales) return;
    
    const agentes = datosGlobales.filter(a => a.realizado.citasCaptacion > 0)
        .map(a => ({
            nombre: a.agente,
            ratio: a.realizado.exclusivasVenta / Math.max(a.realizado.citasCaptacion, 1)
        }))
        .sort((a, b) => b.ratio - a.ratio)
        .slice(0, 10);
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: agentes.map(a => a.agente),
            datasets: [{
                label: 'Exclusivas por Cita',
                data: agentes.map(a => a.ratio),
                backgroundColor: 'rgba(251, 146, 60, 0.8)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: (ctx) => ctx.parsed.y.toFixed(2) + ' excl/cita'
                    }
                }
            }
        }
    });
}

function crearGraficoBalanceRoles() {
    const ctx = document.getElementById('chart-balance-roles');
    if (!ctx || !datosGlobales) return;
    
    const vendedor = datosGlobales.reduce((s, a) => s + (a.realizado.exclusivasVenta || 0), 0);
    const comprador = datosGlobales.reduce((s, a) => s + (a.realizado.exclusivasComprador || 0), 0);
    const visitas = datosGlobales.reduce((s, a) => s + (a.realizado.casasEnsenadas || 0), 0);
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Lado Vendedor', 'Lado Comprador', 'Visitas'],
            datasets: [{
                data: [vendedor, comprador, visitas],
                backgroundColor: [
                    'rgba(239, 68, 68, 0.8)',
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(168, 85, 247, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

function crearGraficoEficienciaVisitas() {
    const ctx = document.getElementById('chart-eficiencia-visitas');
    if (!ctx || !datosGlobales) return;
    
    const agentes = datosGlobales
        .filter(a => a.realizado.casasEnsenadas > 10)
        .map(a => ({
            nombre: a.agente,
            eficiencia: a.realizado.gci / Math.max(a.realizado.casasEnsenadas, 1)
        }))
        .sort((a, b) => b.eficiencia - a.eficiencia)
        .slice(0, 10);
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: agentes.map(a => a.agente),
            datasets: [{
                label: 'GCI por Visita (â‚¬)',
                data: agentes.map(a => a.eficiencia),
                backgroundColor: 'rgba(168, 85, 247, 0.8)'
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: (ctx) => ctx.parsed.x.toFixed(0) + 'â‚¬/visita'
                    }
                }
            }
        }
    });
}

function crearGraficoTopRatios() {
    const ctx = document.getElementById('chart-top-ratios');
    if (!ctx || !datosGlobales) return;
    
    const top5 = [...datosGlobales]
        .sort((a, b) => b.cumplimientoGlobal - a.cumplimientoGlobal)
        .slice(0, 5);
    
    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ['GCI', 'Citas', 'Exclusivas', 'Visitas', 'ConversiÃ³n'],
            datasets: top5.map((a, idx) => ({
                label: a.agente,
                data: [
                    (a.realizado.gci / 50000) * 100,
                    (a.realizado.citasCaptacion / 100) * 100,
                    (a.realizado.exclusivasVenta / 50) * 100,
                    (a.realizado.casasEnsenadas / 100) * 100,
                    a.cumplimientoGlobal
                ],
                borderColor: `hsl(${idx * 72}, 70%, 50%)`,
                backgroundColor: `hsla(${idx * 72}, 70%, 50%, 0.2)`
            }))
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}
function autoCargarAgentesEnModal(modalId) {
    // Buscar todos los selects de agentes dentro del modal
    const modal = document.getElementById(modalId);
    if (!modal) return;
    
    const selectsAgentes = modal.querySelectorAll('select[id*="agente"], select[id*="agent"]');
    selectsAgentes.forEach(select => {
        if (select.options.length <= 1) { // Solo si estÃ¡ vacÃ­o
            const esMultiple = select.multiple;
            cargarAgentesEnSelect(select.id, esMultiple);
        }
    });
}

// Y modifica tu funciÃ³n abrirModalEncima:
function abrirModalEncima(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    
    modal.classList.add('active');
    document.body.classList.add('modal-open');
    
    // Auto-cargar agentes
    setTimeout(() => {
        autoCargarAgentesEnModal(modalId);
    }, 100);
}
function cargarAgentesEnCualquierModal() {
    // Buscar TODOS los selects de agentes en la pÃ¡gina
    const todosLosSelects = document.querySelectorAll('select[id*="agente"], select[id*="agent"]');
    
    todosLosSelects.forEach(select => {
        // Solo cargar si estÃ¡ visible y vacÃ­o
        if (select.offsetParent !== null && select.options.length <= 1) {
            console.log('ğŸ”„ Cargando agentes en:', select.id);
            poblarSelectAgentes(select.id);
        }
    });
}
function mostrarModalCierreAÃ±o() {
    cerrarModalSuperior('modal-acciones');
    abrirModalEncima('modal-cierre-aÃ±o');
    
    // âœ… CORRECTO: Llamar al backend
    google.script.run
        .withSuccessHandler(function(aÃ±oActual) {
            const select = document.getElementById('cierre-aÃ±o-select');
            select.innerHTML = '<option value="">-- Selecciona un aÃ±o --</option>';
            
            // Permitir cerrar desde aÃ±o actual hasta 2020
            for (let aÃ±o = aÃ±oActual; aÃ±o >= 2020; aÃ±o--) {
                const option = document.createElement('option');
                option.value = aÃ±o;
                option.textContent = aÃ±o + (aÃ±o === aÃ±oActual ? ' (AÃ±o Actual)' : '');
                select.appendChild(option);
            }
        })
        .withFailureHandler(function(error) {
            console.error('Error obteniendo aÃ±o:', error);
            // Fallback: usar aÃ±o del sistema
            const aÃ±oActual = new Date().getFullYear();
            const select = document.getElementById('cierre-aÃ±o-select');
            select.innerHTML = '<option value="">-- Selecciona un aÃ±o --</option>';
            
            for (let aÃ±o = aÃ±oActual; aÃ±o >= 2020; aÃ±o--) {
                const option = document.createElement('option');
                option.value = aÃ±o;
                option.textContent = aÃ±o;
                select.appendChild(option);
            }
        })
        .obtenerAÃ±oContable(); // âœ… Llamada correcta desde frontend
    
    // Resetear estado
    document.getElementById('cierre-preview').style.display = 'none';
    document.getElementById('cierre-confirmar').checked = false;
    document.getElementById('btn-ejecutar-cierre').disabled = true;
    document.getElementById('cierre-progreso').style.display = 'none';
}

function previsualizarCierre() {
    const aÃ±o = parseInt(document.getElementById('cierre-aÃ±o-select').value);
    
    if (!aÃ±o) {
        document.getElementById('cierre-preview').style.display = 'none';
        document.getElementById('cierre-advertencia').style.display = 'none';
        return;
    }
    
    // âœ… OBTENER AÃ‘O CONTABLE DESDE BACKEND
    google.script.run
        .withSuccessHandler(function(aÃ±oActual) {
            // Mostrar advertencia especial si es aÃ±o actual
            const advertencia = document.getElementById('cierre-advertencia');
            const textoConfirmacion = document.getElementById('cierre-texto-confirmacion');
            
            if (aÃ±o === aÃ±oActual) {
                textoConfirmacion.innerHTML = `âš ï¸ <strong>ATENCIÃ“N:</strong> Vas a cerrar el aÃ±o ACTUAL (${aÃ±o}). Esta operaciÃ³n moverÃ¡ datos que podrÃ­an estar en uso. Â¿EstÃ¡s seguro?`;
                advertencia.style.background = 'rgba(220,38,38,0.1)';
                advertencia.style.borderColor = '#dc2626';
            } else {
                textoConfirmacion.textContent = 'Entiendo que esta operaciÃ³n moverÃ¡ datos a histÃ³rico y no se puede deshacer fÃ¡cilmente';
                advertencia.style.background = 'rgba(251,191,36,0.1)';
                advertencia.style.borderColor = '#fbbf24';
            }
            
            advertencia.style.display = 'block';
            
            // Mostrar loading en vista previa
            document.getElementById('cierre-preview').style.display = 'block';
            document.getElementById('preview-registros').textContent = '...';
            document.getElementById('preview-agentes').textContent = '...';
            document.getElementById('preview-gci').textContent = '...';
            
            // Resetear confirmaciÃ³n
            document.getElementById('cierre-confirmar').checked = false;
            document.getElementById('btn-ejecutar-cierre').disabled = true;
            document.getElementById('btn-ejecutar-cierre').style.opacity = '0.5';
            
            // Llamar backend para obtener preview
            google.script.run
                .withSuccessHandler(function(preview) {
                    document.getElementById('preview-registros').textContent = preview.registros.toLocaleString('es-ES');
                    document.getElementById('preview-agentes').textContent = preview.agentes;
                    document.getElementById('preview-gci').textContent = preview.gci.toLocaleString('es-ES', {maximumFractionDigits: 0}) + 'â‚¬';
                    document.getElementById('preview-rango').textContent = `PerÃ­odo: ${preview.fechaInicio} - ${preview.fechaFin}`;
                })
                .withFailureHandler(function(error) {
                    mostrarNotificacion('Error al obtener vista previa: ' + error, 'error');
                })
                .obtenerPreviewCierre(aÃ±o);
        })
        .withFailureHandler(function(error) {
            console.error('Error obteniendo aÃ±o contable:', error);
            // Fallback: asumir que no es aÃ±o actual
            const advertencia = document.getElementById('cierre-advertencia');
            const textoConfirmacion = document.getElementById('cierre-texto-confirmacion');
            
            textoConfirmacion.textContent = 'Entiendo que esta operaciÃ³n moverÃ¡ datos a histÃ³rico y no se puede deshacer fÃ¡cilmente';
            advertencia.style.background = 'rgba(251,191,36,0.1)';
            advertencia.style.borderColor = '#fbbf24';
            advertencia.style.display = 'block';
        })
        .obtenerAÃ±oContable(); // âœ… LLAMADA CORRECTA AL BACKEND
}

function ejecutarCierreAÃ±o() {
    const aÃ±o = parseInt(document.getElementById('cierre-aÃ±o-select').value);
    
    if (!aÃ±o) {
        mostrarNotificacion('Selecciona un aÃ±o', 'error');
        return;
    }
    
    if (!document.getElementById('cierre-confirmar').checked) {
        mostrarNotificacion('Debes confirmar que entiendes la operaciÃ³n', 'error');
        return;
    }
    
    // Deshabilitar botÃ³n
    const btn = document.getElementById('btn-ejecutar-cierre');
    btn.disabled = true;
    btn.textContent = 'â³ Procesando...';
    
    // Mostrar barra de progreso
    document.getElementById('cierre-progreso').style.display = 'block';
    
    // Simular progreso
    let progreso = 0;
    const intervalo = setInterval(() => {
        progreso += 5;
        if (progreso <= 90) {
            document.getElementById('cierre-barra').style.width = progreso + '%';
            document.getElementById('cierre-texto').textContent = progreso + '%';
        }
    }, 500);
    
    // Ejecutar cierre
    google.script.run
        .withSuccessHandler(function(resultado) {
            clearInterval(intervalo);
            document.getElementById('cierre-barra').style.width = '100%';
            document.getElementById('cierre-texto').textContent = '100%';
            
            if (resultado.success) {
                setTimeout(() => {
                    mostrarNotificacion(resultado.message, 'success');
                    cerrarModalSuperior('modal-cierre-aÃ±o');
                    
                    // Recargar dashboard
                    if (vistaActualGerente) {
                        cargarDashboardGerente();
                    }
                }, 500);
            } else {
                mostrarNotificacion('âŒ ' + resultado.message, 'error');
                btn.disabled = false;
                btn.textContent = 'ğŸ”’ EJECUTAR CIERRE DE AÃ‘O';
            }
        })
        .withFailureHandler(function(error) {
            clearInterval(intervalo);
            mostrarNotificacion('âŒ Error: ' + error, 'error');
            btn.disabled = false;
            btn.textContent = 'ğŸ”’ EJECUTAR CIERRE DE AÃ‘O';
        })
        .cerrarAÃ±o(aÃ±o);
}
function ejecutarCierreAÃ±o() {
    const aÃ±o = parseInt(document.getElementById('cierre-aÃ±o-select').value);
    
    if (!aÃ±o) {
        mostrarNotificacion('Selecciona un aÃ±o', 'error');
        return;
    }
    
    if (!document.getElementById('cierre-confirmar').checked) {
        mostrarNotificacion('Debes confirmar que entiendes la operaciÃ³n', 'error');
        return;
    }
    
    // Deshabilitar botÃ³n
    const btn = document.getElementById('btn-ejecutar-cierre');
    btn.disabled = true;
    btn.textContent = 'â³ Procesando...';
    btn.style.opacity = '0.7';
    
    // Mostrar barra de progreso
    document.getElementById('cierre-progreso').style.display = 'block';
    
    // Simular progreso
    let progreso = 0;
    const intervalo = setInterval(() => {
        progreso += 5;
        if (progreso <= 90) {
            document.getElementById('cierre-barra').style.width = progreso + '%';
            document.getElementById('cierre-texto').textContent = progreso + '%';
        }
    }, 500);
    
    // Ejecutar cierre
    google.script.run
        .withSuccessHandler(function(resultado) {
            clearInterval(intervalo);
            document.getElementById('cierre-barra').style.width = '100%';
            document.getElementById('cierre-texto').textContent = '100%';
            
            if (resultado.success) {
                setTimeout(() => {
                    mostrarNotificacion(resultado.message, 'success');
                    cerrarModalSuperior('modal-cierre-aÃ±o');
                    
                    // Recargar dashboard
                    if (typeof cargarDashboardGerente === 'function') {
                        cargarDashboardGerente();
                    }
                }, 500);
            } else {
                mostrarNotificacion('âŒ ' + resultado.message, 'error');
                btn.disabled = false;
                btn.textContent = 'ğŸ”’ EJECUTAR CIERRE DE AÃ‘O';
                btn.style.opacity = '1';
                document.getElementById('cierre-progreso').style.display = 'none';
            }
        })
        .withFailureHandler(function(error) {
            clearInterval(intervalo);
            mostrarNotificacion('âŒ Error: ' + error, 'error');
            btn.disabled = false;
            btn.textContent = 'ğŸ”’ EJECUTAR CIERRE DE AÃ‘O';
            btn.style.opacity = '1';
            document.getElementById('cierre-progreso').style.display = 'none';
        })
        .cerrarAÃ±o(aÃ±o);
}
function habilitarBotonCierre() {
    const checkbox = document.getElementById('cierre-confirmar');
    const btn = document.getElementById('btn-ejecutar-cierre');
    const aÃ±oSeleccionado = document.getElementById('cierre-aÃ±o-select').value;
    
    if (!checkbox || !btn) {
        console.error('Elementos no encontrados');
        return;
    }
    
    if (checkbox.checked && aÃ±oSeleccionado) {
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
        console.log('âœ… BotÃ³n habilitado');
    } else {
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
        console.log('âŒ BotÃ³n deshabilitado');
    }
}
// ============================================
// REFERENCIA AÃ‘O ANTERIOR
// ============================================

function toggleRefAnterior() {
    var cont = document.getElementById('me-ref-contenido');
    var toggle = document.getElementById('me-ref-toggle');
    if (cont.style.display === 'none') {
        cont.style.display = 'block';
        toggle.style.transform = 'rotate(180deg)';
    } else {
        cont.style.display = 'none';
        toggle.style.transform = 'rotate(0deg)';
    }
}

function cargarReferenciaAnterior() {
    var aÃ±o = new Date().getFullYear() - 1;
    document.getElementById('me-aÃ±o-ref').textContent = aÃ±o;
    
    google.script.run
        .withSuccessHandler(function(datos) {
            if (datos && datos.success && datos.gci > 0) {
                var comMedia = datos.transacciones > 0 ? Math.round(datos.gci / datos.transacciones) : 0;
                
                document.getElementById('me-ref-gci').textContent = formatearMoneda(datos.gci);
                document.getElementById('me-ref-trans').textContent = datos.transacciones || 0;
                document.getElementById('me-ref-comision').textContent = formatearMoneda(comMedia);
                document.getElementById('me-ref-citas').textContent = datos.citasCaptacion || 0;
                document.getElementById('me-ref-capt').textContent = datos.captaciones || 0;
                document.getElementById('me-ref-resumen').textContent = '(' + formatearMoneda(datos.gci) + ')';
                
                // Guardar para pre-cargar
                window.datosRefAnterior = datos;
                window.datosRefAnterior.comisionMedia = comMedia;
            } else {
                document.getElementById('me-ref-resumen').textContent = '(sin datos)';
            }
        })
        .withFailureHandler(function() {
            document.getElementById('me-ref-resumen').textContent = '(error)';
        })
        .obtenerDatosEquipoAÃ±oAnterior(aÃ±o);
}

function precargarDesdeAnterior() {
    var d = window.datosRefAnterior;
    if (!d) {
        mostrarNotificacion('No hay datos del aÃ±o anterior', 'warning');
        return;
    }
    
    // Pre-cargar solo los ratios, no el beneficio
    if (d.comisionMedia > 0) document.getElementById('me-comision-media').value = d.comisionMedia;
    
    if (d.citasCaptacion > 0 && d.captaciones > 0) {
        var ratioCita = Math.round((d.captaciones / d.citasCaptacion) * 100);
        document.getElementById('me-ratio-cita-capt').value = Math.min(ratioCita, 100);
    }
    
    if (d.captaciones > 0 && d.transacciones > 0) {
        var ratioCapt = Math.round((d.transacciones / d.captaciones) * 100);
        document.getElementById('me-ratio-capt-venta').value = Math.min(ratioCapt, 100);
    }
    
    mostrarNotificacion('âœ… Ratios pre-cargados del ' + (new Date().getFullYear() - 1), 'success');
}

// ============================================
// DISTRIBUCIÃ“N MENSUAL
// ============================================

function distMensualDefecto() {
    var defecto = {1:5, 2:10, 3:10, 4:5, 5:10, 6:10, 7:10, 8:5, 9:10, 10:10, 11:10, 12:5};
    for (var m = 1; m <= 12; m++) {
        document.getElementById('me-dist-' + m).value = defecto[m];
    }
    validarDistMensual();
}

function distMensualUniforme() {
    var val = (100 / 12).toFixed(2);
    for (var m = 1; m <= 12; m++) {
        document.getElementById('me-dist-' + m).value = val;
    }
    validarDistMensual();
}

function validarDistMensual() {
    var total = 0;
    for (var m = 1; m <= 12; m++) {
        total += parseFloat(document.getElementById('me-dist-' + m).value) || 0;
    }
    
    var div = document.getElementById('me-dist-validacion');
    var diff = Math.abs(total - 100);
    
    if (diff < 0.1) {
        div.innerHTML = 'âœ… Total: <strong>100%</strong>';
        div.style.background = 'rgba(34,197,94,0.2)';
        div.style.color = '#22c55e';
    } else if (total < 100) {
        div.innerHTML = 'âš ï¸ Total: <strong>' + total.toFixed(1) + '%</strong> (faltan ' + (100 - total).toFixed(1) + '%)';
        div.style.background = 'rgba(255,193,7,0.2)';
        div.style.color = '#ffc107';
    } else {
        div.innerHTML = 'âŒ Total: <strong>' + total.toFixed(1) + '%</strong> (sobran ' + (total - 100).toFixed(1) + '%)';
        div.style.background = 'rgba(239,68,68,0.2)';
        div.style.color = '#ef4444';
    }
    
    return diff < 0.1;
}

function obtenerDistMensual() {
    var dist = {};
    for (var m = 1; m <= 12; m++) {
        dist[m] = parseFloat(document.getElementById('me-dist-' + m).value) || 0;
    }
    return dist;
}

// Llamar al abrir modal
function abrirModalModeloEconomico() {
    document.getElementById('modal-modelo-economico').style.display = 'flex';
    cargarReferenciaAnterior();
    validarDistMensual();
}
// Variable global para el periodo del mando
window.mandoPeriodo = 'mes'; // 'semana', 'mes', 'anual'

function renderizarCentroMando() {
    const agentes = datosFiltrados || [];
    const periodo = window.mandoPeriodo || 'mes';
    
    // ===== CÃLCULOS TEMPORALES =====
    const hoy = new Date();
    const mesActual = hoy.getMonth();
    const diaDelMes = hoy.getDate();
    const diasEnMes = new Date(hoy.getFullYear(), mesActual + 1, 0).getDate();
    const diasTranscurridos = Math.ceil((hoy - new Date(hoy.getFullYear(), 0, 1)) / (1000 * 60 * 60 * 24));
    const diasRestantesAno = 365 - diasTranscurridos;
    const factorTiempoAnual = diasTranscurridos / 365;
    const factorTiempoMes = diaDelMes / diasEnMes;
    
    const nombresMeses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    const mesNombre = nombresMeses[mesActual];
    
    // ===== SEMANAS DEL MES =====
    const semanaActual = Math.ceil(diaDelMes / 7);
    const semanasEnMes = Math.ceil(diasEnMes / 7);
    const diasEnSemana = 7;
    const diaInicioSemana = (semanaActual - 1) * 7 + 1;
    const diaFinSemana = Math.min(semanaActual * 7, diasEnMes);
    const diasTranscurridosSemana = Math.min(diaDelMes - diaInicioSemana + 1, diasEnSemana);
    const factorTiempoSemana = diasTranscurridosSemana / diasEnSemana;
    
    // Meses restantes (incluyendo el actual)
    const mesesRestantes = 12 - mesActual;
    const semanasRestantesAno = Math.ceil(diasRestantesAno / 7);

    // ===== CÃLCULOS DEL EQUIPO - ANUALES =====
    const totalGCI = agentes.reduce((sum, a) => sum + (a.realizado?.gci || 0), 0);
    // Objetivo anual: usar Modelo EconÃ³mico si estÃ¡ activo, si no suma de agentes
const sumaObjetivosAgentes = agentes.reduce((sum, a) => sum + (a.objetivos?.gci || 0), 0);
const totalObjetivoAnual = (window.objetivosGlobalesOficina?.gci > 0) 
    ? window.objetivosGlobalesOficina.gci 
    : sumaObjetivosAgentes;

console.log('ğŸ¯ Objetivo GCI:', totalObjetivoAnual, 
    window.objetivosGlobalesOficina?.gci ? '(Modelo EconÃ³mico)' : '(Suma Agentes)');
    const objetivoMes = totalObjetivoAnual / 12;
    const objetivoSemana = objetivoMes / semanasEnMes;
    
    // ===== GCI DEL MES ACTUAL =====
    let gciMesActual = 0;
    let objetivoMesReal = 0;
    
    const labelsBackend = datosAgregadosEquipo?.labels || [];
    const gciMensualEquipo = reordenarDatosMensuales(
        datosAgregadosEquipo?.gci?.realizado,
        labelsBackend
    );
    const objMensualEquipo = reordenarDatosMensuales(
        datosAgregadosEquipo?.gci?.objetivo,
        labelsBackend
    );
    
    gciMesActual = gciMensualEquipo[mesActual] || 0;
    objetivoMesReal = objMensualEquipo[mesActual] || objetivoMes;
    
    // ===== OBJETIVO A LA FECHA (YTD) =====
    let objetivoAcumuladoAFecha = 0;
    for (let i = 0; i < mesActual; i++) {
        objetivoAcumuladoAFecha += objMensualEquipo[i] || 0;
    }
    // AÃ±adir proporciÃ³n del mes actual
    objetivoAcumuladoAFecha += (objetivoMesReal * factorTiempoMes);
    
    // DÃ©ficit o superÃ¡vit YTD
    const deficitYTD = totalGCI - objetivoAcumuladoAFecha;
    
    // ===== CALCULAR SEGÃšN PERIODO SELECCIONADO =====
    let tituloPerido = '';
    let subtituloPeriodo = '';
    let realizadoMostrar = 0;
    let objetivoMostrar = 0;
    let factorTiempo = 0;
    let objetivoFecha = 0;
    
    switch(periodo) {
        case 'semana':
            tituloPerido = `Semana ${semanaActual} de ${mesNombre}`;
            subtituloPeriodo = `DÃ­a ${diasTranscurridosSemana} de 7`;
            realizadoMostrar = gciMesActual * (diasTranscurridosSemana / diaDelMes) || 0;
            objetivoMostrar = objetivoMesReal / semanasEnMes;
            factorTiempo = factorTiempoSemana;
            objetivoFecha = objetivoMostrar * factorTiempoSemana;
            break;
        case 'mes':
            tituloPerido = mesNombre;
            subtituloPeriodo = `DÃ­a ${diaDelMes} de ${diasEnMes}`;
            realizadoMostrar = gciMesActual;
            objetivoMostrar = objetivoMesReal;
            factorTiempo = factorTiempoMes;
            objetivoFecha = objetivoMesReal * factorTiempoMes;
            break;
        case 'ytd':
            tituloPerido = 'AÃ±o a la Fecha';
            subtituloPeriodo = `${diasTranscurridos} dÃ­as transcurridos`;
            realizadoMostrar = totalGCI;
            objetivoMostrar = totalObjetivoAnual;
            factorTiempo = factorTiempoAnual;
            objetivoFecha = objetivoAcumuladoAFecha;
            break;
        case 'anual':
        default:
            tituloPerido = 'AÃ±o ' + hoy.getFullYear();
            subtituloPeriodo = `${diasRestantesAno} dÃ­as restantes`;
            realizadoMostrar = totalGCI;
            objetivoMostrar = totalObjetivoAnual;
            factorTiempo = factorTiempoAnual;
            objetivoFecha = totalObjetivoAnual * factorTiempoAnual;
            break;
    }
    
    const proyeccion = factorTiempo > 0 ? realizadoMostrar / factorTiempo : 0;
    const falta = Math.max(objetivoMostrar - realizadoMostrar, 0);
    const diffVsObjetivo = realizadoMostrar - objetivoFecha;
    const cumplimiento = objetivoFecha > 0 ? (realizadoMostrar / objetivoFecha * 100) : 0;
    
    // HistÃ³rico aÃ±o anterior
    let historicoAnual = 0;
    if (facturacionPasadaGlobal?.kpis?.gci) {
        historicoAnual = facturacionPasadaGlobal.kpis.gci;
    }
    const pctVsAnterior = historicoAnual > 0 ? ((proyeccion - historicoAnual) / historicoAnual * 100) : 0;
    
    // ===== PRORRATEO PARA CUMPLIR OBJETIVO =====
    const faltaParaObjetivoAnual = Math.max(totalObjetivoAnual - totalGCI, 0);
    const nuevoObjetivoMensual = mesesRestantes > 0 ? faltaParaObjetivoAnual / mesesRestantes : 0;
    const nuevoObjetivoSemanal = semanasRestantesAno > 0 ? faltaParaObjetivoAnual / semanasRestantesAno : 0;
    const incrementoVsOriginal = objetivoMes > 0 ? ((nuevoObjetivoMensual - objetivoMes) / objetivoMes * 100) : 0;
    
    // CuÃ¡nto falta por periodo
    let faltaPorPeriodo = falta;
    let periodosRestantes = 1;
    let labelPeriodo = '';
    
    switch(periodo) {
        case 'semana':
            periodosRestantes = semanasRestantesAno;
            faltaPorPeriodo = nuevoObjetivoSemanal;
            labelPeriodo = 'semana';
            break;
        case 'mes':
        case 'ytd':
            periodosRestantes = mesesRestantes;
            faltaPorPeriodo = nuevoObjetivoMensual;
            labelPeriodo = 'mes';
            break;
        case 'anual':
            periodosRestantes = mesesRestantes;
            faltaPorPeriodo = nuevoObjetivoMensual;
            labelPeriodo = 'mes restante';
            break;
    }

    // Formateo
    const fmt = (v) => Math.round(v || 0).toLocaleString('es-ES');
    const fmtE = (v) => fmt(v) + 'â‚¬';
    const fmtDec = (v, d = 1) => (v || 0).toFixed(d);

    // ===== PREPARAR DATOS DE AGENTES CON TODOS LOS KPIs =====
    const agentesConCalculo = agentes.map(a => {
        const gci = a.realizado?.gci || 0;
        const objAnual = a.objetivos?.gci || 0;
        const objMesAgente = objAnual / 12;
        const objSemanaAgente = objMesAgente / semanasEnMes;
        const cumpl = parseFloat(a.cumplimientoGlobal) || 0;
        
        // EvoluciÃ³n mensual del agente
        let gciEsteMes = 0;
        if (a.evolucionMensual?.gci?.realizado) {
            const labelsAg = a.evolucionMensual?.labels || [];
            const gciMensualAg = reordenarDatosMensuales(a.evolucionMensual.gci.realizado, labelsAg);
            gciEsteMes = gciMensualAg[mesActual] || 0;
        }
        
        const faltaMesAgente = Math.max(objMesAgente - gciEsteMes, 0);
        const semanasRestantesMes = semanasEnMes - semanaActual + 1;
        const faltaSemanaAgente = faltaMesAgente / Math.max(semanasRestantesMes, 1);
        
        // ===== TODOS LOS KPIs =====
        // Objetivos anuales
        const objCitas = a.objetivos?.citasCaptacion || 0;
        const objExclusivas = a.objetivos?.exclusivasVenta || 0;
        const objLeadComprador = a.objetivos?.leadComprador || a.objetivos?.leadsCompradores || 0;
        const objLeadVendedor = a.objetivos?.leadVendedor || 0;
        const objArras = a.objetivos?.arras || 0;
        const objBajadasPrecio = a.objetivos?.bajadasPrecio || 0;
        const objPropuestas = a.objetivos?.propuestasCompra || 0;
        const objCasasEnsenadas = a.objetivos?.casasEnsenadas || 0;
        
        // Realizados
        const realCitas = a.realizado?.citasCaptacion || 0;
        const realExclusivas = a.realizado?.exclusivasVenta || 0;
        const realLeadComprador = a.realizado?.leadComprador || a.realizado?.leadsCompradores || 0;
        const realLeadVendedor = a.realizado?.leadVendedor || 0;
        const realArras = a.realizado?.arras || 0;
        const realBajadasPrecio = a.realizado?.bajadasPrecio || 0;
        const realPropuestas = a.realizado?.propuestasCompra || 0;
        const realCasasEnsenadas = a.realizado?.casasEnsenadas || 0;
        
        // Objetivos mensuales y semanales
        const citasMes = objCitas / 12;
        const exclusivasMes = objExclusivas / 12;
        const leadCompradorMes = objLeadComprador / 12;
        const leadVendedorMes = objLeadVendedor / 12;
        const arrasMes = objArras / 12;
        const bajadasMes = objBajadasPrecio / 12;
        const propuestasMes = objPropuestas / 12;
        const casasMes = objCasasEnsenadas / 12;
        
        const citasSemana = citasMes / semanasEnMes;
        const exclusivasSemana = exclusivasMes / semanasEnMes;
        const leadCompradorSemana = leadCompradorMes / semanasEnMes;
        const leadVendedorSemana = leadVendedorMes / semanasEnMes;
        const arrasSemana = arrasMes / semanasEnMes;
        const bajadasSemana = bajadasMes / semanasEnMes;
        const propuestasSemana = propuestasMes / semanasEnMes;
        const casasSemana = casasMes / semanasEnMes;
        
        // DÃ©ficit YTD del agente
        const deficitGCIAgente = gci - (objAnual * factorTiempoAnual);
        
        // Nuevo objetivo mensual para cumplir
        const faltaAnualAgente = Math.max(objAnual - gci, 0);
        const nuevoObjMesAgente = mesesRestantes > 0 ? faltaAnualAgente / mesesRestantes : 0;
        const nuevoObjSemAgente = semanasRestantesAno > 0 ? faltaAnualAgente / semanasRestantesAno : 0;
        
        return {
            ...a,
            gciEsteMes,
            gciAnual: gci,
            objMes: objMesAgente,
            objSemana: objSemanaAgente,
            faltaMes: faltaMesAgente,
            faltaSemana: faltaSemanaAgente,
            cumplimiento: cumpl,
            deficitYTD: deficitGCIAgente,
            nuevoObjMes: nuevoObjMesAgente,
            nuevoObjSemana: nuevoObjSemAgente,
            // KPIs detallados
            citasMes, citasSemana, realCitas, objCitas,
            exclusivasMes, exclusivasSemana, realExclusivas, objExclusivas,
            leadCompradorMes, leadCompradorSemana, realLeadComprador, objLeadComprador,
            leadVendedorMes, leadVendedorSemana, realLeadVendedor, objLeadVendedor,
            arrasMes, arrasSemana, realArras, objArras,
            bajadasMes, bajadasSemana, realBajadasPrecio, objBajadasPrecio,
            propuestasMes, propuestasSemana, realPropuestas, objPropuestas,
            casasMes, casasSemana, realCasasEnsenadas, objCasasEnsenadas
        };
    }).sort((a, b) => b.cumplimiento - a.cumplimiento);

    // ===== DETERMINAR QUÃ‰ COLUMNAS MOSTRAR SEGÃšN PERIODO =====
    const esVistaYTD = periodo === 'ytd';
    const esVistaAnual = periodo === 'anual';
    const esVistaMes = periodo === 'mes';
    const esVistaSemana = periodo === 'semana';

    return `
        <div class="mando-container" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
            
            <!-- ===== HEADER ===== -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid var(--color-border);">
                <div>
                    <h1 style="margin: 0; font-size: 1.8em; font-weight: 700; color: var(--color-text-primary);">
                        Centro de Control
                    </h1>
                    <div style="color: #888; margin-top: 5px;">
                        ${mesNombre} ${hoy.getFullYear()} Â· Semana ${semanaActual} de ${semanasEnMes} Â· DÃ­a ${diaDelMes} de ${diasEnMes}
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn ${periodo === 'semana' ? 'btn-primary' : ''}" onclick="cambiarVistaMando('semana')" style="padding: 8px 16px; border-radius: 8px; ${periodo === 'semana' ? 'background: #6366f1; color: white;' : 'background: var(--color-surface); border: 1px solid var(--color-border);'}">Esta Semana</button>
                    <button class="btn ${periodo === 'mes' ? 'btn-primary' : ''}" onclick="cambiarVistaMando('mes')" style="padding: 8px 16px; border-radius: 8px; ${periodo === 'mes' ? 'background: #6366f1; color: white;' : 'background: var(--color-surface); border: 1px solid var(--color-border);'}">Este Mes</button>
                    <button class="btn ${periodo === 'ytd' ? 'btn-primary' : ''}" onclick="cambiarVistaMando('ytd')" style="padding: 8px 16px; border-radius: 8px; ${periodo === 'ytd' ? 'background: #f59e0b; color: white;' : 'background: var(--color-surface); border: 1px solid var(--color-border);'}">A la Fecha</button>
                    <button class="btn ${periodo === 'anual' ? 'btn-primary' : ''}" onclick="cambiarVistaMando('anual')" style="padding: 8px 16px; border-radius: 8px; ${periodo === 'anual' ? 'background: #6366f1; color: white;' : 'background: var(--color-surface); border: 1px solid var(--color-border);'}">AÃ±o</button>
                </div>
            </div>

            <!-- ===== RESUMEN EJECUTIVO ===== -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
                
                <!-- REALIZADO -->
                <div style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 12px; padding: 20px;">
                    <div style="font-size: 0.8em; color: #888; text-transform: uppercase; letter-spacing: 1px;">Realizado ${esVistaYTD ? 'YTD' : tituloPerido}</div>
                    <div style="font-size: 2.2em; font-weight: 800; color: var(--color-text-primary); margin: 10px 0;">${fmtE(realizadoMostrar)}</div>
                    <div style="font-size: 0.85em; color: ${diffVsObjetivo >= 0 ? '#22c55e' : '#ef4444'};">
                        ${diffVsObjetivo >= 0 ? 'â–²' : 'â–¼'} ${fmtE(Math.abs(diffVsObjetivo))} vs objetivo
                    </div>
                </div>
                
                <!-- OBJETIVO A LA FECHA -->
                <div style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 12px; padding: 20px;">
                    <div style="font-size: 0.8em; color: #888; text-transform: uppercase; letter-spacing: 1px;">Objetivo ${esVistaYTD ? 'Acumulado' : 'a Hoy'}</div>
                    <div style="font-size: 2.2em; font-weight: 800; color: var(--color-text-primary); margin: 10px 0;">${fmtE(objetivoFecha)}</div>
                    <div style="font-size: 0.85em; color: #888;">
                        de ${fmtE(objetivoMostrar)} ${esVistaAnual || esVistaYTD ? 'anual' : esVistaMes ? 'mensual' : 'semanal'}
                    </div>
                </div>
                
                <!-- PROYECCIÃ“N -->
                <div style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 12px; padding: 20px;">
                    <div style="font-size: 0.8em; color: #888; text-transform: uppercase; letter-spacing: 1px;">ProyecciÃ³n Cierre</div>
                    <div style="font-size: 2.2em; font-weight: 800; color: var(--color-text-primary); margin: 10px 0;">${fmtE(proyeccion)}</div>
                    <div style="font-size: 0.85em; color: ${pctVsAnterior >= 0 ? '#22c55e' : '#ef4444'};">
                        ${pctVsAnterior >= 0 ? '+' : ''}${pctVsAnterior.toFixed(1)}% vs aÃ±o anterior
                    </div>
                </div>
                
                <!-- FALTA PARA OBJETIVO -->
                <div style="background: var(--color-surface); border: 1px solid ${falta > 0 ? 'rgba(239,68,68,0.3)' : 'rgba(34,197,94,0.3)'}; border-radius: 12px; padding: 20px;">
                    <div style="font-size: 0.8em; color: #888; text-transform: uppercase; letter-spacing: 1px;">Falta para Objetivo</div>
                    <div style="font-size: 2.2em; font-weight: 800; color: ${falta > 0 ? '#ef4444' : '#22c55e'}; margin: 10px 0;">${fmtE(falta)}</div>
                    <div style="font-size: 0.85em; color: #888;">
                        ${fmtE(faltaPorPeriodo)}/${labelPeriodo} restante
                    </div>
                </div>
            </div>

            ${esVistaYTD || esVistaAnual ? `
            <!-- ===== PANEL PRORRATEO (Solo en vista YTD y Anual) ===== -->
            <div style="background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(239,68,68,0.05)); border: 2px solid rgba(245,158,11,0.3); border-radius: 12px; padding: 25px; margin-bottom: 30px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                    <span style="font-size: 1.5em;">ğŸ¯</span>
                    <h2 style="margin: 0; font-size: 1.2em; font-weight: 700; color: var(--color-text-primary);">
                        Plan de AcciÃ³n - Para Cumplir Objetivo Anual
                    </h2>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
                    <div style="text-align: center; padding: 15px; background: var(--color-surface); border-radius: 10px;">
                        <div style="font-size: 0.8em; color: #888; margin-bottom: 5px;">DÃ©ficit/SuperÃ¡vit YTD</div>
                        <div style="font-size: 1.8em; font-weight: 800; color: ${deficitYTD >= 0 ? '#22c55e' : '#ef4444'};">
                            ${deficitYTD >= 0 ? '+' : ''}${fmtE(deficitYTD)}
                        </div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: var(--color-surface); border-radius: 10px;">
                        <div style="font-size: 0.8em; color: #888; margin-bottom: 5px;">Nuevo Obj. Mensual</div>
                        <div style="font-size: 1.8em; font-weight: 800; color: ${incrementoVsOriginal > 10 ? '#ef4444' : '#f59e0b'};">
                            ${fmtE(nuevoObjetivoMensual)}
                        </div>
                        <div style="font-size: 0.75em; color: ${incrementoVsOriginal > 0 ? '#ef4444' : '#22c55e'};">
                            ${incrementoVsOriginal > 0 ? '+' : ''}${incrementoVsOriginal.toFixed(0)}% vs original
                        </div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: var(--color-surface); border-radius: 10px;">
                        <div style="font-size: 0.8em; color: #888; margin-bottom: 5px;">Nuevo Obj. Semanal</div>
                        <div style="font-size: 1.8em; font-weight: 800; color: var(--color-text-primary);">
                            ${fmtE(nuevoObjetivoSemanal)}
                        </div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: var(--color-surface); border-radius: 10px;">
                        <div style="font-size: 0.8em; color: #888; margin-bottom: 5px;">Tiempo Restante</div>
                        <div style="font-size: 1.8em; font-weight: 800; color: var(--color-text-primary);">
                            ${mesesRestantes} meses
                        </div>
                        <div style="font-size: 0.75em; color: #888;">${semanasRestantesAno} semanas</div>
                    </div>
                </div>
                
                ${faltaParaObjetivoAnual > 0 ? `
                <div style="margin-top: 20px; padding: 15px; background: rgba(239,68,68,0.1); border-radius: 8px; text-align: center;">
                    <span style="font-size: 1.1em; color: #ef4444; font-weight: 600;">
                        âš ï¸ Para cumplir el objetivo anual, el equipo necesita facturar <strong>${fmtE(nuevoObjetivoMensual)}/mes</strong> durante los prÃ³ximos <strong>${mesesRestantes} meses</strong>
                    </span>
                </div>
                ` : `
                <div style="margin-top: 20px; padding: 15px; background: rgba(34,197,94,0.1); border-radius: 8px; text-align: center;">
                    <span style="font-size: 1.1em; color: #22c55e; font-weight: 600;">
                        âœ… Â¡El equipo va por encima del objetivo! SuperÃ¡vit de ${fmtE(Math.abs(deficitYTD))}
                    </span>
                </div>
                `}
            </div>
            ` : ''}

            <!-- ===== OBJETIVO DEL MES EN CURSO ===== -->
            <div style="background: linear-gradient(135deg, var(--color-surface), rgba(99,102,241,0.05)); border: 1px solid var(--color-border); border-radius: 12px; padding: 25px; margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                    <div>
                        <div style="font-size: 0.9em; color: #888; margin-bottom: 5px;">ğŸ“… Objetivo ${mesNombre}</div>
                        <div style="font-size: 2.5em; font-weight: 800; color: var(--color-text-primary);">${fmtE(objetivoMesReal)}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 0.85em; color: #888;">Realizado</div>
                        <div style="font-size: 1.8em; font-weight: 700; color: var(--color-text-primary);">${fmtE(gciMesActual)}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 0.85em; color: #888;">Falta</div>
                        <div style="font-size: 1.8em; font-weight: 700; color: #ef4444;">${fmtE(Math.max(objetivoMesReal - gciMesActual, 0))}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 0.85em; color: #888;">Obj. Semanal</div>
                        <div style="font-size: 1.8em; font-weight: 700; color: var(--color-text-primary);">${fmtE(objetivoMesReal / semanasEnMes)}</div>
                    </div>
                    <div style="text-align: center; padding: 15px 25px; background: ${cumplimiento >= 90 ? 'rgba(34,197,94,0.15)' : cumplimiento >= 70 ? 'rgba(234,179,8,0.15)' : 'rgba(239,68,68,0.15)'}; border-radius: 10px;">
                        <div style="font-size: 0.85em; color: #888;">Cumplimiento</div>
                        <div style="font-size: 2em; font-weight: 800; color: ${cumplimiento >= 90 ? '#22c55e' : cumplimiento >= 70 ? '#eab308' : '#ef4444'};">${cumplimiento.toFixed(0)}%</div>
                    </div>
                </div>
            </div>

            <!-- ===== TABLA DE CONTROL POR AGENTE (EXPANDIDA) ===== -->
            <div style="margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0; font-size: 1.2em; font-weight: 600;">
                        Control por Agente - ${esVistaYTD ? 'AÃ±o a la Fecha' : esVistaAnual ? 'Anual' : mesNombre}
                    </h2>
                    <div style="font-size: 0.85em; color: #888;">${agentes.length} agentes activos</div>
                </div>
                
                <div style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 12px; overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85em; min-width: 1200px;">
                        <thead>
                            <tr style="background: rgba(255,255,255,0.03);">
                                <th style="padding: 12px 10px; text-align: left; font-weight: 600; border-bottom: 1px solid var(--color-border); position: sticky; left: 0; background: var(--color-surface); z-index: 10;">Agente</th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; border-bottom: 1px solid var(--color-border);">GCI ${esVistaYTD || esVistaAnual ? 'YTD' : 'Mes'}</th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; border-bottom: 1px solid var(--color-border);">Obj.</th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; border-bottom: 1px solid var(--color-border);">Falta</th>
                                ${esVistaYTD || esVistaAnual ? `
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; border-bottom: 1px solid var(--color-border); background: rgba(245,158,11,0.1);">Nuevo Obj/Mes</th>
                                ` : `
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; border-bottom: 1px solid var(--color-border);">Obj/Sem</th>
                                `}
                                <th style="padding: 12px 8px; text-align: center; font-weight: 600; border-bottom: 1px solid var(--color-border);">Citas</th>
                                <th style="padding: 12px 8px; text-align: center; font-weight: 600; border-bottom: 1px solid var(--color-border);">Exclus.</th>
                                <th style="padding: 12px 8px; text-align: center; font-weight: 600; border-bottom: 1px solid var(--color-border);">Lead Vend.</th>
                                <th style="padding: 12px 8px; text-align: center; font-weight: 600; border-bottom: 1px solid var(--color-border);">Lead Comp.</th>
                                <th style="padding: 12px 8px; text-align: center; font-weight: 600; border-bottom: 1px solid var(--color-border);">Propuestas</th>
                                <th style="padding: 12px 8px; text-align: center; font-weight: 600; border-bottom: 1px solid var(--color-border);">Arras</th>
                                <th style="padding: 12px 8px; text-align: center; font-weight: 600; border-bottom: 1px solid var(--color-border);">Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${agentesConCalculo.map((a, idx) => {
                                const status = a.cumplimiento >= 90 ? 'excelente' : a.cumplimiento >= 70 ? 'bueno' : a.cumplimiento >= 50 ? 'medio' : 'bajo';
                                const statusColor = status === 'excelente' ? '#22c55e' : status === 'bueno' ? '#3b82f6' : status === 'medio' ? '#eab308' : '#ef4444';
                                const statusBg = status === 'excelente' ? 'rgba(34,197,94,0.1)' : status === 'bueno' ? 'rgba(59,130,246,0.1)' : status === 'medio' ? 'rgba(234,179,8,0.1)' : 'rgba(239,68,68,0.1)';
                                const statusIcon = status === 'excelente' ? 'âœ“' : status === 'bueno' ? 'â†’' : status === 'medio' ? '!' : 'âš ';
                                
                                // Determinar valores segÃºn periodo
                                const gciMostrar = esVistaYTD || esVistaAnual ? a.gciAnual : a.gciEsteMes;
                                const objMostrar = esVistaYTD || esVistaAnual ? (a.objetivos?.gci || 0) : a.objMes;
                                const faltaMostrar = esVistaYTD || esVistaAnual ? Math.max((a.objetivos?.gci || 0) - a.gciAnual, 0) : a.faltaMes;
                                
                                // KPIs segÃºn periodo - con nuevo objetivo si es YTD/Anual
                                let citasLabel, exclLabel, leadVLabel, leadCLabel, propLabel, arrasLabel;
                                
                                if (esVistaYTD || esVistaAnual) {
                                    // Calcular nuevo objetivo mensual para cada KPI
                                    const faltaCitas = Math.max(a.objCitas - a.realCitas, 0);
                                    const faltaExcl = Math.max(a.objExclusivas - a.realExclusivas, 0);
                                    const faltaLeadV = Math.max(a.objLeadVendedor - a.realLeadVendedor, 0);
                                    const faltaLeadC = Math.max(a.objLeadComprador - a.realLeadComprador, 0);
                                    const faltaProp = Math.max(a.objPropuestas - a.realPropuestas, 0);
                                    const faltaArras = Math.max(a.objArras - a.realArras, 0);
                                    
                                    const nuevoObjCitasMes = mesesRestantes > 0 ? faltaCitas / mesesRestantes : 0;
                                    const nuevoObjExclMes = mesesRestantes > 0 ? faltaExcl / mesesRestantes : 0;
                                    const nuevoObjLeadVMes = mesesRestantes > 0 ? faltaLeadV / mesesRestantes : 0;
                                    const nuevoObjLeadCMes = mesesRestantes > 0 ? faltaLeadC / mesesRestantes : 0;
                                    const nuevoObjPropMes = mesesRestantes > 0 ? faltaProp / mesesRestantes : 0;
                                    const nuevoObjArrasMes = mesesRestantes > 0 ? faltaArras / mesesRestantes : 0;
                                    
                                    // Formato: Realizado/Obj â†’ NuevoObj/mes
                                    citasLabel = `<div>${a.realCitas}/${a.objCitas}</div><div style="font-size:0.75em;color:#f59e0b;margin-top:2px;">â†’${Math.ceil(nuevoObjCitasMes)}/mes</div>`;
                                    exclLabel = `<div>${a.realExclusivas}/${a.objExclusivas}</div><div style="font-size:0.75em;color:#f59e0b;margin-top:2px;">â†’${fmtDec(nuevoObjExclMes)}/mes</div>`;
                                    leadVLabel = `<div>${a.realLeadVendedor}/${a.objLeadVendedor}</div><div style="font-size:0.75em;color:#f59e0b;margin-top:2px;">â†’${Math.ceil(nuevoObjLeadVMes)}/mes</div>`;
                                    leadCLabel = `<div>${a.realLeadComprador}/${a.objLeadComprador}</div><div style="font-size:0.75em;color:#f59e0b;margin-top:2px;">â†’${Math.ceil(nuevoObjLeadCMes)}/mes</div>`;
                                    propLabel = `<div>${a.realPropuestas}/${a.objPropuestas}</div><div style="font-size:0.75em;color:#f59e0b;margin-top:2px;">â†’${Math.ceil(nuevoObjPropMes)}/mes</div>`;
                                    arrasLabel = `<div>${a.realArras}/${a.objArras}</div><div style="font-size:0.75em;color:#f59e0b;margin-top:2px;">â†’${fmtDec(nuevoObjArrasMes)}/mes</div>`;
                                } else if (esVistaSemana) {
                                    citasLabel = fmtDec(a.citasSemana);
                                    exclLabel = fmtDec(a.exclusivasSemana);
                                    leadVLabel = fmtDec(a.leadVendedorSemana);
                                    leadCLabel = fmtDec(a.leadCompradorSemana);
                                    propLabel = fmtDec(a.propuestasSemana);
                                    arrasLabel = fmtDec(a.arrasSemana);
                                } else {
                                    // Vista Mes
                                    citasLabel = fmtDec(a.citasMes);
                                    exclLabel = fmtDec(a.exclusivasMes);
                                    leadVLabel = fmtDec(a.leadVendedorMes);
                                    leadCLabel = fmtDec(a.leadCompradorMes);
                                    propLabel = fmtDec(a.propuestasMes);
                                    arrasLabel = fmtDec(a.arrasMes);
                                }
                                
                                return `
                                    <tr style="cursor: pointer; transition: background 0.2s;" 
                                        onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                                        onmouseout="this.style.background='transparent'"
                                        onclick="mostrarAnalisisDetallado('${a.id}')">
                                        <td style="padding: 10px; border-bottom: 1px solid var(--color-border); position: sticky; left: 0; background: var(--color-surface);">
                                            <div style="font-weight: 600; white-space: nowrap;">${a.agente}</div>
                                            <div style="font-size: 0.8em; color: #888;">${a.cumplimiento.toFixed(0)}% global</div>
                                        </td>
                                        <td style="padding: 10px 8px; text-align: right; border-bottom: 1px solid var(--color-border); font-weight: 600;">
                                            ${fmtE(gciMostrar)}
                                        </td>
                                        <td style="padding: 10px 8px; text-align: right; border-bottom: 1px solid var(--color-border); color: #888;">
                                            ${fmtE(objMostrar)}
                                        </td>
                                        <td style="padding: 10px 8px; text-align: right; border-bottom: 1px solid var(--color-border); color: ${faltaMostrar > 0 ? '#ef4444' : '#22c55e'}; font-weight: 600;">
                                            ${faltaMostrar > 0 ? fmtE(faltaMostrar) : 'âœ“'}
                                        </td>
                                        ${esVistaYTD || esVistaAnual ? `
                                        <td style="padding: 10px 8px; text-align: right; border-bottom: 1px solid var(--color-border); font-weight: 700; background: rgba(245,158,11,0.05); color: ${a.nuevoObjMes > a.objMes * 1.2 ? '#ef4444' : '#f59e0b'};">
                                            ${fmtE(a.nuevoObjMes)}
                                        </td>
                                        ` : `
                                        <td style="padding: 10px 8px; text-align: right; border-bottom: 1px solid var(--color-border); font-weight: 600;">
                                            ${fmtE(a.faltaSemana > 0 ? a.faltaSemana : a.objSemana)}
                                        </td>
                                        `}
                                        <td style="padding: 10px 8px; text-align: center; border-bottom: 1px solid var(--color-border);">
                                            <span style="background: rgba(99,102,241,0.15); padding: 3px 8px; border-radius: 12px; font-size: 0.9em;">${citasLabel}</span>
                                        </td>
                                        <td style="padding: 10px 8px; text-align: center; border-bottom: 1px solid var(--color-border);">
                                            <span style="background: rgba(34,197,94,0.15); padding: 3px 8px; border-radius: 12px; font-size: 0.9em;">${exclLabel}</span>
                                        </td>
                                        <td style="padding: 10px 8px; text-align: center; border-bottom: 1px solid var(--color-border);">
                                            <span style="background: rgba(234,179,8,0.15); padding: 3px 8px; border-radius: 12px; font-size: 0.9em;">${leadVLabel}</span>
                                        </td>
                                        <td style="padding: 10px 8px; text-align: center; border-bottom: 1px solid var(--color-border);">
                                            <span style="background: rgba(236,72,153,0.15); padding: 3px 8px; border-radius: 12px; font-size: 0.9em;">${leadCLabel}</span>
                                        </td>
                                        <td style="padding: 10px 8px; text-align: center; border-bottom: 1px solid var(--color-border);">
                                            <span style="background: rgba(139,92,246,0.15); padding: 3px 8px; border-radius: 12px; font-size: 0.9em;">${propLabel}</span>
                                        </td>
                                        <td style="padding: 10px 8px; text-align: center; border-bottom: 1px solid var(--color-border);">
                                            <span style="background: rgba(6,182,212,0.15); padding: 3px 8px; border-radius: 12px; font-size: 0.9em;">${arrasLabel}</span>
                                        </td>
                                        <td style="padding: 10px 8px; text-align: center; border-bottom: 1px solid var(--color-border);">
                                            <span style="background: ${statusBg}; color: ${statusColor}; padding: 4px 10px; border-radius: 15px; font-size: 0.85em; font-weight: 600; white-space: nowrap;">
                                                ${statusIcon} ${status === 'excelente' ? 'Ok' : status === 'bueno' ? 'Bien' : status === 'medio' ? 'Alerta' : 'CrÃ­tico'}
                                            </span>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                <div style="font-size: 0.75em; color: #888; margin-top: 8px; text-align: right;">
                    ${esVistaYTD || esVistaAnual ? 'Formato KPIs: Realizado/Objetivo' : esVistaSemana ? 'KPIs: Objetivo semanal' : 'KPIs: Objetivo mensual'} Â· Click en agente para ver detalle
                </div>
            </div>

            <!-- ===== EVOLUCIÃ“N MENSUAL ===== -->
            <div style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 12px; padding: 25px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; font-size: 1.2em; font-weight: 600;">EvoluciÃ³n GCI Mensual</h2>
                    <div style="display: flex; gap: 20px; font-size: 0.85em;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="width: 12px; height: 12px; background: #22c55e; border-radius: 2px;"></span>
                            Realizado
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="width: 12px; height: 12px; background: #6366f1; border-radius: 2px;"></span>
                            Objetivo
                        </div>
                        ${esVistaYTD ? `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="width: 12px; height: 3px; background: #f59e0b;"></span>
                            Nuevo Obj.
                        </div>
                        ` : ''}
                    </div>
                </div>
                <div style="height: 300px;">
                    <canvas id="chart-mando-evolucion"></canvas>
                </div>
            </div>
        </div>
    `;
}

// ===== FUNCIÃ“N: Cambiar vista del mando =====
function cambiarVistaMando(periodo) {
    console.log('ğŸ”„ Cambiando periodo del mando a:', periodo);
    window.mandoPeriodo = periodo;
    
    const contenedor = document.getElementById('vistaContenido');
    
    // Si ya tenemos los objetivos cargados, renderizar directamente
    if (window.objetivosGlobalesOficina !== undefined) {
        contenedor.innerHTML = renderizarCentroMando();
        inicializarGraficosMando();
    } else {
        // Solo cargar si no existen (primera vez o error previo)
        google.script.run
            .withSuccessHandler(function(objetivos) {
                window.objetivosGlobalesOficina = objetivos;
                contenedor.innerHTML = renderizarCentroMando();
                inicializarGraficosMando();
            })
            .withFailureHandler(function() {
                window.objetivosGlobalesOficina = null;
                contenedor.innerHTML = renderizarCentroMando();
                inicializarGraficosMando();
            })
            .obtenerObjetivosGlobalesOficina();
    }
}

// ===== HELPER: Renderizar tarjeta de ratio =====
function renderRatioMando(titulo, agentes, kpiA, kpiB, unidad, valorA, valorB) {
    let ratio = 0;
    
    if (valorA !== undefined && valorB !== undefined) {
        ratio = valorB > 0 ? valorA / valorB : 0;
    } else {
        const totalA = agentes.reduce((s, a) => s + (a.realizado?.[kpiA] || 0), 0);
        const totalB = agentes.reduce((s, a) => s + (a.realizado?.[kpiB] || 0), 0);
        ratio = totalA > 0 ? (totalB / totalA) * 100 : 0;
    }
    
    const fmt = unidad === 'â‚¬' ? Math.round(ratio).toLocaleString('es-ES') + 'â‚¬' : ratio.toFixed(1) + '%';
    
    return `
        <div style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 12px; padding: 20px; text-align: center;">
            <div style="font-size: 0.8em; color: #888; margin-bottom: 10px;">${titulo}</div>
            <div style="font-size: 2em; font-weight: 800; color: var(--color-text-primary);">${fmt}</div>
        </div>
    `;
}
// ============================================
// DISTRIBUCIÃ“N MENSUAL
// ============================================

// Valores por defecto (ene, abr, ago, dic = 5%, resto = 10%)
var distribucionMensualDefecto = {
    1: 5, 2: 10, 3: 10, 4: 5, 5: 10, 6: 10,
    7: 10, 8: 5, 9: 10, 10: 10, 11: 10, 12: 5
};

function resetearDistribucionMensual() {
    for (var mes = 1; mes <= 12; mes++) {
        var input = document.getElementById('me-dist-' + mes);
        if (input) {
            input.value = distribucionMensualDefecto[mes];
        }
    }
    validarDistribucionMensual();
    mostrarNotificacion('âœ… DistribuciÃ³n restaurada a valores por defecto', 'success');
}

function distribucionUniforme() {
    var valorUniforme = (100 / 12).toFixed(2);
    for (var mes = 1; mes <= 12; mes++) {
        var input = document.getElementById('me-dist-' + mes);
        if (input) {
            input.value = valorUniforme;
        }
    }
    validarDistribucionMensual();
    mostrarNotificacion('âœ… DistribuciÃ³n uniforme aplicada (8.33% cada mes)', 'success');
}

function validarDistribucionMensual() {
    var total = 0;
    for (var mes = 1; mes <= 12; mes++) {
        var input = document.getElementById('me-dist-' + mes);
        var valor = parseFloat(input?.value) || 0;
        total += valor;
        
        // Marcar meses bajos
        var item = input?.closest('.mes-dist-item');
        if (item) {
            if (valor <= 5) {
                item.classList.add('mes-bajo');
            } else {
                item.classList.remove('mes-bajo');
            }
        }
    }
    
    var validacion = document.getElementById('me-dist-validacion');
    var diff = Math.abs(total - 100);
    
    if (diff < 0.1) {
        validacion.innerHTML = 'âœ… Total: <strong>100%</strong> - DistribuciÃ³n correcta';
        validacion.style.background = 'rgba(34,197,94,0.2)';
        validacion.style.color = '#22c55e';
    } else if (total < 100) {
        validacion.innerHTML = 'âš ï¸ Total: <strong>' + total.toFixed(1) + '%</strong> - Faltan <strong>' + (100 - total).toFixed(1) + '%</strong>';
        validacion.style.background = 'rgba(255,193,7,0.2)';
        validacion.style.color = '#ffc107';
    } else {
        validacion.innerHTML = 'âŒ Total: <strong>' + total.toFixed(1) + '%</strong> - Sobran <strong>' + (total - 100).toFixed(1) + '%</strong>';
        validacion.style.background = 'rgba(239,68,68,0.2)';
        validacion.style.color = '#ef4444';
    }
    
    // Actualizar preview si hay GCI calculado
    actualizarPreviewDistribucion();
    
    return diff < 0.1;
}

function actualizarPreviewDistribucion() {
    var gciInput = document.getElementById('me-obj-gci');
    var gci = parseFloat(gciInput?.value) || 0;
    
    var previewContainer = document.getElementById('me-dist-preview');
    var previewGrid = document.getElementById('me-dist-preview-grid');
    
    if (gci <= 0) {
        previewContainer.style.display = 'none';
        return;
    }
    
    previewContainer.style.display = 'block';
    
    var meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    var html = '';
    
    for (var mes = 1; mes <= 12; mes++) {
        var pct = parseFloat(document.getElementById('me-dist-' + mes)?.value) || 0;
        var valor = Math.round(gci * pct / 100);
        var color = pct <= 5 ? '#ffc107' : '#22c55e';
        
        html += '<div style="text-align: center; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 6px;">';
        html += '<div style="color: #888;">' + meses[mes - 1] + '</div>';
        html += '<div style="font-weight: 700; color: ' + color + ';">' + formatearMoneda(valor) + '</div>';
        html += '</div>';
    }
    
    previewGrid.innerHTML = html;
}

function obtenerDistribucionMensual() {
    var distribucion = {};
    for (var mes = 1; mes <= 12; mes++) {
        distribucion[mes] = parseFloat(document.getElementById('me-dist-' + mes)?.value) || 0;
    }
    return distribucion;
}

// ============================================
// CUADRE OBJETIVOS
// ============================================

var datosCuadreGlobal = null;

function cargarCuadreObjetivos() {
    var tbody = document.getElementById('me-cuadre-tbody');
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px;"><div class="loader"></div><div style="margin-top: 10px;">Cargando datos...</div></td></tr>';
    
    google.script.run
        .withSuccessHandler(function(resultado) {
            if (!resultado || !resultado.success) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px; color: #ff6b6b;">âŒ Error: ' + (resultado?.error || 'Sin datos') + '</td></tr>';
                return;
            }
            
            datosCuadreGlobal = resultado;
            renderizarCuadreObjetivos(resultado);
        })
        .withFailureHandler(function(error) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px; color: #ff6b6b;">âŒ Error: ' + error.message + '</td></tr>';
        })
        .obtenerDatosCuadre();
}

function renderizarCuadreObjetivos(datos) {
    // Resumen GCI
    var gciOficina = datos.oficina?.gci || 0;
    var gciAgentes = datos.sumaAgentes?.gci || 0;
    var diffGci = gciOficina - gciAgentes;
    var pctDiff = gciAgentes > 0 ? ((diffGci / gciAgentes) * 100).toFixed(1) : 0;
    
    document.getElementById('cuadre-gci-oficina').textContent = formatearMoneda(gciOficina);
    document.getElementById('cuadre-gci-agentes').textContent = formatearMoneda(gciAgentes);
    document.getElementById('cuadre-num-agentes').textContent = (datos.numAgentes || 0) + ' agentes activos';
    
    var diffContainer = document.getElementById('cuadre-diff-container');
    var diffElement = document.getElementById('cuadre-gci-diff');
    var pctElement = document.getElementById('cuadre-diff-pct');
    
    if (Math.abs(diffGci) < 100) {
        diffContainer.style.background = 'rgba(34,197,94,0.15)';
        diffContainer.style.borderColor = 'rgba(34,197,94,0.3)';
        diffElement.style.color = '#22c55e';
        diffElement.textContent = 'âœ“ Cuadrado';
        pctElement.textContent = '';
    } else {
        diffContainer.style.background = diffGci > 0 ? 'rgba(255,193,7,0.15)' : 'rgba(239,68,68,0.15)';
        diffContainer.style.borderColor = diffGci > 0 ? 'rgba(255,193,7,0.3)' : 'rgba(239,68,68,0.3)';
        diffElement.style.color = diffGci > 0 ? '#ffc107' : '#ef4444';
        diffElement.textContent = (diffGci > 0 ? '+' : '') + formatearMoneda(diffGci);
        pctElement.textContent = (diffGci > 0 ? '+' : '') + pctDiff + '% vs agentes';
        pctElement.style.color = diffGci > 0 ? '#ffc107' : '#ef4444';
    }
    
    // Estado general
    var estadoDiv = document.getElementById('cuadre-estado');
    if (Math.abs(diffGci) < 100) {
        estadoDiv.innerHTML = 'âœ… <strong>Los objetivos estÃ¡n cuadrados.</strong> La suma de agentes coincide con los objetivos de oficina.';
        estadoDiv.style.background = 'rgba(34,197,94,0.1)';
        estadoDiv.style.color = '#22c55e';
    } else if (gciOficina > gciAgentes) {
        estadoDiv.innerHTML = 'âš ï¸ <strong>Oficina mayor que agentes.</strong> Hay ' + formatearMoneda(diffGci) + ' sin asignar a ningÃºn agente.';
        estadoDiv.style.background = 'rgba(255,193,7,0.1)';
        estadoDiv.style.color = '#ffc107';
    } else {
        estadoDiv.innerHTML = 'âŒ <strong>Agentes mayor que oficina.</strong> La suma de agentes supera el objetivo de oficina en ' + formatearMoneda(Math.abs(diffGci)) + '.';
        estadoDiv.style.background = 'rgba(239,68,68,0.1)';
        estadoDiv.style.color = '#ef4444';
    }
    
    // Tabla detallada
    renderizarTablaCuadre(datos);
    // Renderizar tabla de agentes
    renderizarTablaAgentes(datos);
}

function renderizarTablaCuadre(datos) {
    var tbody = document.getElementById('me-cuadre-tbody');
    
    // âœ… CORREGIDO: leer correctamente el checkbox
    var checkboxDiff = document.getElementById('cuadre-solo-diferencias');
    var soloDiferencias = checkboxDiff ? checkboxDiff.checked : false;
    
    var kpis = [
        { key: 'gci', label: 'ğŸ’° GCI', formato: 'moneda' },
        { key: 'citasCaptacion', label: 'ğŸ“ Citas CaptaciÃ³n' },
        { key: 'exclusivasVenta', label: 'ğŸ  Exclusivas Venta' },
        { key: 'captacionesAbierto', label: 'ğŸ˜ï¸ Capt. Abierto' },
        { key: 'exclusivasComprador', label: 'ğŸ”‘ Exclusivas Comp.' },
        { key: 'citasCompradores', label: 'ğŸ“… Citas Compradores' },
        { key: 'casasEnsenadas', label: 'ğŸ¡ Casas EnseÃ±adas' },
        { key: 'llamadas', label: 'ğŸ“ Llamadas' },
        { key: 'leadVendedor', label: 'ğŸ“± Lead Vendedor' },
        { key: 'leadsCompradores', label: 'ğŸ‘¤ Lead Comprador' },
        { key: 'tresBs', label: 'âš¡ 3Bs' },
        { key: 'bajadasPrecio', label: 'ğŸ’¹ Bajadas Precio' },
        { key: 'propuestasCompra', label: 'ğŸ“„ Propuestas' },
        { key: 'arras', label: 'âœï¸ Arras' },
        { key: 'volumenNegocio', label: 'ğŸ’¼ Volumen Negocio', formato: 'moneda' }
    ];
    
    var html = '';
    
    kpis.forEach(function(kpi) {
        var valOficina = datos.oficina?.[kpi.key] || 0;
        var valAgentes = datos.sumaAgentes?.[kpi.key] || 0;
        var diff = valOficina - valAgentes;
        var hayDiferencia = Math.abs(diff) > 0.5;
        
        // Si solo queremos diferencias y no hay, saltar
        if (soloDiferencias && !hayDiferencia) return;
        
        var colorDiff, icono;
        if (!hayDiferencia) {
            colorDiff = '#22c55e';
            icono = 'âœ…';
        } else if (diff > 0) {
            colorDiff = '#ffc107';
            icono = 'âš ï¸';
        } else {
            colorDiff = '#ef4444';
            icono = 'âŒ';
        }
        
        var formatear = kpi.formato === 'moneda' ? formatearMoneda : function(v) { return Math.round(v).toLocaleString('es-ES'); };
        
        html += '<tr style="border-bottom: 1px solid var(--color-border);">';
        html += '<td style="padding: 10px;">' + kpi.label + '</td>';
        html += '<td style="padding: 10px; text-align: right; font-weight: 700; color: #667eea;">' + formatear(valOficina) + '</td>';
        html += '<td style="padding: 10px; text-align: right; font-weight: 700; color: #22c55e;">' + formatear(valAgentes) + '</td>';
        html += '<td style="padding: 10px; text-align: right; font-weight: 700; color: ' + colorDiff + ';">' + (diff !== 0 ? (diff > 0 ? '+' : '') + formatear(diff) : '-') + '</td>';
        html += '<td style="padding: 10px; text-align: center; font-size: 1.2em;">' + icono + '</td>';
        html += '</tr>';
    });
    
    if (html === '') {
        html = '<tr><td colspan="5" style="text-align: center; padding: 30px; color: #22c55e;">âœ… Todos los KPIs estÃ¡n cuadrados</td></tr>';
    }
    
    tbody.innerHTML = html;
}

function filtrarTablaCuadre() {
    if (datosCuadreGlobal) {
        renderizarTablaCuadre(datosCuadreGlobal);
    }
}
function renderizarTablaAgentes(datos) {
    var tbody = document.getElementById('me-cuadre-agentes-tbody');
    if (!tbody) return;
    
    var agentes = datos.agentes || [];
    var gciTotal = datos.sumaAgentes?.gci || 0;
    
    if (agentes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #888;">No hay agentes con objetivos</td></tr>';
        return;
    }
    
    var html = '';
    
    agentes.forEach(function(ag, idx) {
        var pct = gciTotal > 0 ? ((ag.gci / gciTotal) * 100).toFixed(1) : 0;
        var color = idx < 3 ? '#22c55e' : (idx < 6 ? '#ffc107' : '#888');
        
        html += '<tr style="border-bottom: 1px solid var(--color-border);">';
        html += '<td style="padding: 10px;">';
        html += '<span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: ' + color + '; margin-right: 8px;"></span>';
        html += ag.nombre;
        html += '</td>';
        html += '<td style="padding: 10px; text-align: right; font-weight: 700; color: #22c55e;">' + formatearMoneda(ag.gci) + '</td>';
        html += '<td style="padding: 10px; text-align: right; color: #888;">' + pct + '%</td>';
        html += '<td style="padding: 10px; text-align: right;">' + (ag.citasCaptacion || 0) + '</td>';
        html += '<td style="padding: 10px; text-align: right;">' + (ag.exclusivasVenta || 0) + '</td>';
        html += '<td style="padding: 10px; text-align: right;">' + (ag.casasEnsenadas || 0) + '</td>';
        html += '</tr>';
    });
    
    // Fila de totales
    html += '<tr style="background: rgba(34,197,94,0.1); font-weight: 700;">';
    html += '<td style="padding: 10px;">TOTAL (' + agentes.length + ' agentes)</td>';
    html += '<td style="padding: 10px; text-align: right; color: #22c55e;">' + formatearMoneda(gciTotal) + '</td>';
    html += '<td style="padding: 10px; text-align: right;">100%</td>';
    html += '<td style="padding: 10px; text-align: right;">' + (datos.sumaAgentes?.citasCaptacion || 0) + '</td>';
    html += '<td style="padding: 10px; text-align: right;">' + (datos.sumaAgentes?.exclusivasVenta || 0) + '</td>';
    html += '<td style="padding: 10px; text-align: right;">' + (datos.sumaAgentes?.casasEnsenadas || 0) + '</td>';
    html += '</tr>';
    
    tbody.innerHTML = html;
}
// ============================================
// ACCIONES DE CUADRE
// ============================================

// ============================================
// BOTONES DE CUADRE
// ============================================

function confirmarOficinaAAgentes() {
    if (!datosCuadreGlobal) {
        mostrarNotificacion('âš ï¸ Primero carga los datos de cuadre', 'warning');
        return;
    }
    
    var metodo = document.getElementById('cuadre-metodo-reparto')?.value || 'proporcional';
    var numAgentes = datosCuadreGlobal.numAgentes || 0;
    
    if (numAgentes === 0) {
        mostrarNotificacion('âŒ No hay agentes activos', 'error');
        return;
    }
    
    var gciOficina = datosCuadreGlobal.oficina?.gci || 0;
    
    var mensaje = 'Â¿Repartir ' + formatearMoneda(gciOficina) + ' entre ' + numAgentes + ' agentes?\n\n';
    mensaje += 'MÃ©todo: ' + metodo + '\n';
    mensaje += 'Se crearÃ¡n/actualizarÃ¡n los objetivos mensuales de cada agente.';
    
    if (confirm(mensaje)) {
        ejecutarOficinaAAgentes(metodo);
    }
}

function confirmarAgentesAOficina() {
    if (!datosCuadreGlobal) {
        mostrarNotificacion('âš ï¸ Primero carga los datos de cuadre', 'warning');
        return;
    }
    
    var gciAgentes = datosCuadreGlobal.sumaAgentes?.gci || 0;
    var gciOficina = datosCuadreGlobal.oficina?.gci || 0;
    
    var mensaje = 'Â¿Actualizar objetivos de oficina con la suma de agentes?\n\n';
    mensaje += 'GCI Oficina actual: ' + formatearMoneda(gciOficina) + '\n';
    mensaje += 'GCI Suma agentes: ' + formatearMoneda(gciAgentes) + '\n';
    mensaje += 'Nuevo GCI Oficina: ' + formatearMoneda(gciAgentes);
    
    if (confirm(mensaje)) {
        ejecutarAgentesAOficina();
    }
}

function ejecutarOficinaAAgentes(metodo) {
    mostrarNotificacion('â³ Repartiendo objetivos...', 'info');
    
    google.script.run
        .withSuccessHandler(function(resultado) {
            console.log('Resultado repartir:', resultado);
            if (resultado.success) {
                var msg = 'âœ… Objetivos repartidos a ' + resultado.agentesActualizados + ' agentes';
                if (resultado.filasCreadas > 0) {
                    msg += ' (' + resultado.filasCreadas + ' filas creadas)';
                }
                mostrarNotificacion(msg, 'success');
                cargarCuadreObjetivos(); // Recargar datos
            } else {
                mostrarNotificacion('âŒ ' + resultado.error, 'error');
            }
        })
        .withFailureHandler(function(error) {
            console.error('Error repartir:', error);
            mostrarNotificacion('âŒ Error: ' + error.message, 'error');
        })
        .repartirObjetivosOficinaAAgentes(metodo);
}

function ejecutarAgentesAOficina() {
    mostrarNotificacion('â³ Sincronizando...', 'info');
    
    google.script.run
        .withSuccessHandler(function(resultado) {
            console.log('Resultado sincronizar:', resultado);
            if (resultado.success) {
                mostrarNotificacion('âœ… Oficina sincronizada. Nuevo GCI: ' + formatearMoneda(resultado.nuevoGci), 'success');
                cargarCuadreObjetivos(); // Recargar datos
            } else {
                mostrarNotificacion('âŒ ' + resultado.error, 'error');
            }
        })
        .withFailureHandler(function(error) {
            console.error('Error sincronizar:', error);
            mostrarNotificacion('âŒ Error: ' + error.message, 'error');
        })
        .sincronizarOficinaConAgentes();
}

// Variable global para datos de cuadre
var datosCuadreGlobal = null;

function cargarCuadreObjetivos() {
    var tbody = document.getElementById('me-cuadre-tbody');
    if (tbody) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;"><div class="loader"></div> Cargando...</td></tr>';
    }
    
    google.script.run
        .withSuccessHandler(function(resultado) {
            console.log('Datos cuadre:', resultado);
            if (resultado && resultado.success) {
                datosCuadreGlobal = resultado;
                renderizarCuadreObjetivos(resultado);
            } else {
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:#ff6b6b;">âŒ ' + (resultado?.error || 'Error') + '</td></tr>';
                }
            }
        })
        .withFailureHandler(function(error) {
            console.error('Error cargar cuadre:', error);
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:#ff6b6b;">âŒ ' + error.message + '</td></tr>';
            }
        })
        .obtenerDatosCuadre();
}

// Inicializar distribuciÃ³n al cargar
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        validarDistribucionMensual();
    }, 500);
});
// ===== INICIALIZAR GRÃFICOS =====
function inicializarGraficosMando() {
    setTimeout(() => {
        crearGraficoEvolucionMando();
    }, 100);
}
// ===== MODAL DETALLE KPI CON GRÃFICO Y PLAN DE ACCIÃ“N =====
function mostrarDetalleKPI(kpiKey) {
    const modalBody = document.getElementById('modal-analisis-body');
    if (!modalBody) return;
    
    const tituloAgente = modalBody.querySelector('h1');
    if (!tituloAgente) return;
    
    const nombreAgente = tituloAgente.textContent.replace('ğŸ‘¤ ', '');
    const agente = datosGlobales.find(d => d.agente === nombreAgente);
    if (!agente) return;
    
    const real = agente.realizado;
    const obj = agente.objetivos;
    const evol = agente.evolucionMensual;
    const hist = historialAgentesCache[agente.id] || null;
    
    const hoy = new Date();
    const mesActual = hoy.getMonth();
    const diasTranscurridos = Math.ceil((hoy - new Date(hoy.getFullYear(), 0, 1)) / (1000 * 60 * 60 * 24));
    const factorTiempo = diasTranscurridos / 365;
    const mesesRestantes = 12 - mesActual;
    const semanasRestantes = Math.ceil((365 - diasTranscurridos) / 7);
    
    const kpiMeta = {
        'gci': { nombre: 'ğŸ’° GCI', unidad: 'â‚¬', histKey: 'gci' },
        'citasCaptacion': { nombre: 'ğŸ“ Citas CaptaciÃ³n', unidad: '', histKey: 'citasCapt' },
        'exclusivasVenta': { nombre: 'ğŸ  Exclusivas Venta', unidad: '', histKey: 'exclVenta' },
        'exclusivasComprador': { nombre: 'ğŸ”‘ Exclusivas Comprador', unidad: '', histKey: 'exclComprador' },
        'captacionesAbierto': { nombre: 'ğŸ˜ï¸ Captaciones Abierto', unidad: '', histKey: 'captAbierto' },
        'citasCompradores': { nombre: 'ğŸ‘¥ Citas Compradores', unidad: '', histKey: 'citasComp' },
        'casasEnsenadas': { nombre: 'ğŸ¡ Casas EnseÃ±adas', unidad: '', histKey: 'visitas' },
        'llamadas': { nombre: 'ğŸ“ Llamadas', unidad: '', histKey: 'llamadas' },
        'leadsCompradores': { nombre: 'ğŸ‘¥ Leads Compradores', unidad: '', histKey: 'leads' },
        'volumenNegocio': { nombre: 'ğŸ“Š Volumen Negocio', unidad: 'â‚¬', histKey: 'volumen' },
        'leadVendedor': { nombre: 'ğŸ“‹ Lead Vendedor', unidad: '', histKey: null },
        'leadComprador': { nombre: 'ğŸ‘¤ Lead Comprador', unidad: '', histKey: null },
        'propuestasCompra': { nombre: 'ğŸ“ Propuestas Compra', unidad: '', histKey: null },
        'arras': { nombre: 'ğŸ“„ Arras Firmadas', unidad: '', histKey: null },
        'bajadasPrecio': { nombre: 'ğŸ“‰ Bajadas Precio', unidad: '', histKey: null },
        'tresBs': { nombre: 'ğŸ¯ 3 Bs', unidad: '', histKey: null }
    };
    
    const meta = kpiMeta[kpiKey] || { nombre: kpiKey, unidad: '', histKey: null };
    
    const realizado = real[kpiKey] || 0;
    const objetivo = obj[kpiKey] || 0;
    const objetivoFecha = objetivo * factorTiempo;
    const falta = Math.max(objetivo - realizado, 0);
    const nuevoObjMes = mesesRestantes > 0 ? falta / mesesRestantes : 0;
    const nuevoObjSem = semanasRestantes > 0 ? falta / semanasRestantes : 0;
    const proyeccion = factorTiempo > 0 ? realizado / factorTiempo : 0;
    const cumplimiento = objetivoFecha > 0 ? (realizado / objetivoFecha * 100) : 0;
    
    // AÃ±o anterior y aÃ±o anterior a la fecha
    const anoAnterior = (hist && meta.histKey) ? (hist[meta.histKey] || 0) : 0;
    const anoAnteriorAFecha = anoAnterior * factorTiempo;
    const diffVsAnt = realizado - anoAnterior;
    const diffVsAntFecha = realizado - anoAnteriorAFecha;
    const pctVsAnt = anoAnterior > 0 ? (diffVsAnt / anoAnterior * 100) : 0;
    const pctVsAntFecha = anoAnteriorAFecha > 0 ? (diffVsAntFecha / anoAnteriorAFecha * 100) : 0;
    
    const fmt = (v) => {
        if (meta.unidad === 'â‚¬') return Math.round(v).toLocaleString('es-ES') + 'â‚¬';
        return Math.round(v).toLocaleString('es-ES');
    };
    
    const colorCump = cumplimiento >= 100 ? '#22c55e' : cumplimiento >= 80 ? '#ffd700' : '#ff6b6b';
    const colorAntFecha = diffVsAntFecha >= 0 ? '#22c55e' : '#ff6b6b';
    
    const modalHTML = `
        <div id="modal-detalle-kpi" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10001; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s;">
            <div style="background: #1a1a2e; border: 1px solid #333; border-radius: 16px; max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto; position: relative;">
                <button onclick="document.getElementById('modal-detalle-kpi').remove()" 
                        style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.1); border: none; font-size: 1.5em; cursor: pointer; color: #fff; z-index: 10; width: 40px; height: 40px; border-radius: 50%;">âœ•</button>
                
                <div style="padding: 25px;">
                    <div style="text-align: center; margin-bottom: 25px;">
                        <h2 style="margin: 0; font-size: 1.8em; color: #fff;">${meta.nombre}</h2>
                        <div style="color: #888; margin-top: 5px;">${agente.agente} - Plan de AcciÃ³n</div>
                    </div>
                    
                    <!-- Resumen rÃ¡pido -->
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 25px;">
                        <div style="background: #252540; padding: 15px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.75em; color: #888;">Realizado YTD</div>
                            <div style="font-size: 1.5em; font-weight: 900; color: #fff;">${fmt(realizado)}</div>
                        </div>
                        <div style="background: #252540; padding: 15px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.75em; color: #888;">Objetivo Anual</div>
                            <div style="font-size: 1.5em; font-weight: 900; color: #ffd700;">${fmt(objetivo)}</div>
                        </div>
                        <div style="background: #252540; padding: 15px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.75em; color: #888;">Cumplimiento</div>
                            <div style="font-size: 1.5em; font-weight: 900; color: ${colorCump};">${cumplimiento.toFixed(0)}%</div>
                        </div>
                        <div style="background: #252540; padding: 15px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.75em; color: #888;">vs AÃ±o Ant. (fecha)</div>
                            <div style="font-size: 1.5em; font-weight: 900; color: ${colorAntFecha};">${pctVsAntFecha >= 0 ? '+' : ''}${pctVsAntFecha.toFixed(0)}%</div>
                            <div style="font-size: 0.7em; color: #666;">${fmt(anoAnteriorAFecha)} a fecha</div>
                        </div>
                        <div style="background: #252540; padding: 15px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.75em; color: #888;">vs AÃ±o Ant. (total)</div>
                            <div style="font-size: 1.5em; font-weight: 900; color: ${diffVsAnt >= 0 ? '#22c55e' : '#ff6b6b'};">${pctVsAnt >= 0 ? '+' : ''}${pctVsAnt.toFixed(0)}%</div>
                            <div style="font-size: 0.7em; color: #666;">${fmt(anoAnterior)} total ${hoy.getFullYear()-1}</div>
                        </div>
                    </div>
                    
                    <!-- Plan de AcciÃ³n -->
                    <div style="background: linear-gradient(135deg, rgba(245,158,11,0.2), rgba(239,68,68,0.15)); border: 2px solid rgba(245,158,11,0.4); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                        <h3 style="margin: 0 0 15px 0; color: #f59e0b;">ğŸ¯ Plan de AcciÃ³n para Cumplir Objetivo</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <div style="background: #252540; padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 0.8em; color: #888;">Falta para Objetivo</div>
                                <div style="font-size: 1.6em; font-weight: 900; color: #ef4444;">${fmt(falta)}</div>
                            </div>
                            <div style="background: #252540; padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 0.8em; color: #888;">Nuevo Obj. Mensual</div>
                                <div style="font-size: 1.6em; font-weight: 900; color: #f59e0b;">${fmt(nuevoObjMes)}</div>
                                <div style="font-size: 0.75em; color: #888;">x ${mesesRestantes} meses</div>
                            </div>
                            <div style="background: #252540; padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 0.8em; color: #888;">Nuevo Obj. Semanal</div>
                                <div style="font-size: 1.6em; font-weight: 900; color: #f59e0b;">${fmt(nuevoObjSem)}</div>
                                <div style="font-size: 0.75em; color: #888;">x ${semanasRestantes} semanas</div>
                            </div>
                        </div>
                        
                        ${falta > 0 ? `
                        <div style="margin-top: 15px; padding: 12px; background: rgba(239,68,68,0.2); border-radius: 8px; text-align: center;">
                            <span style="color: #ff6b6b; font-weight: 600;">
                                âš ï¸ Para cumplir el objetivo anual de ${fmt(objetivo)}, necesita hacer <strong>${fmt(nuevoObjMes)}</strong> cada mes durante los prÃ³ximos <strong>${mesesRestantes} meses</strong>
                            </span>
                        </div>
                        ` : `
                        <div style="margin-top: 15px; padding: 12px; background: rgba(34,197,94,0.2); border-radius: 8px; text-align: center;">
                            <span style="color: #22c55e; font-weight: 600;">
                                âœ… Â¡Objetivo cumplido! ProyecciÃ³n: ${fmt(proyeccion)}
                            </span>
                        </div>
                        `}
                    </div>
                    
                    <!-- GrÃ¡fico -->
                    <div style="background: #252540; border-radius: 12px; padding: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.1em; color: #fff;">ğŸ“ˆ EvoluciÃ³n Mensual</h3>
                        <div style="height: 300px;">
                            <canvas id="chart-detalle-kpi-modal"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    setTimeout(() => {
        renderizarGraficoDetalleKPIModal(agente, kpiKey, hist);
    }, 100);
}

function renderizarGraficoDetalleKPIModal(agente, kpiKey, hist) {
    const ctx = document.getElementById('chart-detalle-kpi-modal');
    if (!ctx) return;
    
    const labels = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    const evol = agente.evolucionMensual;
    
    let dataReal = new Array(12).fill(0);
    let dataObj = new Array(12).fill(0);
    
    if (evol && evol[kpiKey]) {
        const labelsBackend = evol.labels || [];
        
        if (labelsBackend.length > 0 && labelsBackend[0] === 'Dic') {
            const realOrig = evol[kpiKey].realizado || [];
            const objOrig = evol[kpiKey].objetivo || [];
            if (realOrig.length === 12) dataReal = [...realOrig.slice(1), realOrig[0]];
            if (objOrig.length === 12) dataObj = [...objOrig.slice(1), objOrig[0]];
        } else {
            dataReal = evol[kpiKey].realizado || new Array(12).fill(0);
            dataObj = evol[kpiKey].objetivo || new Array(12).fill(0);
        }
    }
    
    // HistÃ³rico
    let dataHist = new Array(12).fill(0);
    if (hist) {
        const mapKeys = {
    'gci': 'gci',
    'citasCaptacion': 'citasCapt',
    'exclusivasVenta': 'exclVenta',
    'exclusivasComprador': 'exclComp',
    'captacionesAbierto': 'captAbierto',
    'captacionesAlquiler': 'captAlquiler',
    'citasCompradores': 'citasComp',
    'casasEnsenadas': 'visitas',
    'llamadas': 'llamadas',
    'leadVendedor': 'leadVendedor',
    'leadComprador': 'leadComprador',
    'leadsCompradores': 'leadsCompradores',
    'tresBs': 'tresBs',
    'bajadasPrecio': 'bajadasPrecio',
    'propuestasCompra': 'propuestas',
    'leadSeguimiento': 'leadSeguimiento',
    'arras': 'arras',
    'ventas': 'ventas',
    'volumenNegocio': 'volumenNegocio'
};
        const histKey = mapKeys[kpiKey];
        if (histKey && hist[histKey]) {
            const valorMensual = hist[histKey] / 12;
            dataHist = new Array(12).fill(valorMensual);
        }
    }
    
    const datasets = [
        { 
            label: 'Realizado', 
            data: dataReal, 
            backgroundColor: 'rgba(0, 255, 136, 0.7)', 
            borderColor: '#22c55e', 
            borderWidth: 2,
            order: 3 
        }
    ];
    
    if (dataHist.reduce((a, b) => a + b, 0) > 0) {
        datasets.push({ 
            label: 'AÃ±o Anterior (promedio)', 
            data: dataHist, 
            backgroundColor: 'rgba(102, 126, 234, 0.4)', 
            borderColor: '#667eea', 
            borderWidth: 1,
            order: 2 
        });
    }
    
    datasets.push({ 
        label: 'Objetivo', 
        data: dataObj, 
        type: 'line', 
        borderColor: '#ffd700', 
        backgroundColor: 'rgba(255, 215, 0, 0.1)',
        borderWidth: 3, 
        pointRadius: 4,
        pointBackgroundColor: '#ffd700',
        tension: 0.3, 
        fill: false,
        order: 1 
    });
    
    new Chart(ctx, {
        type: 'bar',
        data: { labels: labels, datasets: datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                x: { grid: { display: false } }
            },
            plugins: { 
                legend: { display: true, position: 'top' }
            }
        }
    });
}
function crearGraficoEvolucionMando() {
    const ctx = document.getElementById('chart-mando-evolucion');
    if (!ctx) return;
    
    if (chartInstances['chart-mando-evolucion']) {
        chartInstances['chart-mando-evolucion'].destroy();
    }
    
    // Labels siempre en orden correcto
    const labels = LABELS_MESES;
    
    // Obtener labels del backend para detectar orden
    const labelsBackend = datosAgregadosEquipo?.labels || [];
    
    console.log('ğŸ“Š Labels backend:', labelsBackend);
    console.log('ğŸ“Š Datos GCI originales:', datosAgregadosEquipo?.gci?.realizado);
    
    // Obtener y reordenar datos
    let realizadoMensual = reordenarDatosMensuales(
        datosAgregadosEquipo?.gci?.realizado || new Array(12).fill(0),
        labelsBackend
    );
    let objetivoMensual = reordenarDatosMensuales(
        datosAgregadosEquipo?.gci?.objetivo || new Array(12).fill(0),
        labelsBackend
    );
    
    console.log('ğŸ“Š Datos GCI reordenados:', realizadoMensual);
    
    // HistÃ³rico
    let historicoMensual = new Array(12).fill(0);
    if (facturacionPasadaGlobal?.kpis?.gci) {
        const valorMensual = facturacionPasadaGlobal.kpis.gci / 12;
        historicoMensual = new Array(12).fill(valorMensual);
    }
    
    chartInstances['chart-mando-evolucion'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Realizado',
                    data: realizadoMensual,
                    backgroundColor: '#22c55e',
                    borderRadius: 4,
                    order: 2
                },
                {
                    label: 'Objetivo',
                    data: objetivoMensual,
                    type: 'line',
                    borderColor: '#6366f1',
                    borderWidth: 2,
                    pointRadius: 4,
                    pointBackgroundColor: '#6366f1',
                    tension: 0.3,
                    order: 1
                },
                {
                    label: 'AÃ±o Anterior',
                    data: historicoMensual,
                    type: 'line',
                    borderColor: '#888',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    tension: 0.3,
                    order: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(255,255,255,0.05)' },
                    ticks: {
                        callback: (v) => (v / 1000).toFixed(0) + 'Kâ‚¬',
                        color: '#888'
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#888' }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.9)',
                    padding: 12,
                    callbacks: {
                        label: (ctx) => ctx.dataset.label + ': ' + Math.round(ctx.parsed.y).toLocaleString('es-ES') + 'â‚¬'
                    }
                }
            }
        }
    });
}
// ===== FUNCIÃ“N HELPER: Asegurar array de 12 elementos =====
function reordenarDatosMensuales(datosArray, labelsBackend) {
    // Si no hay datos, retornar array vacÃ­o de 12
    if (!datosArray || !Array.isArray(datosArray)) {
        console.log('âš ï¸ Datos no es array, retornando array de 12 ceros');
        return new Array(12).fill(0);
    }
    
    // Convertir a array de nÃºmeros
    let datos = datosArray.map(v => parseFloat(v) || 0);
    
    console.log('ğŸ“Š reordenarDatosMensuales - Entrada: ' + datos.length + ' elementos');
    
    // Si ya tiene 12 elementos, verificar si necesita reordenar
    if (datos.length === 12) {
        // Verificar si el primer label es Diciembre
        const primerLabel = labelsBackend && labelsBackend[0] ? String(labelsBackend[0]).toLowerCase() : '';
        if (primerLabel.startsWith('dic')) {
            console.log('ğŸ”„ Reordenando de Dic-Nov a Ene-Dic');
            const diciembre = datos[0];
            return [...datos.slice(1), diciembre];
        }
        console.log('âœ… Array de 12 elementos, orden correcto');
        return datos;
    }
    
    // Si tiene 13 elementos, quitar uno
    if (datos.length === 13) {
        console.log('âš ï¸ Array de 13 elementos, ajustando...');
        const primerLabel = labelsBackend && labelsBackend[0] ? String(labelsBackend[0]).toLowerCase() : '';
        if (primerLabel.startsWith('dic')) {
            // El primer elemento es Diciembre extra, tomar elementos 1-12
            return datos.slice(1, 13);
        } else {
            // Tomar los primeros 12
            return datos.slice(0, 12);
        }
    }
    
    // Si tiene menos de 12, rellenar con ceros
    if (datos.length < 12) {
        console.log('âš ï¸ Array de ' + datos.length + ' elementos, rellenando con ceros');
        while (datos.length < 12) {
            datos.push(0);
        }
        return datos;
    }
    
    // Si tiene mÃ¡s de 13, truncar a 12
    console.log('âš ï¸ Array de ' + datos.length + ' elementos, truncando a 12');
    return datos.slice(0, 12);
}

// Labels siempre en orden correcto
const LABELS_MESES = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“ INSTALACIÃ“N COMPLETA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

console.log('âœ… JavaScript de HistÃ³rico y GrÃ¡ficos cargado correctamente');

 </script>
